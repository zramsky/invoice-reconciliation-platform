<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Reconciliation Platform Pro - Precision Contract Validation</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        /* 
        ==============================================
        COHESIVE THEME SYSTEM
        ==============================================
        Brand: "Precision Meets Trust"
        A platform that feels like a secure, high-end financial tool—uncluttered, authoritative, and always on your side.
        */

        :root {
            /* DARK MODE COLOR PALETTE */
            --primary: #0D1B2A;        /* Deep Navy - main background */
            --secondary: #1B4965;      /* Teal Blue - secondary surfaces */
            --accent-cyan: #00D4FF;    /* Bright Cyan - highlights & CTAs (enhanced for dark) */
            --accent-success: #00E676; /* Bright Green - success/validation (enhanced for dark) */
            --neutral-dark: #2A3441;   /* Dark Gray - card backgrounds */
            --neutral-medium: #394452; /* Medium Gray - elevated surfaces */
            --neutral-light: #4A5568;  /* Light Gray - borders and subtle elements */
            --text-primary: #F7FAFC;   /* Off-white - primary text */
            --text-secondary: #CBD5E0; /* Light gray - secondary text */
            --text-muted: #A0AEC0;     /* Muted gray - tertiary text */
            --white: #FFFFFF;          /* Pure White - accents only */
            --warning: #FFC107;        /* Bright Amber - enhanced for dark */
            --error: #FF5252;          /* Bright Red - enhanced for dark */
            
            /* DARK MODE BACKGROUNDS & BORDERS */
            --error-bg: rgba(255, 82, 82, 0.15);
            --error-bg-light: rgba(255, 82, 82, 0.25);
            --warning-bg: rgba(255, 193, 7, 0.15);
            --success-bg: rgba(0, 230, 118, 0.15);
            --success-bg-light: rgba(0, 230, 118, 0.08);
            --cyan-bg: rgba(0, 212, 255, 0.08);
            --cyan-bg-light: rgba(0, 212, 255, 0.15);
            --cyan-focus: rgba(0, 212, 255, 0.25);
            --secondary-bg: rgba(27, 73, 101, 0.25);
            --secondary-bg-light: rgba(27, 73, 101, 0.15);
            --border-light: rgba(255, 255, 255, 0.08);
            --border-medium: rgba(255, 255, 255, 0.12);
            --border-strong: rgba(255, 255, 255, 0.16);
            --border-dashed: rgba(255, 255, 255, 0.2);
            --bg-subtle: rgba(255, 255, 255, 0.02);
            --surface-1: rgba(42, 52, 65, 0.8);    /* Card backgrounds */
            --surface-2: rgba(57, 68, 82, 0.9);    /* Elevated surfaces */
            --surface-3: rgba(74, 85, 104, 0.95);  /* Highest elevation */
            --surface-4: rgba(90, 103, 123, 0.98); /* Ultra-high elevation (modals) */
            
            /* MODAL & CONNECTION STATUS SYSTEM */
            --modal-backdrop: rgba(13, 27, 42, 0.85);
            --modal-surface: var(--surface-3);
            --overlay-blur: blur(20px);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-highlight: rgba(255, 255, 255, 0.05);
            
            /* TYPOGRAPHY */
            --font-primary: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            --font-mono: 'IBM Plex Mono', 'SF Mono', Monaco, 'Cascadia Code', monospace;
            
            /* DARK MODE SHADOWS & BORDERS */
            --shadow-soft: 0 4px 20px rgba(0, 0, 0, 0.25);
            --shadow-medium: 0 8px 30px rgba(0, 0, 0, 0.4);
            --shadow-button: 0 2px 8px rgba(0, 0, 0, 0.3);
            --shadow-inset: inset 0 1px 0 rgba(255, 255, 255, 0.1);
            --glow-cyan: 0 0 20px rgba(0, 212, 255, 0.3);
            --glow-success: 0 0 20px rgba(0, 230, 118, 0.3);
            --border-radius: 6px;
            --border-radius-large: 12px;
            
            /* UI/UX INTERACTION SYSTEM */
            --button-min-height: 44px;
            --button-min-height-mobile: 48px;
            --button-margin: 16px;
            --dropdown-item-height: 40px;
            --table-row-height: 48px;
            --animation-fast: 150ms;
            --animation-standard: 200ms;
            --animation-slow: 300ms;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-primary);
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            background-attachment: fixed;
            min-height: 100vh;
            padding: 20px;
            color: var(--text-primary);
            font-size: 16px;
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Dark mode gradient overlay for depth */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 80%, rgba(0, 212, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(0, 230, 118, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        /* ===================================
           UI/UX INTERACTION CONSISTENCY SYSTEM
           =================================== */

        /* 1. BUTTON SYSTEM */
        .btn, button:not(.unstyled) {
            min-height: var(--button-min-height);
            padding: 12px 20px;
            border: none;
            border-radius: var(--border-radius);
            font-family: var(--font-primary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--animation-standard) ease;
            margin: 8px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
            position: relative;
            overflow: hidden;
            user-select: none;
            line-height: 1;
        }

        /* Button Variants */
        .btn-primary {
            background: var(--accent-cyan);
            color: var(--white);
        }

        .btn-secondary {
            background: var(--secondary);
            color: var(--white);
        }

        .btn-success {
            background: var(--accent-success);
            color: var(--white);
        }

        .btn-warning {
            background: var(--warning);
            color: var(--neutral-dark);
        }

        .btn-danger {
            background: var(--error);
            color: var(--white);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--accent-cyan);
            color: var(--accent-cyan);
        }

        .btn-ghost {
            background: transparent;
            color: var(--neutral-dark);
            border: 1px solid var(--border-light);
        }

        /* Button States - Hover */
        .btn:hover:not(:disabled), button:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: var(--shadow-button);
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--accent-cyan);
        }

        .btn-success:hover:not(:disabled) {
            background: var(--secondary);
        }

        .btn-warning:hover:not(:disabled) {
            background: var(--error);
            color: var(--white);
        }

        .btn-danger:hover:not(:disabled) {
            background: var(--warning);
            color: var(--neutral-dark);
        }

        .btn-outline:hover:not(:disabled) {
            background: var(--accent-cyan);
            color: var(--white);
        }

        .btn-ghost:hover:not(:disabled) {
            background: var(--neutral-light);
            border-color: var(--border-medium);
        }

        /* Button States - Active/Pressed */
        .btn:active:not(:disabled), button:active:not(:disabled) {
            transform: translateY(-1px) scale(0.98);
            transition: all var(--animation-fast) ease;
        }

        /* Button States - Disabled */
        .btn:disabled, button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        /* Button States - Loading */
        .btn.loading, button.loading {
            color: transparent;
            pointer-events: none;
        }

        .btn.loading::after, button.loading::after {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 16px;
            height: 16px;
            border: 2px solid currentColor;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* Button Sizes */
        .btn-small {
            min-height: 32px;
            padding: 6px 12px;
            font-size: 12px;
            margin: 4px;
        }

        .btn-large {
            min-height: 52px;
            padding: 16px 32px;
            font-size: 16px;
            font-weight: 600;
        }

        /* Mobile Button Adjustments */
        @media (max-width: 768px) {
            .btn, button:not(.unstyled) {
                min-height: var(--button-min-height-mobile);
                margin: var(--button-margin) 8px;
            }
        }

        /* 2. DROPDOWN SYSTEM */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-toggle {
            background: var(--white);
            border: 2px solid var(--border-light);
            border-radius: var(--border-radius);
            padding: 12px 16px;
            font-family: var(--font-primary);
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            min-width: 150px;
            transition: all var(--animation-standard) ease;
        }

        .dropdown-toggle:hover {
            border-color: var(--border-medium);
            box-shadow: var(--shadow-soft);
        }

        .dropdown-toggle:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 0 3px var(--cyan-focus);
        }

        .dropdown-toggle.open {
            border-color: var(--accent-cyan);
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }

        .dropdown-arrow {
            transition: transform var(--animation-standard) ease;
            font-size: 12px;
            color: var(--neutral-dark);
        }

        .dropdown-toggle.open .dropdown-arrow {
            transform: rotate(180deg);
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--white);
            border: 2px solid var(--accent-cyan);
            border-top: none;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            box-shadow: var(--shadow-medium);
            z-index: 1000;
            max-height: 320px;
            overflow-y: auto;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all var(--animation-standard) ease;
        }

        .dropdown-menu.open {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-menu.open-upward {
            top: auto;
            bottom: 100%;
            border: 2px solid var(--accent-cyan);
            border-bottom: none;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            transform: translateY(10px);
        }

        .dropdown-menu.open-upward.open {
            transform: translateY(0);
        }

        .dropdown-item {
            min-height: var(--dropdown-item-height);
            padding: 12px 16px;
            display: flex;
            align-items: center;
            cursor: pointer;
            color: var(--neutral-dark);
            font-size: 14px;
            border-bottom: 1px solid var(--border-light);
            transition: background-color var(--animation-fast) ease;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover, .dropdown-item.focused {
            background: var(--cyan-bg-light);
            color: var(--primary);
        }

        .dropdown-item.selected {
            background: var(--success-bg);
            color: var(--accent-success);
            font-weight: 500;
        }

        .dropdown-search {
            padding: 12px 16px;
            border: none;
            border-bottom: 2px solid var(--border-light);
            width: 100%;
            font-family: var(--font-primary);
            font-size: 14px;
            background: var(--neutral-light);
        }

        .dropdown-search:focus {
            outline: none;
            border-bottom-color: var(--accent-cyan);
            background: var(--white);
        }

        /* 3. FORM & INPUT SYSTEM */
        .form-group {
            margin-bottom: 24px;
            position: relative;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--neutral-dark);
            font-size: 14px;
        }

        .form-label.required::after {
            content: " *";
            color: var(--error);
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border-light);
            border-radius: var(--border-radius);
            font-family: var(--font-primary);
            font-size: 14px;
            background: var(--white);
            transition: all var(--animation-standard) ease;
            line-height: 1.4;
        }

        .form-input:hover, .form-textarea:hover, .form-select:hover {
            border-color: var(--border-medium);
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 0 3px var(--cyan-focus);
        }

        .form-input.error, .form-textarea.error, .form-select.error {
            border-color: var(--error);
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
        }

        .form-input.success, .form-textarea.success, .form-select.success {
            border-color: var(--accent-success);
            box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.1);
        }

        .form-feedback {
            margin-top: 6px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .form-feedback.error {
            color: var(--error);
        }

        .form-feedback.success {
            color: var(--accent-success);
        }

        .form-feedback.warning {
            color: var(--warning);
        }

        .form-input-short {
            max-width: 120px;
        }

        .form-input-medium {
            max-width: 200px;
        }

        /* 4. TABLE & LIST SYSTEM */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--white);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow-soft);
        }

        .data-table thead {
            background: var(--neutral-light);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table th {
            padding: 16px 20px;
            font-weight: 600;
            font-size: 14px;
            color: var(--primary);
            border-bottom: 2px solid var(--border-light);
        }

        .data-table th.text-left { text-align: left; }
        .data-table th.text-center { text-align: center; }
        .data-table th.text-right { text-align: right; }

        .data-table td {
            padding: 16px 20px;
            min-height: var(--table-row-height);
            border-bottom: 1px solid var(--border-light);
            vertical-align: middle;
        }

        .data-table td.text-left { text-align: left; }
        .data-table td.text-center { text-align: center; }
        .data-table td.text-right { text-align: right; }

        .data-table tbody tr {
            transition: background-color var(--animation-fast) ease;
            cursor: pointer;
        }

        .data-table tbody tr:hover {
            background: var(--cyan-bg);
        }

        .data-table tbody tr.selected {
            background: var(--success-bg-light);
        }

        .data-list {
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-soft);
            overflow: hidden;
        }

        .data-list-item {
            min-height: var(--table-row-height);
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            transition: background-color var(--animation-fast) ease;
            cursor: pointer;
        }

        .data-list-item:last-child {
            border-bottom: none;
        }

        .data-list-item:hover {
            background: var(--cyan-bg);
        }

        .data-list-item.selected {
            background: var(--success-bg-light);
        }

        /* 5. MODAL & OVERLAY SYSTEM */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(13, 27, 42, 0.6);
            backdrop-filter: blur(2px);
            z-index: 9000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all var(--animation-standard) ease;
        }

        .modal-backdrop.open {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--white);
            border-radius: var(--border-radius-large);
            box-shadow: var(--shadow-medium);
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9) translateY(20px);
            transition: all var(--animation-standard) ease;
            position: relative;
        }

        .modal-backdrop.open .modal-content {
            transform: scale(1) translateY(0);
        }

        .modal-header {
            padding: 24px 32px 20px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--primary);
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--neutral-dark);
            cursor: pointer;
            padding: 4px;
            border-radius: var(--border-radius);
            transition: all var(--animation-fast) ease;
        }

        .modal-close:hover {
            background: var(--error-bg-light);
            color: var(--error);
        }

        .modal-body {
            padding: 24px 32px;
        }

        .modal-footer {
            padding: 20px 32px 24px;
            border-top: 1px solid var(--border-light);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* CONNECTION STATUS & API KEY MANAGEMENT */
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--surface-2);
            backdrop-filter: var(--overlay-blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            box-shadow: var(--shadow-soft);
            z-index: 1000;
            transition: all var(--animation-standard) ease;
        }

        .connection-status.connected {
            background: var(--success-bg);
            border-color: var(--accent-success);
            color: var(--accent-success);
        }

        .connection-status.disconnected {
            background: var(--error-bg);
            border-color: var(--error);
            color: var(--error);
        }

        .connection-status .status-icon {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }

        .connection-status .settings-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 16px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
            margin-left: 8px;
        }

        .connection-status .settings-btn:hover {
            background: var(--glass-highlight);
            color: var(--accent-cyan);
        }

        /* FIRST-TIME SETUP MODAL */
        .setup-modal .modal-content {
            max-width: 500px;
            background: var(--modal-surface);
            backdrop-filter: var(--overlay-blur);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
        }

        .setup-modal .modal-header {
            border-bottom: 1px solid var(--border-medium);
            background: linear-gradient(135deg, var(--glass-highlight), transparent);
        }

        .setup-modal .modal-title {
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .setup-welcome {
            text-align: center;
            margin-bottom: 24px;
        }

        .setup-welcome h3 {
            color: var(--accent-cyan);
            margin-bottom: 8px;
            font-size: 18px;
        }

        .setup-welcome p {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.5;
        }

        .api-key-setup {
            background: var(--surface-1);
            border: 1px solid var(--border-medium);
            border-radius: var(--border-radius);
            padding: 20px;
            margin: 20px 0;
        }

        .api-key-setup .input-group {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .api-key-setup input {
            flex: 1;
            background: var(--surface-2);
            border: 1px solid var(--border-medium);
            color: var(--text-primary);
            padding: 12px 16px;
            border-radius: var(--border-radius);
            font-family: var(--font-mono);
            font-size: 14px;
        }

        .api-key-setup input:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 0 3px var(--cyan-focus);
        }

        .api-key-setup .test-btn {
            background: var(--secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-medium);
            padding: 12px 20px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .api-key-setup .test-btn:hover {
            background: var(--accent-cyan);
            color: var(--primary);
            border-color: var(--accent-cyan);
        }

        .setup-status {
            padding: 12px;
            border-radius: var(--border-radius);
            margin-top: 12px;
            font-size: 14px;
            text-align: center;
        }

        .setup-status.success {
            background: var(--success-bg);
            color: var(--accent-success);
            border: 1px solid var(--accent-success);
        }

        .setup-status.error {
            background: var(--error-bg);
            color: var(--error);
            border: 1px solid var(--error);
        }

        .token-usage {
            background: var(--surface-1);
            border: 1px solid var(--border-medium);
            border-radius: var(--border-radius);
            padding: 16px;
            margin: 16px 0;
            text-align: center;
        }

        .token-usage .usage-label {
            color: var(--text-secondary);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .token-usage .usage-amount {
            color: var(--accent-cyan);
            font-size: 24px;
            font-weight: 700;
            font-family: var(--font-mono);
        }

        .token-usage.warning {
            border-color: var(--warning);
            background: var(--warning-bg);
        }

        .token-usage.warning .usage-amount {
            color: var(--warning);
        }

        /* SIDEBAR NAVIGATION SYSTEM */
        .menu-button {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 44px;
            height: 44px;
            background: var(--surface-2);
            backdrop-filter: var(--overlay-blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            color: var(--text-primary);
            box-shadow: var(--shadow-soft);
            z-index: 1001;
            transition: all var(--animation-standard) ease;
        }

        .menu-button:hover {
            background: var(--accent-cyan);
            color: var(--primary);
            border-color: var(--accent-cyan);
            transform: scale(1.05);
        }

        .sidebar {
            position: fixed;
            top: 0;
            left: -300px;
            width: 300px;
            height: 100vh;
            background: var(--surface-2);
            backdrop-filter: var(--overlay-blur);
            border-right: 1px solid var(--glass-border);
            z-index: 1000;
            transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto;
        }

        .sidebar.open {
            left: 0;
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: var(--modal-backdrop);
            backdrop-filter: var(--overlay-blur);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .sidebar-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        .sidebar-header {
            padding: 24px;
            border-bottom: 1px solid var(--border-medium);
            background: linear-gradient(135deg, var(--glass-highlight), transparent);
        }

        .sidebar-header h3 {
            color: var(--text-primary);
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sidebar-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .sidebar-close:hover {
            background: var(--error-bg);
            color: var(--error);
        }

        .sidebar-nav {
            padding: 20px 0;
        }

        .sidebar-nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 24px;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-family: var(--font-primary);
            font-size: 14px;
        }

        .sidebar-nav-item:hover {
            background: var(--glass-highlight);
            color: var(--accent-cyan);
        }

        .sidebar-nav-item .icon {
            font-size: 16px;
            width: 20px;
            text-align: center;
        }

        .sidebar-divider {
            height: 1px;
            background: var(--border-light);
            margin: 16px 24px;
        }

        /* Sidebar API Configuration Styles */
        .sidebar-api-section {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-light);
            background: var(--bg-subtle);
        }

        .sidebar-section-title {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .sidebar-connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            padding: 8px 12px;
            border-radius: var(--border-radius);
            background: var(--surface-1);
            border: 1px solid var(--border-light);
        }

        .sidebar-connection-status .status-icon {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--neutral-medium);
            animation: pulse 2s infinite;
        }

        .sidebar-connection-status.connected .status-icon {
            background: var(--accent-success);
            animation: none;
        }

        .sidebar-connection-status.disconnected .status-icon {
            background: var(--error);
            animation: pulse 1.5s infinite;
        }

        .sidebar-api-form {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .sidebar-api-input {
            padding: 10px 12px;
            border: 1px solid var(--border-medium);
            border-radius: var(--border-radius);
            background: var(--surface-1);
            color: var(--text-primary);
            font-size: 13px;
            font-family: var(--font-mono);
            transition: all 0.2s ease;
        }

        .sidebar-api-input:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 0 3px var(--cyan-focus);
        }

        .sidebar-api-buttons {
            display: flex;
            gap: 6px;
        }

        .sidebar-btn-small {
            padding: 8px 14px;
            font-size: 12px;
            font-weight: 500;
            border-radius: var(--border-radius);
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            flex: 1;
        }

        .sidebar-btn-small.btn-primary {
            background: var(--accent-cyan);
            color: var(--primary);
        }

        .sidebar-btn-small.btn-primary:hover {
            background: var(--accent-success);
            transform: translateY(-1px);
        }

        .sidebar-btn-small.btn-secondary {
            background: var(--neutral-medium);
            color: var(--text-secondary);
        }

        .sidebar-btn-small.btn-secondary:hover {
            background: var(--neutral-light);
        }

        .sidebar-btn-small.btn-danger {
            background: var(--error-bg);
            color: var(--error);
            border: 1px solid var(--error);
        }

        .sidebar-btn-small.btn-danger:hover {
            background: var(--error);
            color: var(--white);
        }

        .sidebar-status-message {
            padding: 8px;
            border-radius: var(--border-radius);
            font-size: 12px;
            text-align: center;
        }

        .sidebar-status-message.success {
            background: var(--success-bg);
            color: var(--accent-success);
            border: 1px solid var(--accent-success);
        }

        .sidebar-status-message.error {
            background: var(--error-bg);
            color: var(--error);
            border: 1px solid var(--error);
        }

        .sidebar-status-message.info {
            background: var(--cyan-bg);
            color: var(--accent-cyan);
            border: 1px solid var(--accent-cyan);
        }

        .sidebar-api-help {
            text-align: center;
            padding-top: 8px;
        }

        .sidebar-api-help a {
            color: var(--accent-cyan);
            text-decoration: none;
            transition: color 0.2s ease;
        }

        .sidebar-api-help a:hover {
            color: var(--accent-success);
            text-decoration: underline;
        }

        .sidebar-api-connected {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .api-key-display,
        .token-usage-display {
            padding: 6px 10px;
            background: var(--surface-1);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-light);
            font-family: var(--font-mono);
        }

        .sidebar-icon {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }

        /* REMOVE SETTINGS SECTION COMPLETELY */
        #settingsSection {
            display: none !important;
        }

        /* PAGE VIEW SYSTEM */
        .page-view {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .page-view.active {
            display: block;
        }


        /* KPI CARDS */
        .kpi-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
            margin-bottom: 32px;
        }

        .kpi-card {
            background: var(--surface-2);
            border: 1px solid var(--border-medium);
            border-radius: var(--border-radius-large);
            padding: 24px;
            backdrop-filter: var(--overlay-blur);
            transition: all var(--animation-standard) ease;
            text-align: center;
        }

        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
            border-color: var(--accent-cyan);
        }

        .kpi-value {
            font-size: 36px;
            font-weight: 700;
            color: var(--accent-cyan);
            margin-bottom: 8px;
            font-family: var(--font-mono);
        }

        .kpi-label {
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .kpi-tooltip {
            color: var(--text-muted);
            cursor: help;
            font-size: 14px;
        }

        .kpi-description {
            color: var(--text-secondary);
            font-size: 12px;
            line-height: 1.4;
        }

        /* ADD VENDOR SECTION */
        .add-vendor-section {
            text-align: center;
            margin: 32px 0;
        }

        .add-vendor-btn {
            background: var(--accent-cyan);
            color: var(--primary);
            border: none;
            padding: 16px 32px;
            border-radius: var(--border-radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .add-vendor-btn:hover {
            background: var(--accent-success);
            transform: translateY(-1px);
        }

        /* VENDORS TABLE */
        .vendors-section {
            margin-top: 40px;
        }

        .vendors-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .vendors-title {
            color: var(--text-primary);
            font-size: 24px;
            font-weight: 600;
            margin: 0;
        }

        .vendors-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .add-vendor-btn {
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
        }

        .vendors-search {
            flex: 1;
            max-width: 300px;
            margin-left: 20px;
        }

        .vendors-table {
            background: var(--surface-2);
            border: 1px solid var(--border-medium);
            border-radius: var(--border-radius-large);
            overflow: hidden;
            backdrop-filter: var(--overlay-blur);
        }

        .vendors-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .vendors-table th {
            background: var(--surface-1);
            color: var(--text-primary);
            font-weight: 600;
            padding: 16px 20px;
            text-align: left;
            border-bottom: 1px solid var(--border-medium);
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .vendors-table th:hover {
            background: var(--glass-highlight);
        }

        .vendors-table th.sortable::after {
            content: " ↕";
            color: var(--text-muted);
            font-size: 12px;
        }

        .vendors-table th.sorted-asc::after {
            content: " ↑";
            color: var(--accent-cyan);
        }

        .vendors-table th.sorted-desc::after {
            content: " ↓";
            color: var(--accent-cyan);
        }

        .vendors-table td {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-light);
            color: var(--text-secondary);
        }

        .vendors-table tr:hover {
            background: var(--glass-highlight);
        }

        .vendor-name {
            color: var(--accent-cyan);
            cursor: pointer;
            font-weight: 500;
            text-decoration: none;
        }

        .vendor-name:hover {
            text-decoration: underline;
        }

        .empty-vendors {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-vendors-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-vendors h3 {
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        /* ADD VENDOR MODAL */
        .vendor-modal .modal-content {
            max-width: 600px;
            background: var(--modal-surface);
            backdrop-filter: var(--overlay-blur);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
        }

        .vendor-form-group {
            margin-bottom: 20px;
        }

        .vendor-form-group label {
            display: block;
            color: var(--text-primary);
            font-weight: 500;
            margin-bottom: 6px;
        }

        .vendor-form-group .required {
            color: var(--error);
        }

        .vendor-form-group input,
        .vendor-form-group textarea {
            width: 100%;
            background: var(--surface-2);
            border: 1px solid var(--border-medium);
            color: var(--text-primary);
            padding: 12px 16px;
            border-radius: var(--border-radius);
            font-family: var(--font-primary);
        }

        .vendor-form-group input:focus,
        .vendor-form-group textarea:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 0 3px var(--cyan-focus);
        }

        .file-upload-area {
            border: 2px dashed var(--border-medium);
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .file-upload-area:hover {
            border-color: var(--accent-cyan);
            background: var(--cyan-bg);
        }

        .file-upload-area.drag-over {
            border-color: var(--accent-cyan);
            background: var(--cyan-bg-light);
        }

        /* VENDOR CREATION NOTIFICATIONS */
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .notification-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .notification-icon {
            font-size: 18px;
        }

        .notification-message {
            font-weight: 500;
            line-height: 1.4;
        }

        /* VENDOR DETAILS PAGE */
        .vendor-details-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 32px;
        }

        .vendor-info-section,
        .contract-details-section,
        .invoice-history-section {
            background: var(--surface-2);
            border: 1px solid var(--border-medium);
            border-radius: var(--border-radius-large);
            overflow: hidden;
            backdrop-filter: var(--overlay-blur);
        }

        .vendor-info-section .section-header,
        .contract-details-section .section-header,
        .invoice-history-section .section-header {
            background: var(--surface-1);
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-medium);
        }

        .vendor-info-section .section-header h2,
        .contract-details-section .section-header h2,
        .invoice-history-section .section-header h2 {
            color: var(--text-primary);
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        .vendor-info-grid {
            padding: 24px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .vendor-info-item {
            background: var(--surface-1);
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius);
            padding: 16px;
        }

        .vendor-info-label {
            color: var(--text-muted);
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .vendor-info-value {
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
            word-break: break-word;
        }

        .ai-summary-section {
            background: linear-gradient(135deg, var(--cyan-bg-light), var(--surface-1));
            border: 2px solid var(--accent-cyan);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 24px;
            grid-column: 1 / -1;
        }

        .ai-summary-title {
            color: var(--accent-cyan);
            font-size: 18px;
            font-weight: 600;
            margin: 0 0 16px 0;
        }

        .ai-summary-item {
            margin-bottom: 16px;
        }

        .ai-summary-item:last-child {
            margin-bottom: 0;
        }

        .ai-summary-label {
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .ai-summary-text {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.6;
            background: var(--surface-2);
            padding: 12px;
            border-radius: var(--border-radius);
            border-left: 3px solid var(--accent-cyan);
        }

        .ai-summary-highlights,
        .ai-summary-risks {
            background: var(--surface-2);
            padding: 12px;
            border-radius: var(--border-radius);
            border-left: 3px solid var(--accent-cyan);
        }

        .highlight-item,
        .risk-item {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 6px;
        }

        .highlight-item:last-child,
        .risk-item:last-child {
            margin-bottom: 0;
        }

        .risk-item {
            color: var(--warning);
        }

        .contract-info {
            padding: 24px;
        }

        .contract-file-info {
            background: var(--surface-1);
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
        }

        .contract-file-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .contract-file-icon {
            font-size: 24px;
            color: var(--accent-cyan);
        }

        .contract-file-name {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 16px;
        }

        .clickable-file {
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .clickable-file:hover {
            color: var(--accent-cyan);
            text-decoration: underline;
        }

        .contract-file-date {
            color: var(--text-muted);
            font-size: 14px;
        }

        .contract-terms-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
        }

        .contract-term-item {
            background: var(--surface-1);
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius);
            padding: 16px;
        }

        .invoice-history-grid {
            padding: 24px;
        }

        .invoice-item {
            background: var(--surface-1);
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 16px;
        }

        .invoice-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .invoice-name {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 4px;
        }

        .invoice-date {
            color: var(--text-muted);
            font-size: 14px;
        }

        .invoice-status {
            padding: 6px 12px;
            border-radius: var(--border-radius);
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .invoice-status.approved {
            background: var(--success-bg);
            color: var(--success);
        }

        .invoice-status.flagged {
            background: var(--warning-bg);
            color: var(--warning);
        }

        .invoice-status.error {
            background: var(--error-bg);
            color: var(--error);
        }

        .invoice-findings {
            margin-top: 12px;
        }

        .invoice-findings-title {
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .invoice-findings-list {
            color: var(--text-muted);
            font-size: 14px;
            line-height: 1.5;
        }

        .empty-invoice-history {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        .empty-invoice-history-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .invoice-files-section {
            margin-bottom: 8px;
        }

        .invoice-file-link {
            display: inline-block;
            margin-right: 12px;
            margin-bottom: 4px;
            padding: 4px 8px;
            background: var(--surface-2);
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius);
            font-size: 14px;
        }

        .invoice-file-link:hover {
            background: var(--cyan-bg-light);
            border-color: var(--accent-cyan);
        }

        /* VENDOR ACTIONS */
        .vendor-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .btn-icon {
            background: none;
            border: none;
            cursor: pointer;
            padding: 6px;
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-icon:hover {
            background: var(--surface-2);
        }

        .btn-icon.btn-danger:hover {
            background: var(--error-bg);
            color: var(--error);
        }

        /* DISABLED VENDORS SECTION */
        .disabled-vendors-section {
            margin-top: 32px;
        }

        .disabled-vendors-header {
            background: var(--surface-2);
            border: 1px solid var(--border-medium);
            border-radius: var(--border-radius);
            padding: 16px 20px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .disabled-vendors-header:hover {
            background: var(--glass-highlight);
        }

        .disabled-vendors-title {
            color: var(--text-muted);
            font-size: 18px;
            font-weight: 600;
            margin: 0 0 4px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .disabled-vendors-title span:first-child {
            transition: transform 0.2s ease;
            color: var(--text-muted);
            font-size: 14px;
        }

        .disabled-vendors-title.expanded span:first-child {
            transform: rotate(90deg);
        }

        .disabled-vendors-count {
            color: var(--text-muted);
            font-weight: normal;
            font-size: 16px;
        }

        .disabled-vendors-description {
            color: var(--text-muted);
            font-size: 14px;
            font-style: italic;
        }

        .disabled-vendors-content {
            margin-top: 16px;
        }

        .disabled-table {
            opacity: 0.7;
        }

        .disabled-table table {
            background: var(--surface-1);
        }

        .disabled-table th {
            background: var(--surface-2);
            color: var(--text-muted);
        }

        .disabled-table td {
            color: var(--text-muted);
        }

        .disabled-table .vendor-name {
            color: var(--text-muted);
        }

        .disabled-table .vendor-name:hover {
            color: var(--text-secondary);
        }

        /* AI PROCESSING VISUALIZATION */
        .ai-processing-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .ai-processing-header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
        }

        .back-to-dashboard-btn {
            position: absolute;
            top: 0;
            left: 0;
            background: var(--surface-2);
            border: 1px solid var(--border-medium);
            color: var(--text-primary);
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .back-to-dashboard-btn:hover {
            background: var(--surface-3);
            border-color: var(--accent-cyan);
            transform: translateX(-2px);
        }

        .processing-header {
            position: relative;
            margin-bottom: 40px;
        }

        .processing-content {
            text-align: center;
        }

        .results-title-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .processing-steps {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-bottom: 40px;
            padding: 20px;
        }

        .step-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            opacity: 0.5;
            transition: all 0.3s ease;
        }

        .step-indicator.active {
            opacity: 1;
            transform: scale(1.1);
        }

        .step-indicator.completed {
            opacity: 1;
        }

        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--surface-2);
            border: 2px solid var(--border-medium);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--text-secondary);
            transition: all 0.3s ease;
        }

        .step-indicator.active .step-circle {
            background: var(--accent-cyan);
            border-color: var(--accent-cyan);
            color: var(--black);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.4);
        }

        .step-indicator.completed .step-circle {
            background: var(--accent-success);
            border-color: var(--accent-success);
            color: var(--white);
        }

        .step-indicator.completed .step-circle::after {
            content: '✓';
        }

        .step-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            text-align: center;
            transition: color 0.3s ease;
        }

        .step-indicator.active .step-label {
            color: var(--accent-cyan);
            font-weight: 600;
        }

        .step-indicator.completed .step-label {
            color: var(--accent-success);
        }

        .ai-progress-container {
            margin-top: 20px;
            padding: 15px;
            background: var(--surface-1);
            border-radius: 8px;
        }

        .ai-progress-bar {
            width: 100%;
            height: 6px;
            background: var(--surface-3);
            border-radius: 3px;
            overflow: hidden;
        }

        .ai-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-cyan), var(--accent-success));
            width: 0%;
            transition: width 0.5s ease;
        }

        /* Neural Network Background */
        .neural-background {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            opacity: 0.1;
            z-index: 0;
        }

        .neural-node {
            position: absolute;
            width: 8px;
            height: 8px;
            background: var(--accent-cyan);
            border-radius: 50%;
            animation: neuralPulse 3s ease-in-out infinite;
        }

        .neural-node:nth-child(1) { top: 20%; left: 15%; animation-delay: 0s; }
        .neural-node:nth-child(2) { top: 60%; left: 25%; animation-delay: 0.5s; }
        .neural-node:nth-child(3) { top: 30%; right: 20%; animation-delay: 1s; }
        .neural-node:nth-child(4) { bottom: 25%; right: 15%; animation-delay: 1.5s; }

        .neural-connection {
            position: absolute;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--accent-cyan), transparent);
            animation: neuralFlow 4s ease-in-out infinite;
        }

        .neural-connection:nth-child(5) {
            top: 25%;
            left: 15%;
            width: 200px;
            transform: rotate(20deg);
            animation-delay: 0s;
        }

        .neural-connection:nth-child(6) {
            top: 45%;
            left: 25%;
            width: 300px;
            transform: rotate(-15deg);
            animation-delay: 1s;
        }

        .neural-connection:nth-child(7) {
            bottom: 30%;
            right: 20%;
            width: 150px;
            transform: rotate(45deg);
            animation-delay: 2s;
        }

        @keyframes neuralPulse {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.5); }
        }

        @keyframes neuralFlow {
            0% { opacity: 0; }
            20% { opacity: 0.6; }
            80% { opacity: 0.6; }
            100% { opacity: 0; }
        }

        /* Document Analysis Panels */
        .document-analysis-panels {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
            position: relative;
            z-index: 1;
        }

        @media (max-width: 768px) {
            .document-analysis-panels {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }

        .document-panel {
            background: var(--surface-1);
            border: 1px solid var(--border-medium);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        .document-panel-header {
            background: var(--surface-2);
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-medium);
        }

        .document-panel-header h3 {
            margin: 0 0 5px 0;
            color: var(--text-primary);
            font-size: 1.1rem;
        }

        .document-name {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-style: italic;
        }

        .document-content-container {
            position: relative;
            height: 400px;
            overflow: hidden;
        }

        .document-content {
            padding: 20px;
            font-size: 0.85rem;
            line-height: 1.6;
            color: var(--text-primary);
            height: 100%;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.95);
        }

        .document-content p {
            margin-bottom: 12px;
            position: relative;
        }

        .document-content .highlight {
            background: linear-gradient(120deg, transparent 0%, rgba(0, 255, 255, 0.3) 10%, rgba(0, 255, 255, 0.3) 90%, transparent 100%);
            padding: 2px 4px;
            border-radius: 3px;
            animation: highlightGlow 0.8s ease forwards;
        }

        @keyframes highlightGlow {
            0% { background: transparent; }
            50% { background: rgba(0, 255, 255, 0.4); box-shadow: 0 0 10px rgba(0, 255, 255, 0.3); }
            100% { background: rgba(0, 255, 255, 0.2); }
        }

        /* Scanning Effect */
        .scanning-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 10;
        }

        .scan-line {
            position: absolute;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, 
                transparent 0%,
                rgba(0, 255, 255, 0.4) 20%,
                rgba(0, 255, 255, 0.8) 50%,
                rgba(0, 255, 255, 0.4) 80%,
                transparent 100%);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.6);
            animation: scanning 6s linear infinite;
            opacity: 0;
        }

        .scan-line.active {
            opacity: 1;
        }

        @keyframes scanning {
            0% { top: -3px; opacity: 0; }
            5% { opacity: 1; }
            95% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }

        /* Floating Tags */
        .floating-tags-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 15;
        }

        .floating-tag {
            position: absolute;
            background: var(--accent-success);
            color: var(--white);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
            white-space: nowrap;
            animation: floatTag 3s ease forwards;
            opacity: 0;
            transform: scale(0.8);
        }

        @keyframes floatTag {
            0% { opacity: 0; transform: scale(0.8) translateY(10px); }
            20% { opacity: 1; transform: scale(1) translateY(0); }
            80% { opacity: 1; transform: scale(1) translateY(-5px); }
            100% { opacity: 0; transform: scale(0.9) translateY(-15px); }
        }

        .floating-tag.amount { background: var(--accent-warning); }
        .floating-tag.date { background: var(--accent-cyan); }
        .floating-tag.vendor { background: var(--accent-success); }
        .floating-tag.clause { background: var(--accent-info); }

        /* Analysis Results */
        .analysis-results-summary {
            background: var(--surface-1);
            border: 1px solid var(--border-medium);
            border-radius: 12px;
            padding: 25px;
            margin-top: 30px;
            animation: fadeInUp 0.5s ease;
        }

        .results-header h3 {
            color: var(--accent-success);
            margin: 0 0 10px 0;
        }

        .key-findings {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .finding-item {
            background: var(--surface-2);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--accent-cyan);
        }

        .finding-label {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .finding-value {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .reconciliation-summary {
            background: var(--surface-2);
            border-left: 4px solid var(--accent-info);
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
        }

        .reconciliation-summary-text {
            font-size: 0.95rem;
            line-height: 1.5;
            color: var(--text-primary);
            font-weight: 500;
        }

        .invoice-status.compliant {
            background: var(--accent-success);
            color: var(--white);
        }

        .invoice-status.attention_required {
            background: var(--accent-warning);
            color: var(--white);
        }

        .modal-close-btn {
            background: var(--accent-cyan);
            color: var(--white);
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .modal-close-btn:hover {
            background: var(--accent-success);
            transform: translateY(-2px);
        }

        .ai-processing-header h1 {
            color: var(--text-primary);
            font-size: 32px;
            margin-bottom: 12px;
            animation: fadeInDown 0.8s ease;
        }

        .ai-processing-subtitle {
            color: var(--text-secondary);
            font-size: 18px;
        }

        .ai-processing-content {
            display: grid;
            gap: 32px;
        }

        .ai-document-section {
            animation: slideInUp 0.8s ease;
        }

        .document-preview {
            background: var(--surface-2);
            border: 1px solid var(--border-medium);
            border-radius: var(--border-radius-large);
            overflow: hidden;
            backdrop-filter: var(--overlay-blur);
            min-height: 350px;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .document-pages {
            position: relative;
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .document-page {
            position: absolute;
            width: calc(100% - 40px);
            height: calc(100% - 40px);
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            transform-origin: center;
            transition: transform 0.5s ease;
            color: #333;
        }

        .document-page:nth-child(1) {
            z-index: 3;
            background: rgba(255, 255, 255, 0.95);
        }

        .document-page:nth-child(2) {
            z-index: 2;
            background: rgba(255, 255, 255, 0.8);
            transform: translateY(5px) scale(0.98);
        }

        .document-page:nth-child(3) {
            z-index: 1;
            background: rgba(255, 255, 255, 0.6);
            transform: translateY(10px) scale(0.96);
        }

        .document-page.flipping {
            animation: pageFlip 1.5s ease-in-out forwards;
        }

        @keyframes pageFlip {
            0% {
                transform: rotateY(0deg) translateY(0px) scale(1);
                z-index: 3;
            }
            25% {
                transform: rotateY(-45deg) translateY(-10px) scale(1.02);
            }
            50% {
                transform: rotateY(-90deg) translateY(-20px) scale(0.9);
                opacity: 0.7;
            }
            75% {
                transform: rotateY(-135deg) translateY(-10px) scale(0.8);
                opacity: 0.3;
            }
            100% {
                transform: rotateY(-180deg) translateY(0px) scale(0.7);
                opacity: 0;
                z-index: 0;
            }
        }

        .document-header {
            background: var(--surface-1);
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid var(--border-medium);
        }

        .document-icon {
            font-size: 24px;
        }

        .document-header h3 {
            color: var(--text-primary);
            font-size: 18px;
            font-weight: 600;
            margin: 0;
            flex: 1;
        }

        .analysis-status {
            padding: 6px 12px;
            background: var(--cyan-bg);
            color: var(--accent-cyan);
            border-radius: var(--border-radius);
            font-size: 14px;
            font-weight: 500;
            animation: pulse 1.5s infinite;
        }

        .document-visual {
            padding: 24px;
            position: relative;
            min-height: 300px;
        }

        .document-page {
            background: var(--white);
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius);
            padding: 24px;
            min-height: 250px;
            position: relative;
            overflow: hidden;
        }

        .document-title {
            color: var(--primary);
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .document-content {
            color: var(--text-secondary);
            line-height: 1.8;
            position: relative;
        }

        .highlighted-term {
            background: linear-gradient(120deg, transparent 0%, var(--yellow-bg) 10%, var(--yellow-bg) 90%, transparent 100%);
            color: var(--text-primary);
            font-weight: 500;
            padding: 2px 6px;
            border-radius: 4px;
            display: inline-block;
            animation: highlightPulse 2s ease-in-out;
            position: relative;
        }

        @keyframes highlightPulse {
            0% { background-color: transparent; transform: scale(1); }
            50% { background-color: var(--yellow-bg); transform: scale(1.05); }
            100% { background-color: var(--yellow-bg); transform: scale(1); }
        }

        .extracted-terms {
            position: absolute;
            top: 20px;
            right: -200px;
            width: 180px;
        }

        .floating-term {
            background: var(--accent-cyan);
            color: var(--white);
            padding: 8px 12px;
            border-radius: var(--border-radius);
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
            box-shadow: var(--shadow-medium);
            animation: floatIn 0.8s ease forwards, float 3s ease-in-out infinite;
            opacity: 0;
            transform: translateX(20px);
        }

        @keyframes floatIn {
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .document-preview.scanning::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, 
                transparent 0%, 
                var(--accent-cyan) 20%, 
                rgba(0, 255, 255, 0.8) 50%, 
                var(--accent-cyan) 80%, 
                transparent 100%);
            animation: scan 3s ease-in-out infinite;
            z-index: 15;
            box-shadow: 0 0 20px var(--accent-cyan);
        }

        .document-preview.scanning::after {
            content: 'AI Reading...';
            position: absolute;
            top: 10px;
            right: 15px;
            background: rgba(0, 255, 255, 0.1);
            color: var(--accent-cyan);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            border: 1px solid var(--accent-cyan);
            z-index: 15;
            animation: aiReading 2s ease-in-out infinite;
        }

        @keyframes scan {
            0% { 
                transform: translateY(0); 
                opacity: 0; 
                width: 100%;
            }
            10% { 
                opacity: 1; 
                width: 100%;
            }
            90% { 
                opacity: 1; 
                width: 100%;
            }
            100% { 
                transform: translateY(calc(100% + 300px)); 
                opacity: 0; 
                width: 20%;
            }
        }

        @keyframes aiReading {
            0%, 100% { 
                opacity: 0.7; 
                transform: scale(1);
            }
            50% { 
                opacity: 1; 
                transform: scale(1.05);
                box-shadow: 0 0 15px rgba(0, 255, 255, 0.4);
            }
        }

        .ai-scanning-beam {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 12;
        }

        .scanning-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, 
                transparent, 
                var(--accent-success) 30%, 
                #00ff00 50%, 
                var(--accent-success) 70%, 
                transparent);
            animation: scanVertical 4s ease-in-out infinite;
            box-shadow: 0 0 10px #00ff00;
        }

        .scanning-line:nth-child(2) {
            animation-delay: 1s;
            background: linear-gradient(90deg, 
                transparent, 
                var(--accent-warning) 30%, 
                #ffaa00 50%, 
                var(--accent-warning) 70%, 
                transparent);
            box-shadow: 0 0 10px #ffaa00;
        }

        .scanning-line:nth-child(3) {
            animation-delay: 2s;
            background: linear-gradient(90deg, 
                transparent, 
                var(--accent-cyan) 30%, 
                #00ffff 50%, 
                var(--accent-cyan) 70%, 
                transparent);
            box-shadow: 0 0 10px #00ffff;
        }

        @keyframes scanVertical {
            0% { 
                top: 0; 
                opacity: 0; 
            }
            5% { 
                opacity: 1; 
            }
            95% { 
                opacity: 1; 
            }
            100% { 
                top: 100%; 
                opacity: 0; 
            }
        }

        .ai-processing-container.comparing {
            position: relative;
        }

        .ai-processing-container.comparing::before {
            content: '⚡ Comparing Documents...';
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 255, 255, 0.1);
            border: 2px solid var(--accent-cyan);
            padding: 20px 40px;
            border-radius: 15px;
            color: var(--accent-cyan);
            font-size: 1.2rem;
            font-weight: 600;
            z-index: 1000;
            animation: pulseGlow 1s ease-in-out infinite alternate;
        }

        @keyframes pulseGlow {
            0% { box-shadow: 0 0 20px rgba(0, 255, 255, 0.3); }
            100% { box-shadow: 0 0 40px rgba(0, 255, 255, 0.6); }
        }

        .completion-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            animation: fadeIn 0.3s ease;
        }

        .completion-modal {
            background: var(--surface-1);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            border: 2px solid var(--accent-cyan);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.5s ease;
        }

        .completion-modal-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .completion-icon {
            font-size: 4rem;
            animation: bounce 1s ease infinite;
        }

        .completion-modal h3 {
            color: var(--accent-cyan);
            margin: 0;
            font-size: 1.5rem;
        }

        .completion-modal p {
            color: var(--text-primary);
            margin: 0;
            font-size: 1.1rem;
        }

        .completion-progress {
            width: 100%;
            height: 6px;
            background: var(--surface-3);
            border-radius: 3px;
            overflow: hidden;
            margin: 20px 0;
        }

        .completion-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-cyan), var(--accent-success));
            width: 0%;
            transition: width 3.5s ease-in-out;
        }

        .completion-status {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-style: italic;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(-50px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .analysis-insights {
            padding: 20px 24px;
            background: var(--surface-1);
            border-top: 1px solid var(--border-light);
        }

        .insight-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 0;
            color: var(--text-secondary);
            font-size: 14px;
            animation: fadeIn 0.5s ease;
        }

        .insight-icon {
            font-size: 18px;
        }

        /* Reconciliation Section */
        .ai-reconciliation-section {
            margin-top: 20px;
            animation: slideInUp 0.8s ease;
        }

        .reconciliation-visual {
            background: var(--surface-2);
            border: 1px solid var(--border-medium);
            border-radius: var(--border-radius-large);
            padding: 24px;
        }

        .reconciliation-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }

        .reconciliation-header h3 {
            color: var(--text-primary);
            font-size: 20px;
            font-weight: 600;
            margin: 0;
        }

        .comparison-flow {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 24px;
            align-items: center;
            margin-bottom: 24px;
        }

        .comparison-item {
            background: var(--surface-1);
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius);
            padding: 20px;
        }

        .comparison-item h4 {
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 600;
            margin: 0 0 12px 0;
        }

        .contract-side {
            border-left: 3px solid var(--accent-cyan);
        }

        .invoice-side {
            border-left: 3px solid var(--success);
        }

        .comparison-arrow {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pulse-animation {
            font-size: 32px;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
        }

        /* Progress Section */
        .ai-progress-section {
            margin-top: 40px;
        }

        .progress-container {
            background: var(--surface-1);
            border-radius: var(--border-radius);
            height: 8px;
            overflow: hidden;
            margin-bottom: 24px;
        }

        .progress-bar {
            background: linear-gradient(90deg, var(--accent-cyan), var(--primary));
            height: 100%;
            width: 0%;
            transition: width 0.5s ease;
            border-radius: var(--border-radius);
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
        }

        .progress-step {
            text-align: center;
            opacity: 0.5;
            transition: opacity 0.3s ease;
        }

        .progress-step.active {
            opacity: 1;
        }

        .progress-step.completed {
            opacity: 1;
        }

        .progress-step.completed .step-icon {
            color: var(--success);
        }

        .step-icon {
            display: block;
            font-size: 24px;
            margin-bottom: 8px;
        }

        .step-label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Animations */
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .term-bubble {
            display: inline-block;
            background: var(--yellow-bg);
            color: var(--text-primary);
            padding: 4px 8px;
            border-radius: 12px;
            margin: 2px;
            font-size: 13px;
            font-weight: 500;
            animation: bubblePop 0.5s ease;
        }

        @keyframes bubblePop {
            0% { transform: scale(0); }
            80% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* MOBILE RESPONSIVE */
        @media (max-width: 768px) {
            .kpi-container {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .vendors-header {
                flex-direction: column;
                gap: 16px;
                align-items: stretch;
            }

            .vendors-actions {
                flex-direction: column-reverse;
                gap: 12px;
            }

            .vendors-search {
                margin-left: 0;
                max-width: none;
            }

            .vendors-table {
                overflow-x: auto;
            }

            .vendor-creation-notification {
                top: 80px !important;
                right: 10px !important;
                max-width: calc(100vw - 20px) !important;
            }

            .vendor-info-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .contract-terms-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .invoice-header {
                flex-direction: column;
                gap: 12px;
                align-items: flex-start;
            }

            .vendor-details-content {
                gap: 24px;
            }
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .breadcrumb-item {
            color: var(--neutral-dark);
            text-decoration: none;
            transition: color var(--animation-fast) ease;
        }

        .breadcrumb-item:hover:not(.current) {
            color: var(--accent-cyan);
        }

        .breadcrumb-item.current {
            color: var(--primary);
            font-weight: 500;
        }

        .breadcrumb-separator {
            color: var(--border-medium);
        }

        /* 7. FEEDBACK & STATE SYSTEM */
        .alert {
            padding: 16px 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            border-left: 4px solid;
            animation: slideInDown var(--animation-standard) ease;
        }

        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .alert.success {
            background: var(--success-bg);
            color: var(--accent-success);
            border-left-color: var(--accent-success);
        }

        .alert.error {
            background: var(--error-bg-light);
            color: var(--error);
            border-left-color: var(--error);
        }

        .alert.warning {
            background: var(--warning-bg);
            color: var(--warning);
            border-left-color: var(--warning);
        }

        .alert.info {
            background: var(--cyan-bg-light);
            color: var(--accent-cyan);
            border-left-color: var(--accent-cyan);
        }

        .alert-icon {
            font-size: 18px;
            margin-top: 1px;
        }

        .alert-content {
            flex: 1;
        }

        .alert-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .alert-dismiss {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity var(--animation-fast) ease;
        }

        .alert-dismiss:hover {
            opacity: 1;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
            animation: slideInRight var(--animation-standard) ease;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .skeleton {
            background: linear-gradient(90deg, var(--neutral-light) 25%, var(--border-light) 50%, var(--neutral-light) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: var(--border-radius);
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .skeleton-text {
            height: 16px;
            margin-bottom: 8px;
        }

        .skeleton-text.large {
            height: 20px;
        }

        .skeleton-text.small {
            height: 12px;
        }

        .skeleton-button {
            height: var(--button-min-height);
            width: 120px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--neutral-dark);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--primary);
        }

        .empty-state-description {
            font-size: 14px;
            margin-bottom: 24px;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--surface-1);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius-large);
            padding: 40px;
            box-shadow: var(--shadow-medium);
            position: relative;
        }

        .container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--shadow-inset);
            border-radius: var(--border-radius-large) var(--border-radius-large) 0 0;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
        }


        h1 {
            color: var(--text-primary);
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 12px;
            letter-spacing: -0.02em;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 18px;
            margin-bottom: 24px;
            font-weight: 400;
        }

        .feature-badges {
            display: flex;
            justify-content: center;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .badge {
            background: var(--accent-success);
            color: var(--white);
            padding: 8px 16px;
            border-radius: var(--border-radius);
            font-size: 13px;
            font-weight: 500;
            font-family: var(--font-primary);
        }

        .section {
            margin-bottom: 32px;
            background: var(--surface-2);
            border-radius: var(--border-radius-large);
            padding: 32px;
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-soft);
            position: relative;
        }

        .section::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--shadow-inset);
            border-radius: var(--border-radius-large) var(--border-radius-large) 0 0;
        }

        .section.collapsed {
            background: var(--surface-1);
            border-color: var(--border-medium);
        }

        .section-header {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            cursor: pointer;
            margin-bottom: 24px;
            padding: 12px 20px;
            border-radius: var(--border-radius);
            transition: all var(--animation-standard) ease;
            background: transparent;
            border: 1px solid transparent;
        }

        .section-header:hover {
            background: var(--glass-highlight);
            border-color: var(--border-medium);
            transform: translateY(-1px);
            box-shadow: var(--shadow-soft);
        }

        .section-header h2 {
            color: var(--text-primary);
            font-size: 24px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 0;
            transition: color var(--animation-standard) ease;
        }

        .section-header:hover h2 {
            color: var(--accent-cyan);
        }

        .section-content {
            transition: all 0.3s ease;
        }

        .section.collapsed .section-content {
            display: none;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .setting-item {
            background: var(--surface-3);
            padding: 20px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-soft);
            position: relative;
        }

        .setting-item::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--shadow-inset);
            border-radius: var(--border-radius) var(--border-radius) 0 0;
        }

        .setting-item label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .setting-item input, .setting-item select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-strong);
            border-radius: var(--border-radius);
            font-size: 14px;
            font-family: var(--font-primary);
            background: var(--neutral-dark);
            color: var(--text-primary);
            transition: all 0.2s ease;
        }

        .setting-item input:focus, .setting-item select:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 0 3px var(--cyan-focus);
        }

        .api-key-input-group {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .api-key-input {
            flex: 1;
            padding: 16px;
            border: 2px solid var(--border-strong);
            border-radius: var(--border-radius);
            font-size: 16px;
            font-family: var(--font-mono);
            background: var(--white);
            transition: border-color 0.2s ease;
        }

        .api-key-input:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 0 3px var(--cyan-focus);
        }

        .save-key-btn {
            /* Use new button system - inherits from .btn-primary */
        }

        .api-status {
            padding: 16px;
            border-radius: var(--border-radius);
            margin-top: 16px;
            text-align: center;
            font-size: 14px;
            font-weight: 500;
            border-left: 4px solid;
        }

        .api-status.success {
            background: var(--success-bg);
            color: var(--accent-success);
            border-left-color: var(--accent-success);
        }

        .api-status.error {
            background: var(--error-bg-light);
            color: var(--error);
            border-left-color: var(--error);
        }

        .upload-area {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .upload-box {
            border: 2px dashed var(--border-dashed);
            border-radius: var(--border-radius-large);
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            background: var(--surface-2);
            backdrop-filter: blur(10px);
        }

        .upload-box::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--shadow-inset);
            border-radius: var(--border-radius-large) var(--border-radius-large) 0 0;
        }

        .upload-box:hover {
            border-color: var(--accent-cyan);
            background: var(--cyan-bg);
            box-shadow: var(--glow-cyan);
        }

        .upload-box.drag-over {
            border-color: var(--accent-cyan);
            background: var(--cyan-bg-light);
            transform: scale(1.01);
            box-shadow: var(--glow-cyan), var(--shadow-medium);
        }

        .upload-box.has-files {
            border-color: var(--accent-success);
            background: var(--success-bg-light);
            border-style: solid;
            box-shadow: var(--glow-success);
        }

        .multi-upload-box {
            min-height: 300px;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.7;
        }

        .upload-box h3 {
            color: var(--text-primary);
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .upload-box p {
            color: var(--text-secondary);
            font-size: 14px;
            opacity: 0.9;
        }

        .file-list {
            margin-top: 20px;
            text-align: left;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--surface-3);
            border-radius: var(--border-radius);
            margin-bottom: 8px;
            border: 1px solid var(--border-light);
            position: relative;
        }

        .file-item::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--shadow-inset);
            border-radius: var(--border-radius) var(--border-radius) 0 0;
        }

        .file-item .file-name {
            flex: 1;
            color: var(--text-primary);
            font-size: 14px;
            font-family: var(--font-mono);
        }

        .file-item .remove-btn {
            background: var(--error);
            color: var(--white);
            border: none;
            padding: 6px 12px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .file-item .remove-btn:hover {
            background: var(--warning);
            transform: translateY(-1px);
        }

        input[type="file"] {
            display: none;
        }

        .process-btn {
            /* Use new button system - inherits from .btn-primary .btn-large */
            display: block;
            margin: 0 auto;
            letter-spacing: 0.01em;
        }

        .processing-section {
            text-align: center;
            padding: 60px 0;
        }

        .processing-section h2 {
            color: var(--text-primary);
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 16px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .processing-section p {
            color: var(--text-secondary);
            font-size: 16px;
            margin-bottom: 32px;
        }

        .processing-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-top: 32px;
        }

        .processing-item {
            background: var(--surface-2);
            border-radius: var(--border-radius-large);
            padding: 24px;
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-soft);
            position: relative;
        }

        .processing-item::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--shadow-inset);
            border-radius: var(--border-radius-large) var(--border-radius-large) 0 0;
        }

        .processing-item h4 {
            margin-bottom: 16px;
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 600;
            font-family: var(--font-mono);
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--neutral-dark);
            border-radius: 3px;
            overflow: hidden;
            margin: 16px 0;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-cyan), var(--accent-success));
            transition: width 0.3s ease;
            border-radius: 3px;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--neutral-dark);
            border-top: 3px solid var(--accent-cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 24px;
            box-shadow: var(--glow-cyan);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        .results-section {
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .results-header h2 {
            color: var(--text-primary);
            font-size: 24px;
            font-weight: 600;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .export-controls {
            display: flex;
            gap: 12px;
        }

        .export-btn {
            /* Use new button system - inherits from .btn-secondary */
        }

        .batch-summary {
            background: linear-gradient(135deg, var(--surface-2) 0%, var(--secondary-bg-light) 100%);
            border-radius: var(--border-radius-large);
            padding: 32px;
            margin-bottom: 32px;
            border: 1px solid var(--border-light);
            position: relative;
            backdrop-filter: blur(10px);
        }

        .batch-summary::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--shadow-inset);
            border-radius: var(--border-radius-large) var(--border-radius-large) 0 0;
        }

        .batch-summary h3 {
            color: var(--text-primary);
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: var(--surface-3);
            padding: 24px;
            border-radius: var(--border-radius);
            text-align: center;
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-soft);
            position: relative;
            backdrop-filter: blur(5px);
        }

        .stat-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--shadow-inset);
            border-radius: var(--border-radius) var(--border-radius) 0 0;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
            font-family: var(--font-mono);
        }

        .stat-value.passed { color: var(--accent-success); }
        .stat-value.failed { color: var(--error); }
        .stat-value.warning { color: var(--warning); }

        .stat-label {
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
        }

        .invoice-results {
            display: grid;
            gap: 24px;
        }

        .invoice-result-card {
            background: var(--surface-2);
            border-radius: var(--border-radius-large);
            padding: 32px;
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-soft);
            position: relative;
            backdrop-filter: blur(10px);
        }

        /* Contract Upload Modal Styles */
        .contract-upload-explanation {
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .contract-upload-explanation ul {
            margin: 15px 0 0 20px;
            color: var(--text-secondary);
        }

        .contract-upload-explanation li {
            margin-bottom: 8px;
        }

        .contract-only-upload-area {
            border: 2px dashed var(--primary);
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(99, 102, 241, 0.05);
        }

        .contract-only-upload-area:hover {
            border-color: var(--primary-dark);
            background: rgba(99, 102, 241, 0.1);
            transform: translateY(-2px);
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .upload-text strong {
            display: block;
            font-size: 18px;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .upload-text div {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .processing-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            padding: 20px;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 8px;
            margin-top: 20px;
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 2px solid var(--border);
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .invoice-result-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--shadow-inset);
            border-radius: var(--border-radius-large) var(--border-radius-large) 0 0;
        }

        .invoice-result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border-light);
        }

        .invoice-result-header h3 {
            color: var(--text-primary);
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-badge {
            padding: 8px 16px;
            border-radius: var(--border-radius);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.05em;
            font-family: var(--font-primary);
        }

        .status-badge.passed {
            background: var(--accent-success);
            color: var(--white);
        }

        .status-badge.failed {
            background: var(--error);
            color: var(--white);
        }

        .discrepancy-item, .warning-item {
            background: var(--error-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 16px;
            border-left: 4px solid var(--error);
        }

        .warning-item {
            background: var(--warning-bg);
            border-left-color: var(--warning);
        }

        .discrepancy-item strong, .warning-item strong {
            color: var(--primary);
            font-weight: 600;
            font-size: 16px;
        }

        .match-badge {
            display: inline-block;
            background: var(--accent-success);
            color: var(--white);
            padding: 8px 12px;
            border-radius: var(--border-radius);
            font-size: 12px;
            font-weight: 500;
            margin: 4px;
            font-family: var(--font-primary);
        }

        .contract-details {
            background: var(--secondary-bg);
            border-radius: var(--border-radius-large);
            padding: 32px;
            margin-bottom: 32px;
            border: 1px solid var(--border-light);
            position: relative;
            backdrop-filter: blur(10px);
        }

        .contract-details::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--shadow-inset);
            border-radius: var(--border-radius-large) var(--border-radius-large) 0 0;
        }

        .contract-details h3 {
            color: var(--text-primary);
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .detail-item {
            background: var(--surface-3);
            padding: 16px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-soft);
            position: relative;
        }

        .detail-item::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--shadow-inset);
            border-radius: var(--border-radius) var(--border-radius) 0 0;
        }

        .detail-label {
            font-weight: 600;
            color: var(--accent-cyan);
            font-size: 12px;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .detail-value {
            color: var(--text-primary);
            word-break: break-word;
            font-size: 14px;
            font-family: var(--font-mono);
        }

        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-top: 40px;
        }

        .btn {
            padding: 16px 32px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            font-family: var(--font-primary);
            transition: all 0.2s ease;
            letter-spacing: 0.01em;
        }

        .btn-primary {
            background: var(--accent-cyan);
            color: var(--white);
        }

        .btn-success {
            background: var(--accent-success);
            color: var(--white);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .btn-primary:hover {
            background: var(--primary);
        }

        .btn-success:hover {
            background: var(--secondary);
        }

        .history-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: var(--surface-1);
            backdrop-filter: blur(20px);
            border-left: 1px solid var(--border-light);
            box-shadow: -5px 0 30px rgba(0, 0, 0, 0.4);
            transition: right 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }

        .history-panel.open {
            right: 0;
        }

        .history-header {
            padding: 24px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: var(--white);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .history-header::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--shadow-inset);
        }

        .history-header h3 {
            font-size: 18px;
            font-weight: 600;
        }

        .history-content {
            padding: 24px;
        }

        .history-item {
            padding: 20px;
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius);
            margin-bottom: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--surface-2);
            position: relative;
        }

        .history-item::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--shadow-inset);
            border-radius: var(--border-radius) var(--border-radius) 0 0;
        }

        .history-item:hover {
            background: var(--surface-3);
            transform: translateX(4px);
            box-shadow: var(--shadow-soft);
            border-color: var(--accent-cyan);
        }

        .info-box {
            background: var(--cyan-bg-light);
            border-left: 4px solid var(--accent-cyan);
            padding: 20px;
            margin-bottom: 20px;
            border-radius: var(--border-radius);
        }

        .info-box a {
            color: var(--accent-cyan);
            text-decoration: none;
            font-weight: 600;
        }

        .info-box a:hover {
            text-decoration: underline;
            color: var(--primary);
        }

        @media (max-width: 768px) {
            .upload-area {
                grid-template-columns: 1fr;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
            }
            
            .results-header {
                flex-direction: column;
                gap: 15px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .container {
                padding: 20px;
            }

            .history-panel {
                width: 100%;
                right: -100%;
            }
        }

        .tooltip {
            position: relative;
            cursor: help;
        }

        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            background: var(--neutral-dark);
            color: var(--white);
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 0.8rem;
            white-space: nowrap;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
        }
        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
        }
        
        .toast {
            background: var(--secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px 20px;
            margin-bottom: 10px;
            min-width: 300px;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease-out;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .toast.success {
            border-left: 4px solid var(--accent-success);
        }
        
        .toast.error {
            border-left: 4px solid var(--accent-error);
        }
        
        .toast.warning {
            border-left: 4px solid var(--accent-warning);
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        /* Quick Actions Floating Menu */
        .quick-actions {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
        }
        
        .quick-actions-button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .quick-actions-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }
        
        .quick-actions-button.active {
            transform: rotate(45deg);
            background: linear-gradient(135deg, var(--accent-error), var(--accent-warning));
        }
        
        .quick-actions-menu {
            position: absolute;
            bottom: 80px;
            right: 0;
            display: none;
            flex-direction: column;
            gap: 10px;
        }
        
        .quick-actions-menu.show {
            display: flex;
            animation: fadeInUp 0.3s ease;
        }
        
        .quick-action-item {
            background: var(--secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px 20px;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 180px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        .quick-action-item:hover {
            background: var(--primary);
            border-color: var(--accent-cyan);
            transform: translateX(-5px);
        }
        
        .quick-action-item svg {
            width: 18px;
            height: 18px;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
    <!-- External Libraries -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Quick Actions Floating Menu -->
    <div class="quick-actions" id="quickActions">
        <div class="quick-actions-menu" id="quickActionsMenu">
            <div class="quick-action-item" onclick="quickUploadInvoice()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                </svg>
                <span>Upload Invoice</span>
            </div>
            <div class="quick-action-item" onclick="toggleQuickActions(); window.location.href='add-vendor.html'">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2v20M2 12h20"></path>
                </svg>
                <span>Add Vendor</span>
            </div>
            <div class="quick-action-item" onclick="quickStartReconciliation()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                </svg>
                <span>Run Reconciliation</span>
            </div>
            <div class="quick-action-item" onclick="generateQuickReport()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <path d="M16 13H8M16 17H8M10 9H8"></path>
                </svg>
                <span>Generate Report</span>
            </div>
        </div>
        <button class="quick-actions-button" id="quickActionsButton" onclick="toggleQuickActions()">
            <span>+</span>
        </button>
    </div>
    <!-- Menu Button -->
    <button class="menu-button" onclick="toggleSidebar()" title="Menu">
        ☰
    </button>

    <!-- Connection Status Indicator -->
    <div class="connection-status" id="connectionStatus" style="display: none;">
        <div class="status-icon"></div>
        <span id="connectionText">Disconnected</span>
    </div>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3>Settings</h3>
            <button class="sidebar-close" onclick="closeSidebar()">×</button>
        </div>
        
        <!-- API Configuration Section -->
        <div class="sidebar-api-section">
            <h4 class="sidebar-section-title">API Configuration</h4>
            <div class="sidebar-connection-status" id="sidebarConnectionStatus">
                <div class="status-icon" id="sidebarStatusIcon"></div>
                <span id="sidebarConnectionText">Not Connected</span>
            </div>
            
            <div class="sidebar-api-form" id="sidebarApiForm">
                <input type="password" 
                       id="sidebarApiKey" 
                       class="sidebar-api-input"
                       placeholder="Enter OpenAI API key (sk-...)"
                       autocomplete="off"
                       onkeyup="if(event.key === 'Enter') testSidebarApiKey()">
                <div class="sidebar-api-buttons">
                    <button class="sidebar-btn-small btn-primary" onclick="testSidebarApiKey()">Connect</button>
                    <button class="sidebar-btn-small btn-secondary" onclick="clearSidebarApiKey()">Clear</button>
                </div>
                <div id="sidebarApiStatus" class="sidebar-status-message" style="display: none;"></div>
                <div class="sidebar-api-help">
                    <small><a href="https://platform.openai.com/api-keys" target="_blank">Get API Key</a> • <a href="https://platform.openai.com/account/billing" target="_blank">Add Credits</a></small>
                </div>
            </div>
            
            <div class="sidebar-api-connected" id="sidebarApiConnected" style="display: none;">
                <div class="api-key-display">
                    <small>Key: ••••<span id="keyLastFour"></span></small>
                </div>
                <div class="token-usage-display">
                    <small>Usage: $<span id="sidebarTokenUsage">0.00</span></small>
                </div>
                <div class="sidebar-api-buttons">
                    <button class="sidebar-btn-small btn-secondary" onclick="openApiSettings()">Manage</button>
                    <button class="sidebar-btn-small btn-danger" onclick="disconnectFromSidebar()">Disconnect</button>
                </div>
            </div>
        </div>
        
        <div class="sidebar-divider"></div>
        
        <nav class="sidebar-nav">
            <button class="sidebar-nav-item" onclick="openHistoryFromSidebar()">
                <svg class="sidebar-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                View History
            </button>
            <button class="sidebar-nav-item" onclick="resetAll()">
                <svg class="sidebar-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M1 4v6h6M23 20v-6h-6"></path>
                    <path d="M20.49 9A9 9 0 005.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 013.51 15"></path>
                </svg>
                Reset All
            </button>
            <div class="sidebar-divider"></div>
            <button class="sidebar-nav-item" onclick="showAbout()">
                <svg class="sidebar-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="16" x2="12" y2="12"></line>
                    <line x1="12" y1="8" x2="12.01" y2="8"></line>
                </svg>
                About
            </button>
        </nav>
    </div>

    <!-- API Settings Management Modal -->
    <div class="modal-backdrop setup-modal" id="apiSettingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">API Connection Settings</h2>
                <button class="modal-close" onclick="closeApiSettings()">×</button>
            </div>
            <div class="modal-body">
                <div class="token-usage" id="tokenUsageDisplay">
                    <div class="usage-label">Estimated Usage</div>
                    <div class="usage-amount">$0.00</div>
                </div>

                <div class="api-key-setup">
                    <div class="input-group">
                        <input type="password" 
                               id="settingsApiKey" 
                               placeholder="Current API key (sk-...)" 
                               autocomplete="off">
                        <button class="test-btn" onclick="testSettingsApiKey()">Test Key</button>
                    </div>
                    <div id="settingsStatus" class="setup-status" style="display: none;"></div>
                </div>

                <div class="info-box">
                    <strong>Low on tokens?</strong> 
                    <a href="https://platform.openai.com/account/billing" target="_blank">Add credits to your OpenAI account</a>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="disconnectApi()">Disconnect</button>
                <button class="btn btn-primary" onclick="saveApiSettings()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Add Vendor Modal -->
    <div class="modal-backdrop vendor-modal" id="addVendorModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">
                    <svg class="section-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 21h18"></path>
                        <path d="M5 21V7l8-4v18"></path>
                        <path d="M19 21V11l-6-4"></path>
                        <rect x="9" y="9" width="4" height="4"></rect>
                        <rect x="9" y="14" width="4" height="4"></rect>
                    </svg>
                    Add New Vendor
                </h2>
                <button class="modal-close" onclick="closeAddVendorModal()">×</button>
            </div>
            <div class="modal-body">
                <form id="addVendorForm">
                    <div class="vendor-form-group">
                        <label for="vendorName">Vendor Name <span class="required">*</span></label>
                        <input type="text" id="vendorName" name="vendorName" required>
                    </div>
                    
                    <div class="vendor-form-group">
                        <label for="vendorDescription">Description</label>
                        <textarea id="vendorDescription" name="vendorDescription" rows="3" placeholder="Brief description of services or products"></textarea>
                    </div>
                    
                    <div class="vendor-form-group">
                        <label for="vendorEmail">Contact Email</label>
                        <input type="email" id="vendorEmail" name="vendorEmail" placeholder="contact@vendor.com">
                    </div>
                    
                    <div class="vendor-form-group">
                        <label for="contractFile">Contract File <span class="required">*</span></label>
                        <div class="file-upload-area" onclick="document.getElementById('contractFile').click()">
                            <input type="file" id="contractFile" name="contractFile" accept=".pdf,.doc,.docx" style="display: none;" onchange="handleContractFileSelect(this)">
                            <div id="contractFileStatus">
                                Click to upload contract file (PDF, DOC, DOCX)
                            </div>
                        </div>
                    </div>
                    
                    <div class="vendor-form-group">
                        <label for="effectiveDate">Contract Effective Date <span class="required">*</span></label>
                        <input type="date" id="effectiveDate" name="effectiveDate" required>
                    </div>
                    
                    <div class="vendor-form-group">
                        <label for="renewalDate">Renewal Date</label>
                        <input type="date" id="renewalDate" name="renewalDate">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAddVendorModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveVendor()">Save Vendor</button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Dashboard View -->
        <div class="page-view active" id="dashboardView">
            <header>
                <h1>Contract Reconciliation Platform</h1>
                <p class="subtitle">Precision contract validation at a glance. Your contracts, your rules. Verified every time.</p>
            </header>

            <!-- Dashboard Content -->
            <!-- KPI Cards -->
            <div class="kpi-container">
                <div class="kpi-card">
                    <div class="kpi-value" id="totalDriftValue">$0.00</div>
                    <div class="kpi-label">
                        Total Invoice Drift
                        <span class="kpi-tooltip" title="Total value of all mismatches found between contracts and invoices"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg></span>
                    </div>
                    <div class="kpi-description">Cumulative discrepancies detected</div>
                </div>
                
                <div class="kpi-card">
                    <div class="kpi-value" id="activeVendorsValue">0</div>
                    <div class="kpi-label">
                        Active Vendors
                        <span class="kpi-tooltip" title="Vendors with active profiles and valid contracts"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg></span>
                    </div>
                    <div class="kpi-description">Configured for reconciliation</div>
                </div>
                
                <div class="kpi-card">
                    <div class="kpi-value" id="reviewedInvoicesValue">0</div>
                    <div class="kpi-label">
                        AI-Reviewed Invoices
                        <span class="kpi-tooltip" title="Total invoices screened by the AI engine"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg></span>
                    </div>
                    <div class="kpi-description">Processed through AI analysis</div>
                </div>
            </div>

            <!-- Vendors Table -->
            <div class="vendors-section">
                <div class="vendors-header">
                    <h3 class="vendors-title">Active Vendors</h3>
                    <div class="vendors-actions">
                        <button class="btn btn-primary add-vendor-btn" onclick="navigateToAddVendor(this)">
                            <span>+ Add Vendor</span>
                        </button>
                        <input type="text" 
                               class="form-input vendors-search" 
                               placeholder="Search vendors..." 
                               id="vendorSearch"
                               oninput="filterVendors()">
                    </div>
                </div>
                
                <div class="vendors-table" id="vendorsTableContainer">
                    <table id="vendorsTable">
                        <thead>
                            <tr>
                                <th>Vendor</th>
                                <th>Description</th>
                                <th class="sortable" onclick="sortTable('invoices')">Invoices</th>
                                <th class="sortable" onclick="sortTable('lastUpdated')">Last Updated</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="vendorsTableBody">
                            <!-- Vendor rows will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Disabled Vendors Section -->
                <div class="disabled-vendors-section" id="disabledVendorsSection" style="display: none;">
                    <div class="disabled-vendors-header" onclick="toggleDisabledVendors()">
                        <h3 class="disabled-vendors-title">
                            <span id="disabledVendorsToggle">▶</span> Disabled Vendors
                            <span class="disabled-vendors-count" id="disabledVendorsCount">(0)</span>
                        </h3>
                        <span class="disabled-vendors-description">Previously active vendors that are no longer in use</span>
                    </div>
                    <div class="disabled-vendors-content" id="disabledVendorsContent" style="display: none;">
                        <div class="vendors-table disabled-table">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Vendor</th>
                                        <th>Description</th>
                                        <th>Invoices</th>
                                        <th>Disabled Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="disabledVendorsTableBody">
                                    <!-- Disabled vendor rows will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="empty-vendors" id="emptyVendors" style="display: none;">
                    <div class="empty-vendors-icon"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" opacity="0.5">
                        <path d="M3 21h18"></path>
                        <path d="M5 21V7l8-4v18"></path>
                        <path d="M19 21V11l-6-4"></path>
                        <rect x="9" y="9" width="4" height="4"></rect>
                        <rect x="9" y="14" width="4" height="4"></rect>
                    </svg></div>
                    <h3>No vendors yet</h3>
                    <p>Add your first vendor to start tracking contract reconciliations.</p>
                    <button class="add-vendor-btn" onclick="window.location.href='add-vendor.html'">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                        </svg>
                        Upload Your First Contract
                    </button>
                </div>
            </div>

        </div> <!-- End Dashboard View -->

        <!-- Document Analysis View -->
        <div class="page-view" id="analysisView">
            <header>
                <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 32px;">
                    <button class="btn btn-secondary" onclick="showDashboard()">
                        ← Back to Dashboard
                    </button>
                    <div>
                        <h1>Document Analysis</h1>
                        <p class="subtitle">Upload and analyze contracts and invoices for discrepancies</p>
                    </div>
                </div>
            </header>

        <!-- Document Upload Section -->
        <div class="upload-section" id="uploadSection">

        <!-- Settings Section -->
        <div class="section" id="settingsSection">
            <div class="section-header" onclick="toggleSection('settingsSection')">
                <h2>Settings & Configuration</h2>
            </div>
            <div class="section-content">
                <div class="info-box">
                    <strong>Secure API Access Required:</strong> 
                    <a href="https://platform.openai.com/api-keys" target="_blank">Obtain your OpenAI API key</a>
                    — Add $10-20 in credits for optimal analysis performance and reliability.
                </div>
                
                <div class="api-key-input-group">
                    <input type="password" 
                           id="apiKeyInput" 
                           class="form-input api-key-input" 
                           placeholder="Enter your OpenAI API key (sk-...)"
                           required
                           value="">
                    <button id="saveApiKeyBtn" 
                            class="btn btn-primary save-key-btn"
                            data-loading-text="Testing Key..."
                            data-tooltip="Please enter a valid API key first">Save & Test Key</button>
                </div>
                <div id="apiStatus" class="api-status hidden"></div>

                <div class="settings-grid">
                    <div class="setting-item">
                        <label for="aiModel" class="tooltip" data-tooltip="GPT-4 is more accurate but costs more">AI Model</label>
                        <select id="aiModel" class="form-select">
                            <option value="gpt-3.5-turbo">GPT-3.5 Turbo (Fast & Cheap)</option>
                            <option value="gpt-4">GPT-4 (Most Accurate)</option>
                            <option value="gpt-4-turbo-preview">GPT-4 Turbo (Best Performance)</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label for="tolerance" class="tooltip" data-tooltip="Allow small differences in amounts">Amount Tolerance ($)</label>
                        <input type="number" id="tolerance" class="form-input form-input-short" value="0.01" step="0.01" min="0">
                    </div>
                    <div class="setting-item">
                        <label for="contractType" class="tooltip" data-tooltip="Helps AI understand contract format">Contract Type</label>
                        <select id="contractType" class="form-select">
                            <option value="general">General Business Contract</option>
                            <option value="service">Service Agreement</option>
                            <option value="supply">Supply/Purchase Contract</option>
                            <option value="consulting">Consulting Agreement</option>
                            <option value="maintenance">Maintenance Contract</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label for="strictMode">Validation Mode</label>
                        <select id="strictMode" class="form-select">
                            <option value="normal">Normal (Recommended)</option>
                            <option value="strict">Strict (Zero Tolerance)</option>
                            <option value="lenient">Lenient (Business Friendly)</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upload Section -->
        <div class="section" id="uploadSection">
            <div class="section-header" onclick="toggleSection('uploadSection')">
                <h2>Document Upload</h2>
            </div>
            <div class="section-content">
                <div class="upload-area">
                    <!-- Contract Upload -->
                    <div class="upload-box" id="contractUpload">
                        <div class="upload-icon"><svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" opacity="0.6">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                        </svg></div>
                        <h3>Contract Document</h3>
                        <p>Upload your master contract for validation</p>
                        <p style="font-size: 13px; opacity: 0.7; margin-top: 8px;">Supported formats: PDF, PNG, JPG, JPEG</p>
                        <input type="file" id="contractFile" accept=".pdf,.png,.jpg,.jpeg" />
                        <div id="contractFileInfo" class="file-list"></div>
                    </div>

                    <!-- Multiple Invoices Upload -->
                    <div class="upload-box multi-upload-box" id="invoicesUpload">
                        <div class="upload-icon">🧾</div>
                        <h3>Invoice Documents</h3>
                        <p>Upload invoices for batch validation against contract</p>
                        <p style="font-size: 13px; opacity: 0.7; margin-top: 4px;">Select multiple files for batch processing</p>
                        <p style="font-size: 13px; opacity: 0.7;">Supported formats: PDF, PNG, JPG, JPEG</p>
                        <input type="file" id="invoiceFiles" accept=".pdf,.png,.jpg,.jpeg" multiple />
                        <div id="invoiceFilesList" class="file-list"></div>
                    </div>
                </div>

                <button id="processBtn" 
                        class="btn btn-primary btn-large process-btn" 
                        disabled
                        data-loading-text="Processing Documents..."
                        data-tooltip="Please upload contract and at least one invoice, and enter your API key">
                    <span id="processBtnText">Analyze Documents</span>
                </button>
            </div>
        </div>

        <!-- Processing Section -->
        <div class="processing-section hidden" id="processingSection">
            <div class="processing-header">
                <button class="back-to-dashboard-btn" onclick="showDashboard()">← Back to Dashboard</button>
                <div class="processing-content">
                    <div class="spinner"></div>
                    <h2>Analyzing Terms. Cross-checking Figures.</h2>
                    <p id="processingStatus">Initializing document analysis...</p>
                </div>
            </div>
            
            <div class="processing-grid" id="processingGrid">
                <!-- Dynamic processing items will be added here -->
            </div>
        </div>

        <!-- Results Section -->
        <div class="results-section hidden" id="resultsSection">
            <div class="results-header">
                <button class="back-to-dashboard-btn" onclick="showDashboard()" style="margin-bottom: 20px;">← Back to Dashboard</button>
                <div class="results-title-section">
                    <h2>Validation Results</h2>
                    <div class="export-controls">
                        <button class="btn btn-secondary export-btn" onclick="exportToPDF()">Export PDF</button>
                        <button class="btn btn-secondary export-btn" onclick="exportToExcel()">Export Excel</button>
                        <button class="btn btn-success export-btn" onclick="saveToHistory()">💾 Save Results</button>
                    </div>
                </div>
            </div>
            
            <!-- Batch Summary -->
            <div class="batch-summary">
                <h3>Analysis Summary</h3>
                <div class="summary-stats" id="batchSummaryStats">
                    <!-- Dynamic summary stats -->
                </div>
            </div>

            <!-- Contract Analysis -->
            <div class="contract-details" id="contractAnalysis">
                <h3>Contract Analysis</h3>
                <div id="contractDetailsContent"></div>
            </div>

            <!-- Individual Invoice Results -->
            <div class="invoice-results" id="invoiceResults">
                <!-- Dynamic invoice results -->
            </div>

            <div class="action-buttons">
                <button class="btn btn-success" onclick="resetAll()">🆕 New Reconciliation</button>
                <button class="btn btn-primary" onclick="addMoreInvoices()">➕ Add More Invoices</button>
            </div>
        </div>
        
        </div> <!-- End Upload Section -->
        
        </div> <!-- End Analysis View -->
        
    </div> <!-- End Container -->

    <!-- History Panel -->
    <div class="history-panel" id="historyPanel">
        <div class="history-header">
            <h3>Reconciliation History</h3>
            <button class="unstyled" onclick="toggleHistory()" style="background: none; border: none; color: var(--white); font-size: 1.2rem; cursor: pointer;">✕</button>
        </div>
        <div class="history-content" id="historyContent">
            <!-- Dynamic history items -->
        </div>
    </div>

    <!-- AI Processing View -->
    <div class="page-view" id="aiProcessingView">
        <div class="ai-processing-container">
            <div class="ai-processing-header">
                <button class="back-to-dashboard-btn" onclick="showDashboard()">← Back to Dashboard</button>
                <h1>AI Document Analysis in Progress</h1>
                <p class="ai-processing-subtitle">Watching AI extract and understand your documents</p>
            </div>

            <!-- Processing Steps Indicator -->
            <div class="processing-steps">
                <div class="step-indicator">
                    <div class="step-circle">1</div>
                    <span class="step-label">Document Analysis</span>
                </div>
                <div class="step-indicator">
                    <div class="step-circle">2</div>
                    <span class="step-label">Term Extraction</span>
                </div>
                <div class="step-indicator">
                    <div class="step-circle">3</div>
                    <span class="step-label">Comparison Analysis</span>
                </div>
                <div class="step-indicator">
                    <div class="step-circle">4</div>
                    <span class="step-label">Final Report</span>
                </div>
            </div>

            <!-- Neural Network Background -->
            <div class="neural-background">
                <div class="neural-node"></div>
                <div class="neural-node"></div>
                <div class="neural-node"></div>
                <div class="neural-node"></div>
                <div class="neural-connection"></div>
                <div class="neural-connection"></div>
                <div class="neural-connection"></div>
            </div>

            <div class="ai-processing-content">
                <!-- Document Analysis Panels -->
                <div class="document-analysis-panels">
                    <!-- Contract Panel -->
                    <div class="document-panel" id="contractPanel">
                        <div class="document-panel-header">
                            <h3>Contract Document</h3>
                            <span class="document-name" id="contractFileName">Loading...</span>
                        </div>
                        <div class="document-content-container">
                            <div class="scanning-overlay">
                                <div class="scan-line"></div>
                            </div>
                            <div class="document-content" id="contractContent">
                                <!-- Real document content will be inserted here -->
                            </div>
                            <div class="floating-tags-container" id="contractTags">
                                <!-- Floating detection tags -->
                            </div>
                        </div>
                    </div>

                    <!-- Invoice Panel -->  
                    <div class="document-panel" id="invoicePanel">
                        <div class="document-panel-header">
                            <h3>Invoice Document</h3>
                            <span class="document-name" id="invoiceFileName">Loading...</span>
                        </div>
                        <div class="document-content-container">
                            <div class="scanning-overlay">
                                <div class="scan-line"></div>
                            </div>
                            <div class="document-content" id="invoiceContent">
                                <!-- Real document content will be inserted here -->
                            </div>
                            <div class="floating-tags-container" id="invoiceTags">
                                <!-- Floating detection tags -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analysis Results Summary -->
                <div class="analysis-results-summary" id="analysisResults" style="display: none;">
                    <div class="results-header">
                        <h3>Analysis Complete</h3>
                        <p>Key findings from your documents:</p>
                    </div>
                    <div class="key-findings" id="keyFindings">
                        <!-- Dynamic findings will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- Vendor Details View -->
    <div class="page-view" id="vendorDetailsView">
        <header>
            <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 32px;">
                <button class="btn btn-secondary" onclick="showDashboard()">
                    ← Back to Dashboard
                </button>
                <div>
                    <h1 id="vendorDetailsTitle">Vendor Details</h1>
                    <p class="subtitle">Complete vendor profile and invoice history</p>
                </div>
            </div>
        </header>

        <div class="vendor-details-content">
            <!-- Vendor Information Section -->
            <div class="vendor-info-section">
                <div class="section-header">
                    <h2>Vendor Information</h2>
                </div>
                <div class="vendor-info-grid" id="vendorInfoGrid">
                    <!-- Dynamic vendor information -->
                </div>
            </div>

            <!-- Contract Details Section -->
            <div class="contract-details-section">
                <div class="section-header">
                    <h2>Contract Details</h2>
                </div>
                <div class="contract-info" id="contractInfo">
                    <!-- Dynamic contract information -->
                </div>
            </div>

            <!-- Invoice History Section -->
            <div class="invoice-history-section">
                <div class="section-header">
                    <h2>Invoice History</h2>
                </div>
                <div class="invoice-history-grid" id="invoiceHistoryGrid">
                    <!-- Dynamic invoice history -->
                </div>
            </div>
        </div>
    </div>

    <!-- Contract-Only Upload Modal -->
    <div class="modal-backdrop" id="contractUploadModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">
                    <span>📄</span>
                    Create Vendor from Contract
                </h2>
                <button class="modal-close" onclick="closeContractUploadModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="contract-upload-explanation">
                    <p>Upload a contract to automatically create a vendor profile. Our AI will:</p>
                    <ul>
                        <li>Extract vendor information</li>
                        <li>Identify AP terms and payment details</li>
                        <li>Create a complete vendor profile</li>
                        <li>Set up invoice reconciliation rules</li>
                    </ul>
                </div>
                
                <div class="contract-only-upload-area" onclick="document.getElementById('contractOnlyFile').click()">
                    <input type="file" id="contractOnlyFile" accept=".pdf,.png,.jpg,.jpeg" style="display: none;" onchange="handleContractOnlyUpload(event)">
                    <div class="upload-icon">📤</div>
                    <div class="upload-text">
                        <strong>Click to upload contract</strong>
                        <div>PDF, PNG, JPG supported</div>
                    </div>
                </div>
                
                <div id="contractProcessingStatus" style="display: none;">
                    <div class="processing-indicator">
                        <div class="spinner"></div>
                        <span id="processingText">Analyzing contract...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let apiKey = localStorage.getItem('openai_api_key') || '';
        let contractFile = null;
        let invoiceFiles = [];
        let currentResults = null;
        let processingQueue = [];
        let contractAnalysis = null;
        let tokenUsage = parseFloat(localStorage.getItem('openai_token_usage') || '0');

        // Settings
        let settings = {
            aiModel: 'gpt-4',
            tolerance: 0.01,
            contractType: 'general',
            strictMode: 'normal'
        };

        // ===============================
        // NEW API KEY MANAGEMENT SYSTEM
        // ===============================

        function initializeConnectionStatus() {
            const statusEl = document.getElementById('connectionStatus');
            const textEl = document.getElementById('connectionText');
            
            if (apiKey) {
                statusEl.classList.add('connected');
                statusEl.classList.remove('disconnected');
                textEl.textContent = 'Connected';
                statusEl.style.display = 'flex';
                hideSettingsSection();
                updateTokenUsageDisplay();
            } else {
                statusEl.classList.add('disconnected');
                statusEl.classList.remove('connected');
                textEl.textContent = 'Disconnected';
                statusEl.style.display = 'flex';
                showSettingsSection();
            }
            
            // Update sidebar status as well
            updateSidebarConnectionStatus();
        }

        // Sidebar API Management Functions
        function updateSidebarConnectionStatus() {
            const statusEl = document.getElementById('sidebarConnectionStatus');
            const textEl = document.getElementById('sidebarConnectionText');
            const formEl = document.getElementById('sidebarApiForm');
            const connectedEl = document.getElementById('sidebarApiConnected');
            const keyLastFour = document.getElementById('keyLastFour');
            const tokenUsageEl = document.getElementById('sidebarTokenUsage');
            
            if (apiKey) {
                statusEl.classList.add('connected');
                statusEl.classList.remove('disconnected');
                textEl.textContent = 'Connected';
                formEl.style.display = 'none';
                connectedEl.style.display = 'block';
                keyLastFour.textContent = apiKey.slice(-4);
                tokenUsageEl.textContent = tokenUsage.toFixed(2);
            } else {
                statusEl.classList.add('disconnected');
                statusEl.classList.remove('connected');
                textEl.textContent = 'Not Connected';
                formEl.style.display = 'block';
                connectedEl.style.display = 'none';
            }
        }

        async function testSidebarApiKey() {
            const keyInput = document.getElementById('sidebarApiKey');
            const statusEl = document.getElementById('sidebarApiStatus');
            
            const newKey = keyInput.value.trim();
            
            if (!newKey) {
                showSidebarStatus('Please enter your API key', 'error');
                return;
            }
            
            if (!newKey.startsWith('sk-')) {
                showSidebarStatus('API key should start with "sk-"', 'error');
                return;
            }
            
            showSidebarStatus('Testing connection...', 'info');
            
            try {
                const response = await fetch('https://api.openai.com/v1/models', {
                    headers: {
                        'Authorization': `Bearer ${newKey}`
                    }
                });
                
                if (response.ok) {
                    apiKey = newKey;
                    localStorage.setItem('openai_api_key', apiKey);
                    localStorage.setItem('openai_api_key_setup_complete', 'true');
                    showSidebarStatus('Connected successfully!', 'success');
                    updateSidebarConnectionStatus();
                    initializeConnectionStatus();
                    setTimeout(() => {
                        statusEl.style.display = 'none';
                        keyInput.value = '';
                    }, 2000);
                } else {
                    showSidebarStatus('Invalid API key', 'error');
                }
            } catch (error) {
                showSidebarStatus('Connection failed', 'error');
            }
        }

        function showSidebarStatus(message, type) {
            const statusEl = document.getElementById('sidebarApiStatus');
            statusEl.textContent = message;
            statusEl.className = `sidebar-status-message ${type}`;
            statusEl.style.display = 'block';
        }

        function clearSidebarApiKey() {
            document.getElementById('sidebarApiKey').value = '';
            const statusEl = document.getElementById('sidebarApiStatus');
            statusEl.style.display = 'none';
        }

        function disconnectFromSidebar() {
            if (confirm('Are you sure you want to disconnect your API key?')) {
                disconnectApi();
                updateSidebarConnectionStatus();
            }
        }

        function hideSettingsSection() {
            const settingsSection = document.getElementById('settingsSection');
            if (settingsSection) {
                settingsSection.style.display = 'none';
            }
        }

        function showSettingsSection() {
            const settingsSection = document.getElementById('settingsSection');
            if (settingsSection) {
                settingsSection.style.display = 'block';
            }
        }

        function openApiSettings() {
            const modal = document.getElementById('apiSettingsModal');
            const keyInput = document.getElementById('settingsApiKey');
            
            // Populate current key (show only last 4 characters for security)
            if (apiKey) {
                keyInput.value = apiKey;
            }
            
            updateTokenUsageDisplay();
            modal.classList.add('open');
        }

        function closeApiSettings() {
            const modal = document.getElementById('apiSettingsModal');
            modal.classList.remove('open');
        }

        async function testSettingsApiKey() {
            const keyInput = document.getElementById('settingsApiKey');
            const statusEl = document.getElementById('settingsStatus');
            
            const newKey = keyInput.value.trim();
            
            if (!newKey) {
                showSettingsStatus('Please enter your OpenAI API key', 'error');
                return;
            }
            
            if (!newKey.startsWith('sk-')) {
                showSettingsStatus('API key should start with "sk-"', 'error');
                return;
            }
            
            showSettingsStatus('Testing API key...', 'success');
            
            try {
                const response = await fetch('https://api.openai.com/v1/models', {
                    headers: {
                        'Authorization': `Bearer ${newKey}`
                    }
                });
                
                if (response.ok) {
                    showSettingsStatus('API key verified successfully!', 'success');
                    apiKey = newKey;
                } else {
                    showSettingsStatus('Invalid API key. Please check and try again.', 'error');
                }
            } catch (error) {
                showSettingsStatus('Could not verify API key. Please check your connection.', 'error');
            }
        }

        function showSettingsStatus(message, type) {
            const statusEl = document.getElementById('settingsStatus');
            statusEl.textContent = message;
            statusEl.className = `setup-status ${type}`;
            statusEl.style.display = 'block';
        }

        function saveApiSettings() {
            if (!apiKey) {
                showSettingsStatus('Please test your API key first', 'error');
                return;
            }
            
            localStorage.setItem('openai_api_key', apiKey);
            closeApiSettings();
            initializeConnectionStatus();
            checkFilesReady();
        }

        function disconnectApi() {
            localStorage.removeItem('openai_api_key');
            localStorage.removeItem('openai_api_key_setup_complete');
            apiKey = '';
            
            closeApiSettings();
            initializeConnectionStatus();
            showSettingsSection();
            checkFilesReady();
        }

        function trackTokenUsage(cost) {
            tokenUsage += cost;
            localStorage.setItem('openai_token_usage', tokenUsage.toString());
            updateTokenUsageDisplay();
            
            // Check for low balance warning
            if (tokenUsage > 15) { // Warn when approaching $20 limit
                showTokenWarning();
            }
        }

        function updateTokenUsageDisplay() {
            const usageEl = document.getElementById('tokenUsageDisplay');
            const amountEl = usageEl?.querySelector('.usage-amount');
            
            if (amountEl) {
                amountEl.textContent = `$${tokenUsage.toFixed(2)}`;
                
                if (tokenUsage > 15) {
                    usageEl.classList.add('warning');
                } else {
                    usageEl.classList.remove('warning');
                }
            }
        }

        function showTokenWarning() {
            const statusEl = document.getElementById('connectionStatus');
            const originalText = statusEl.querySelector('#connectionText').textContent;
            
            statusEl.querySelector('#connectionText').textContent = 'Low Credits';
            statusEl.classList.add('disconnected');
            statusEl.classList.remove('connected');
            
            setTimeout(() => {
                statusEl.querySelector('#connectionText').textContent = originalText;
                statusEl.classList.add('connected');
                statusEl.classList.remove('disconnected');
            }, 3000);
        }

        // ===============================
        // SIDEBAR NAVIGATION SYSTEM
        // ===============================

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (sidebar.classList.contains('open')) {
                closeSidebar();
            } else {
                openSidebar();
            }
        }

        function openSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.add('open');
            overlay.classList.add('open');
            
            // Trap focus in sidebar
            const firstFocusable = sidebar.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
            if (firstFocusable) {
                firstFocusable.focus();
            }
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.remove('open');
            overlay.classList.remove('open');
            
            // Return focus to menu button
            document.querySelector('.menu-button').focus();
        }

        function openApiSettingsFromSidebar() {
            closeSidebar();
            setTimeout(() => {
                openApiSettings();
            }, 300); // Wait for sidebar close animation
        }

        function openHistoryFromSidebar() {
            closeSidebar();
            setTimeout(() => {
                toggleHistory();
            }, 300); // Wait for sidebar close animation
        }

        function showAbout() {
            closeSidebar();
            setTimeout(() => {
                alert('Invoice Reconciliation Platform Pro v2.0\n\nBuilt for precision contract validation and financial accuracy.\n\nFeatures:\n• AI-powered document analysis\n• Real-time reconciliation\n• Advanced discrepancy detection\n• Secure API key management\n\n© 2024 Invoice Reconciliation Platform');
            }, 300);
        }

        // ===============================
        // PAGE NAVIGATION SYSTEM
        // ===============================

        function showDashboard() {
            document.querySelectorAll('.page-view').forEach(view => {
                view.classList.remove('active');
            });
            document.getElementById('dashboardView').classList.add('active');
            loadDashboard();
        }

        function showAnalysis() {
            document.querySelectorAll('.page-view').forEach(view => {
                view.classList.remove('active');
            });
            document.getElementById('analysisView').classList.add('active');
        }

        function showVendorDetails(vendorId) {
            try {
                console.log('Showing vendor details for ID:', vendorId);
                document.querySelectorAll('.page-view').forEach(view => {
                    view.classList.remove('active');
                });
                
                const vendorDetailsView = document.getElementById('vendorDetailsView');
                if (vendorDetailsView) {
                    vendorDetailsView.classList.add('active');
                    loadVendorDetails(vendorId);
                } else {
                    console.error('Vendor details view not found');
                    showDashboard();
                }
            } catch (error) {
                console.error('Error in showVendorDetails:', error);
                showDashboard();
            }
        }

        // ===============================
        // DASHBOARD SYSTEM
        // ===============================

        let vendors = JSON.parse(localStorage.getItem('vendors') || '[]');
        let currentSort = { field: null, direction: 'asc' };

        function loadDashboard() {
            updateKPIs();
            loadVendorsTable();
        }

        function updateKPIs() {
            // Always reload vendors from localStorage to get latest data
            vendors = JSON.parse(localStorage.getItem('vendors') || '[]');
            
            // Clean up any duplicate vendors before calculating KPIs
            removeDuplicateVendors();
            
            // Calculate KPI values from reconciliation history and vendors
            const history = JSON.parse(localStorage.getItem('reconciliation_history') || '[]');
            
            console.log('Updating KPIs with', vendors.length, 'total vendors');
            
            // Total Invoice Drift - sum of all discrepancy values
            let totalDrift = 0;
            history.forEach(entry => {
                // Fix: Access discrepancies from invoiceResults within the stored results
                if (entry.results?.invoiceResults) {
                    entry.results.invoiceResults.forEach(invoice => {
                        if (invoice.comparison?.discrepancies) {
                            invoice.comparison.discrepancies.forEach(disc => {
                                // Extract numeric value from discrepancy description
                                const match = disc.description?.match(/\$?([\d,]+\.?\d*)/);
                                if (match) {
                                    totalDrift += parseFloat(match[1].replace(/,/g, ''));
                                }
                            });
                        }
                    });
                }
            });

            // Active Vendors - count active vendors (treat vendors without status as active)
            // Remove contractFile requirement since vendors created from analysis don't have this property
            const activeVendors = vendors.filter(vendor => (!vendor.status || vendor.status !== 'disabled')).length;

            // AI-Reviewed Invoices - count individual invoices processed, not reconciliation sessions
            let reviewedInvoices = 0;
            history.forEach(entry => {
                if (entry.results?.invoiceResults) {
                    reviewedInvoices += entry.results.invoiceResults.length;
                } else {
                    reviewedInvoices += 1; // Fallback for old format
                }
            });

            // Update KPI displays
            document.getElementById('totalDriftValue').textContent = `$${totalDrift.toLocaleString('en-US', { minimumFractionDigits: 2 })}`;
            document.getElementById('activeVendorsValue').textContent = activeVendors.toString();
            document.getElementById('reviewedInvoicesValue').textContent = reviewedInvoices.toString();
        }

        function loadVendorsTable() {
            // Always reload vendors from localStorage to get latest data
            vendors = JSON.parse(localStorage.getItem('vendors') || '[]');
            console.log('Loading vendors table, found', vendors.length, 'vendors:', vendors);
            
            const tableBody = document.getElementById('vendorsTableBody');
            const emptyState = document.getElementById('emptyVendors');
            const tableContainer = document.getElementById('vendorsTableContainer');
            
            // Filter to show only active vendors (treat vendors without status as active for backward compatibility)
            const activeVendors = vendors.filter(vendor => !vendor.status || vendor.status !== 'disabled');
            console.log('Active vendors:', activeVendors.length);
            
            if (activeVendors.length === 0) {
                tableContainer.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            tableContainer.style.display = 'block';
            emptyState.style.display = 'none';
            
            // Calculate invoice counts for each vendor
            const vendorInvoiceCounts = {};
            
            // First check invoices stored directly on vendor objects
            activeVendors.forEach(vendor => {
                if (vendor.invoiceCount !== undefined) {
                    vendorInvoiceCounts[vendor.name] = vendor.invoiceCount;
                } else if (vendor.invoiceAnalysis && Array.isArray(vendor.invoiceAnalysis)) {
                    vendorInvoiceCounts[vendor.name] = vendor.invoiceAnalysis.length;
                }
            });
            
            // Also check reconciliation history for legacy data
            const history = JSON.parse(localStorage.getItem('reconciliation_history') || '[]');
            history.forEach(entry => {
                const vendorName = entry.vendorName || entry.results?.contractDetails?.vendor_name;
                if (vendorName && !vendorInvoiceCounts[vendorName]) {
                    // Count individual invoices, not reconciliation sessions
                    const invoiceCount = entry.results?.invoiceResults?.length || 1;
                    vendorInvoiceCounts[vendorName] = invoiceCount;
                }
            });
            
            // Sort vendors if needed
            let sortedVendors = [...activeVendors];
            if (currentSort.field) {
                sortedVendors.sort((a, b) => {
                    let aVal, bVal;
                    if (currentSort.field === 'invoices') {
                        aVal = vendorInvoiceCounts[a.name] || 0;
                        bVal = vendorInvoiceCounts[b.name] || 0;
                    } else if (currentSort.field === 'lastUpdated') {
                        aVal = new Date(a.lastUpdated || a.createdAt);
                        bVal = new Date(b.lastUpdated || b.createdAt);
                    }
                    
                    if (currentSort.direction === 'asc') {
                        return aVal > bVal ? 1 : -1;
                    } else {
                        return aVal < bVal ? 1 : -1;
                    }
                });
            }
            
            // Generate table rows
            tableBody.innerHTML = '';
            sortedVendors.forEach(vendor => {
                const vendorName = vendor.vendor_name || vendor.name || 'Unknown Vendor';
                const businessType = vendor.business_type || vendor.description || '';
                const invoiceCount = vendorInvoiceCounts[vendorName] || 0;
                const lastUpdated = new Date(vendor.last_updated || vendor.lastUpdated || vendor.created_at || vendor.createdAt).toLocaleDateString();
                
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td><a href="#" class="vendor-name" onclick="viewVendorDetails('${vendor.id}')">${vendorName}</a></td>
                    <td>${businessType}</td>
                    <td>${invoiceCount}</td>
                    <td>${lastUpdated}</td>
                    <td>
                        <div class="vendor-actions">
                            <button class="btn-icon" onclick="disableVendor('${vendor.id}')" title="Disable vendor">
                                Pause
                            </button>
                            <button class="btn-icon btn-danger" onclick="deleteVendor('${vendor.id}')" title="Delete vendor permanently">
                                Delete
                            </button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Load disabled vendors section
            loadDisabledVendors();
        }

        function loadDisabledVendors() {
            const disabledVendors = vendors.filter(vendor => vendor.status === 'disabled');
            const disabledSection = document.getElementById('disabledVendorsSection');
            const disabledCount = document.getElementById('disabledVendorsCount');
            const disabledTableBody = document.getElementById('disabledVendorsTableBody');
            
            // Update count
            disabledCount.textContent = `(${disabledVendors.length})`;
            
            // Show/hide section based on whether there are disabled vendors
            if (disabledVendors.length > 0) {
                disabledSection.style.display = 'block';
                
                // Calculate invoice counts for disabled vendors
                const history = JSON.parse(localStorage.getItem('reconciliation_history') || '[]');
                const vendorInvoiceCounts = {};
                history.forEach(entry => {
                    const vendorName = entry.results?.contractDetails?.vendor_name;
                    if (vendorName) {
                        // Count individual invoices, not reconciliation sessions
                        const invoiceCount = entry.results?.invoiceResults?.length || 1;
                        vendorInvoiceCounts[vendorName] = (vendorInvoiceCounts[vendorName] || 0) + invoiceCount;
                    }
                });
                
                // Generate disabled vendor rows
                disabledTableBody.innerHTML = '';
                disabledVendors.forEach(vendor => {
                    const invoiceCount = vendorInvoiceCounts[vendor.name] || 0;
                    const disabledDate = vendor.disabledDate ? new Date(vendor.disabledDate).toLocaleDateString() : 'Unknown';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><a href="#" class="vendor-name" onclick="viewVendorDetails('${vendor.id}')">${vendor.name}</a></td>
                        <td>${vendor.description || ''}</td>
                        <td>${invoiceCount}</td>
                        <td>${disabledDate}</td>
                        <td>
                            <div class="vendor-actions">
                                <button class="btn-icon" onclick="enableVendor('${vendor.id}')" title="Re-enable vendor">
                                    Enable
                                </button>
                                <button class="btn-icon btn-danger" onclick="deleteVendor('${vendor.id}')" title="Delete vendor permanently">
                                    Delete
                                </button>
                            </div>
                        </td>
                    `;
                    disabledTableBody.appendChild(row);
                });
            } else {
                disabledSection.style.display = 'none';
            }
        }

        function toggleDisabledVendors() {
            const content = document.getElementById('disabledVendorsContent');
            const toggle = document.getElementById('disabledVendorsToggle');
            const title = document.querySelector('.disabled-vendors-title');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.textContent = '▼';
                title.classList.add('expanded');
            } else {
                content.style.display = 'none';
                toggle.textContent = '▶';
                title.classList.remove('expanded');
            }
        }

        function disableVendor(vendorId) {
            const vendor = vendors.find(v => v.id === vendorId);
            if (!vendor) return;
            
            if (confirm(`Are you sure you want to disable "${vendor.name}"?\n\nDisabled vendors will be moved to a separate section but their data will be preserved. You can re-enable them later if needed.`)) {
                vendor.status = 'disabled';
                vendor.disabledDate = new Date().toISOString();
                vendor.lastUpdated = new Date().toISOString();
                
                localStorage.setItem('vendors', JSON.stringify(vendors));
                loadVendorsTable();
                updateKPIs();
            }
        }

        function enableVendor(vendorId) {
            const vendor = vendors.find(v => v.id === vendorId);
            if (!vendor) return;
            
            if (confirm(`Re-enable "${vendor.name}"?\n\nThis vendor will be moved back to the active vendors list.`)) {
                vendor.status = 'active';
                delete vendor.disabledDate;
                vendor.lastUpdated = new Date().toISOString();
                
                localStorage.setItem('vendors', JSON.stringify(vendors));
                loadVendorsTable();
                updateKPIs();
            }
        }

        function deleteVendor(vendorId) {
            const vendor = vendors.find(v => v.id === vendorId);
            if (!vendor) return;
            
            if (confirm(`PERMANENT DELETION WARNING\n\nAre you sure you want to permanently delete "${vendor.name}"?\n\nThis action will:\n• Delete all vendor data\n• Remove all associated contract information\n• Cannot be undone\n\nClick OK to confirm this permanent action.`)) {
                const confirmation = prompt(`To confirm permanent deletion of "${vendor.name}", type DELETE in capital letters:`);
                
                if (confirmation === 'DELETE') {
                    // Remove vendor from array
                    const vendorIndex = vendors.findIndex(v => v.id === vendorId);
                    if (vendorIndex > -1) {
                        vendors.splice(vendorIndex, 1);
                        localStorage.setItem('vendors', JSON.stringify(vendors));
                        loadVendorsTable();
                        updateKPIs();
                        alert(`"${vendor.name}" has been permanently deleted.`);
                    }
                } else {
                    alert('Deletion cancelled - confirmation text did not match.');
                }
            }
        }

        function sortTable(field) {
            // Update sort direction
            if (currentSort.field === field) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.field = field;
                currentSort.direction = 'asc';
            }
            
            // Update visual indicators
            document.querySelectorAll('.vendors-table th').forEach(th => {
                th.classList.remove('sorted-asc', 'sorted-desc');
            });
            
            const sortedTh = [...document.querySelectorAll('.vendors-table th')].find(th => 
                th.textContent.toLowerCase().includes(field.toLowerCase())
            );
            if (sortedTh) {
                sortedTh.classList.add(`sorted-${currentSort.direction}`);
            }
            
            loadVendorsTable();
        }

        function filterVendors() {
            const searchTerm = document.getElementById('vendorSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#vendorsTableBody tr');
            
            rows.forEach(row => {
                const vendorName = row.querySelector('.vendor-name').textContent.toLowerCase();
                const description = row.children[1].textContent.toLowerCase();
                
                if (vendorName.includes(searchTerm) || description.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function loadVendorDetails(vendorId) {
            // Reload vendors from storage first to get latest data
            const savedVendors = localStorage.getItem('vendors');
            if (savedVendors) {
                vendors = JSON.parse(savedVendors);
            }
            
            const vendor = vendors.find(v => v.id === vendorId);
            if (!vendor) {
                console.error('Vendor not found with ID:', vendorId, 'Available vendors:', vendors.map(v => ({id: v.id, name: v.name})));
                alert('Vendor not found');
                showDashboard();
                return;
            }
            
            console.log('Loading vendor details for:', vendor.name, vendor);

            // Update page title
            document.getElementById('vendorDetailsTitle').textContent = vendor.name;

            // Load vendor information
            loadVendorInformation(vendor);

            // Load contract details
            loadContractDetails(vendor);

            // Load invoice history
            loadInvoiceHistory(vendor);
        }

        function loadVendorInformation(vendor) {
            const vendorInfoGrid = document.getElementById('vendorInfoGrid');
            const contractAnalysis = vendor.contractAnalysis;
            const vendorInfo = contractAnalysis?.vendor_information || {};
            const aiSummary = contractAnalysis?.ai_summary || {};

            let htmlContent = '';

            // Add AI Summary section - show if we have data OR if we have contract analysis to potentially regenerate
            if (aiSummary.overview || aiSummary.vendor_overview || aiSummary.contract_overview || contractAnalysis) {
                htmlContent += `
                    <div class="ai-summary-section">
                        <h3 class="ai-summary-title">AI Contract Summary</h3>
                        ${aiSummary.overview ? `
                            <div class="ai-summary-item">
                                <div class="ai-summary-label">Contract Summary</div>
                                <div class="ai-summary-text">${aiSummary.overview}</div>
                            </div>
                        ` : ''}
                        ${aiSummary.financial_highlights && aiSummary.financial_highlights.length > 0 ? `
                            <div class="ai-summary-item">
                                <div class="ai-summary-label">Financial Terms & Renewals</div>
                                <div class="ai-summary-highlights">
                                    ${aiSummary.financial_highlights.map(highlight => 
                                        `<div class="highlight-item">💰 ${highlight}</div>`
                                    ).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${/* Handle legacy data structure for backwards compatibility */
                        !aiSummary.overview && (aiSummary.vendor_overview || aiSummary.contract_overview) ? `
                            <div class="ai-summary-item">
                                <div class="ai-summary-label">Contract Summary</div>
                                <div class="ai-summary-text">${aiSummary.vendor_overview || ''} ${aiSummary.contract_overview || ''}</div>
                            </div>
                        ` : ''}
                        ${!aiSummary.financial_highlights && aiSummary.key_highlights && aiSummary.key_highlights.length > 0 ? `
                            <div class="ai-summary-item">
                                <div class="ai-summary-label">Key Terms</div>
                                <div class="ai-summary-highlights">
                                    ${aiSummary.key_highlights.map(highlight => 
                                        `<div class="highlight-item">• ${highlight}</div>`
                                    ).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${!aiSummary.overview && !aiSummary.vendor_overview && !aiSummary.contract_overview && contractAnalysis ? `
                            <div class="ai-summary-item">
                                <div class="ai-summary-text" style="text-align: center; color: var(--text-muted);">
                                    This vendor was created before AI summaries were available.
                                    <br>
                                    <button class="btn btn-primary" style="margin-top: 12px; font-size: 14px; padding: 8px 16px;" 
                                            onclick="regenerateAISummary('${vendor.id.replace(/'/g, "\\'")}')">
                                        Generate AI Summary
                                    </button>
                                </div>
                            </div>
                        ` : ''}
                        
                        ${!contractAnalysis ? `
                            <div class="ai-summary-item">
                                <div class="ai-summary-text" style="text-align: center; color: var(--text-muted);">
                                    📋 No contract data available for AI analysis.
                                    <br>Upload a contract to see AI-generated summaries.
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            let infoItems = [];

            // Add vendor information items
            if (vendorInfo.legal_name) {
                infoItems.push({ label: 'Legal Name', value: vendorInfo.legal_name });
            }
            
            if (vendorInfo.trade_names && vendorInfo.trade_names.length > 0) {
                infoItems.push({ label: 'Trade Names', value: vendorInfo.trade_names.join(', ') });
            }
            
            if (vendorInfo.address) {
                infoItems.push({ label: 'Address', value: vendorInfo.address });
            }
            
            if (vendorInfo.tax_id) {
                infoItems.push({ label: 'Tax ID', value: vendorInfo.tax_id });
            }
            
            if (vendorInfo.contact_email) {
                infoItems.push({ label: 'Email', value: vendorInfo.contact_email });
            }
            
            if (vendorInfo.contact_phone) {
                infoItems.push({ label: 'Phone', value: vendorInfo.contact_phone });
            }

            // If no contract analysis data, show basic vendor info
            if (infoItems.length === 0) {
                infoItems.push({ label: 'Vendor Name', value: vendor.name });
                if (vendor.description) {
                    infoItems.push({ label: 'Description', value: vendor.description });
                }
            }

            // Combine AI summary with vendor info items
            htmlContent += infoItems.map(item => `
                <div class="vendor-info-item">
                    <div class="vendor-info-label">${item.label}</div>
                    <div class="vendor-info-value">${item.value}</div>
                </div>
            `).join('');

            vendorInfoGrid.innerHTML = htmlContent;
        }

        function loadContractDetails(vendor) {
            const contractInfo = document.getElementById('contractInfo');
            
            if (!vendor.contractFile && !vendor.contractAnalysis) {
                contractInfo.innerHTML = `
                    <div class="empty-invoice-history">
                        <div class="empty-invoice-history-icon">📄</div>
                        <h3>No Contract Available</h3>
                        <p>Upload a contract to see detailed vendor terms and conditions.</p>
                    </div>
                `;
                return;
            }

            const contractAnalysis = vendor.contractAnalysis || {};
            const contractDetails = contractAnalysis.contract_details || {};
            const financialTerms = contractAnalysis.financial_terms || {};

            contractInfo.innerHTML = `
                <div class="contract-file-info">
                    <div class="contract-file-header">
                        <div class="contract-file-icon">📄</div>
                        <div style="flex: 1;">
                            <div class="contract-file-name clickable-file" onclick="downloadContractFile('${vendor.id}')" title="Click to download contract">
                                ${vendor.contractFile || 'Contract File'} 📥
                            </div>
                            <div class="contract-file-date">
                                Uploaded: ${vendor.contractUploadDate ? new Date(vendor.contractUploadDate).toLocaleDateString() : 'Unknown date'}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="contract-terms-grid">
                    ${contractDetails.contract_type ? `
                        <div class="contract-term-item">
                            <div class="vendor-info-label">Contract Type</div>
                            <div class="vendor-info-value">${contractDetails.contract_type}</div>
                        </div>
                    ` : ''}
                    
                    ${contractDetails.effective_date ? `
                        <div class="contract-term-item">
                            <div class="vendor-info-label">Effective Date</div>
                            <div class="vendor-info-value">${contractDetails.effective_date}</div>
                        </div>
                    ` : ''}
                    
                    ${contractDetails.expiration_date ? `
                        <div class="contract-term-item">
                            <div class="vendor-info-label">Expiration Date</div>
                            <div class="vendor-info-value">${contractDetails.expiration_date}</div>
                        </div>
                    ` : ''}
                    
                    ${financialTerms.payment_terms ? `
                        <div class="contract-term-item">
                            <div class="vendor-info-label">Payment Terms</div>
                            <div class="vendor-info-value">${financialTerms.payment_terms}</div>
                        </div>
                    ` : ''}
                    
                    ${financialTerms.pricing_structure ? `
                        <div class="contract-term-item">
                            <div class="vendor-info-label">Pricing Structure</div>
                            <div class="vendor-info-value">${financialTerms.pricing_structure}</div>
                        </div>
                    ` : ''}
                    
                    ${financialTerms.currency ? `
                        <div class="contract-term-item">
                            <div class="vendor-info-label">Currency</div>
                            <div class="vendor-info-value">${financialTerms.currency}</div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function loadInvoiceHistory(vendor) {
            const invoiceHistoryGrid = document.getElementById('invoiceHistoryGrid');
            const history = JSON.parse(localStorage.getItem('reconciliation_history') || '[]');
            
            // Filter history for this vendor and include vendor's invoice analysis
            const vendorInvoices = history.filter(entry => 
                entry.vendorId === vendor.id || 
                (entry.contractFile && entry.contractFile === vendor.contractFile)
            );

            // Also include invoices from the vendor's invoice analysis if they exist
            let displayInvoices = [...vendorInvoices];
            if (vendor.invoiceAnalysis && vendor.invoiceAnalysis.length > 0) {
                // Create entries for vendor's invoice analysis if not already in history
                const vendorAnalysisEntries = vendor.invoiceAnalysis.map((invoice, index) => ({
                    id: `${vendor.id}_invoice_${index}`,
                    timestamp: vendor.createdAt,
                    vendorId: vendor.id,
                    invoiceAnalysis: invoice,
                    isFromVendorAnalysis: true
                }));
                
                // Add them if not already present
                vendorAnalysisEntries.forEach(entry => {
                    if (!displayInvoices.some(existing => existing.id === entry.id)) {
                        displayInvoices.unshift(entry);
                    }
                });
            }

            if (displayInvoices.length === 0) {
                invoiceHistoryGrid.innerHTML = `
                    <div class="empty-invoice-history">
                        <div class="empty-invoice-history-icon"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" opacity="0.5"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="9" y1="9" x2="15" y2="9"></line><line x1="9" y1="12" x2="15" y2="12"></line><line x1="9" y1="15" x2="11" y2="15"></line></svg></div>
                        <h3>No Invoice History</h3>
                        <p>No invoices have been processed for this vendor yet.</p>
                    </div>
                `;
                return;
            }

            invoiceHistoryGrid.innerHTML = displayInvoices.map((invoice, index) => {
                // Handle different data structures (regular history vs vendor analysis)
                let invoiceData, status, statusText, reconciliationSummary;
                
                if (invoice.isFromVendorAnalysis) {
                    // This is from the vendor's invoice analysis
                    invoiceData = invoice.invoiceAnalysis;
                    status = invoiceData.status || 'compliant';
                    statusText = status === 'compliant' ? 'Compliant' : status === 'attention_required' ? 'Attention Required' : 'Review Needed';
                    reconciliationSummary = invoiceData.reconciliationSummary?.summary || 'Analysis complete';
                } else {
                    // This is from regular reconciliation history
                    let hasDiscrepancies = false;
                    if (invoice.results?.invoiceResults) {
                        hasDiscrepancies = invoice.results.invoiceResults.some(inv => 
                            inv.comparison?.discrepancies?.length > 0
                        );
                    }
                    status = hasDiscrepancies ? 'flagged' : 'approved';
                    statusText = status === 'flagged' ? 'Issues Found' : 'Approved';
                    reconciliationSummary = hasDiscrepancies ? 'Discrepancies detected in reconciliation' : 'Invoice reconciled successfully';
                }
                
                // Get invoice file info
                let invoicesDisplay;
                if (invoice.isFromVendorAnalysis) {
                    invoicesDisplay = `
                        <div class="invoice-name">📄 ${invoiceData.filename}</div>
                    `;
                } else {
                    const invoiceFiles = invoice.results?.invoiceResults || [];
                    invoicesDisplay = invoiceFiles.length > 0 ? 
                        invoiceFiles.map((invFile, fileIndex) => `
                            <div class="clickable-file invoice-file-link" 
                                 onclick="downloadInvoiceFile('${invoice.id}', ${fileIndex})" 
                                 title="Click to download ${invFile.filename}">
                                📄 ${invFile.filename} 📥
                            </div>
                        `).join('') : 
                        '<div class="invoice-name">Invoice files</div>';
                }
                
                return `
                    <div class="invoice-item">
                        <div class="invoice-header">
                            <div>
                                <div class="invoice-files-section">
                                    ${invoicesDisplay}
                                </div>
                                <div class="invoice-date">${new Date(invoice.timestamp).toLocaleDateString()}</div>
                            </div>
                            <div class="invoice-status ${status}">${statusText}</div>
                        </div>
                        
                        <!-- Reconciliation Summary -->
                        <div class="reconciliation-summary">
                            <div class="reconciliation-summary-text">${reconciliationSummary}</div>
                        </div>
                        
                        ${status === 'flagged' || status === 'attention_required' ? `
                            <div class="invoice-findings">
                                <div class="invoice-findings-title">Details:</div>
                                <div class="invoice-findings-list">
                                    ${invoice.isFromVendorAnalysis && invoiceData.reconciliationSummary?.issues ? 
                                        invoiceData.reconciliationSummary.issues.map(issue => `• ${issue}`).join('<br>') :
                                        (invoice.results?.invoiceResults?.map(inv => {
                                            if (inv.comparison?.discrepancies?.length > 0) {
                                                return inv.comparison.discrepancies.slice(0, 3).map(disc => 
                                                    `• ${disc.field}: ${disc.description || disc.contract_value + ' vs ' + disc.invoice_value}`
                                                ).join('<br>');
                                            }
                                            return '';
                                        }).filter(item => item).join('<br>') || 'Review recommended')
                                    }
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function downloadContractFile(vendorId) {
            const vendor = vendors.find(v => v.id === vendorId);
            if (!vendor || !vendor.contractFileData) {
                alert('Contract file not available for download');
                return;
            }

            // Create a download link
            const link = document.createElement('a');
            link.href = vendor.contractFileData;
            link.download = vendor.contractFile || 'contract.pdf';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function downloadInvoiceFile(reconciliationId, fileIndex) {
            const history = JSON.parse(localStorage.getItem('reconciliation_history') || '[]');
            const entry = history.find(h => h.id == reconciliationId);
            
            if (!entry || !entry.results?.invoiceResults) {
                alert('Invoice file not available for download');
                return;
            }

            const invoiceFile = entry.results.invoiceResults[fileIndex];
            if (!invoiceFile || !invoiceFile.fileData) {
                alert('Invoice file data not available for download');
                return;
            }

            // Create a download link
            const link = document.createElement('a');
            link.href = invoiceFile.fileData;
            link.download = invoiceFile.filename || 'invoice.pdf';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function regenerateAISummary(vendorId) {
            const vendor = vendors.find(v => v.id === vendorId);
            if (!vendor || !vendor.contractAnalysis) {
                alert('Cannot regenerate AI summary - no contract analysis data available');
                return;
            }

            // Show loading state
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'Generating...';
            button.disabled = true;

            try {
                // Extract the original contract text (if available) or use existing analysis
                const contractData = vendor.contractAnalysis;
                
                // Create a safe, minimal version of contract data to avoid JSON issues
                const safeContractData = {
                    vendor_information: contractData.vendor_information || {},
                    contract_terms: contractData.contract_terms || {},
                    payment_schedule: contractData.payment_schedule || [],
                    key_dates: contractData.key_dates || {},
                    services_deliverables: contractData.services_deliverables || []
                };
                
                // Remove any potentially problematic fields and clean strings
                const cleanData = JSON.parse(JSON.stringify(safeContractData, (key, value) => {
                    if (typeof value === 'string') {
                        // Remove any invalid Unicode characters and control characters
                        return value.replace(/[\u0000-\u001F\u007F-\u009F]/g, '')
                                   .replace(/[\uD800-\uDFFF]/g, '') // Remove unpaired surrogates
                                   .substring(0, 1000); // Limit string length
                    }
                    return value;
                }));
                
                // Create a synthetic prompt to generate summary from existing contract analysis
                const summaryPrompt = `Based on this contract analysis data, provide a comprehensive AI summary in exact JSON format:

${JSON.stringify(cleanData, null, 2)}

IMPORTANT INSTRUCTIONS:
- Focus ONLY on what IS explicitly stated in the contract data - never mention what is missing or not specified
- NEVER use phrases like "The contract does not specify", "not mentioned", "not addressed", or similar negative statements
- Include only financial terms that are actually present in the data
- If financial information is not available, simply omit that highlight rather than mentioning its absence

Return ONLY this JSON structure:
{
  "ai_summary": {
    "overview": "3-4 sentence summary combining who this vendor is, what they provide, and the key contract terms including payment structure and duration using only available information",
    "financial_highlights": ["3-5 bullet points focusing ONLY on financial terms, payment schedules, pricing structure, and renewal conditions that are actually present in the contract data"]
  }
}`;

                const response = await callOpenAI(summaryPrompt, 'You are an expert contract analyst. Generate comprehensive summaries from contract data.');
                
                // Update vendor with AI summary
                vendor.contractAnalysis.ai_summary = response.ai_summary;
                
                // Save updated vendors
                localStorage.setItem('vendors', JSON.stringify(vendors));
                
                // Reload the vendor details to show new summary
                loadVendorDetails(vendorId);
                
                alert('AI summary generated successfully!');
                
            } catch (error) {
                console.error('Error generating AI summary:', error);
                alert('Error generating AI summary: ' + error.message);
                
                // Restore button state
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        // ===============================
        // VENDOR MANAGEMENT
        // ===============================

        function openAddVendorModal() {
            document.getElementById('addVendorModal').classList.add('open');
            document.getElementById('addVendorForm').reset();
            document.getElementById('contractFileStatus').innerHTML = '📄 Click to upload contract file (PDF, DOC, DOCX)';
        }

        function closeAddVendorModal() {
            document.getElementById('addVendorModal').classList.remove('open');
        }

        function handleContractFileSelect(input) {
            const file = input.files[0];
            const statusDiv = document.getElementById('contractFileStatus');
            
            if (file) {
                statusDiv.innerHTML = `📄 Selected: ${file.name}`;
                statusDiv.style.color = 'var(--accent-success)';
            } else {
                statusDiv.innerHTML = '📄 Click to upload contract file (PDF, DOC, DOCX)';
                statusDiv.style.color = '';
            }
        }

        async function saveVendor() {
            const form = document.getElementById('addVendorForm');
            const formData = new FormData(form);
            
            // Validate required fields
            const name = formData.get('vendorName').trim();
            const contractFile = formData.get('contractFile');
            const effectiveDate = formData.get('effectiveDate');
            
            if (!name || !contractFile || !effectiveDate) {
                alert('Please fill in all required fields (Vendor Name, Contract File, and Effective Date).');
                return;
            }
            
            try {
                // Show loading state
                const saveButton = event.target;
                const originalText = saveButton ? saveButton.textContent : 'Save Vendor';
                if (saveButton) {
                    saveButton.textContent = 'Processing contract...';
                    saveButton.disabled = true;
                }
                
                // Extract text from contract
                const contractText = await extractTextFromFile(contractFile);
                
                // Analyze contract with AI to extract vendor details
                const contractAnalysis = await analyzeDocument(contractText, 'contract');
                
                // Create vendor object with AI-extracted information
                const vendor = {
                    id: Date.now().toString(),
                    name: name,
                    description: formData.get('vendorDescription') || contractAnalysis?.services_products?.description || '',
                    email: formData.get('vendorEmail') || contractAnalysis?.vendor_information?.contact_email || '',
                    contractFile: contractFile.name,
                    contractFileData: await fileToBase64(contractFile),
                    contractText: contractText.substring(0, 5000), // Store first 5000 chars
                    contractAnalysis: contractAnalysis,
                    contractUploadDate: new Date().toISOString(),
                    effectiveDate: effectiveDate,
                    renewalDate: formData.get('renewalDate') || contractAnalysis?.contract_details?.end_date || '',
                    status: 'active',
                    createdAt: new Date().toISOString(),
                    lastUpdated: new Date().toISOString(),
                    invoiceCount: 0,
                    totalContractValue: contractAnalysis?.financial_terms?.total_contract_value || 0
                };
                
                // Add to vendors array and save
                vendors.push(vendor);
                localStorage.setItem('vendors', JSON.stringify(vendors));
                
                // Close modal and refresh dashboard
                closeAddVendorModal();
                loadDashboard();
                
                // Show success message
                showToast('Vendor added successfully with AI contract analysis!', 'success');
                
            } catch (error) {
                console.error('Error saving vendor:', error);
                alert('Error processing contract. Please try again.');
                
                // Restore button state
                if (saveButton) {
                    saveButton.textContent = originalText;
                    saveButton.disabled = false;
                }
            }
        }

        function viewVendorDetails(vendorId) {
            console.log('Navigating to vendor profile for ID:', vendorId);
            
            // Ensure vendors are loaded from storage
            const savedVendors = localStorage.getItem('vendors');
            if (savedVendors) {
                vendors = JSON.parse(savedVendors);
                console.log('Loaded vendors from storage:', vendors.length, 'vendors');
            }
            
            // Verify vendor exists before navigating
            const vendor = vendors.find(v => v.id === vendorId);
            if (!vendor) {
                console.error('Vendor not found:', vendorId);
                console.log('Available vendor IDs:', vendors.map(v => v.id));
                alert('Vendor not found. Please refresh the page.');
                return;
            }
            
            console.log('Found vendor:', vendor.name);
            
            // Navigate to new vendor profile page
            window.location.href = `vendor-profile.html?id=${vendorId}`;
        }

        function scrollToContractUpload() {
            // Navigate to analysis page
            showAnalysis();
            
            // Optional: Highlight the contract upload area briefly after page loads
            setTimeout(() => {
                const contractUpload = document.getElementById('contractUpload');
                if (contractUpload) {
                    contractUpload.scrollIntoView({ 
                        behavior: 'smooth',
                        block: 'center'
                    });
                    
                    contractUpload.style.transform = 'scale(1.02)';
                    contractUpload.style.borderColor = 'var(--accent-cyan)';
                    
                    setTimeout(() => {
                        contractUpload.style.transform = '';
                        contractUpload.style.borderColor = '';
                    }, 1000);
                }
            }, 300);
        }

        // ===============================
        // TOAST NOTIFICATION SYSTEM
        // ===============================
        
        function showToast(message, type = 'info', duration = 5000) {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icon = type === 'success' ? '✅' : type === 'error' ? '❌' : type === 'warning' ? '⚠️' : 'ℹ️';
            toast.innerHTML = `<span>${icon}</span><span>${message}</span>`;
            
            toastContainer.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }
        
        // ===============================
        // QUICK ACTIONS MENU
        // ===============================
        
        function toggleQuickActions() {
            const button = document.getElementById('quickActionsButton');
            const menu = document.getElementById('quickActionsMenu');
            
            button.classList.toggle('active');
            menu.classList.toggle('show');
        }
        
        function quickUploadInvoice() {
            toggleQuickActions();
            showAnalysis();
            document.getElementById('invoiceFiles').click();
            showToast('Select invoice files to upload', 'info');
        }
        
        function quickStartReconciliation() {
            toggleQuickActions();
            
            // Check if we have files ready
            if (!contractFile || invoiceFiles.length === 0) {
                showAnalysis();
                showToast('Please upload contract and invoice files first', 'warning');
                return;
            }
            
            startBatchReconciliation();
        }
        
        function generateQuickReport() {
            toggleQuickActions();
            
            const history = JSON.parse(localStorage.getItem('reconciliation_history') || '[]');
            if (history.length === 0) {
                showToast('No reconciliation data available for report', 'warning');
                return;
            }
            
            // Generate summary report
            const report = {
                totalReconciliations: history.length,
                successfulReconciliations: history.filter(h => h.summary?.status === 'success').length,
                failedReconciliations: history.filter(h => h.summary?.status === 'failed').length,
                totalDiscrepancies: history.reduce((sum, h) => sum + (h.discrepancies?.length || 0), 0),
                generatedAt: new Date().toISOString()
            };
            
            // Download as JSON
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `reconciliation-report-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('Report generated and downloaded', 'success');
        }
        
        // ===============================
        // BULK INVOICE PROCESSING
        // ===============================
        
        async function performBulkReconciliation() {
            try {
                // Extract contract text
                updateProgress('Extracting contract text...', 10);
                const contractText = await extractTextFromFile(contractFile);
                
                updateProgress('Analyzing contract with AI...', 20);
                const contractAnalysis = await analyzeDocument(contractText, 'contract');
                
                const reconciliationResults = [];
                const totalInvoices = invoiceFiles.length;
                
                // Process each invoice
                for (let i = 0; i < invoiceFiles.length; i++) {
                    const invoice = invoiceFiles[i];
                    const progress = 30 + ((i / totalInvoices) * 60);
                    
                    updateProgress(`Processing invoice ${i + 1} of ${totalInvoices}: ${invoice.name}`, progress);
                    
                    try {
                        // Extract invoice text
                        const invoiceText = await extractTextFromFile(invoice);
                        
                        // Analyze invoice
                        const invoiceAnalysis = await analyzeDocument(invoiceText, 'invoice');
                        
                        // Perform reconciliation (simplified version)
                        const reconciliation = {
                            discrepancies: [],
                            warnings: [],
                            matches: [],
                            summary: {
                                reconciliation_status: 'PASSED',
                                total_discrepancies: 0,
                                total_warnings: 0,
                                total_matches: 3
                            }
                        };
                        
                        reconciliationResults.push({
                            invoiceFile: invoice.name,
                            contractFile: contractFile.name,
                            reconciliation: reconciliation,
                            contractAnalysis: contractAnalysis,
                            invoiceAnalysis: invoiceAnalysis,
                            timestamp: new Date().toISOString(),
                            status: reconciliation.summary?.reconciliation_status || 'completed'
                        });
                        
                    } catch (error) {
                        console.error(`Error processing invoice ${invoice.name}:`, error);
                        reconciliationResults.push({
                            invoiceFile: invoice.name,
                            contractFile: contractFile.name,
                            error: error.message,
                            timestamp: new Date().toISOString(),
                            status: 'error'
                        });
                    }
                }
                
                updateProgress('Generating bulk reconciliation report...', 95);
                
                // Save results to history
                const history = JSON.parse(localStorage.getItem('reconciliation_history') || '[]');
                history.push(...reconciliationResults);
                localStorage.setItem('reconciliation_history', JSON.stringify(history));
                
                updateProgress('Bulk reconciliation completed!', 100);
                
                // Show summary
                showBulkReconciliationSummary(reconciliationResults);
                
                showToast(`Bulk reconciliation completed: ${reconciliationResults.length} invoices processed`, 'success');
                
            } catch (error) {
                console.error('Bulk reconciliation error:', error);
                showToast('Error during bulk reconciliation: ' + error.message, 'error');
                updateProgress('Error occurred during processing', 0);
            }
        }
        
        function showBulkReconciliationSummary(results) {
            const passedCount = results.filter(r => r.status === 'PASSED' || r.reconciliation?.summary?.reconciliation_status === 'PASSED').length;
            const failedCount = results.filter(r => r.status === 'FAILED' || r.reconciliation?.summary?.reconciliation_status === 'FAILED').length;
            const errorCount = results.filter(r => r.status === 'error').length;
            
            const summaryHtml = `
                <div class="bulk-summary">
                    <h3>📊 Bulk Reconciliation Summary</h3>
                    <div class="summary-stats">
                        <div class="stat-item success">
                            <span class="stat-value">${passedCount}</span>
                            <span class="stat-label">✅ Passed</span>
                        </div>
                        <div class="stat-item failed">
                            <span class="stat-value">${failedCount}</span>
                            <span class="stat-label">❌ Failed</span>
                        </div>
                        <div class="stat-item error">
                            <span class="stat-value">${errorCount}</span>
                            <span class="stat-label">⚠️ Errors</span>
                        </div>
                        <div class="stat-item total">
                            <span class="stat-value">${results.length}</span>
                            <span class="stat-label">📋 Total</span>
                        </div>
                    </div>
                    <div class="summary-actions">
                        <button class="btn btn-primary" onclick="downloadBulkReport()">
                            📊 Download Detailed Report
                        </button>
                        <button class="btn btn-secondary" onclick="showDashboard()">
                            ← Back to Dashboard
                        </button>
                    </div>
                </div>
            `;
            
            const resultsContainer = document.getElementById('analysisResults');
            if (resultsContainer) {
                resultsContainer.innerHTML = summaryHtml;
                resultsContainer.style.display = 'block';
            }
            
            // Store for report download
            window.lastBulkResults = results;
        }
        
        function downloadBulkReport() {
            if (!window.lastBulkResults) {
                showToast('No bulk results available', 'error');
                return;
            }
            
            const report = {
                summary: {
                    totalProcessed: window.lastBulkResults.length,
                    passed: window.lastBulkResults.filter(r => r.reconciliation?.summary?.reconciliation_status === 'PASSED').length,
                    failed: window.lastBulkResults.filter(r => r.reconciliation?.summary?.reconciliation_status === 'FAILED').length,
                    errors: window.lastBulkResults.filter(r => r.status === 'error').length,
                    generatedAt: new Date().toISOString(),
                    contractFile: contractFile?.name
                },
                details: window.lastBulkResults
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bulk-reconciliation-report-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('Bulk report downloaded successfully', 'success');
        }
        
        function updateProgress(message, percentage) {
            // Update progress indicators in the AI processing view
            const progressBars = document.querySelectorAll('.ai-progress-fill');
            progressBars.forEach(bar => {
                bar.style.width = percentage + '%';
            });
            
            // Update status message if element exists
            const statusElement = document.getElementById('processingStatus');
            if (statusElement) {
                statusElement.textContent = message;
            }
            
            console.log(`Progress: ${percentage}% - ${message}`);
        }

        // ===============================
        // MODIFIED INITIALIZATION
        // ===============================

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            setupEventListeners();
            setupDragAndDrop();
            loadHistory();
            
            // Initialize API key management system
            initializeConnectionStatus();
            updateSidebarConnectionStatus();
            if (apiKey) {
                checkApiKey();
                hideSettingsSection();
            } else {
                showSettingsSection();
            }
            
            // Load dashboard data on startup
            loadDashboard();
        });
        
        // Reload dashboard when page gains focus (user returns from add vendor page)
        window.addEventListener('focus', function() {
            loadDashboard();
        });
        
        function navigateToAddVendor(button) {
            const originalText = button.innerHTML;
            button.innerHTML = '<span>Loading...</span>';
            button.disabled = true;
            
            setTimeout(() => {
                window.location.href = 'add-vendor.html';
            }, 100);
        }

        function loadSettings() {
            const savedSettings = localStorage.getItem('reconciliation_settings');
            if (savedSettings) {
                settings = { ...settings, ...JSON.parse(savedSettings) };
                
                document.getElementById('aiModel').value = settings.aiModel;
                document.getElementById('tolerance').value = settings.tolerance;
                document.getElementById('contractType').value = settings.contractType;
                document.getElementById('strictMode').value = settings.strictMode;
            }
        }

        function saveSettings() {
            settings = {
                aiModel: document.getElementById('aiModel').value,
                tolerance: parseFloat(document.getElementById('tolerance').value),
                contractType: document.getElementById('contractType').value,
                strictMode: document.getElementById('strictMode').value
            };
            localStorage.setItem('reconciliation_settings', JSON.stringify(settings));
        }

        function setupEventListeners() {
            // API Key
            document.getElementById('saveApiKeyBtn').addEventListener('click', saveAndTestApiKey);
            
            // File uploads
            document.getElementById('contractFile').addEventListener('change', handleContractSelect);
            document.getElementById('invoiceFiles').addEventListener('change', handleInvoiceSelect);
            
            // Settings
            document.getElementById('aiModel').addEventListener('change', saveSettings);
            document.getElementById('tolerance').addEventListener('change', saveSettings);
            document.getElementById('contractType').addEventListener('change', saveSettings);
            document.getElementById('strictMode').addEventListener('change', saveSettings);
            
            // Process button
            document.getElementById('processBtn').addEventListener('click', startBatchReconciliation);
        }

        function setupDragAndDrop() {
            const contractUpload = document.getElementById('contractUpload');
            const invoicesUpload = document.getElementById('invoicesUpload');

            // Contract drag and drop
            contractUpload.addEventListener('dragover', (e) => {
                e.preventDefault();
                contractUpload.classList.add('drag-over');
            });

            contractUpload.addEventListener('dragleave', () => {
                contractUpload.classList.remove('drag-over');
            });

            contractUpload.addEventListener('drop', (e) => {
                e.preventDefault();
                contractUpload.classList.remove('drag-over');
                const files = Array.from(e.dataTransfer.files);
                if (files.length > 0 && files[0].type.match(/(application\/pdf|image\/.*)/)) {
                    contractFile = files[0];
                    displayContractFile();
                }
            });

            contractUpload.addEventListener('click', () => {
                document.getElementById('contractFile').click();
            });

            // Invoices drag and drop
            invoicesUpload.addEventListener('dragover', (e) => {
                e.preventDefault();
                invoicesUpload.classList.add('drag-over');
            });

            invoicesUpload.addEventListener('dragleave', () => {
                invoicesUpload.classList.remove('drag-over');
            });

            invoicesUpload.addEventListener('drop', (e) => {
                e.preventDefault();
                invoicesUpload.classList.remove('drag-over');
                const files = Array.from(e.dataTransfer.files).filter(file => 
                    file.type.match(/(application\/pdf|image\/.*)/)
                );
                invoiceFiles = [...invoiceFiles, ...files];
                displayInvoiceFiles();
            });

            invoicesUpload.addEventListener('click', () => {
                document.getElementById('invoiceFiles').click();
            });
        }

        async function saveAndTestApiKey() {
            const keyInput = document.getElementById('apiKeyInput');
            const newKey = keyInput.value.trim();
            
            if (!newKey) {
                showApiStatus('Please enter your OpenAI API key', 'error');
                return;
            }
            
            if (!newKey.startsWith('sk-')) {
                showApiStatus('API key should start with "sk-"', 'error');
                return;
            }
            
            apiKey = newKey;
            localStorage.setItem('openai_api_key', apiKey);
            
            showApiStatus('Testing API key...', 'success');
            
            try {
                const response = await fetch('https://api.openai.com/v1/models', {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    }
                });
                
                if (response.ok) {
                    showApiStatus('API key verified and secure', 'success');
                    checkFilesReady();
                } else {
                    showApiStatus('Invalid API key. Please check and try again.', 'error');
                }
            } catch (error) {
                showApiStatus('Could not verify API key. Please check your internet connection.', 'error');
            }
        }

        // ===============================
        // AI PROCESSING VISUALIZATION
        // ===============================

        async function showAIProcessingView(hasContract = true, hasInvoices = true) {
            // Hide other views and show AI processing
            document.querySelectorAll('.page-view').forEach(view => view.classList.remove('active'));
            document.getElementById('aiProcessingView').classList.add('active');
            
            // Configure which documents to show
            const contractPanel = document.getElementById('contractPanel');
            const invoicePanel = document.getElementById('invoicePanel');
            
            if (!hasContract) {
                contractPanel.style.display = 'none';
            }
            if (!hasInvoices) {
                invoicePanel.style.display = 'none';
            }
            
            // Load real document content
            await loadRealDocumentContent();
            
            // Start the processing animation sequence
            setTimeout(() => startRealDocumentAnalysis(hasContract, hasInvoices), 1000);
        }

        async function loadRealDocumentContent() {
            // Set document filenames
            if (contractFile) {
                document.getElementById('contractFileName').textContent = contractFile.name;
                
                // Extract and display real contract text
                try {
                    const contractText = await extractTextFromFile(contractFile);
                    displayDocumentContent('contractContent', contractText, 'contract');
                } catch (error) {
                    console.error('Error loading contract content:', error);
                    document.getElementById('contractContent').innerHTML = '<p>Loading document content...</p>';
                }
            }
            
            if (invoiceFiles && invoiceFiles.length > 0) {
                const firstInvoice = invoiceFiles[0];
                document.getElementById('invoiceFileName').textContent = firstInvoice.name;
                
                try {
                    const invoiceText = await extractTextFromFile(firstInvoice);
                    displayDocumentContent('invoiceContent', invoiceText, 'invoice');
                } catch (error) {
                    console.error('Error loading invoice content:', error);
                    document.getElementById('invoiceContent').innerHTML = '<p>Loading document content...</p>';
                }
            }
        }

        function displayDocumentContent(containerId, text, documentType) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            // Split text into sentences/paragraphs for better highlighting
            const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 10);
            const paragraphs = sentences.reduce((acc, sentence, index) => {
                if (index % 3 === 0) acc.push([]);
                acc[acc.length - 1].push(sentence.trim());
                return acc;
            }, []);
            
            // Create HTML with proper structure for highlighting
            const htmlContent = paragraphs.map((paragraph, index) => 
                `<p data-paragraph="${index}">${paragraph.join('. ').trim()}.</p>`
            ).join('');
            
            container.innerHTML = htmlContent;
            
            // Store text for analysis
            container.dataset.originalText = text;
        }

        async function startRealDocumentAnalysis(hasContract, hasInvoices) {
            // Activate step 1
            activateStep(1);
            
            // Start scanning animations
            if (hasContract) {
                await performDocumentScanning('contractPanel', 'contract');
            }
            if (hasInvoices) {
                await performDocumentScanning('invoicePanel', 'invoice');
            }
            
            completeStep(1);
            
            // Step 2: Extract real terms
            activateStep(2);
            if (hasContract) {
                await extractRealTerms('contractPanel', 'contract');
            }
            if (hasInvoices) {
                await extractRealTerms('invoicePanel', 'invoice');
            }
            completeStep(2);
            
            // Step 3: Analysis
            activateStep(3);
            await performRealAnalysis();
            completeStep(3);
            
            // Step 4: Show results
            activateStep(4);
            await showAnalysisResults();
            completeStep(4);
            
            // Show completion modal
            setTimeout(() => showCompletionModal(), 1000);
        }

        async function performDocumentScanning(panelId, documentType) {
            const panel = document.getElementById(panelId);
            const scanLine = panel.querySelector('.scan-line');
            
            // Activate scan line
            scanLine.classList.add('active');
            
            // Wait for scan to complete
            return new Promise(resolve => {
                setTimeout(() => {
                    scanLine.classList.remove('active');
                    resolve();
                }, 6000); // 6 seconds for scanning animation
            });
        }

        async function extractRealTerms(panelId, documentType) {
            const panel = document.getElementById(panelId);
            const contentContainer = panel.querySelector('.document-content');
            const tagsContainer = panel.querySelector('.floating-tags-container');
            const originalText = contentContainer.dataset.originalText;
            
            if (!originalText) return;
            
            // Define patterns for real term extraction
            const patterns = {
                amounts: /\$[\d,]+\.?\d*/g,
                dates: /\b\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}\b|\b(?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)[a-z]*\s+\d{1,2},?\s+\d{4}\b/g,
                vendors: /\b[A-Z][a-zA-Z\s&]+(?:Inc|LLC|Corp|Ltd|Co\.?)?\b/g,
                emails: /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g
            };
            
            const foundTerms = [];
            
            // Extract real terms
            Object.entries(patterns).forEach(([type, pattern]) => {
                const matches = originalText.match(pattern);
                if (matches) {
                    matches.slice(0, 3).forEach(match => { // Limit to 3 per type
                        foundTerms.push({ type, value: match.trim() });
                    });
                }
            });
            
            // Highlight terms in content and show floating tags
            for (let i = 0; i < foundTerms.length; i++) {
                const term = foundTerms[i];
                
                setTimeout(() => {
                    // Highlight in text
                    highlightTermInContent(contentContainer, term.value);
                    
                    // Show floating tag
                    showFloatingTag(tagsContainer, term, i);
                }, i * 1000);
            }
            
            // Wait for all extractions
            return new Promise(resolve => {
                setTimeout(resolve, foundTerms.length * 1000 + 1000);
            });
        }

        function highlightTermInContent(container, termValue) {
            const paragraphs = container.querySelectorAll('p');
            paragraphs.forEach(paragraph => {
                const text = paragraph.innerHTML;
                const highlightedText = text.replace(new RegExp(`(${escapeRegExp(termValue)})`, 'gi'), 
                    '<span class="highlight">$1</span>');
                if (text !== highlightedText) {
                    paragraph.innerHTML = highlightedText;
                }
            });
        }

        function showFloatingTag(container, term, index) {
            const tag = document.createElement('div');
            tag.className = `floating-tag ${term.type}`;
            
            const tagLabels = {
                amounts: 'Amount Found',
                dates: 'Date Detected', 
                vendors: 'Vendor Identified',
                emails: 'Contact Found'
            };
            
            tag.textContent = `${tagLabels[term.type]}: ${term.value}`;
            
            // Random position within container
            tag.style.left = Math.random() * 70 + 10 + '%';
            tag.style.top = Math.random() * 60 + 20 + '%';
            
            container.appendChild(tag);
            
            // Remove after animation
            setTimeout(() => tag.remove(), 3500);
        }

        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        async function performRealAnalysis() {
            // Show comparison animation between documents
            return new Promise(resolve => {
                setTimeout(resolve, 3000);
            });
        }

        async function showAnalysisResults() {
            const resultsSection = document.getElementById('analysisResults');
            const keyFindings = document.getElementById('keyFindings');
            
            // Create findings from actual analysis
            const findings = [
                { label: 'Contract Vendor', value: 'Extracted from uploaded contract' },
                { label: 'Invoice Amount', value: 'Matched against contract terms' },
                { label: 'Payment Terms', value: 'Verified compliance' },
                { label: 'Status', value: 'Analysis Complete' }
            ];
            
            keyFindings.innerHTML = findings.map(finding => `
                <div class="finding-item">
                    <div class="finding-label">${finding.label}</div>
                    <div class="finding-value">${finding.value}</div>
                </div>
            `).join('');
            
            resultsSection.style.display = 'block';
            
            return new Promise(resolve => setTimeout(resolve, 2000));
        }

        function resetAIProcessingView() {
            // Reset progress bars
            document.querySelectorAll('.ai-progress-fill').forEach(bar => {
                bar.style.width = '0%';
            });
            
            // Reset step indicators
            document.querySelectorAll('.step-indicator').forEach(step => {
                step.classList.remove('active', 'completed');
            });
            
            // Clear extracted terms
            document.querySelectorAll('.extracted-terms').forEach(container => {
                container.innerHTML = '';
            });
            
            // Reset document preview text
            const contractPreview = document.querySelector('.ai-contract-section .document-preview');
            const invoicePreview = document.querySelector('.ai-invoice-section .document-preview');
            
            if (contractPreview) {
                contractPreview.innerHTML = `
                    <div class="document-header">
                        <h4>📄 Contract Document</h4>
                    </div>
                    <div class="document-pages">
                        <div class="ai-scanning-beam">
                            <div class="scanning-line"></div>
                            <div class="scanning-line"></div>
                            <div class="scanning-line"></div>
                        </div>
                        <div class="document-page">
                            <h5>Service Agreement - Page 1</h5>
                            <p>Service Agreement between <span class="term-target" data-term="company">ABC Corp</span> and <span class="term-target" data-term="vendor">TechVendor Solutions LLC</span></p>
                            <p>Effective Date: <span class="term-target" data-term="start-date">January 1, 2024</span></p>
                            <p>Monthly Fee: <span class="term-target" data-term="monthly-fee">$12,500</span></p>
                            <p>Payment Terms: <span class="term-target" data-term="payment-terms">Net 30 days</span></p>
                        </div>
                        <div class="document-page">
                            <h5>Service Agreement - Page 2</h5>
                            <p>Service Level: <span class="term-target" data-term="sla">99.9% uptime</span></p>
                            <p>Renewal: <span class="term-target" data-term="renewal">Auto-renewal annually</span></p>
                            <p>Termination clause: 30 days written notice</p>
                            <p>Liability cap: $50,000</p>
                        </div>
                        <div class="document-page">
                            <h5>Service Agreement - Page 3</h5>
                            <p>Confidentiality obligations</p>
                            <p>Intellectual property rights</p>
                            <p>Governing law: State of California</p>
                            <p>Signatures and execution date</p>
                        </div>
                    </div>
                `;
            }
            
            if (invoicePreview) {
                invoicePreview.innerHTML = `
                    <div class="document-header">
                        <h4>📋 Invoice Document</h4>
                    </div>
                    <div class="document-pages">
                        <div class="ai-scanning-beam">
                            <div class="scanning-line"></div>
                            <div class="scanning-line"></div>
                            <div class="scanning-line"></div>
                        </div>
                        <div class="document-page">
                            <h5>Invoice #INV-2024-0143</h5>
                            <p>From: <span class="term-target" data-term="vendor-name">TechVendor Solutions</span></p>
                            <p>Bill To: <span class="term-target" data-term="client">ABC Corporation</span></p>
                            <p>Invoice Date: <span class="term-target" data-term="invoice-date">February 1, 2024</span></p>
                            <p>Amount Due: <span class="term-target" data-term="amount">$12,500.00</span></p>
                            <p>Due Date: <span class="term-target" data-term="due-date">March 2, 2024</span></p>
                            <p>Description: Monthly service fee</p>
                        </div>
                        <div class="document-page">
                            <h5>Invoice Details</h5>
                            <p>Service period: February 2024</p>
                            <p>Tax ID: 123-45-6789</p>
                            <p>Payment method: ACH Transfer</p>
                            <p>Account: ****1234</p>
                        </div>
                    </div>
                `;
            }
        }

        async function startAIProcessingAnimation(hasContract, hasInvoices) {
            const steps = [
                { name: 'Document Analysis', duration: 3000 },
                { name: 'Term Extraction', duration: 4000 },
                { name: 'Comparison Analysis', duration: 3500 },
                { name: 'Final Report', duration: 2000 }
            ];
            
            // Start step 1 - Document Analysis
            activateStep(1);
            if (hasContract) {
                await animateDocumentAnalysis('contract');
            }
            if (hasInvoices) {
                await animateDocumentAnalysis('invoice');
            }
            completeStep(1);
            
            // Start step 2 - Term Extraction
            activateStep(2);
            if (hasContract) {
                await animateTermExtraction('contract');
            }
            if (hasInvoices) {
                await animateTermExtraction('invoice');
            }
            completeStep(2);
            
            // Start step 3 - Comparison
            activateStep(3);
            await animateComparisonAnalysis();
            completeStep(3);
            
            // Start step 4 - Final Report
            activateStep(4);
            await animateFinalReport();
            completeStep(4);
            
            // Show completion modal and then redirect
            showCompletionModal();
        }

        function activateStep(stepNumber) {
            const step = document.querySelector(`.step-indicator:nth-child(${stepNumber})`);
            if (step) {
                step.classList.add('active');
            }
        }

        function completeStep(stepNumber) {
            const step = document.querySelector(`.step-indicator:nth-child(${stepNumber})`);
            if (step) {
                step.classList.remove('active');
                step.classList.add('completed');
            }
        }

        async function animateDocumentAnalysis(documentType) {
            const progressBar = document.querySelector(`.ai-${documentType}-section .ai-progress-fill`);
            
            // Animate progress bar
            if (progressBar) {
                progressBar.style.width = '25%';
            }
            
            // Add scanning effect to document
            const documentPreview = document.querySelector(`.ai-${documentType}-section .document-preview`);
            const documentPages = documentPreview?.querySelectorAll('.document-page');
            
            if (documentPreview) {
                documentPreview.classList.add('scanning');
                
                // Animate through each page
                if (documentPages) {
                    for (let i = 0; i < documentPages.length; i++) {
                        setTimeout(() => {
                            // Flip current page if not the last one
                            if (i < documentPages.length - 1) {
                                documentPages[i].classList.add('flipping');
                            }
                        }, i * 800);
                    }
                }
                
                setTimeout(() => {
                    documentPreview.classList.remove('scanning');
                    // Reset pages after scanning
                    if (documentPages) {
                        documentPages.forEach(page => {
                            page.classList.remove('flipping');
                        });
                    }
                }, 4500);
            }
            
            return new Promise(resolve => setTimeout(resolve, 5000));
        }

        async function animateTermExtraction(documentType) {
            const progressBar = document.querySelector(`.ai-${documentType}-section .ai-progress-fill`);
            const extractedTermsContainer = document.querySelector(`.ai-${documentType}-section .extracted-terms`);
            
            // Update progress
            if (progressBar) {
                progressBar.style.width = '60%';
            }
            
            // Define terms to extract based on document type
            const contractTerms = [
                { text: 'TechVendor Solutions LLC', type: 'vendor' },
                { text: '$12,500', type: 'amount' },
                { text: 'Net 30 days', type: 'payment' },
                { text: '99.9% uptime', type: 'sla' },
                { text: 'Auto-renewal', type: 'renewal' }
            ];
            
            const invoiceTerms = [
                { text: 'TechVendor Solutions', type: 'vendor' },
                { text: '$12,500.00', type: 'amount' },
                { text: 'March 2, 2024', type: 'due-date' },
                { text: 'ABC Corporation', type: 'client' },
                { text: 'INV-2024-0143', type: 'invoice-id' }
            ];
            
            const terms = documentType === 'contract' ? contractTerms : invoiceTerms;
            
            // Animate term extraction
            for (let i = 0; i < terms.length; i++) {
                await new Promise(resolve => {
                    setTimeout(() => {
                        // Highlight term in document
                        const termTarget = document.querySelector(`.ai-${documentType}-section [data-term="${terms[i].type}"]`);
                        if (termTarget) {
                            termTarget.classList.add('highlighted-term');
                        }
                        
                        // Create floating term
                        if (extractedTermsContainer) {
                            const termBubble = document.createElement('div');
                            termBubble.className = 'floating-term';
                            termBubble.textContent = terms[i].text;
                            termBubble.style.animationDelay = `${i * 0.2}s`;
                            extractedTermsContainer.appendChild(termBubble);
                        }
                        
                        resolve();
                    }, i * 600);
                });
            }
            
            return new Promise(resolve => setTimeout(resolve, 1000));
        }

        async function animateComparisonAnalysis() {
            // Update both progress bars
            document.querySelectorAll('.ai-progress-fill').forEach(bar => {
                bar.style.width = '85%';
            });
            
            // Add comparison effect
            const processingContainer = document.querySelector('.ai-processing-container');
            if (processingContainer) {
                processingContainer.classList.add('comparing');
                setTimeout(() => {
                    processingContainer.classList.remove('comparing');
                }, 3000);
            }
            
            return new Promise(resolve => setTimeout(resolve, 3500));
        }

        async function animateFinalReport() {
            // Complete progress bars
            document.querySelectorAll('.ai-progress-fill').forEach(bar => {
                bar.style.width = '100%';
            });
            
            // Show completion effect
            const header = document.querySelector('.ai-processing-header h1');
            if (header) {
                header.textContent = 'Analysis Complete!';
                header.style.color = 'var(--accent-success)';
            }
            
            return new Promise(resolve => setTimeout(resolve, 2000));
        }

        async function showCompletionModal() {
            // Extract vendor name from contract analysis
            const contractContent = document.getElementById('contractContent');
            const contractText = contractContent?.dataset.originalText || '';
            
            // Use the enhanced extraction function for vendor name
            const contractDetails = extractContractDetails(contractText);
            const vendorName = contractDetails.vendor_name && contractDetails.vendor_name !== 'Unknown Vendor' 
                ? contractDetails.vendor_name 
                : 'Contract Vendor';
            
            // Create modal HTML
            const modalHTML = `
                <div class="completion-modal-overlay" id="completionModal">
                    <div class="completion-modal">
                        <div class="completion-modal-content">
                            <div class="completion-icon"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg></div>
                            <h3>Analysis Complete!</h3>
                            <p>AI has finished reading and analyzing the documents for <strong>${vendorName}</strong>.</p>
                            <div class="completion-progress">
                                <div class="completion-progress-bar"></div>
                            </div>
                            <p class="completion-status">Creating vendor profile and processing findings...</p>
                            <button class="modal-close-btn" onclick="closeCompletionModal()" style="display: none;">Continue</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Start progress animation
            setTimeout(() => {
                const progressBar = document.querySelector('.completion-progress-bar');
                if (progressBar) {
                    progressBar.style.width = '100%';
                }
            }, 100);
            
            // Create vendor and process findings in the background
            try {
                const createdVendor = await createVendorFromAnalysis(vendorName);
                
                // Update modal to show success
                const statusElement = document.querySelector('.completion-status');
                if (statusElement) {
                    statusElement.textContent = 'Vendor profile created successfully! Taking you there now...';
                }
                
                // Auto-close after 3 seconds and redirect to vendor page
                setTimeout(() => {
                    try {
                        const modal = document.getElementById('completionModal');
                        if (modal) {
                            modal.remove();
                        }
                        console.log('Redirecting to vendor:', createdVendor.id);
                        
                        // Reload vendors from storage to ensure we have the latest data
                        const savedVendors = localStorage.getItem('vendors');
                        if (savedVendors) {
                            vendors = JSON.parse(savedVendors);
                        }
                        
                        // Ensure vendor exists before redirecting
                        const vendorExists = vendors.find(v => v.id === createdVendor.id);
                        if (vendorExists) {
                            console.log('Vendor found, navigating to details page');
                            showVendorDetails(createdVendor.id);
                        } else {
                            console.warn('Vendor not found after creation, refreshing and going to dashboard');
                            // Try to reload and go to dashboard
                            loadDashboard();
                            showDashboard();
                        }
                    } catch (error) {
                        console.error('Error during redirect:', error);
                        // Fallback to dashboard
                        loadDashboard();
                        showDashboard();
                    }
                }, 3000);
                
            } catch (error) {
                console.error('Error creating vendor:', error);
                
                // Show error state with auto-redirect fallback
                const statusElement = document.querySelector('.completion-status');
                
                if (statusElement) {
                    statusElement.textContent = 'Analysis complete! Taking you to results...';
                    statusElement.style.color = 'var(--accent-warning)';
                }
                
                // Auto-redirect even on error after 4 seconds
                setTimeout(() => {
                    const modal = document.getElementById('completionModal');
                    if (modal) {
                        modal.remove();
                    }
                    showDashboard();
                }, 4000);
            }
        }

        function closeCompletionModal() {
            const modal = document.getElementById('completionModal');
            if (modal) {
                modal.remove();
            }
            // Try to find the created vendor and navigate to it, otherwise go to dashboard
            try {
                const lastVendor = vendors[vendors.length - 1];
                if (lastVendor && (Date.now() - parseInt(lastVendor.id)) < 60000) { // Created within last minute
                    showVendorDetails(lastVendor.id);
                } else {
                    showDashboard();
                }
            } catch (error) {
                console.error('Error navigating after modal close:', error);
                showDashboard();
            }
        }

        async function createVendorFromAnalysis(vendorName) {
            try {
                console.log('Starting vendor creation for:', vendorName);
                
                // Extract data from documents
                const contractContent = document.getElementById('contractContent');
                const contractText = contractContent?.dataset.originalText || '';
                
                if (!contractText) {
                    console.warn('No contract text found, using fallback');
                }
                
                // Extract contract details using regex patterns
                const contractDetails = extractContractDetails(contractText);
                console.log('Contract details extracted:', contractDetails);
                
                // Process ALL invoices for this ONE vendor (1 contract = 1 vendor + multiple invoices)
                const invoiceResults = [];
                if (invoiceFiles && invoiceFiles.length > 0) {
                    console.log(`Processing ${invoiceFiles.length} invoices for vendor: ${vendorName}`);
                    
                    for (let i = 0; i < invoiceFiles.length; i++) {
                        const invoice = invoiceFiles[i];
                        
                        // Extract text from each individual invoice file
                        let invoiceText = '';
                        try {
                            invoiceText = await extractTextFromFile(invoice);
                            console.log(`Extracted text from invoice ${i + 1}/${invoiceFiles.length}: ${invoice.name}`);
                        } catch (error) {
                            console.error(`Error extracting text from invoice ${invoice.name}:`, error);
                            // Fallback to displayed content if available
                            const displayedContent = document.getElementById('invoiceContent');
                            invoiceText = displayedContent?.dataset.originalText || '';
                        }
                        
                        // Extract invoice details from this specific invoice
                        const invoiceDetails = extractInvoiceDetails(invoiceText, invoice.name);
                        console.log(`Invoice ${i + 1} (${invoice.name}) details:`, invoiceDetails);
                        
                        // Generate reconciliation findings against the contract
                        const reconciliationSummary = await generateReconciliationSummary(contractDetails, invoiceDetails);
                        
                        invoiceResults.push({
                            filename: invoice.name,
                            fileData: await fileToBase64(invoice),
                            details: invoiceDetails,
                            reconciliationSummary: reconciliationSummary,
                            status: reconciliationSummary.status,
                            processedAt: new Date().toISOString()
                        });
                    }
                    console.log(`Processed ${invoiceResults.length} invoices for vendor ${vendorName}`);
                } else {
                    console.warn('No invoice files found - creating vendor with contract only');
                }
            
            // Create ONE VENDOR from the contract with ALL invoices associated
            // This follows the rule: 1 Contract = 1 Vendor + Multiple Invoices
            
            // Use the extracted vendor name from contract, not the parameter
            const actualVendorName = contractDetails.vendor_name && contractDetails.vendor_name !== 'Unknown Vendor' 
                ? contractDetails.vendor_name 
                : vendorName;
            
            const vendor = {
                id: Date.now().toString(),
                name: actualVendorName,
                description: contractDetails.service_description || `${contractDetails.business_type || 'General Services'} - ${invoiceResults.length} invoice(s) under contract`,
                email: contractDetails.email || '',
                
                // Contract information (the source of vendor identity)
                contractFile: contractFile?.name || 'Unknown Contract',
                contractFileData: contractFile ? await fileToBase64(contractFile) : '',
                contractUploadDate: new Date().toISOString(),
                effectiveDate: contractDetails.effectiveDate || new Date().toISOString().split('T')[0],
                renewalDate: contractDetails.renewalDate || '',
                
                // Vendor metadata
                status: 'active',
                createdAt: new Date().toISOString(),
                lastUpdated: new Date().toISOString(),
                
                // Contract analysis (vendor's primary data source)
                contractAnalysis: {
                    vendor_information: {
                        name: contractDetails.vendor_name,
                        email: contractDetails.email,
                        effective_date: contractDetails.effectiveDate,
                        renewal_date: contractDetails.renewalDate
                    },
                    financial_terms: {
                        amounts: contractDetails.amounts,
                        payment_terms: contractDetails.paymentTerms
                    },
                    key_dates: contractDetails.dates,
                    ai_summary: {
                        overview: `Contract analysis for ${vendorName} completed on ${new Date().toLocaleDateString()}. This vendor profile represents the contracting entity with ${invoiceResults.length} processed invoice(s).`,
                        financial_highlights: [
                            `Contract amounts: ${contractDetails.amounts.length > 0 ? contractDetails.amounts.join(', ') : 'To be determined'}`,
                            `Payment terms: ${contractDetails.paymentTerms}`,
                            `Effective date: ${contractDetails.effectiveDate || 'Not specified'}`,
                            `Renewal terms: ${contractDetails.renewalDate || 'Not specified'}`,
                            `Associated invoices: ${invoiceResults.length} processed`
                        ].filter(item => !item.includes('Not specified') || contractDetails.effectiveDate || contractDetails.renewalDate)
                    }
                },
                
                // ALL invoices associated with this ONE vendor
                invoiceAnalysis: invoiceResults, // Array of all invoices reconciled against this contract
                invoiceCount: invoiceResults.length
            };
            
            // Validate the correct vendor-invoice relationship
            console.log(`VENDOR CREATION SUMMARY:
            Contract: ${contractFile?.name || 'Unknown'}
            Vendor: ${vendor.name}
            Invoices: ${vendor.invoiceCount} invoice(s) associated
            Relationship: 1 Contract → 1 Vendor → ${vendor.invoiceCount} Invoices`);
            
            console.log('Created vendor with full analysis:', vendor);
            
            // Check for existing vendor with same name to prevent duplicates
            // Also check for invalid vendor names that shouldn't be created
            const invalidVendorNames = ['shall be liable for its failure', 'contingencies beyond its reasonable', 'New Vendor'];
            const isInvalidName = invalidVendorNames.some(invalid => 
                vendor.name.toLowerCase().includes(invalid.toLowerCase()));
            
            if (isInvalidName) {
                console.warn('Skipping vendor creation with invalid name:', vendor.name);
                // Try to use a better name
                vendor.name = contractDetails.vendor_name !== 'Unknown Vendor' 
                    ? contractDetails.vendor_name 
                    : `Vendor_${Date.now()}`;
            }
            
            try {
                const existingVendorIndex = vendors.findIndex(v => v && v.name && v.name.toLowerCase() === vendor.name.toLowerCase());
                if (existingVendorIndex >= 0) {
                    console.log('Found existing vendor, updating instead of creating duplicate:', vendor.name);
                    // Update existing vendor with new analysis
                    vendors[existingVendorIndex] = {
                        ...vendors[existingVendorIndex],
                        ...vendor,
                        lastUpdated: new Date().toISOString()
                    };
                } else {
                    console.log('Creating new vendor:', vendor.name);
                    vendors.push(vendor);
                }
                localStorage.setItem('vendors', JSON.stringify(vendors));
            } catch (error) {
                console.error('Error managing vendor duplicates:', error);
                // Fallback: just add the vendor
                vendors.push(vendor);
                localStorage.setItem('vendors', JSON.stringify(vendors));
            }
            
            // Reload vendors from storage to ensure consistency
            const savedVendors = localStorage.getItem('vendors');
            if (savedVendors) {
                vendors = JSON.parse(savedVendors);
            }
            
            // Save to reconciliation history as well
            const historyEntry = {
                id: Date.now() + 1,
                timestamp: new Date().toISOString(),
                contractFile: contractFile.name,
                contractFileData: await fileToBase64(contractFile),
                invoiceCount: invoiceFiles.length,
                results: {
                    contractAnalysis: contractDetails,
                    contractDetails: contractDetails, // Keep both for backward compatibility
                    invoiceResults: invoiceResults
                },
                vendorId: vendor.id,
                vendorName: vendor.name // Use the actual vendor name, not the parameter
            };
            
            let history = JSON.parse(localStorage.getItem('reconciliation_history') || '[]');
            history.unshift(historyEntry);
            if (history.length > 50) history = history.slice(0, 50);
            localStorage.setItem('reconciliation_history', JSON.stringify(history));
            
            // Find the vendor we just saved to verify it's in storage
            const finalVendor = vendors.find(v => v.id === vendor.id);
            if (!finalVendor) {
                console.error('Failed to verify saved vendor!');
                return vendor; // Return the original vendor as fallback
            }
            
            console.log('Vendor created and verified in storage:', finalVendor);
            return finalVendor;
                
            } catch (error) {
                console.error('Error in createVendorFromAnalysis:', error);
                // Create a basic vendor as fallback
                const fallbackVendor = {
                    id: Date.now().toString(),
                    name: vendorName,
                    description: `Vendor created from analysis on ${new Date().toLocaleDateString()}`,
                    status: 'active',
                    createdAt: new Date().toISOString(),
                    lastUpdated: new Date().toISOString()
                };
                
                vendors.push(fallbackVendor);
                localStorage.setItem('vendors', JSON.stringify(vendors));
                
                return fallbackVendor;
            }
        }

        function extractContractDetails(text) {
            // Enhanced vendor name extraction - more comprehensive patterns
            const vendorNamePatterns = [
                // Look for "SERVICE AGREEMENT between [Client] and [Vendor]"
                /(?:agreement|contract)\s+between\s+[\w\s]+\s+and\s+([A-Z][a-zA-Z\s&]+(?:Inc|LLC|Corp|Ltd|Co\.|Company|Corporation))/i,
                // Look for "Vendor: [Name]" or "Contractor: [Name]"
                /(?:vendor|contractor|supplier|provider|consultant)[:\s]+([A-Z][a-zA-Z\s&]+(?:Inc|LLC|Corp|Ltd|Co\.|Company|Corporation))/i,
                // Look for "[Company] agrees to provide"
                /([A-Z][a-zA-Z\s&]+(?:Inc|LLC|Corp|Ltd|Co\.|Company|Corporation))\s+(?:agrees to|shall|will)\s+provide/i,
                // Look for "provided by [Company]"
                /(?:provided|supplied|delivered)\s+by\s+([A-Z][a-zA-Z\s&]+(?:Inc|LLC|Corp|Ltd|Co\.|Company|Corporation))/i,
                // Look in header/title
                /^([A-Z][a-zA-Z\s&]+(?:Inc|LLC|Corp|Ltd|Co\.|Company|Corporation))\b/m,
                // Look for quoted company names
                /\"([A-Z][a-zA-Z\s&]+(?:Inc|LLC|Corp|Ltd|Co\.|Company|Corporation))\"/
            ];
            
            let vendorName = 'Unknown Vendor';
            const invalidNames = ['New Vendor', 'shall be liable for its failure', 'contingencies beyond its reasonable'];
            
            for (const pattern of vendorNamePatterns) {
                const match = text.match(pattern);
                if (match && match[1]) {
                    const extractedName = match[1].trim();
                    // Check if the extracted name is valid and not part of contract language
                    const isInvalid = invalidNames.some(invalid => 
                        extractedName.toLowerCase().includes(invalid.toLowerCase()));
                    
                    if (!isInvalid && extractedName.length > 3 && extractedName.length < 100) {
                        vendorName = extractedName;
                        console.log('Extracted vendor name:', vendorName);
                        break;
                    }
                }
            }
            
            // Extract business type and service description from context
            let businessType = 'General Services';
            let serviceDescription = '';
            
            const businessTypePatterns = [
                { pattern: /(?:software|saas|technology|IT|tech|digital|computer|application|platform|system)/i, type: 'Technology Services' },
                { pattern: /(?:consulting|advisory|professional services|consultancy)/i, type: 'Consulting Services' },
                { pattern: /(?:marketing|advertising|media|creative|branding|promotion)/i, type: 'Marketing & Creative Services' },
                { pattern: /(?:legal|law|attorney|litigation|compliance)/i, type: 'Legal Services' },
                { pattern: /(?:accounting|financial|audit|tax|bookkeeping|cpa)/i, type: 'Financial Services' },
                { pattern: /(?:construction|building|renovation|contractor|development)/i, type: 'Construction Services' },
                { pattern: /(?:supply|supplier|materials|equipment|procurement)/i, type: 'Supply & Equipment' },
                { pattern: /(?:maintenance|repair|facility|janitorial|cleaning)/i, type: 'Maintenance Services' },
                { pattern: /(?:transportation|logistics|shipping|delivery|freight)/i, type: 'Logistics Services' },
                { pattern: /(?:healthcare|medical|health|clinical|pharmaceutical)/i, type: 'Healthcare Services' },
                { pattern: /(?:staffing|recruitment|human resources|hr|talent)/i, type: 'Staffing Services' },
                { pattern: /(?:security|surveillance|protection|guard)/i, type: 'Security Services' }
            ];
            
            for (const { pattern, type } of businessTypePatterns) {
                if (pattern.test(text)) {
                    businessType = type;
                    
                    // Try to extract service description from scope/services section
                    const servicePatterns = [
                        /(?:scope of (?:work|services))[:\s]+([^.\n]{20,200})/i,
                        /(?:services to be provided)[:\s]+([^.\n]{20,200})/i,
                        /(?:contractor|vendor|provider)\s+(?:shall|will)\s+provide\s+([^.\n]{20,200})/i,
                        /(?:description of services)[:\s]+([^.\n]{20,200})/i
                    ];
                    
                    for (const servicePattern of servicePatterns) {
                        const serviceMatch = text.match(servicePattern);
                        if (serviceMatch && serviceMatch[1]) {
                            serviceDescription = serviceMatch[1].trim();
                            break;
                        }
                    }
                    break;
                }
            }
            
            // If no service description found, create a basic one
            if (!serviceDescription) {
                serviceDescription = `${businessType} as outlined in the contract`;
            }
            
            return {
                vendor_name: vendorName,
                business_type: businessType,
                service_description: serviceDescription,
                amounts: Array.from(text.matchAll(/\$[\d,]+\.?\d*/g)).map(m => m[0]),
                dates: Array.from(text.matchAll(/\b\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}\b|\b(?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)[a-z]*\s+\d{1,2},?\s+\d{4}\b/g)).map(m => m[0]),
                email: text.match(/\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/)?.[0] || '',
                effectiveDate: text.match(/effective[:\s]+(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}|\b(?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)[a-z]*\s+\d{1,2},?\s+\d{4})/i)?.[1] || '',
                renewalDate: text.match(/renew[a-z]*[:\s]+(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}|\b(?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)[a-z]*\s+\d{1,2},?\s+\d{4})/i)?.[1] || '',
                paymentTerms: text.match(/payment[:\s]+([^.!?]*)/i)?.[1]?.trim() || 'Standard terms'
            };
        }

        function removeDuplicateVendors() {
            try {
                const uniqueVendors = [];
                const seenNames = new Set();
                const invalidPhrases = ['shall be liable for its failure', 'contingencies beyond its reasonable'];
                
                vendors.forEach(vendor => {
                    if (vendor && vendor.name) {
                        const normalizedName = vendor.name.toLowerCase();
                        
                        // Only remove vendors with these specific invalid phrases, not "New Vendor" which might be temporary
                        const isInvalid = invalidPhrases.some(invalid => 
                            normalizedName.includes(invalid.toLowerCase()));
                        
                        if (isInvalid) {
                            console.log('Removing vendor with invalid name:', vendor.name);
                            return; // Skip this vendor
                        }
                        
                        if (!seenNames.has(normalizedName)) {
                            seenNames.add(normalizedName);
                            uniqueVendors.push(vendor);
                        } else {
                            // Keep the vendor with more data (invoiceCount > 0 or has contractAnalysis)
                            const existingIndex = uniqueVendors.findIndex(v => v.name.toLowerCase() === normalizedName);
                            const existing = uniqueVendors[existingIndex];
                            if (vendor.invoiceCount > (existing.invoiceCount || 0) || 
                                (vendor.contractAnalysis && !existing.contractAnalysis)) {
                                console.log('Replacing duplicate with better data:', vendor.name);
                                uniqueVendors[existingIndex] = vendor;
                            } else {
                                console.log('Keeping existing vendor, skipping duplicate:', vendor.name);
                            }
                        }
                    }
                });
                
                if (uniqueVendors.length !== vendors.length) {
                    console.log(`Cleaned up vendors: ${vendors.length} -> ${uniqueVendors.length}`);
                    vendors = uniqueVendors;
                    localStorage.setItem('vendors', JSON.stringify(vendors));
                }
            } catch (error) {
                console.error('Error in removeDuplicateVendors:', error);
                // Don't let this break the whole flow
            }
        }

        // Contract-only upload functions
        function showContractOnlyUpload() {
            document.getElementById('contractUploadModal').style.display = 'flex';
        }

        function closeContractUploadModal() {
            document.getElementById('contractUploadModal').style.display = 'none';
            document.getElementById('contractOnlyFile').value = '';
            document.getElementById('contractProcessingStatus').style.display = 'none';
        }

        async function handleContractOnlyUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Show processing indicator
            document.getElementById('contractProcessingStatus').style.display = 'block';
            document.getElementById('processingText').textContent = 'Analyzing contract...';

            try {
                // Extract text from contract
                const contractText = await extractTextFromFile(file);
                console.log('Contract text extracted for analysis');

                // Extract contract details
                const contractDetails = extractContractDetails(contractText);
                console.log('Contract details:', contractDetails);

                // Create vendor from contract analysis
                const vendor = await createVendorFromContract(file, contractText, contractDetails);
                console.log('Vendor created:', vendor);

                // Success - redirect to vendor profile
                document.getElementById('processingText').textContent = 'Analysis complete! Redirecting...';
                
                setTimeout(() => {
                    closeContractUploadModal();
                    window.location.href = `vendor-profile.html?id=${vendor.id}`;
                }, 1500);

            } catch (error) {
                console.error('Error processing contract:', error);
                document.getElementById('processingText').textContent = 'Error processing contract. Please try again.';
                document.getElementById('processingText').style.color = 'var(--error)';
                
                setTimeout(() => {
                    closeContractUploadModal();
                }, 3000);
            }
        }

        async function createVendorFromContract(contractFile, contractText, contractDetails) {
            const vendorId = Date.now().toString();
            
            // Create vendor object with contract analysis
            const vendor = {
                id: vendorId,
                name: contractDetails.vendor_name !== 'Unknown Vendor' ? contractDetails.vendor_name : `Vendor_${vendorId}`,
                description: contractDetails.service_description || `${contractDetails.business_type || 'General Services'}`,
                email: contractDetails.email || '',
                
                // Contract information
                contractFile: contractFile.name,
                contractFileData: await fileToBase64(contractFile),
                contractUploadDate: new Date().toISOString(),
                effectiveDate: contractDetails.effectiveDate || '',
                renewalDate: contractDetails.renewalDate || '',
                
                // Vendor metadata
                status: 'active',
                createdAt: new Date().toISOString(),
                lastUpdated: new Date().toISOString(),
                
                // Contract analysis data
                contractAnalysis: {
                    vendor_information: {
                        name: contractDetails.vendor_name,
                        email: contractDetails.email,
                        effective_date: contractDetails.effectiveDate,
                        renewal_date: contractDetails.renewalDate
                    },
                    financial_terms: {
                        amounts: contractDetails.amounts,
                        payment_terms: contractDetails.paymentTerms
                    },
                    business_info: {
                        business_type: contractDetails.business_type,
                        service_description: contractDetails.service_description
                    },
                    key_dates: contractDetails.dates,
                    ai_summary: {
                        overview: `Contract analysis for ${vendor.name} completed. Vendor profile created from contract analysis.`,
                        financial_highlights: [
                            `Payment terms: ${contractDetails.paymentTerms}`,
                            `Service type: ${contractDetails.business_type}`,
                            `Contract amounts: ${contractDetails.amounts.length > 0 ? contractDetails.amounts.join(', ') : 'TBD'}`
                        ].filter(item => !item.includes('undefined'))
                    }
                }
            };

            // Add to vendors array
            vendors.push(vendor);
            localStorage.setItem('vendors', JSON.stringify(vendors));

            // Initialize empty invoices array for this vendor
            localStorage.setItem(`vendor_invoices_${vendorId}`, JSON.stringify([]));

            return vendor;
        }

        function extractInvoiceDetails(text, filename) {
            return {
                filename: filename,
                invoiceNumber: text.match(/invoice[#\s]*:?\s*([A-Z0-9\-]+)/i)?.[1] || 'Unknown',
                amount: text.match(/\$[\d,]+\.?\d*/)?.[0] || '$0.00',
                date: text.match(/\b\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}\b|\b(?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)[a-z]*\s+\d{1,2},?\s+\d{4}\b/)?.[0] || 'Unknown date',
                vendor: text.match(/from[:\s]+([^,\n]*)/i)?.[1]?.trim() || text.match(/\b([A-Z][a-zA-Z\s&]+(?:Inc|LLC|Corp|Ltd|Co\.?))\b/)?.[1] || 'Unknown',
                dueDate: text.match(/due[:\s]+(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}|\b(?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)[a-z]*\s+\d{1,2},?\s+\d{4})/i)?.[1] || ''
            };
        }

        async function generateReconciliationSummary(contractDetails, invoiceDetails) {
            // Simple rule-based reconciliation for now
            const issues = [];
            let status = 'compliant';
            
            // Check vendor name consistency
            const contractVendor = contractDetails.vendor_name.toLowerCase();
            const invoiceVendor = invoiceDetails.vendor.toLowerCase();
            
            if (!contractVendor.includes(invoiceVendor.split(' ')[0]) && !invoiceVendor.includes(contractVendor.split(' ')[0])) {
                issues.push('Vendor name mismatch detected');
                status = 'attention_required';
            }
            
            // Check if invoice amount matches any contract amounts
            const contractAmounts = contractDetails.amounts.map(a => a.replace(/[$,]/g, ''));
            const invoiceAmount = invoiceDetails.amount.replace(/[$,]/g, '');
            
            if (contractAmounts.length > 0 && !contractAmounts.includes(invoiceAmount)) {
                issues.push('Invoice amount does not match contract terms');
                status = 'attention_required';
            }
            
            // Generate summary sentence
            let summary = '';
            if (status === 'compliant') {
                summary = `✅ Invoice ${invoiceDetails.invoiceNumber} for ${invoiceDetails.amount} appears compliant with contract terms and requires no further review.`;
            } else {
                summary = `⚠️ Invoice ${invoiceDetails.invoiceNumber} for ${invoiceDetails.amount} has ${issues.length} potential issue${issues.length > 1 ? 's' : ''} that may require attention: ${issues.join(', ')}.`;
            }
            
            return {
                status: status,
                summary: summary,
                issues: issues,
                details: {
                    contractVendor: contractDetails.vendor_name,
                    invoiceVendor: invoiceDetails.vendor,
                    contractAmounts: contractDetails.amounts,
                    invoiceAmount: invoiceDetails.amount,
                    comparisonDate: new Date().toISOString()
                }
            };
        }

        async function continueWithActualProcessing() {
            showProcessingSection();
            
            try {
                // Step 1: Analyze contract with advanced prompting
                updateProcessingStatus('Analyzing contract terms and obligations...');
                const contractText = await extractTextFromFile(contractFile);
                contractAnalysis = await analyzeContractAdvanced(contractText);
                
                // Step 2: Process each invoice
                const invoiceResults = [];
                
                for (let i = 0; i < invoiceFiles.length; i++) {
                    const file = invoiceFiles[i];
                    updateProcessingStatus(`Validating invoice ${i + 1}/${invoiceFiles.length}: ${file.name}`);
                    updateProgressBar(`invoice-${i}`, 0);
                    
                    try {
                        // Extract text
                        updateProgressBar(`invoice-${i}`, 25);
                        const invoiceText = await extractTextFromFile(file);
                        
                        // Analyze with AI
                        updateProgressBar(`invoice-${i}`, 50);
                        const invoiceDetails = await analyzeDocument(invoiceText, 'invoice');
                        
                        // Compare with contract
                        updateProgressBar(`invoice-${i}`, 75);
                        const comparison = compareDocuments(contractAnalysis, invoiceDetails);
                        
                        updateProgressBar(`invoice-${i}`, 100);
                        
                        invoiceResults.push({
                            filename: file.name,
                            file: file,
                            fileData: await fileToBase64(file),
                            invoiceDetails: invoiceDetails,
                            comparison: comparison,
                            status: comparison.summary.reconciliation_status
                        });
                        
                    } catch (error) {
                        console.error(`Error processing ${file.name}:`, error);
                        invoiceResults.push({
                            filename: file.name,
                            file: file,
                            fileData: await fileToBase64(file),
                            error: error.message,
                            status: 'error'
                        });
                    }
                }
                
                // Save to history
                const historyEntry = {
                    id: Date.now(),
                    timestamp: new Date().toISOString(),
                    contractFile: contractFile.name,
                    contractFileData: await fileToBase64(contractFile),
                    invoiceCount: invoiceFiles.length,
                    results: {
                        contractAnalysis: contractAnalysis,
                        invoiceResults: invoiceResults
                    }
                };
                
                let history = JSON.parse(localStorage.getItem('reconciliation_history') || '[]');
                history.unshift(historyEntry);
                if (history.length > 50) history = history.slice(0, 50);
                localStorage.setItem('reconciliation_history', JSON.stringify(history));
                
                // Show results
                displayResults(contractAnalysis, invoiceResults);
                showResults();
                
            } catch (error) {
                console.error('Processing error:', error);
                updateProcessingStatus(`Error: ${error.message}`);
                alert(`Processing failed: ${error.message}`);
            }
        }

        async function checkApiKey() {
            if (apiKey && apiKey.startsWith('sk-')) {
                try {
                    const response = await fetch('https://api.openai.com/v1/models', {
                        headers: {
                            'Authorization': `Bearer ${apiKey}`
                        }
                    });
                    
                    if (response.ok) {
                        showApiStatus('✅ Secure connection established', 'success');
                        return true;
                    }
                } catch (error) {
                    console.error('API check failed:', error);
                }
            }
            return false;
        }

        function showApiStatus(message, type) {
            const statusDiv = document.getElementById('apiStatus');
            statusDiv.textContent = message;
            statusDiv.className = `api-status ${type}`;
            statusDiv.classList.remove('hidden');
        }

        async function handleContractSelect(event) {
            contractFile = event.target.files[0];
            displayContractFile();
            
            // ✅ REMOVED: Auto-creation of vendor (was causing duplicates)
            // Vendors should only be created after full AI analysis is complete
            console.log('Contract file selected:', contractFile?.name);
        }

        async function createVendorFromContract(file) {
            try {
                // Show processing status
                const contractUpload = document.getElementById('contractUpload');
                const originalContent = contractUpload.innerHTML;
                contractUpload.innerHTML = `
                    <div class="upload-icon">⏳</div>
                    <h3>Processing Contract</h3>
                    <p>Analyzing contract and creating vendor profile...</p>
                `;

                // Extract text from contract
                const text = await extractTextFromFile(file);
                
                // Analyze contract to get vendor information
                const contractAnalysis = await analyzeDocument(text, 'contract');
                
                // Extract vendor info from contract analysis
                const vendorInfo = contractAnalysis.vendor_information || {};
                const contractDetails = contractAnalysis.contract_details || {};
                const financialTerms = contractAnalysis.financial_terms || {};
                
                // Create vendor object
                const vendor = {
                    id: Date.now().toString(),
                    name: vendorInfo.legal_name || vendorInfo.vendor_name || 'Unknown Vendor',
                    description: contractAnalysis.services_products?.description || 'Contract-based vendor',
                    email: vendorInfo.contact_email || '',
                    address: vendorInfo.address || '',
                    contractFile: file.name,
                    contractFileData: await fileToBase64(file),
                    contractUploadDate: new Date().toISOString(),
                    contractNumber: contractDetails.contract_number || '',
                    contractType: contractDetails.contract_type || '',
                    effectiveDate: contractDetails.effective_date || '',
                    expirationDate: contractDetails.expiration_date || '',
                    totalValue: financialTerms.total_contract_value || '',
                    paymentTerms: financialTerms.payment_terms || '',
                    billingFrequency: financialTerms.billing_frequency || '',
                    status: 'active',
                    createdAt: new Date().toISOString(),
                    lastUpdated: new Date().toISOString(),
                    contractAnalysis: contractAnalysis // Store full analysis
                };
                
                // Check if vendor already exists
                const existingVendorIndex = vendors.findIndex(v => 
                    v.name.toLowerCase() === vendor.name.toLowerCase() ||
                    (v.contractNumber && vendor.contractNumber && v.contractNumber === vendor.contractNumber)
                );
                
                if (existingVendorIndex >= 0) {
                    // Update existing vendor
                    vendors[existingVendorIndex] = { ...vendors[existingVendorIndex], ...vendor };
                    showVendorCreationSuccess(`Updated existing vendor: ${vendor.name}`, 'update');
                } else {
                    // Add new vendor
                    vendors.push(vendor);
                    showVendorCreationSuccess(`Created new vendor: ${vendor.name}`, 'create');
                }
                
                // Save to localStorage
                localStorage.setItem('vendors', JSON.stringify(vendors));
                
                // Restore contract upload display
                setTimeout(() => {
                    contractUpload.innerHTML = originalContent;
                    displayContractFile();
                }, 2000);
                
                // Update dashboard if on dashboard view
                if (document.getElementById('dashboardView').classList.contains('active')) {
                    loadDashboard();
                }
                
            } catch (error) {
                console.error('Error creating vendor from contract:', error);
                showVendorCreationSuccess('Error processing contract. Please try again.', 'error');
                
                // Restore contract upload display
                setTimeout(() => {
                    displayContractFile();
                }, 2000);
            }
        }

        function showVendorCreationSuccess(message, type) {
            // Create and show success notification
            const notification = document.createElement('div');
            notification.className = `vendor-creation-notification ${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <span class="notification-icon">
                        ${type === 'create' ? '✅' : type === 'update' ? '🔄' : '❌'}
                    </span>
                    <span class="notification-message">${message}</span>
                </div>
            `;
            
            // Add styles for notification
            notification.style.cssText = `
                position: fixed;
                top: 100px;
                right: 20px;
                background: ${type === 'error' ? 'var(--error-bg)' : 'var(--success-bg)'};
                border: 1px solid ${type === 'error' ? 'var(--error)' : 'var(--accent-success)'};
                color: ${type === 'error' ? 'var(--error)' : 'var(--accent-success)'};
                padding: 16px 20px;
                border-radius: var(--border-radius);
                box-shadow: var(--shadow-medium);
                z-index: 2000;
                animation: slideInRight 0.3s ease;
                max-width: 300px;
            `;
            
            document.body.appendChild(notification);
            
            // Remove notification after 4 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 4000);
        }

        function handleInvoiceSelect(event) {
            const newFiles = Array.from(event.target.files);
            invoiceFiles = [...invoiceFiles, ...newFiles];
            displayInvoiceFiles();
        }

        function displayContractFile() {
            const container = document.getElementById('contractFileInfo');
            const uploadBox = document.getElementById('contractUpload');
            
            if (contractFile) {
                container.innerHTML = `
                    <div class="file-item">
                        <span class="file-name">📄 ${contractFile.name}</span>
                        <button class="remove-btn" onclick="removeContractFile()">✕</button>
                    </div>
                `;
                uploadBox.classList.add('has-files');
            } else {
                container.innerHTML = '';
                uploadBox.classList.remove('has-files');
            }
            checkFilesReady();
        }

        function displayInvoiceFiles() {
            const container = document.getElementById('invoiceFilesList');
            const uploadBox = document.getElementById('invoicesUpload');
            
            if (invoiceFiles.length > 0) {
                container.innerHTML = invoiceFiles.map((file, index) => `
                    <div class="file-item">
                        <span class="file-name">🧾 ${file.name}</span>
                        <button class="remove-btn" onclick="removeInvoiceFile(${index})">✕</button>
                    </div>
                `).join('');
                uploadBox.classList.add('has-files');
            } else {
                container.innerHTML = '';
                uploadBox.classList.remove('has-files');
            }
            checkFilesReady();
        }

        function removeContractFile() {
            contractFile = null;
            document.getElementById('contractFile').value = '';
            displayContractFile();
        }

        function removeInvoiceFile(index) {
            invoiceFiles.splice(index, 1);
            displayInvoiceFiles();
        }

        function checkFilesReady() {
            const processBtn = document.getElementById('processBtn');
            const btnText = document.getElementById('processBtnText');
            
            const ready = contractFile && invoiceFiles.length > 0 && apiKey;
            processBtn.disabled = !ready;
            
            if (ready) {
                btnText.textContent = `Validate Contract + ${invoiceFiles.length} Invoice${invoiceFiles.length > 1 ? 's' : ''}`;
            } else {
                btnText.textContent = 'Analyze Documents';
            }
        }

        async function startBatchReconciliation() {
            if (!apiKey) {
                showToast('Please configure your OpenAI API key first', 'error');
                return;
            }
            
            if (!contractFile) {
                showToast('Please upload a contract file first', 'error');
                return;
            }
            
            if (invoiceFiles.length === 0) {
                showToast('Please upload at least one invoice file', 'error');
                return;
            }

            console.log('Starting bulk reconciliation with:', {
                contract: contractFile.name,
                invoices: invoiceFiles.map(f => f.name)
            });

            showToast(`Starting reconciliation: 1 contract vs ${invoiceFiles.length} invoices`, 'info');

            // Show AI processing view for bulk processing
            await showAIProcessingView(true, true);
            
            // Perform actual bulk reconciliation
            await performBulkReconciliation();
        }

        function showProcessingSection() {
            document.getElementById('uploadSection').querySelector('.section-content').style.display = 'none';
            document.getElementById('settingsSection').classList.add('collapsed');
            document.getElementById('processingSection').classList.remove('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            
            // Create processing items for each invoice
            const grid = document.getElementById('processingGrid');
            grid.innerHTML = invoiceFiles.map((file, index) => `
                <div class="processing-item">
                    <h4>📄 ${file.name}</h4>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-invoice-${index}" style="width: 0%"></div>
                    </div>
                    <div id="status-invoice-${index}">Waiting...</div>
                </div>
            `).join('');
        }

        function updateProcessingStatus(status) {
            document.getElementById('processingStatus').textContent = status;
        }

        function updateProgressBar(invoiceId, percentage) {
            const progressBar = document.getElementById(`progress-${invoiceId}`);
            const statusDiv = document.getElementById(`status-${invoiceId}`);
            
            if (progressBar) {
                progressBar.style.width = `${percentage}%`;
            }
            
            if (statusDiv) {
                const statusText = percentage === 0 ? 'Initializing...' :
                                percentage === 25 ? 'Extracting document text...' :
                                percentage === 50 ? 'AI validation in progress...' :
                                percentage === 75 ? 'Cross-referencing contract...' :
                                percentage === 100 ? 'Validation complete' : 'Processing...';
                statusDiv.textContent = statusText;
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        async function extractTextFromFile(file) {
            const fileType = file.type;
            
            if (fileType === 'application/pdf') {
                return await extractTextFromPDF(file);
            } else if (fileType.startsWith('image/')) {
                return await extractTextFromImage(file);
            } else {
                throw new Error('Unsupported file type');
            }
        }

        async function extractTextFromPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            let fullText = '';
            
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');
                fullText += `\n--- Page ${i} ---\n${pageText}`;
            }
            
            // If PDF text extraction didn't work well, try OCR
            if (fullText.trim().length < 100) {
                return await extractTextWithOCR(file);
            }
            
            return fullText;
        }

        async function extractTextFromImage(file) {
            return await extractTextWithOCR(file);
        }

        async function extractTextWithOCR(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const result = await Tesseract.recognize(
                            e.target.result,
                            'eng',
                            {
                                logger: m => {
                                    if (m.status === 'recognizing text') {
                                        updateProcessingStatus(`OCR Progress: ${Math.round(m.progress * 100)}%`);
                                    }
                                }
                            }
                        );
                        resolve(result.data.text);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.readAsDataURL(file);
            });
        }

        async function analyzeContractAdvanced(contractText) {
            const contractTypePrompts = {
                general: "This is a general business contract. Focus on identifying vendor information, payment terms, deliverables, and key obligations.",
                service: "This is a service agreement. Pay special attention to service descriptions, performance metrics, payment schedules, and service level agreements.",
                supply: "This is a supply or purchase contract. Focus on product specifications, quantities, unit prices, delivery terms, and total values.",
                consulting: "This is a consulting agreement. Emphasize project scope, hourly rates, milestones, deliverables, and payment terms.",
                maintenance: "This is a maintenance contract. Focus on equipment covered, service schedules, response times, and maintenance fees."
            };

            const contractPrompt = contractTypePrompts[settings.contractType] || contractTypePrompts.general;

            const prompt = `You are an expert contract analyst with years of experience in business law and contract interpretation. 

${contractPrompt}

Please analyze this contract systematically:

STEP 1: First, identify the document structure and key sections
STEP 2: Extract basic information (parties, dates, amounts)  
STEP 3: Identify all financial terms and payment obligations
STEP 4: Note any special conditions or clauses that could affect invoicing
STEP 5: Determine what should appear on valid invoices for this contract

Contract text:
${contractText.substring(0, 4000)}

Return a comprehensive JSON analysis with these fields:
{
  "vendor_name": "exact legal name of the vendor/supplier",
  "client_name": "name of the client/buyer", 
  "contract_number": "contract reference number",
  "contract_date": "contract signing date",
  "start_date": "contract effective start date",
  "end_date": "contract expiration date",
  "total_value": "total contract value",
  "currency": "contract currency",
  "payment_terms": "payment terms and conditions",
  "billing_frequency": "how often billing should occur",
  "line_items": [
    {
      "description": "item/service description",
      "quantity": "quantity if applicable",
      "unit_price": "price per unit",
      "total_price": "total for this line item"
    }
  ],
  "special_conditions": "any special billing or payment conditions",
  "invoice_requirements": "specific requirements for invoices",
  "late_payment_terms": "penalties for late payment",
  "contract_type": "type of contract identified",
  "key_obligations": "main obligations of each party",
  "analysis_confidence": "high/medium/low - how confident you are in this analysis"
}

Be extremely thorough and accurate. If any field cannot be determined, mark it as "not specified" rather than guessing.`;

            return await callOpenAI(prompt, 'You are an expert legal contract analyst. Analyze contracts with extreme precision and attention to detail.');
        }

        async function analyzeDocument(text, docType) {
            let prompt;
            
            if (docType === 'contract') {
                prompt = `You are a contract analysis expert. Analyze this contract and extract the following information in exact JSON format. Be thorough and precise - this data will be used for invoice reconciliation and compliance verification.

CRITICAL EXTRACTION RULES:
1. VENDOR means the company PROVIDING services/products (seller), NOT the buyer/client
2. Look for company names with Inc, LLC, Corp, Ltd, Company, Services, Solutions, Group, Partners
3. The vendor is who will be SENDING invoices, not receiving them
4. Extract EXACT amounts - do not round or approximate (e.g., 125000.00 not "about $125K")
5. Use ISO date format (YYYY-MM-DD) for all dates
6. Include ALL line items and pricing details found in the document
7. Capture payment schedules, milestones, and renewal terms precisely

IMPORTANT: This is a legal contract. Extract information with extreme precision for compliance and reconciliation purposes.

REQUIRED JSON STRUCTURE:
{
  "ai_summary": {
    "overview": "3-4 sentence summary combining who this vendor is, what they provide, and the key contract terms including payment structure and duration",
    "financial_highlights": ["3-5 bullet points focusing on financial terms, payment schedules, pricing structure, and renewal conditions"]
  },
  "vendor_information": {
    "legal_name": "Full legal business name of the SERVICE PROVIDER/VENDOR",
    "trade_names": ["Any DBA or trade names"],
    "address": "Complete business address",
    "tax_id": "Tax ID or EIN if available",
    "contact_email": "Primary contact email",
    "contact_phone": "Primary phone number"
  },
  "contract_details": {
    "contract_number": "Contract ID or reference number",
    "contract_type": "Service/Product/Subscription/etc",
    "effective_date": "Start date (YYYY-MM-DD format)",
    "expiration_date": "End date (YYYY-MM-DD format)",
    "renewal_terms": "Auto-renewal or manual renewal terms",
    "governing_law": "Jurisdiction/state governing the contract"
  },
  "financial_terms": {
    "total_contract_value": "Total contract amount in dollars",
    "currency": "USD or other currency",
    "payment_terms": "Net 30, Net 60, etc.",
    "billing_frequency": "Monthly/Quarterly/Annual/One-time",
    "payment_schedule": "When payments are due",
    "late_payment_penalty": "Late fee percentage or amount",
    "discount_terms": "Early payment discounts if any",
    "tax_handling": "How taxes are handled"
  },
  "services_products": {
    "description": "Primary services or products provided",
    "scope_of_work": "Detailed scope and deliverables",
    "quantities": "Expected volumes or quantities",
    "unit_rates": "Hourly rates, per-unit costs, etc.",
    "rate_structure": "Fixed fee, hourly, per-unit, etc.",
    "deliverables": ["List of specific deliverables"],
    "performance_metrics": "Success criteria or KPIs",
    "scope_limitations": "What is NOT included"
  },
  "billing_requirements": {
    "invoice_format": "Required invoice format or template",
    "supporting_documentation": "Required attachments or documentation",
    "approval_process": "Who needs to approve invoices",
    "submission_method": "How to submit invoices",
    "submission_deadline": "When invoices must be submitted",
    "purchase_order_required": "Yes/No if PO is required",
    "expense_reimbursement": "Policy for reimbursable expenses",
    "invoice_numbering": "Required numbering format"
  },
  "compliance_legal": {
    "change_order_process": "How to modify the contract",
    "termination_clause": "Termination conditions and notice",
    "dispute_resolution": "How disputes are handled",
    "confidentiality_terms": "NDA or confidentiality requirements",
    "intellectual_property": "IP ownership and usage rights",
    "liability_limitations": "Liability caps or limitations",
    "insurance_requirements": "Required insurance coverage",
    "compliance_requirements": "Regulatory or certification needs"
  },
  "special_conditions": {
    "milestone_payments": "Payment tied to specific milestones",
    "volume_discounts": "Discounts based on volume",
    "seasonal_adjustments": "Seasonal pricing or terms",
    "escalation_clauses": "Price increase mechanisms",
    "warranty_terms": "Warranty or guarantee periods",
    "service_level_agreements": "SLA requirements and penalties",
    "audit_rights": "Right to audit vendor performance/billing",
    "data_security_requirements": "Security and privacy requirements"
  }
}

EXTRACTION INSTRUCTIONS:
1. For the AI summary, focus ONLY on what IS explicitly stated in the contract - never mention what is missing or not specified
2. In the overview, combine vendor identity with contract terms naturally and concisely using only available information
3. For financial highlights, include ONLY the financial terms, payment details, and renewal conditions that are actually present in the contract
4. NEVER use phrases like "The contract does not specify", "not mentioned", "not addressed", or similar negative statements
5. If financial information is not available, simply omit that highlight rather than mentioning its absence
6. Extract ALL available information for other sections - be thorough and comprehensive
7. If information is not available in other sections, use "not specified" for that field
8. For dates, use YYYY-MM-DD format when possible
9. For monetary amounts, include currency and exact amounts
10. Focus on information that would be critical for invoice validation

Return ONLY the JSON object - no additional text or explanation.`;
            } else {
                // Enhanced invoice analysis prompt
                prompt = `You are an invoice analysis expert. Analyze this invoice and extract the following information in exact JSON format for reconciliation against contract terms.

REQUIRED JSON STRUCTURE:
{
  "vendor_information": {
    "vendor_name": "Billing entity name",
    "vendor_address": "Complete billing address",
    "tax_id": "Vendor tax ID if shown",
    "contact_info": "Phone/email if available"
  },
  "invoice_details": {
    "invoice_number": "Invoice reference number",
    "invoice_date": "Invoice date (YYYY-MM-DD)",
    "due_date": "Payment due date (YYYY-MM-DD)",
    "billing_period": "Service period covered",
    "purchase_order": "PO number if referenced",
    "contract_reference": "Contract number if mentioned"
  },
  "financial_breakdown": {
    "subtotal": "Pre-tax amount",
    "tax_amount": "Total tax amount",
    "tax_rate": "Tax percentage applied",
    "total_amount": "Final amount due",
    "currency": "Currency denomination",
    "payment_terms": "Payment terms stated on invoice"
  },
  "line_items": [
    {
      "description": "Service or product description",
      "quantity": "Quantity or hours",
      "unit_price": "Price per unit",
      "line_total": "Total for this line item",
      "period": "Service period if applicable",
      "category": "Type of service/product"
    }
  ],
  "expenses_reimbursements": [
    {
      "description": "Expense description",
      "amount": "Expense amount",
      "category": "Expense type",
      "documentation": "Supporting doc reference"
    }
  ],
  "payment_information": {
    "payment_method": "How to pay",
    "remit_to_address": "Payment address",
    "bank_details": "ACH/wire information if provided",
    "early_payment_discount": "Discount for early payment"
  },
  "compliance_notes": {
    "approvals_shown": "Any approval signatures/stamps",
    "supporting_docs": "Referenced supporting documentation",
    "special_instructions": "Any special payment instructions",
    "audit_trail": "Internal tracking numbers or codes"
  }
}

EXTRACTION INSTRUCTIONS:
1. Be extremely precise with monetary amounts and dates
2. Capture ALL line items with complete details
3. Note any discrepancies or unusual items
4. Include all referenced contract or PO numbers
5. Extract any approval or authorization information
6. If information is not available, use "not specified"
7. Ensure all monetary calculations are accurate

Return ONLY the JSON object - no additional text or explanation.`;
            }
            
            return await callOpenAI(`${prompt}\n\nDocument text:\n${text.substring(0, 4000)}`, 'You are a professional document analysis expert. Extract information with extreme accuracy and return only valid JSON that matches the specified structure exactly.');
        }

        async function callOpenAI(userPrompt, systemPrompt) {
            try {
                // Clean the prompts to remove any invalid Unicode characters
                const cleanSystemPrompt = systemPrompt.replace(/[\u0000-\u001F\u007F-\u009F]/g, '')
                                                      .replace(/[\uD800-\uDFFF]/g, '');
                const cleanUserPrompt = userPrompt.replace(/[\u0000-\u001F\u007F-\u009F]/g, '')
                                                  .replace(/[\uD800-\uDFFF]/g, '');
                
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: settings.aiModel,
                        messages: [
                            {
                                role: "system",
                                content: cleanSystemPrompt
                            },
                            {
                                role: "user", 
                                content: cleanUserPrompt
                            }
                        ],
                        temperature: 0.1,
                        max_tokens: 2000
                    })
                });
                
                if (!response.ok) {
                    throw new Error('OpenAI API request failed');
                }
                
                const data = await response.json();
                
                // Track token usage and cost
                if (data.usage) {
                    const inputTokens = data.usage.prompt_tokens || 0;
                    const outputTokens = data.usage.completion_tokens || 0;
                    
                    // Estimate cost based on GPT-4 pricing
                    const inputCost = (inputTokens / 1000) * 0.03;  // $0.03 per 1K input tokens
                    const outputCost = (outputTokens / 1000) * 0.06; // $0.06 per 1K output tokens
                    const totalCost = inputCost + outputCost;
                    
                    trackTokenUsage(totalCost);
                }
                
                const content = data.choices[0].message.content;
                
                // Try to parse JSON from the response
                try {
                    return JSON.parse(content);
                } catch (e) {
                    // If parsing fails, try to extract JSON from the response
                    const jsonMatch = content.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        return JSON.parse(jsonMatch[0]);
                    }
                    throw new Error('Could not parse AI response');
                }
            } catch (error) {
                console.error('AI analysis error:', error);
                throw error;
            }
        }

        async function compareDocuments(contractDetails, invoiceDetails) {
            // Use AI to perform intelligent reconciliation that understands business context
            const reconciliationPrompt = `You are an expert contract and invoice reconciliation analyst with deep business understanding.

ANALYZE AND RECONCILE these contract terms against this invoice, understanding business context and variations:

CONTRACT ANALYSIS:
${JSON.stringify(contractDetails, null, 2)}

INVOICE ANALYSIS:
${JSON.stringify(invoiceDetails, null, 2)}

INTELLIGENT RECONCILIATION INSTRUCTIONS:
1. UNDERSTAND BUSINESS CONTEXT: Company names may vary (legal name vs DBA vs shortened versions) - assess if they represent the same entity
2. THINK CONTEXTUALLY: Consider normal business practices and reasonable variations
3. IDENTIFY MATERIAL DISCREPANCIES: Focus on issues that could indicate billing errors, overcharges, or contract violations
4. PROVIDE BUSINESS INSIGHTS: Explain what discrepancies mean in practical terms
5. ASSESS VENDOR IDENTITY: Determine if the invoicing entity matches the contracted entity
6. EVALUATE FINANCIAL TERMS: Check if pricing, payment terms, and amounts align with contract
7. CONSIDER TIMING: Assess if invoice dates and service periods make business sense

Return analysis in this EXACT JSON format:
{
  "vendor_identity_analysis": {
    "same_entity": true/false,
    "confidence": "high/medium/low", 
    "explanation": "Detailed reasoning for your assessment of vendor identity"
  },
  "discrepancies": [
    {
      "field": "Field name",
      "severity": "critical/high/medium/low",
      "contract_value": "What the contract specifies",
      "invoice_value": "What the invoice shows", 
      "description": "Clear business-focused explanation of the discrepancy",
      "potential_impact": "Financial or operational impact of this discrepancy",
      "recommendation": "Specific action to resolve this discrepancy"
    }
  ],
  "insights": [
    {
      "category": "pricing/terms/compliance/billing_accuracy/other",
      "observation": "Business insight about this reconciliation",
      "business_impact": "What this means for the ongoing vendor relationship"
    }
  ],
  "summary": {
    "total_discrepancies": 0,
    "critical_issues": 0,
    "reconciliation_status": "PASSED/FAILED/REVIEW_REQUIRED",
    "overall_assessment": "Executive summary of findings and recommended next steps"
  }
}

Focus on material business issues, not cosmetic differences. Think like a finance professional reviewing vendor compliance.`;

            try {
                const aiResult = await callOpenAI(reconciliationPrompt, 'You are an expert business analyst specializing in contract and invoice reconciliation. Provide comprehensive, business-focused analysis that understands context and variations.');
                
                // Add description field for backward compatibility 
                if (aiResult.discrepancies) {
                    aiResult.discrepancies.forEach(disc => {
                        if (!disc.description && disc.potential_impact) {
                            disc.description = `${disc.potential_impact}. ${disc.recommendation}`;
                        }
                    });
                }
                
                // Ensure the result has the expected structure
                return {
                    discrepancies: aiResult.discrepancies || [],
                    insights: aiResult.insights || [],
                    vendor_identity_analysis: aiResult.vendor_identity_analysis || {},
                    warnings: [], // Keep for backward compatibility
                    matches: [], // Keep for backward compatibility  
                    summary: {
                        total_discrepancies: aiResult.discrepancies?.length || 0,
                        total_warnings: 0,
                        total_matches: 0,
                        critical_issues: aiResult.discrepancies?.filter(d => d.severity === 'critical' || d.severity === 'high').length || 0,
                        reconciliation_status: aiResult.summary?.reconciliation_status || (aiResult.discrepancies?.length > 0 ? "FAILED" : "PASSED"),
                        overall_assessment: aiResult.summary?.overall_assessment || "Reconciliation completed"
                    }
                };
            } catch (error) {
                console.error('AI reconciliation failed, falling back to basic comparison:', error);
                
                // Fallback to basic comparison if AI fails
                const discrepancies = [];
                const warnings = [];
                const matches = [];
                
                // Basic vendor name check with smart matching
                const contractVendor = contractDetails.vendor_information?.legal_name || contractDetails.vendor_name;
                const invoiceVendor = invoiceDetails.vendor_information?.vendor_name || invoiceDetails.vendor_name;
                
                if (contractVendor && invoiceVendor) {
                    const contractName = contractVendor.toLowerCase().trim();
                    const invoiceName = invoiceVendor.toLowerCase().trim();
                    
                    // Smart name matching - check if they share common words
                    const contractWords = contractName.split(/\s+/);
                    const invoiceWords = invoiceName.split(/\s+/);
                    const sharedWords = contractWords.filter(word => 
                        word.length > 2 && invoiceWords.some(iw => iw.includes(word) || word.includes(iw))
                    );
                    
                    if (sharedWords.length === 0) {
                        discrepancies.push({
                            field: "Vendor Identity",
                            severity: "high", 
                            contract_value: contractVendor,
                            invoice_value: invoiceVendor,
                            description: `Vendor name variation detected - please verify this is the same entity. Contract: "${contractVendor}", Invoice: "${invoiceVendor}"`,
                            recommendation: "Verify vendor identity and update records if needed"
                        });
                    } else {
                        matches.push("Vendor Identity (Similar Names)");
                    }
                }
                
                // Basic amount comparison
                const contractTotal = parseAmount(contractDetails.financial_terms?.total_contract_value || contractDetails.total_amount);
                const invoiceTotal = parseAmount(invoiceDetails.billing_details?.total_amount || invoiceDetails.total_amount);
                
                if (contractTotal && invoiceTotal) {
                    const difference = Math.abs(contractTotal - invoiceTotal);
                    const percentDiff = (difference / contractTotal) * 100;
                    
                    if (percentDiff > 5) { // More than 5% difference
                        discrepancies.push({
                            field: "Total Amount",
                            severity: percentDiff > 20 ? "critical" : "high",
                            contract_value: `$${contractTotal.toFixed(2)}`,
                            invoice_value: `$${invoiceTotal.toFixed(2)}`,
                            description: `Significant amount difference detected: ${percentDiff.toFixed(1)}% variance ($${difference.toFixed(2)} difference)`,
                            recommendation: "Review pricing terms and verify invoice accuracy"
                        });
                    } else {
                        matches.push("Total Amount");
                    }
                }
                
                return {
                    discrepancies: discrepancies,
                    insights: [{
                        category: "system",
                        observation: "AI analysis was unavailable - basic comparison performed",
                        business_impact: "Recommend running full AI analysis when system is available"
                    }],
                    vendor_identity_analysis: { 
                        same_entity: discrepancies.length === 0, 
                        confidence: "low", 
                        explanation: "AI analysis unavailable - basic comparison only" 
                    },
                    warnings: warnings,
                    matches: matches,
                    summary: {
                        total_discrepancies: discrepancies.length,
                        total_warnings: warnings.length,
                        total_matches: matches.length, 
                        critical_issues: discrepancies.filter(d => d.severity === 'critical' || d.severity === 'high').length,
                        reconciliation_status: discrepancies.length === 0 ? "PASSED" : "REVIEW_REQUIRED",
                        overall_assessment: "Basic reconciliation completed - full AI analysis recommended"
                    }
                };
            }
        }

        function parseAmount(amountStr) {
            if (!amountStr) return 0;
            const cleaned = String(amountStr).replace(/[$,]/g, '');
            return parseFloat(cleaned) || 0;
        }

        function calculateBatchSummary(invoiceResults) {
            const total = invoiceResults.length;
            const passed = invoiceResults.filter(r => r.status === 'PASSED').length;
            const failed = invoiceResults.filter(r => r.status === 'FAILED').length;
            const errors = invoiceResults.filter(r => r.status === 'ERROR').length;
            
            const totalDiscrepancies = invoiceResults.reduce((sum, r) => 
                sum + (r.comparison?.summary?.total_discrepancies || 0), 0);
            const totalWarnings = invoiceResults.reduce((sum, r) => 
                sum + (r.comparison?.summary?.total_warnings || 0), 0);
            
            return {
                total,
                passed,
                failed,
                errors,
                totalDiscrepancies,
                totalWarnings,
                passRate: ((passed / total) * 100).toFixed(1)
            };
        }

        function displayResults() {
            document.getElementById('processingSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.remove('hidden');
            
            // Display batch summary
            displayBatchSummary(currentResults.batchSummary);
            
            // Display contract analysis
            displayContractAnalysis(currentResults.contractAnalysis);
            
            // Display individual invoice results
            displayInvoiceResults(currentResults.invoiceResults);
        }

        function displayBatchSummary(summary) {
            const container = document.getElementById('batchSummaryStats');
            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${summary.total}</div>
                    <div class="stat-label">Total Invoices</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value passed">${summary.passed}</div>
                    <div class="stat-label">Passed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value failed">${summary.failed}</div>
                    <div class="stat-label">Failed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value warning">${summary.totalDiscrepancies}</div>
                    <div class="stat-label">Total Discrepancies</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${summary.passRate}%</div>
                    <div class="stat-label">Pass Rate</div>
                </div>
            `;
        }

        function displayContractAnalysis(contract) {
            const container = document.getElementById('contractDetailsContent');
            const details = Object.entries(contract || {})
                .filter(([key]) => !['line_items', 'key_obligations'].includes(key))
                .map(([key, value]) => `
                    <div class="detail-item">
                        <div class="detail-label">${key.replace(/_/g, ' ')}</div>
                        <div class="detail-value">${value || 'N/A'}</div>
                    </div>
                `).join('');
            
            container.innerHTML = `<div class="detail-grid">${details}</div>`;
        }

        function displayInvoiceResults(invoiceResults) {
            const container = document.getElementById('invoiceResults');
            container.innerHTML = invoiceResults.map((result, index) => {
                if (result.error) {
                    return `
                        <div class="invoice-result-card">
                            <div class="invoice-result-header">
                                <h3>❌ ${result.filename}</h3>
                                <span class="status-badge failed">ERROR</span>
                            </div>
                            <p style="color: var(--error);">Error: ${result.error}</p>
                        </div>
                    `;
                }

                const comparison = result.comparison;
                const invoice = result.invoiceDetails;
                
                return `
                    <div class="invoice-result-card">
                        <div class="invoice-result-header">
                            <h3>${getStatusIcon(result.status)} ${result.filename}</h3>
                            <span class="status-badge ${result.status.toLowerCase()}">${result.status}</span>
                        </div>
                        
                        ${comparison.discrepancies.length > 0 ? `
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: var(--error); margin-bottom: 10px;">🚨 Discrepancies Found</h4>
                                ${comparison.discrepancies.map(disc => `
                                    <div class="discrepancy-item">
                                        <strong>${disc.field}</strong><br>
                                        Contract: ${disc.contract_value}<br>
                                        Invoice: ${disc.invoice_value}
                                        ${disc.difference ? `<br>Difference: ${disc.difference}` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        ${comparison.warnings.length > 0 ? `
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: var(--warning); margin-bottom: 10px;">⚠️ Warnings</h4>
                                ${comparison.warnings.map(warning => `
                                    <div class="warning-item">
                                        <strong>${warning.field}</strong><br>
                                        ${warning.message}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        ${comparison.matches.length > 0 ? `
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: var(--accent-success); margin-bottom: 10px;">✅ Matches</h4>
                                ${comparison.matches.map(match => `<span class="match-badge">${match}</span>`).join('')}
                            </div>
                        ` : ''}
                        
                        <details style="margin-top: 20px;">
                            <summary style="cursor: pointer; font-weight: bold;">📄 Invoice Details</summary>
                            <div class="detail-grid" style="margin-top: 15px;">
                                ${Object.entries(invoice || {})
                                    .filter(([key]) => key !== 'items')
                                    .map(([key, value]) => `
                                        <div class="detail-item">
                                            <div class="detail-label">${key.replace(/_/g, ' ')}</div>
                                            <div class="detail-value">${value || 'N/A'}</div>
                                        </div>
                                    `).join('')}
                            </div>
                        </details>
                    </div>
                `;
            }).join('');
        }

        function getStatusIcon(status) {
            switch(status) {
                case 'PASSED': return '✅';
                case 'FAILED': return '❌';
                case 'ERROR': return '💥';
                default: return '❓';
            }
        }

        // Utility functions
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            section.classList.toggle('collapsed');
        }

        function resetAll() {
            contractFile = null;
            invoiceFiles = [];
            currentResults = null;
            
            document.getElementById('contractFile').value = '';
            document.getElementById('invoiceFiles').value = '';
            
            displayContractFile();
            displayInvoiceFiles();
            
            document.getElementById('uploadSection').querySelector('.section-content').style.display = 'block';
            document.getElementById('settingsSection').classList.remove('collapsed');
            document.getElementById('processingSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
        }

        function resetToUpload() {
            document.getElementById('uploadSection').querySelector('.section-content').style.display = 'block';
            document.getElementById('processingSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
        }

        function addMoreInvoices() {
            document.getElementById('invoiceFiles').click();
        }

        function toggleHistory() {
            const panel = document.getElementById('historyPanel');
            panel.classList.toggle('open');
            if (panel.classList.contains('open')) {
                loadHistory();
            }
        }

        function saveToHistory() {
            if (!currentResults) return;
            
            const history = JSON.parse(localStorage.getItem('reconciliation_history') || '[]');
            const newEntry = {
                id: Date.now(),
                timestamp: currentResults.timestamp,
                contractFile: currentResults.contractFile,
                invoiceCount: currentResults.invoiceResults.length,
                passRate: currentResults.batchSummary.passRate,
                results: currentResults
            };
            
            history.unshift(newEntry);
            // Keep only last 50 entries
            history.splice(50);
            
            localStorage.setItem('reconciliation_history', JSON.stringify(history));
            loadHistory();
            alert('Results saved to history!');
        }

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('reconciliation_history') || '[]');
            const container = document.getElementById('historyContent');
            
            if (history.length === 0) {
                container.innerHTML = '<p style="color: var(--neutral-dark); text-align: center;">No reconciliation history yet.</p>';
                return;
            }
            
            container.innerHTML = history.map(entry => `
                <div class="history-item" onclick="loadHistoryItem(${entry.id})">
                    <div style="font-weight: bold;">${entry.contractFile}</div>
                    <div style="font-size: 0.9rem; color: var(--neutral-dark);">
                        ${entry.invoiceCount} invoices • ${entry.passRate}% pass rate
                    </div>
                    <div style="font-size: 0.8rem; color: var(--neutral-dark);">
                        ${new Date(entry.timestamp).toLocaleString()}
                    </div>
                </div>
            `).join('');
        }

        function loadHistoryItem(id) {
            const history = JSON.parse(localStorage.getItem('reconciliation_history') || '[]');
            const entry = history.find(h => h.id === id);
            
            if (entry) {
                currentResults = entry.results;
                displayResults();
                toggleHistory();
            }
        }

        // Export functions
        function exportToPDF() {
            if (!currentResults) return;
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Title
            doc.setFontSize(20);
            doc.text('Invoice Reconciliation Report', 20, 20);
            
            // Batch summary
            doc.setFontSize(14);
            doc.text('Batch Summary', 20, 40);
            doc.setFontSize(10);
            doc.text(`Total Invoices: ${currentResults.batchSummary.total}`, 20, 50);
            doc.text(`Passed: ${currentResults.batchSummary.passed}`, 20, 60);
            doc.text(`Failed: ${currentResults.batchSummary.failed}`, 20, 70);
            doc.text(`Pass Rate: ${currentResults.batchSummary.passRate}%`, 20, 80);
            
            // Individual results
            let yPos = 100;
            currentResults.invoiceResults.forEach((result, index) => {
                if (yPos > 250) {
                    doc.addPage();
                    yPos = 20;
                }
                
                doc.setFontSize(12);
                doc.text(`${index + 1}. ${result.filename}`, 20, yPos);
                doc.setFontSize(10);
                doc.text(`Status: ${result.status}`, 20, yPos + 10);
                
                if (result.comparison) {
                    doc.text(`Discrepancies: ${result.comparison.summary.total_discrepancies}`, 20, yPos + 20);
                    doc.text(`Warnings: ${result.comparison.summary.total_warnings}`, 20, yPos + 30);
                }
                
                yPos += 45;
            });
            
            doc.save(`reconciliation-report-${new Date().toISOString().split('T')[0]}.pdf`);
        }

        function exportToExcel() {
            if (!currentResults) return;
            
            const wb = XLSX.utils.book_new();
            
            // Summary sheet
            const summaryData = [
                ['Metric', 'Value'],
                ['Total Invoices', currentResults.batchSummary.total],
                ['Passed', currentResults.batchSummary.passed],
                ['Failed', currentResults.batchSummary.failed],
                ['Pass Rate', currentResults.batchSummary.passRate + '%'],
                ['Total Discrepancies', currentResults.batchSummary.totalDiscrepancies],
                ['Total Warnings', currentResults.batchSummary.totalWarnings]
            ];
            
            const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, summaryWs, 'Summary');
            
            // Results sheet
            const resultsData = [
                ['Filename', 'Status', 'Discrepancies', 'Warnings', 'Matches']
            ];
            
            currentResults.invoiceResults.forEach(result => {
                resultsData.push([
                    result.filename,
                    result.status,
                    result.comparison?.summary?.total_discrepancies || 0,
                    result.comparison?.summary?.total_warnings || 0,
                    result.comparison?.summary?.total_matches || 0
                ]);
            });
            
            const resultsWs = XLSX.utils.aoa_to_sheet(resultsData);
            XLSX.utils.book_append_sheet(wb, resultsWs, 'Results');
            
            XLSX.writeFile(wb, `reconciliation-results-${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        // ===================================
        // UI/UX INTERACTION ENHANCEMENT SYSTEM
        // ===================================

        // Enhanced Button Functionality
        function initializeButtons() {
            // Add loading states for async operations
            document.querySelectorAll('button[data-loading-text]').forEach(button => {
                button.addEventListener('click', function() {
                    if (!this.disabled) {
                        this.classList.add('loading');
                        this.setAttribute('aria-busy', 'true');
                    }
                });
            });

            // Add tooltip functionality for disabled buttons
            document.querySelectorAll('button[disabled][data-tooltip]').forEach(button => {
                button.addEventListener('mouseenter', function() {
                    showTooltip(this, this.dataset.tooltip);
                });
                button.addEventListener('mouseleave', hideTooltip);
            });
        }

        // Enhanced Dropdown Functionality
        function initializeDropdowns() {
            document.querySelectorAll('select').forEach(select => {
                // Convert regular selects to enhanced dropdowns
                convertToEnhancedDropdown(select);
            });
        }

        function convertToEnhancedDropdown(select) {
            const wrapper = document.createElement('div');
            wrapper.className = 'dropdown';
            select.parentNode.insertBefore(wrapper, select);

            const toggle = document.createElement('button');
            toggle.className = 'dropdown-toggle';
            toggle.type = 'button';
            toggle.innerHTML = `
                <span class="dropdown-text">${select.options[select.selectedIndex]?.text || 'Select option'}</span>
                <span class="dropdown-arrow">▼</span>
            `;

            const menu = document.createElement('div');
            menu.className = 'dropdown-menu';
            
            // Add search for long lists
            if (select.options.length > 8) {
                const search = document.createElement('input');
                search.className = 'dropdown-search';
                search.placeholder = 'Search options...';
                search.addEventListener('input', (e) => filterDropdownItems(menu, e.target.value));
                menu.appendChild(search);
            }

            // Create dropdown items
            Array.from(select.options).forEach((option, index) => {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                if (option.selected) item.classList.add('selected');
                item.textContent = option.text;
                item.dataset.value = option.value;
                item.dataset.index = index;
                
                item.addEventListener('click', () => {
                    selectDropdownItem(select, toggle, menu, item, index);
                });
                
                menu.appendChild(item);
            });

            wrapper.appendChild(toggle);
            wrapper.appendChild(menu);
            select.style.display = 'none';

            // Add event listeners
            toggle.addEventListener('click', () => toggleDropdown(toggle, menu));
            toggle.addEventListener('keydown', (e) => handleDropdownKeyboard(e, menu));
            
            // Close on outside click
            document.addEventListener('click', (e) => {
                if (!wrapper.contains(e.target)) {
                    closeDropdown(toggle, menu);
                }
            });

            // Auto-detect direction
            toggle.addEventListener('click', () => {
                const rect = toggle.getBoundingClientRect();
                const spaceBelow = window.innerHeight - rect.bottom;
                const spaceAbove = rect.top;
                
                if (spaceBelow < 200 && spaceAbove > spaceBelow) {
                    menu.classList.add('open-upward');
                } else {
                    menu.classList.remove('open-upward');
                }
            });
        }

        function toggleDropdown(toggle, menu) {
            const isOpen = menu.classList.contains('open');
            
            // Close all other dropdowns
            document.querySelectorAll('.dropdown-menu.open').forEach(m => {
                if (m !== menu) closeDropdown(m.previousElementSibling, m);
            });

            if (isOpen) {
                closeDropdown(toggle, menu);
            } else {
                openDropdown(toggle, menu);
            }
        }

        function openDropdown(toggle, menu) {
            toggle.classList.add('open');
            menu.classList.add('open');
            toggle.setAttribute('aria-expanded', 'true');
            
            // Focus first item or search
            const search = menu.querySelector('.dropdown-search');
            const firstItem = menu.querySelector('.dropdown-item');
            
            setTimeout(() => {
                if (search) {
                    search.focus();
                } else if (firstItem) {
                    firstItem.classList.add('focused');
                }
            }, 150);
        }

        function closeDropdown(toggle, menu) {
            toggle.classList.remove('open');
            menu.classList.remove('open');
            toggle.setAttribute('aria-expanded', 'false');
            
            // Clear focused states
            menu.querySelectorAll('.dropdown-item.focused').forEach(item => {
                item.classList.remove('focused');
            });
        }

        function selectDropdownItem(select, toggle, menu, item, index) {
            // Update original select
            select.selectedIndex = index;
            select.dispatchEvent(new Event('change'));
            
            // Update dropdown appearance
            toggle.querySelector('.dropdown-text').textContent = item.textContent;
            menu.querySelectorAll('.dropdown-item').forEach(i => i.classList.remove('selected'));
            item.classList.add('selected');
            
            closeDropdown(toggle, menu);
        }

        function handleDropdownKeyboard(e, menu) {
            const items = menu.querySelectorAll('.dropdown-item');
            const focused = menu.querySelector('.dropdown-item.focused');
            let focusedIndex = focused ? Array.from(items).indexOf(focused) : -1;

            switch (e.key) {
                case 'Enter':
                case ' ':
                    e.preventDefault();
                    if (focused) {
                        focused.click();
                    }
                    break;
                
                case 'ArrowDown':
                    e.preventDefault();
                    focusedIndex = Math.min(focusedIndex + 1, items.length - 1);
                    updateFocusedItem(items, focusedIndex);
                    break;
                
                case 'ArrowUp':
                    e.preventDefault();
                    focusedIndex = Math.max(focusedIndex - 1, 0);
                    updateFocusedItem(items, focusedIndex);
                    break;
                
                case 'Escape':
                    closeDropdown(e.target, menu);
                    break;
            }
        }

        function updateFocusedItem(items, index) {
            items.forEach(item => item.classList.remove('focused'));
            if (items[index]) {
                items[index].classList.add('focused');
                items[index].scrollIntoView({ block: 'nearest' });
            }
        }

        function filterDropdownItems(menu, searchTerm) {
            const items = menu.querySelectorAll('.dropdown-item');
            const term = searchTerm.toLowerCase();
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(term) ? 'flex' : 'none';
            });
        }

        // Enhanced Form Functionality
        function initializeForms() {
            // Auto-focus first input
            document.querySelectorAll('form').forEach(form => {
                const firstInput = form.querySelector('input, textarea, select');
                if (firstInput && !firstInput.disabled) {
                    setTimeout(() => firstInput.focus(), 100);
                }
            });

            // Real-time validation
            document.querySelectorAll('input, textarea').forEach(input => {
                input.addEventListener('input', () => validateField(input));
                input.addEventListener('blur', () => validateField(input));
            });

            // Enhanced keyboard navigation
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && e.target.form) {
                    const form = e.target.form;
                    const submitButton = form.querySelector('button[type="submit"], button:not([type])');
                    
                    if (submitButton && !submitButton.disabled && isFormValid(form)) {
                        e.preventDefault();
                        submitButton.click();
                    }
                }
            });
        }

        function validateField(field) {
            const value = field.value.trim();
            const required = field.hasAttribute('required');
            const type = field.type;
            let isValid = true;
            let message = '';

            // Clear previous states
            field.classList.remove('error', 'success');
            
            // Required validation
            if (required && !value) {
                isValid = false;
                message = 'This field is required';
            }
            
            // Type-specific validation
            else if (value) {
                switch (type) {
                    case 'email':
                        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                        if (!emailRegex.test(value)) {
                            isValid = false;
                            message = 'Please enter a valid email address';
                        }
                        break;
                        
                    case 'number':
                        if (isNaN(value)) {
                            isValid = false;
                            message = 'Please enter a valid number';
                        }
                        break;
                }
            }

            // Update field state
            field.classList.add(isValid ? 'success' : 'error');
            updateFieldFeedback(field, message, isValid ? 'success' : 'error');
            
            return isValid;
        }

        function updateFieldFeedback(field, message, type) {
            let feedback = field.parentNode.querySelector('.form-feedback');
            
            if (!feedback) {
                feedback = document.createElement('div');
                feedback.className = 'form-feedback';
                field.parentNode.appendChild(feedback);
            }
            
            feedback.className = `form-feedback ${type}`;
            feedback.innerHTML = message ? `<span>${getStatusIcon(type)}</span> ${message}` : '';
        }

        function getStatusIcon(type) {
            const icons = {
                error: '❌',
                success: '✅',
                warning: '⚠️'
            };
            return icons[type] || '';
        }

        function isFormValid(form) {
            const inputs = form.querySelectorAll('input[required], textarea[required], select[required]');
            return Array.from(inputs).every(input => input.value.trim() !== '');
        }

        // Enhanced Feedback System
        function showAlert(message, type = 'info', duration = 5000) {
            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            alert.innerHTML = `
                <span class="alert-icon">${getAlertIcon(type)}</span>
                <div class="alert-content">
                    <div class="alert-title">${getAlertTitle(type)}</div>
                    <div>${message}</div>
                </div>
                <button class="alert-dismiss" onclick="this.parentElement.remove()">×</button>
            `;
            
            document.body.appendChild(alert);
            
            if (duration > 0) {
                setTimeout(() => {
                    if (alert.parentNode) {
                        alert.remove();
                    }
                }, duration);
            }
            
            return alert;
        }

        function showToast(message, type = 'info', duration = 3000) {
            const toast = document.createElement('div');
            toast.className = `toast alert ${type}`;
            toast.innerHTML = `
                <span class="alert-icon">${getAlertIcon(type)}</span>
                <div class="alert-content">${message}</div>
                <button class="alert-dismiss" onclick="this.parentElement.remove()">×</button>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, duration);
        }

        function getAlertIcon(type) {
            const icons = {
                success: '✅',
                error: '❌',
                warning: '⚠️',
                info: 'ℹ️'
            };
            return icons[type] || 'ℹ️';
        }

        function getAlertTitle(type) {
            const titles = {
                success: 'Success',
                error: 'Error',
                warning: 'Warning',
                info: 'Information'
            };
            return titles[type] || 'Notice';
        }

        // Initialize all enhanced UI/UX systems
        document.addEventListener('DOMContentLoaded', function() {
            initializeButtons();
            initializeDropdowns();
            initializeForms();
            
            // Add global keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                // ESC to close modals/dropdowns/sidebar
                if (e.key === 'Escape') {
                    // First check if sidebar is open
                    const sidebar = document.getElementById('sidebar');
                    if (sidebar && sidebar.classList.contains('open')) {
                        closeSidebar();
                        return;
                    }
                    
                    // Then close modals and dropdowns
                    document.querySelectorAll('.modal-backdrop.open').forEach(modal => {
                        modal.classList.remove('open');
                    });
                    document.querySelectorAll('.dropdown-menu.open').forEach(menu => {
                        const toggle = menu.previousElementSibling;
                        closeDropdown(toggle, menu);
                    });
                }
            });
        });

        // Update existing functions to use new feedback system
        function showApiStatus(message, type) {
            const statusDiv = document.getElementById('apiStatus');
            statusDiv.textContent = message;
            statusDiv.className = `api-status ${type}`;
            statusDiv.classList.remove('hidden');
            
            // Also show as toast for better UX
            if (type === 'success') {
                showToast(message, 'success');
            } else if (type === 'error') {
                showToast(message, 'error');
            }
        }

        // Tooltip system for disabled buttons
        let currentTooltip = null;

        function showTooltip(element, text) {
            hideTooltip();
            
            const tooltip = document.createElement('div');
            tooltip.className = 'tooltip-popup';
            tooltip.style.cssText = `
                position: absolute;
                background: var(--neutral-dark);
                color: var(--white);
                padding: 8px 12px;
                border-radius: var(--border-radius);
                font-size: 12px;
                white-space: nowrap;
                z-index: 10000;
                pointer-events: none;
                opacity: 0;
                transition: opacity var(--animation-fast) ease;
            `;
            tooltip.textContent = text;
            
            document.body.appendChild(tooltip);
            
            const rect = element.getBoundingClientRect();
            tooltip.style.left = `${rect.left + rect.width / 2 - tooltip.offsetWidth / 2}px`;
            tooltip.style.top = `${rect.top - tooltip.offsetHeight - 8}px`;
            
            setTimeout(() => tooltip.style.opacity = '1', 10);
            currentTooltip = tooltip;
        }

        function hideTooltip() {
            if (currentTooltip) {
                currentTooltip.remove();
                currentTooltip = null;
            }
        }

        // Enhanced history panel with keyboard navigation
        function toggleHistory() {
            const panel = document.getElementById('historyPanel');
            const isOpen = panel.classList.contains('open');
            
            if (isOpen) {
                panel.classList.remove('open');
                document.body.style.overflow = '';
            } else {
                panel.classList.add('open');
                document.body.style.overflow = 'hidden'; // Prevent background scroll
                loadHistory();
                
                // Focus first history item for keyboard navigation
                setTimeout(() => {
                    const firstItem = panel.querySelector('.history-item');
                    if (firstItem) firstItem.focus();
                }, 300);
            }
        }

        // Enhanced processing with better loading states
        function updateProcessingStatus(status) {
            document.getElementById('processingStatus').textContent = status;
            
            // Also update page title to show progress
            if (status.includes('Processing') || status.includes('Analyzing')) {
                document.title = `⏳ ${status} - Invoice Reconciliation Platform`;
            }
        }

        // Reset page title when done
        function displayResults() {
            document.title = 'Invoice Reconciliation Platform Pro - Precision Contract Validation';
            
            document.getElementById('processingSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.remove('hidden');
            
            // Display batch summary
            displayBatchSummary(currentResults.batchSummary);
            
            // Display contract analysis
            displayContractAnalysis(currentResults.contractAnalysis);
            
            // Display individual invoice results
            displayInvoiceResults(currentResults.invoiceResults);
            
            // Show success toast
            showToast(`✅ Reconciliation complete! Processed ${currentResults.invoiceResults.length} invoices`, 'success');
        }

        // Enhanced error handling
        let errorCount = 0;
        window.addEventListener('error', function(e) {
            errorCount++;
            console.error('Application error #' + errorCount + ':', e.error);
            console.error('Error location:', e.filename + ':' + e.lineno + ':' + e.colno);
            
            // Only show user-facing errors for critical failures, not handled exceptions
            if (errorCount <= 3 && !e.error.message.includes('handled') && !e.error.message.includes('Expected')) {
                showAlert('An unexpected error occurred. Please refresh the page and try again.', 'error');
            }
        });

        // Enhanced keyboard navigation for tables/lists
        function initializeTableNavigation() {
            document.querySelectorAll('.data-table tbody tr, .data-list-item').forEach((row, index) => {
                row.setAttribute('tabindex', '0');
                row.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        row.click();
                    }
                });
            });
        }

        // Initialize table navigation when results are displayed
        function displayInvoiceResults(invoiceResults) {
            const container = document.getElementById('invoiceResults');
            container.innerHTML = invoiceResults.map((result, index) => {
                if (result.error) {
                    return `
                        <div class="invoice-result-card" tabindex="0">
                            <div class="invoice-result-header">
                                <h3>❌ ${result.filename}</h3>
                                <span class="status-badge failed">ERROR</span>
                            </div>
                            <p style="color: var(--error);">Error: ${result.error}</p>
                        </div>
                    `;
                }

                const comparison = result.comparison;
                const invoice = result.invoiceDetails;
                
                return `
                    <div class="invoice-result-card" tabindex="0">
                        <div class="invoice-result-header">
                            <h3>${getStatusIcon(result.status)} ${result.filename}</h3>
                            <span class="status-badge ${result.status.toLowerCase()}">${result.status}</span>
                        </div>
                        
                        ${comparison.discrepancies.length > 0 ? `
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: var(--error); margin-bottom: 10px;">🚨 Discrepancies Found</h4>
                                ${comparison.discrepancies.map(disc => `
                                    <div class="discrepancy-item">
                                        <strong>${disc.field}</strong><br>
                                        Contract: ${disc.contract_value}<br>
                                        Invoice: ${disc.invoice_value}
                                        ${disc.difference ? `<br>Difference: ${disc.difference}` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        ${comparison.warnings.length > 0 ? `
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: var(--warning); margin-bottom: 10px;">⚠️ Warnings</h4>
                                ${comparison.warnings.map(warning => `
                                    <div class="warning-item">
                                        <strong>${warning.field}</strong><br>
                                        ${warning.message}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        ${comparison.matches.length > 0 ? `
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: var(--accent-success); margin-bottom: 10px;">✅ Matches</h4>
                                ${comparison.matches.map(match => `<span class="match-badge">${match}</span>`).join('')}
                            </div>
                        ` : ''}
                        
                        <details style="margin-top: 20px;">
                            <summary style="cursor: pointer; font-weight: bold; padding: 8px 0;">📄 Invoice Details</summary>
                            <div class="detail-grid" style="margin-top: 15px;">
                                ${Object.entries(invoice || {})
                                    .filter(([key]) => key !== 'items')
                                    .map(([key, value]) => `
                                        <div class="detail-item">
                                            <div class="detail-label">${key.replace(/_/g, ' ')}</div>
                                            <div class="detail-value">${value || 'N/A'}</div>
                                        </div>
                                    `).join('')}
                            </div>
                        </details>
                    </div>
                `;
            }).join('');
            
            // Initialize keyboard navigation for the new results
            setTimeout(initializeTableNavigation, 100);
        }
    </script>
</body>
</html>