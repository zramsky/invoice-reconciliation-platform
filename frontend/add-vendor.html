<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add New Vendor - Contract Reconciliation Platform</title>
    <style>
        :root {
            --primary: #0f0f0f;
            --secondary: #1a1a1a;
            --accent: #2a2a2a;
            --border: #333;
            --text: #ffffff;
            --text-muted: #b0b0b0;
            --accent-cyan: #00d4ff;
            --accent-purple: #8b5cf6;
            --accent-success: #10b981;
            --accent-warning: #f59e0b;
            --accent-error: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: var(--text-muted);
            font-size: 1.1rem;
        }

        .back-button {
            position: absolute;
            top: 30px;
            left: 30px;
            background: var(--secondary);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
        }

        .back-button:hover {
            background: var(--accent);
            border-color: var(--accent-cyan);
        }

        .upload-section {
            background: var(--secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 40px;
            margin-bottom: 30px;
            text-align: center;
        }

        .upload-area {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 60px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .upload-area:hover {
            border-color: var(--accent-cyan);
            background: rgba(0, 212, 255, 0.05);
        }

        .upload-area.drag-over {
            border-color: var(--accent-cyan);
            background: rgba(0, 212, 255, 0.1);
        }

        .upload-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 20px;
            opacity: 0.6;
        }

        .upload-text {
            font-size: 1.3rem;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .upload-subtext {
            color: var(--text-muted);
            margin-bottom: 20px;
        }

        .file-types {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .processing-section {
            background: var(--secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 40px;
            margin-bottom: 30px;
            display: none;
        }

        .processing-title {
            text-align: center;
            margin-bottom: 30px;
            font-size: 1.5rem;
        }

        .progress-container {
            margin-bottom: 30px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--accent);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-cyan), var(--accent-purple));
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            color: var(--text-muted);
            text-align: center;
        }

        .vendor-form {
            background: var(--secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 40px;
            display: none;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text);
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            background: var(--primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 16px;
            transition: border-color 0.2s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent-cyan);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .required {
            color: var(--accent-error);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
            font-size: 16px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 212, 255, 0.3);
        }

        .btn-secondary {
            background: var(--accent);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--primary);
            border-color: var(--accent-cyan);
        }

        .form-actions {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-top: 30px;
        }

        .ai-insights {
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid var(--accent-cyan);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            display: none;
        }

        .ai-insights-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            color: var(--accent-cyan);
            font-weight: 600;
        }

        .insight-item {
            background: var(--primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
        }

        .insight-label {
            font-weight: 600;
            color: var(--accent-cyan);
            margin-bottom: 4px;
        }

        .insight-value {
            color: var(--text-muted);
        }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
        }
        
        .toast {
            background: var(--secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px 20px;
            margin-bottom: 10px;
            min-width: 300px;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease-out;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .toast.success {
            border-left: 4px solid var(--accent-success);
        }
        
        .toast.error {
            border-left: 4px solid var(--accent-error);
        }
        
        .toast.warning {
            border-left: 4px solid var(--accent-warning);
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    </style>
    <!-- External Libraries -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <a href="index.html" class="back-button">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
        </svg>
        Back to Dashboard
    </a>

    <div class="container">
        <div class="header">
            <h1>Add New Vendor</h1>
            <p>Upload a contract to automatically create a vendor profile</p>
        </div>

        <!-- Upload Section -->
        <div class="upload-section" id="uploadSection">
            <div class="upload-area" id="uploadArea" onclick="document.getElementById('contractFile').click()">
                <input type="file" id="contractFile" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.tiff,.bmp" style="display: none;" onchange="handleFileSelect(event)">
                
                <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="12" y1="11" x2="12" y2="17"></line>
                    <polyline points="9 14 12 11 15 14"></polyline>
                </svg>
                
                <div class="upload-text">Upload Contract Document</div>
                <div class="upload-subtext">Drag and drop your contract file or click to browse</div>
                <div class="file-types">Supports PDF, Word documents, and images</div>
            </div>
        </div>

        <!-- Processing Section -->
        <div class="processing-section" id="processingSection">
            <div class="processing-title">🤖 AI Analysis in Progress</div>
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">Extracting text from contract...</div>
            </div>
        </div>

        <!-- AI Insights Section -->
        <div class="ai-insights" id="aiInsights">
            <div class="ai-insights-title">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M12 1v6m0 6v6m11-7h-6m-6 0H1"></path>
                </svg>
                AI Contract Insights
            </div>
            <div id="insightsContainer"></div>
        </div>

        <!-- Vendor Form -->
        <div class="vendor-form" id="vendorForm">
            <h2 style="margin-bottom: 30px; text-align: center;">Confirm Vendor Information</h2>
            <p style="text-align: center; color: var(--text-muted); margin-bottom: 30px;">
                Review the AI-extracted information and add any missing details
            </p>
            
            <form id="addVendorForm">
                <div class="form-group">
                    <label for="vendorName">Vendor Name <span class="required">*</span></label>
                    <input type="text" id="vendorName" name="vendorName" required>
                </div>
                
                <div class="form-group">
                    <label for="businessType">Business Type <span class="required">*</span></label>
                    <input type="text" id="businessType" name="businessType" placeholder="e.g., Medical Supplies, Waste Management" required>
                </div>
                
                <div class="form-group">
                    <label for="contractDate">Contract Date <span class="required">*</span></label>
                    <input type="date" id="contractDate" name="contractDate" required>
                </div>
                
                <div class="form-group">
                    <label for="notes">Additional Notes (Optional)</label>
                    <textarea id="notes" name="notes" placeholder="Any additional notes for AP reference" rows="3"></textarea>
                </div>
            </form>
            
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="window.location.href='index.html'">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveVendor()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    Create Vendor Profile
                </button>
            </div>
        </div>
    </div>

    <script>
        let uploadedFile = null;
        let contractAnalysis = null;
        let apiKey = localStorage.getItem('openai_api_key');

        // Toast notification system
        function showToast(message, type = 'info', duration = 5000) {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icon = type === 'success' ? '✅' : type === 'error' ? '❌' : type === 'warning' ? '⚠️' : 'ℹ️';
            toast.innerHTML = `<span>${icon}</span><span>${message}</span>`;
            
            toastContainer.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // Drag and drop functionality
        document.addEventListener('DOMContentLoaded', function() {
            const uploadArea = document.getElementById('uploadArea');
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('drag-over');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('drag-over');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
                const files = Array.from(e.dataTransfer.files);
                if (files.length > 0) {
                    const file = files[0];
                    if (isValidFileType(file)) {
                        handleFileUpload(file);
                    } else {
                        showToast('Please upload a valid contract file (PDF, Word, or image)', 'error');
                    }
                }
            });

            // Check for API key
            if (!apiKey) {
                showToast('Please configure your OpenAI API key in the main dashboard first', 'warning');
            }
        });

        function isValidFileType(file) {
            const validTypes = [
                'application/pdf',
                'application/msword',
                'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                'image/jpeg',
                'image/jpg',
                'image/png',
                'image/tiff',
                'image/bmp'
            ];
            return validTypes.includes(file.type);
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file && isValidFileType(file)) {
                handleFileUpload(file);
            } else if (file) {
                showToast('Please upload a valid contract file (PDF, Word, or image)', 'error');
            }
        }

        async function handleFileUpload(file) {
            if (!apiKey) {
                showToast('Please configure your OpenAI API key in the main dashboard first', 'error');
                return;
            }

            uploadedFile = file;
            
            // Hide upload section, show processing
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('processingSection').style.display = 'block';
            
            showToast(`Processing contract: ${file.name}`, 'info');
            
            try {
                // Step 1: Extract text
                updateProgress('Extracting text from contract...', 20);
                const contractText = await extractTextFromFile(file);
                
                // Step 2: Analyze with AI
                updateProgress('Analyzing contract with AI...', 50);
                contractAnalysis = await analyzeContract(contractText);
                
                // Step 3: Show insights
                updateProgress('Extracting vendor information...', 80);
                showAIInsights(contractAnalysis);
                
                // Step 4: Pre-fill form
                updateProgress('Preparing vendor form...', 100);
                prefillVendorForm(contractAnalysis);
                
                // Show final sections
                setTimeout(() => {
                    document.getElementById('processingSection').style.display = 'none';
                    document.getElementById('aiInsights').style.display = 'block';
                    document.getElementById('vendorForm').style.display = 'block';
                    showToast('Contract analysis complete! Review and complete the vendor profile.', 'success');
                }, 1000);
                
            } catch (error) {
                console.error('Error processing contract:', error);
                showToast('Error processing contract: ' + error.message, 'error');
                document.getElementById('processingSection').style.display = 'none';
                document.getElementById('uploadSection').style.display = 'block';
            }
        }

        function updateProgress(message, percentage) {
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressText').textContent = message;
        }

        async function extractTextFromFile(file) {
            const fileType = file.type;
            
            if (fileType === 'application/pdf') {
                return await extractTextFromPDF(file);
            } else if (fileType.startsWith('image/')) {
                return await extractTextFromImage(file);
            } else if (fileType.includes('word')) {
                // For Word documents, we'll treat them as text for now
                showToast('Word document detected. For best results, please convert to PDF first.', 'warning');
                return await extractTextFromImage(file); // Fallback to OCR
            }
            
            throw new Error('Unsupported file type');
        }

        async function extractTextFromPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            let fullText = '';
            
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');
                fullText += pageText + '\\n';
            }
            
            return fullText;
        }

        async function extractTextFromImage(file) {
            const { data: { text } } = await Tesseract.recognize(file, 'eng', {
                logger: m => {
                    if (m.status === 'recognizing text') {
                        updateProgress(`OCR Processing: ${Math.round(m.progress * 100)}%`, 30 + (m.progress * 20));
                    }
                }
            });
            return text;
        }

        async function analyzeContract(text) {
            const prompt = `You are an expert AP contracts analyst. Read the following vendor contract and produce two outputs:

1. "vendor_profile": A concise vendor profile with:
   - vendor_name (as written in the contract)
   - business_type (short label, 1–5 words, e.g., "Medical Supplies", "Waste Management")
   - key_details: top 3–5 short bullets with important vendor context (e.g., renewal type, termination terms, or other high-level items relevant for AP tracking).

2. "ap_terms_summary": A short, structured summary of the billing and payment terms that AP must use to reconcile invoices. Include:
   - invoice_frequency (e.g., monthly, quarterly, milestone)
   - payment_terms (e.g., Net 30, Due upon receipt)
   - recurring_charges (describe items, unit prices, units of measure, included quantities, overage rates if any)
   - one_time_fees (setup, implementation, training, etc.)
   - discounts_or_credits (early payment discounts, volume discounts, service credits, etc.)
   - any other rules that directly affect invoice validation (e.g., required PO number, proration rules, caps, dispute window).

CONTRACT TEXT:
${text.substring(0, 8000)}

OUTPUT REQUIREMENTS:
- Return valid JSON only in this schema:

{
  "vendor_profile": {
    "vendor_name": null,
    "business_type": null,
    "key_details": []
  },
  "ap_terms_summary": {
    "invoice_frequency": null,
    "payment_terms": null,
    "recurring_charges": [],
    "one_time_fees": [],
    "discounts_or_credits": [],
    "other_invoice_rules": []
  }
}

- Be concise and practical. 
- Do not include legal boilerplate, only the terms relevant to AP and reconciliation.
- If something is missing, set the value to null.
- Do not include any prose outside the JSON.`;

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4-turbo-preview',
                        messages: [
                            {
                                role: "system",
                                content: "You are an expert contract analyst. Extract vendor information accurately and return only valid JSON."
                            },
                            {
                                role: "user", 
                                content: prompt
                            }
                        ],
                        temperature: 0.1,
                        max_tokens: 1500
                    })
                });
                
                if (!response.ok) {
                    throw new Error('OpenAI API request failed');
                }
                
                const data = await response.json();
                const content = data.choices[0].message.content;
                
                // Try to parse JSON from the response
                try {
                    return JSON.parse(content);
                } catch (e) {
                    // If parsing fails, try to extract JSON from the response
                    const jsonMatch = content.match(/\\{[\\s\\S]*\\}/);
                    if (jsonMatch) {
                        return JSON.parse(jsonMatch[0]);
                    }
                    throw new Error('Could not parse AI response as JSON');
                }
            } catch (error) {
                console.error('AI analysis error:', error);
                throw error;
            }
        }

        function showAIInsights(analysis) {
            const container = document.getElementById('insightsContainer');
            const vendorProfile = analysis.vendor_profile || {};
            const apTerms = analysis.ap_terms_summary || {};
            
            let insightsHtml = '';
            
            // Vendor Profile Section
            insightsHtml += `
                <div class="insight-section">
                    <h4 style="color: var(--accent-cyan); margin-bottom: 15px;">📋 Vendor Profile</h4>
                    <div class="insight-item">
                        <div class="insight-label">Vendor Name</div>
                        <div class="insight-value">${vendorProfile.vendor_name || 'Not specified'}</div>
                    </div>
                    <div class="insight-item">
                        <div class="insight-label">Business Type</div>
                        <div class="insight-value">${vendorProfile.business_type || 'Not specified'}</div>
                    </div>
                    ${vendorProfile.key_details && vendorProfile.key_details.length > 0 ? `
                        <div class="insight-item">
                            <div class="insight-label">Key Details</div>
                            <div class="insight-value">
                                <ul style="margin: 0; padding-left: 16px;">
                                    ${vendorProfile.key_details.map(detail => `<li>${detail}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            // AP Terms Section
            insightsHtml += `
                <div class="insight-section" style="margin-top: 25px;">
                    <h4 style="color: var(--accent-purple); margin-bottom: 15px;">💰 AP Terms Summary</h4>
                    <div class="insight-item">
                        <div class="insight-label">Invoice Frequency</div>
                        <div class="insight-value">${apTerms.invoice_frequency || 'Not specified'}</div>
                    </div>
                    <div class="insight-item">
                        <div class="insight-label">Payment Terms</div>
                        <div class="insight-value">${apTerms.payment_terms || 'Not specified'}</div>
                    </div>
                    ${apTerms.recurring_charges && apTerms.recurring_charges.length > 0 ? `
                        <div class="insight-item">
                            <div class="insight-label">Recurring Charges</div>
                            <div class="insight-value">
                                <ul style="margin: 0; padding-left: 16px;">
                                    ${apTerms.recurring_charges.map(charge => `<li>${charge}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    ` : ''}
                    ${apTerms.one_time_fees && apTerms.one_time_fees.length > 0 ? `
                        <div class="insight-item">
                            <div class="insight-label">One-Time Fees</div>
                            <div class="insight-value">
                                <ul style="margin: 0; padding-left: 16px;">
                                    ${apTerms.one_time_fees.map(fee => `<li>${fee}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    ` : ''}
                    ${apTerms.discounts_or_credits && apTerms.discounts_or_credits.length > 0 ? `
                        <div class="insight-item">
                            <div class="insight-label">Discounts & Credits</div>
                            <div class="insight-value">
                                <ul style="margin: 0; padding-left: 16px;">
                                    ${apTerms.discounts_or_credits.map(discount => `<li>${discount}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    ` : ''}
                    ${apTerms.other_invoice_rules && apTerms.other_invoice_rules.length > 0 ? `
                        <div class="insight-item">
                            <div class="insight-label">Other Invoice Rules</div>
                            <div class="insight-value">
                                <ul style="margin: 0; padding-left: 16px;">
                                    ${apTerms.other_invoice_rules.map(rule => `<li>${rule}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            container.innerHTML = insightsHtml;
        }

        function prefillVendorForm(analysis) {
            const vendorProfile = analysis.vendor_profile || {};
            
            // Pre-fill form fields with AI-extracted data
            if (vendorProfile.vendor_name) {
                document.getElementById('vendorName').value = vendorProfile.vendor_name;
            }
            if (vendorProfile.business_type) {
                document.getElementById('businessType').value = vendorProfile.business_type;
            }
            
            // Set today's date as default contract date
            document.getElementById('contractDate').value = new Date().toISOString().split('T')[0];
        }

        async function saveVendor() {
            const form = document.getElementById('addVendorForm');
            const formData = new FormData(form);
            
            // Validate required fields
            const name = formData.get('vendorName').trim();
            const businessType = formData.get('businessType').trim();
            const contractDate = formData.get('contractDate');
            
            if (!name || !businessType || !contractDate) {
                showToast('Please fill in all required fields', 'error');
                return;
            }
            
            if (!uploadedFile || !contractAnalysis) {
                showToast('Contract analysis not completed', 'error');
                return;
            }
            
            try {
                // Create streamlined vendor object with only essential AP data
                const vendor = {
                    id: Date.now().toString(),
                    
                    // Basic vendor info
                    vendor_name: name,
                    business_type: businessType,
                    contract_date: contractDate,
                    notes: formData.get('notes') || '',
                    
                    // AI Analysis results
                    vendor_profile: contractAnalysis.vendor_profile || {},
                    ap_terms_summary: contractAnalysis.ap_terms_summary || {},
                    
                    // Contract file reference
                    contract_file: {
                        name: uploadedFile.name,
                        upload_date: new Date().toISOString(),
                        data: await fileToBase64(uploadedFile)
                    },
                    
                    // System metadata
                    status: 'active',
                    created_at: new Date().toISOString(),
                    last_updated: new Date().toISOString(),
                    invoice_count: 0
                };
                
                // Save to localStorage
                const vendors = JSON.parse(localStorage.getItem('vendors') || '[]');
                vendors.push(vendor);
                localStorage.setItem('vendors', JSON.stringify(vendors));
                
                showToast('Vendor profile created successfully!', 'success');
                
                // Redirect to dashboard after short delay
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1500);
                
            } catch (error) {
                console.error('Error saving vendor:', error);
                showToast('Error saving vendor: ' + error.message, 'error');
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }
    </script>
</body>
</html>