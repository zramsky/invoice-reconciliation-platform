<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add New Vendor - Contract Reconciliation Platform</title>
    <style>
        :root {
            --primary: #0f0f0f;
            --secondary: #1a1a1a;
            --accent: #2a2a2a;
            --border: #333;
            --text: #ffffff;
            --text-muted: #b0b0b0;
            --accent-cyan: #00d4ff;
            --accent-purple: #8b5cf6;
            --accent-success: #10b981;
            --accent-warning: #f59e0b;
            --accent-error: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: var(--text-muted);
            font-size: 1.1rem;
        }

        .back-button {
            position: absolute;
            top: 30px;
            left: 30px;
            background: var(--secondary);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
        }

        .back-button:hover {
            background: var(--accent);
            border-color: var(--accent-cyan);
        }

        .upload-section {
            background: var(--secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 40px;
            margin-bottom: 30px;
            text-align: center;
        }

        .upload-area {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 60px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .upload-area:hover {
            border-color: var(--accent-cyan);
            background: rgba(0, 212, 255, 0.05);
        }

        .upload-area.drag-over {
            border-color: var(--accent-cyan);
            background: rgba(0, 212, 255, 0.1);
        }

        .upload-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 20px;
            opacity: 0.6;
        }

        .upload-text {
            font-size: 1.3rem;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .upload-subtext {
            color: var(--text-muted);
            margin-bottom: 20px;
        }

        .file-types {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .processing-section {
            background: var(--secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 40px;
            margin-bottom: 30px;
            display: none;
        }

        .processing-title {
            text-align: center;
            margin-bottom: 30px;
            font-size: 1.5rem;
        }

        .progress-container {
            margin-bottom: 30px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--accent);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-cyan), var(--accent-purple));
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            color: var(--text-muted);
            text-align: center;
        }

        .vendor-form {
            background: var(--secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 40px;
            display: none;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text);
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            background: var(--primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 16px;
            transition: border-color 0.2s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent-cyan);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .required {
            color: var(--accent-error);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
            font-size: 16px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 212, 255, 0.3);
        }

        .btn-secondary {
            background: var(--accent);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--primary);
            border-color: var(--accent-cyan);
        }

        .form-actions {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-top: 30px;
        }

        .ai-insights {
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid var(--accent-cyan);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            display: none;
        }

        .ai-insights-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            color: var(--accent-cyan);
            font-weight: 600;
        }

        .insight-item {
            background: var(--primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
        }

        .insight-label {
            font-weight: 600;
            color: var(--accent-cyan);
            margin-bottom: 4px;
        }

        .insight-value {
            color: var(--text-muted);
        }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
        }
        
        .toast {
            background: var(--secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px 20px;
            margin-bottom: 10px;
            min-width: 300px;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease-out;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .toast.success {
            border-left: 4px solid var(--accent-success);
        }
        
        .toast.error {
            border-left: 4px solid var(--accent-error);
        }
        
        .toast.warning {
            border-left: 4px solid var(--accent-warning);
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    </style>
    <!-- External Libraries -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <a href="index.html" class="back-button">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
        </svg>
        Back to Dashboard
    </a>

    <div class="container">
        <div class="header">
            <h1>Add New Vendor</h1>
            <p>Upload a contract to automatically create a vendor profile</p>
        </div>

        <!-- Upload Section -->
        <div class="upload-section" id="uploadSection">
            <div class="upload-area" id="uploadArea" onclick="document.getElementById('contractFile').click()">
                <input type="file" id="contractFile" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.tiff,.bmp" style="display: none;" onchange="handleFileSelect(event)">
                
                <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="12" y1="11" x2="12" y2="17"></line>
                    <polyline points="9 14 12 11 15 14"></polyline>
                </svg>
                
                <div class="upload-text">Upload Contract Document</div>
                <div class="upload-subtext">Drag and drop your contract file or click to browse</div>
                <div class="file-types">Supports PDF, Word documents, and images</div>
            </div>
        </div>

        <!-- Processing Section -->
        <div class="processing-section" id="processingSection">
            <div class="processing-title">🤖 AI Analysis in Progress</div>
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">Extracting text from contract...</div>
            </div>
        </div>

        <!-- AI Insights Section -->
        <div class="ai-insights" id="aiInsights">
            <div class="ai-insights-title">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M12 1v6m0 6v6m11-7h-6m-6 0H1"></path>
                </svg>
                AI Contract Insights
            </div>
            <div id="insightsContainer"></div>
        </div>

        <!-- Vendor Form -->
        <div class="vendor-form" id="vendorForm">
            <h2 style="margin-bottom: 30px; text-align: center;">Complete Vendor Profile</h2>
            
            <form id="addVendorForm">
                <div class="form-group">
                    <label for="vendorName">Vendor Name <span class="required">*</span></label>
                    <input type="text" id="vendorName" name="vendorName" required>
                </div>
                
                <div class="form-group">
                    <label for="legalName">Legal Business Name</label>
                    <input type="text" id="legalName" name="legalName">
                </div>
                
                <div class="form-group">
                    <label for="businessType">Business Type</label>
                    <input type="text" id="businessType" name="businessType" placeholder="e.g., Technology Services, Consulting">
                </div>
                
                <div class="form-group">
                    <label for="contactEmail">Contact Email</label>
                    <input type="email" id="contactEmail" name="contactEmail">
                </div>
                
                <div class="form-group">
                    <label for="contactPhone">Contact Phone</label>
                    <input type="tel" id="contactPhone" name="contactPhone">
                </div>
                
                <div class="form-group">
                    <label for="address">Address</label>
                    <textarea id="address" name="address" placeholder="Complete business address"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="effectiveDate">Contract Effective Date <span class="required">*</span></label>
                    <input type="date" id="effectiveDate" name="effectiveDate" required>
                </div>
                
                <div class="form-group">
                    <label for="expirationDate">Contract Expiration Date</label>
                    <input type="date" id="expirationDate" name="expirationDate">
                </div>
                
                <div class="form-group">
                    <label for="contractValue">Total Contract Value</label>
                    <input type="number" id="contractValue" name="contractValue" step="0.01" placeholder="0.00">
                </div>
                
                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea id="description" name="description" placeholder="Brief description of services or products"></textarea>
                </div>
            </form>
            
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="window.location.href='index.html'">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveVendor()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    Create Vendor
                </button>
            </div>
        </div>
    </div>

    <script>
        let uploadedFile = null;
        let contractAnalysis = null;
        let apiKey = localStorage.getItem('openai_api_key');

        // Toast notification system
        function showToast(message, type = 'info', duration = 5000) {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icon = type === 'success' ? '✅' : type === 'error' ? '❌' : type === 'warning' ? '⚠️' : 'ℹ️';
            toast.innerHTML = `<span>${icon}</span><span>${message}</span>`;
            
            toastContainer.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // Drag and drop functionality
        document.addEventListener('DOMContentLoaded', function() {
            const uploadArea = document.getElementById('uploadArea');
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('drag-over');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('drag-over');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
                const files = Array.from(e.dataTransfer.files);
                if (files.length > 0) {
                    const file = files[0];
                    if (isValidFileType(file)) {
                        handleFileUpload(file);
                    } else {
                        showToast('Please upload a valid contract file (PDF, Word, or image)', 'error');
                    }
                }
            });

            // Check for API key
            if (!apiKey) {
                showToast('Please configure your OpenAI API key in the main dashboard first', 'warning');
            }
        });

        function isValidFileType(file) {
            const validTypes = [
                'application/pdf',
                'application/msword',
                'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                'image/jpeg',
                'image/jpg',
                'image/png',
                'image/tiff',
                'image/bmp'
            ];
            return validTypes.includes(file.type);
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file && isValidFileType(file)) {
                handleFileUpload(file);
            } else if (file) {
                showToast('Please upload a valid contract file (PDF, Word, or image)', 'error');
            }
        }

        async function handleFileUpload(file) {
            if (!apiKey) {
                showToast('Please configure your OpenAI API key in the main dashboard first', 'error');
                return;
            }

            uploadedFile = file;
            
            // Hide upload section, show processing
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('processingSection').style.display = 'block';
            
            showToast(`Processing contract: ${file.name}`, 'info');
            
            try {
                // Step 1: Extract text
                updateProgress('Extracting text from contract...', 20);
                const contractText = await extractTextFromFile(file);
                
                // Step 2: Analyze with AI
                updateProgress('Analyzing contract with AI...', 50);
                contractAnalysis = await analyzeContract(contractText);
                
                // Step 3: Show insights
                updateProgress('Extracting vendor information...', 80);
                showAIInsights(contractAnalysis);
                
                // Step 4: Pre-fill form
                updateProgress('Preparing vendor form...', 100);
                prefillVendorForm(contractAnalysis);
                
                // Show final sections
                setTimeout(() => {
                    document.getElementById('processingSection').style.display = 'none';
                    document.getElementById('aiInsights').style.display = 'block';
                    document.getElementById('vendorForm').style.display = 'block';
                    showToast('Contract analysis complete! Review and complete the vendor profile.', 'success');
                }, 1000);
                
            } catch (error) {
                console.error('Error processing contract:', error);
                showToast('Error processing contract: ' + error.message, 'error');
                document.getElementById('processingSection').style.display = 'none';
                document.getElementById('uploadSection').style.display = 'block';
            }
        }

        function updateProgress(message, percentage) {
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressText').textContent = message;
        }

        async function extractTextFromFile(file) {
            const fileType = file.type;
            
            if (fileType === 'application/pdf') {
                return await extractTextFromPDF(file);
            } else if (fileType.startsWith('image/')) {
                return await extractTextFromImage(file);
            } else if (fileType.includes('word')) {
                // For Word documents, we'll treat them as text for now
                showToast('Word document detected. For best results, please convert to PDF first.', 'warning');
                return await extractTextFromImage(file); // Fallback to OCR
            }
            
            throw new Error('Unsupported file type');
        }

        async function extractTextFromPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            let fullText = '';
            
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');
                fullText += pageText + '\\n';
            }
            
            return fullText;
        }

        async function extractTextFromImage(file) {
            const { data: { text } } = await Tesseract.recognize(file, 'eng', {
                logger: m => {
                    if (m.status === 'recognizing text') {
                        updateProgress(`OCR Processing: ${Math.round(m.progress * 100)}%`, 30 + (m.progress * 20));
                    }
                }
            });
            return text;
        }

        async function analyzeContract(text) {
            const prompt = `You are a contract analysis expert. Analyze this contract and extract vendor information in exact JSON format.

CRITICAL EXTRACTION RULES:
1. VENDOR means the company PROVIDING services/products (seller), NOT the buyer/client
2. Look for company names with Inc, LLC, Corp, Ltd, Company, Services, Solutions, Group, Partners
3. The vendor is who will be SENDING invoices, not receiving them
4. Extract EXACT amounts - do not round or approximate
5. Use ISO date format (YYYY-MM-DD) for all dates

Contract text:
${text.substring(0, 6000)}

Return ONLY this JSON structure:
{
  "vendor_information": {
    "legal_name": "Full legal business name of the SERVICE PROVIDER/VENDOR",
    "trade_names": ["Any DBA or trade names"],
    "address": "Complete business address",
    "tax_id": "Tax ID or EIN if available",
    "contact_email": "Primary contact email",
    "contact_phone": "Primary phone number"
  },
  "contract_details": {
    "contract_number": "Contract ID or reference number",
    "contract_type": "Service/Product/Subscription/etc",
    "effective_date": "Start date (YYYY-MM-DD format)",
    "expiration_date": "End date (YYYY-MM-DD format)",
    "total_value": "Total contract amount as number",
    "currency": "USD or other currency",
    "payment_terms": "Net 30, Net 60, etc.",
    "billing_frequency": "Monthly/Quarterly/Annual/One-time"
  },
  "services_description": "Brief description of services or products provided"
}

Return ONLY the JSON object - no additional text.`;

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4-turbo-preview',
                        messages: [
                            {
                                role: "system",
                                content: "You are an expert contract analyst. Extract vendor information accurately and return only valid JSON."
                            },
                            {
                                role: "user", 
                                content: prompt
                            }
                        ],
                        temperature: 0.1,
                        max_tokens: 1500
                    })
                });
                
                if (!response.ok) {
                    throw new Error('OpenAI API request failed');
                }
                
                const data = await response.json();
                const content = data.choices[0].message.content;
                
                // Try to parse JSON from the response
                try {
                    return JSON.parse(content);
                } catch (e) {
                    // If parsing fails, try to extract JSON from the response
                    const jsonMatch = content.match(/\\{[\\s\\S]*\\}/);
                    if (jsonMatch) {
                        return JSON.parse(jsonMatch[0]);
                    }
                    throw new Error('Could not parse AI response as JSON');
                }
            } catch (error) {
                console.error('AI analysis error:', error);
                throw error;
            }
        }

        function showAIInsights(analysis) {
            const container = document.getElementById('insightsContainer');
            const vendor = analysis.vendor_information || {};
            const contract = analysis.contract_details || {};
            
            const insights = [
                { label: 'Vendor Name', value: vendor.legal_name || 'Not specified' },
                { label: 'Business Type', value: contract.contract_type || 'Not specified' },
                { label: 'Contract Value', value: contract.total_value ? `$${parseFloat(contract.total_value).toLocaleString()}` : 'Not specified' },
                { label: 'Contract Period', value: contract.effective_date && contract.expiration_date ? `${contract.effective_date} to ${contract.expiration_date}` : 'Not specified' },
                { label: 'Payment Terms', value: contract.payment_terms || 'Not specified' }
            ];
            
            container.innerHTML = insights.map(insight => `
                <div class="insight-item">
                    <div class="insight-label">${insight.label}</div>
                    <div class="insight-value">${insight.value}</div>
                </div>
            `).join('');
        }

        function prefillVendorForm(analysis) {
            const vendor = analysis.vendor_information || {};
            const contract = analysis.contract_details || {};
            
            // Pre-fill form fields
            if (vendor.legal_name) document.getElementById('vendorName').value = vendor.legal_name;
            if (vendor.legal_name) document.getElementById('legalName').value = vendor.legal_name;
            if (contract.contract_type) document.getElementById('businessType').value = contract.contract_type;
            if (vendor.contact_email) document.getElementById('contactEmail').value = vendor.contact_email;
            if (vendor.contact_phone) document.getElementById('contactPhone').value = vendor.contact_phone;
            if (vendor.address) document.getElementById('address').value = vendor.address;
            if (contract.effective_date) document.getElementById('effectiveDate').value = contract.effective_date;
            if (contract.expiration_date) document.getElementById('expirationDate').value = contract.expiration_date;
            if (contract.total_value) document.getElementById('contractValue').value = contract.total_value;
            if (analysis.services_description) document.getElementById('description').value = analysis.services_description;
        }

        async function saveVendor() {
            const form = document.getElementById('addVendorForm');
            const formData = new FormData(form);
            
            // Validate required fields
            const name = formData.get('vendorName').trim();
            const effectiveDate = formData.get('effectiveDate');
            
            if (!name || !effectiveDate) {
                showToast('Please fill in all required fields (Vendor Name and Effective Date)', 'error');
                return;
            }
            
            if (!uploadedFile) {
                showToast('No contract file uploaded', 'error');
                return;
            }
            
            try {
                // Create vendor object
                const vendor = {
                    id: Date.now().toString(),
                    name: name,
                    legalName: formData.get('legalName') || '',
                    businessType: formData.get('businessType') || '',
                    description: formData.get('description') || '',
                    contactEmail: formData.get('contactEmail') || '',
                    contactPhone: formData.get('contactPhone') || '',
                    address: formData.get('address') || '',
                    contractFile: uploadedFile.name,
                    contractFileData: await fileToBase64(uploadedFile),
                    contractAnalysis: contractAnalysis,
                    contractUploadDate: new Date().toISOString(),
                    effectiveDate: effectiveDate,
                    expirationDate: formData.get('expirationDate') || '',
                    contractValue: parseFloat(formData.get('contractValue')) || 0,
                    status: 'active',
                    createdAt: new Date().toISOString(),
                    lastUpdated: new Date().toISOString(),
                    invoiceCount: 0
                };
                
                // Save to localStorage
                const vendors = JSON.parse(localStorage.getItem('vendors') || '[]');
                vendors.push(vendor);
                localStorage.setItem('vendors', JSON.stringify(vendors));
                
                showToast('Vendor created successfully!', 'success');
                
                // Redirect to dashboard after short delay
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1500);
                
            } catch (error) {
                console.error('Error saving vendor:', error);
                showToast('Error saving vendor: ' + error.message, 'error');
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }
    </script>
</body>
</html>