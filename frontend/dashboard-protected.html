<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Unspend - Cut waste. Keep the signal. [Updated v3.0 with Charts]</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        /* 
        ==============================================
        UNSPEND BRAND SYSTEM
        ==============================================
        Brand: "Cut waste. Keep the signal."
        Futuristic, sharp, and trustworthy. Tron energy meets modern fintech.
        */

        :root {
            /* UNSPEND ORANGE SYSTEM */
            --orange-600: #FF7A1A;     /* Glow Orange - primary brand */
            --orange-500: #FF8C3A;     /* Core Orange - main actions */
            --orange-400: #FF9C66;     /* Mid Orange - hover states */
            --orange-300: #FFB38A;     /* Apricot - soft highlights */
            --orange-200: #FFD1B3;     /* Peach Highlight - subtle accents */
            --orange-100: #FFE8D9;     /* Soft Haze - lightest orange */
            --ember-700: #E04D00;      /* Deep Ember - shadows and depth */
            
            /* UNSPEND NEUTRAL SYSTEM */
            --ink-900: #0B0B0C;        /* Darkest - main background */
            --ink-800: #111113;        /* Dark - card backgrounds */
            --ink-600: #2A2A2E;        /* Medium - elevated surfaces */
            --cloud-200: #EDEEF0;      /* Light neutral - borders */
            --cloud-100: #F7F7F8;      /* Lightest - text on dark */
            
            /* UNSPEND GRADIENTS */
            --grad-energy: linear-gradient(90deg, #FF7A1A 0%, #FF9C66 50%, #FFD1A3 100%);
            --grad-surface: radial-gradient(circle at 40% 30%, #FFB38A, #FF8C3A 60%, #E04D00 100%);
            --grad-background: linear-gradient(180deg, #FFE8D9 0%, #FFB38A 60%, #FF8C3A 100%);
            
            /* SEMANTIC COLORS */
            --primary: var(--orange-600);
            --secondary: var(--orange-500);
            --success: #00E676;
            --warning: #FFC107;
            --error: #FF5252;
            
            /* TEXT COLORS */
            --text-primary: var(--cloud-100);
            --text-secondary: var(--cloud-200);
            --text-muted: rgba(237, 238, 240, 0.7);
            --text-on-orange: #FFFFFF;
            
            /* BACKGROUND SYSTEM */
            --bg-main: var(--ink-900);
            --bg-surface: var(--ink-800);
            --bg-elevated: var(--ink-600);
            --bg-orange: rgba(255, 122, 26, 0.1);
            --bg-orange-light: rgba(255, 179, 138, 0.05);
            
            /* BORDER SYSTEM */
            --border-light: rgba(255, 255, 255, 0.08);
            --border-medium: rgba(255, 255, 255, 0.12);
            --border-strong: rgba(255, 255, 255, 0.16);
            --border-orange: var(--orange-600);
            --border-glow: rgba(255, 122, 26, 0.3);
            
            /* MODAL & CONNECTION STATUS SYSTEM */
            --modal-backdrop: rgba(11, 11, 12, 0.85);
            --modal-surface: var(--bg-elevated);
            --overlay-blur: blur(20px);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-highlight: rgba(255, 255, 255, 0.05);
            
            /* UNSPEND TYPOGRAPHY */
            --font-primary: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            --font-mono: 'JetBrains Mono', 'SF Mono', Monaco, 'Cascadia Code', monospace;
            
            /* UNSPEND TYPE SCALE */
            --text-display: 48px;
            --text-h1: 40px;
            --text-h2: 32px;
            --text-h3: 24px;
            --text-body: 16px;
            --text-small: 14px;
            --text-caption: 12px;
            
            /* UNSPEND SHADOWS & GLOWS */
            --shadow-soft: 0 4px 20px rgba(0, 0, 0, 0.2);
            --shadow-medium: 0 8px 20px rgba(0, 0, 0, 0.35);
            --shadow-button: 0 2px 8px rgba(0, 0, 0, 0.3);
            --shadow-inset: inset 0 1px 0 rgba(255, 255, 255, 0.1);
            --glow-orange: 0 0 12px rgba(255, 176, 107, 0.6), 0 0 24px rgba(255, 209, 163, 0.45);
            --glow-orange-soft: 0 0 20px rgba(255, 122, 26, 0.3);
            --glow-success: 0 0 20px rgba(0, 230, 118, 0.3);
            
            /* UNSPEND BORDER RADIUS */
            --radius-card: 16px;
            --radius-pill: 999px;
            --radius-button: 16px;
            --radius-small: 8px;
            
            /* UI/UX INTERACTION SYSTEM */
            --button-min-height: 44px;
            --button-min-height-mobile: 48px;
            --button-margin: 16px;
            --dropdown-item-height: 40px;
            --table-row-height: 48px;
            --animation-fast: 150ms;
            --animation-standard: 200ms;
            --animation-slow: 300ms;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-primary);
            background: var(--bg-main);
            background-attachment: fixed;
            min-height: 100vh;
            padding: 20px;
            color: var(--text-primary);
            font-size: var(--text-body);
            line-height: 1.5;
            overflow-x: hidden;
        }

        /* Dark mode gradient overlay for depth */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 80%, rgba(0, 212, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(0, 230, 118, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        /* ===================================
           UI/UX INTERACTION CONSISTENCY SYSTEM
           =================================== */

        /* 1. BUTTON SYSTEM */
        .btn, button:not(.unstyled) {
            min-height: var(--button-min-height);
            padding: 14px 20px;
            border: none;
            border-radius: var(--radius-button);
            font-family: var(--font-primary);
            font-size: var(--text-small);
            font-weight: 600;
            cursor: pointer;
            transition: all 200ms ease;
            margin: 8px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
            position: relative;
            overflow: hidden;
            user-select: none;
            line-height: 1;
        }

        /* Unspend Button Variants */
        .btn-primary {
            background: var(--grad-energy);
            color: var(--text-on-orange);
            box-shadow: var(--shadow-button);
        }

        .btn-secondary {
            background: var(--bg-surface);
            color: var(--text-primary);
            border: 1px solid var(--border-medium);
        }

        .btn-success {
            background: var(--success);
            color: var(--text-on-orange);
        }

        .btn-warning {
            background: var(--warning);
            color: var(--bg-main);
        }

        .btn-danger {
            background: var(--error);
            color: var(--text-on-orange);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--orange-600);
            color: var(--orange-600);
        }

        .btn-ghost {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border-light);
        }

        /* Unspend Button States - Hover */
        .btn:hover:not(:disabled), button:hover:not(:disabled) {
            transform: translateY(-2px);
            transition: all 200ms ease;
        }

        .btn-primary:hover:not(:disabled) {
            filter: brightness(1.05);
            box-shadow: var(--glow-orange);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--bg-elevated);
            border-color: var(--border-strong);
        }

        .btn-outline:hover:not(:disabled) {
            background: var(--bg-orange);
            box-shadow: var(--glow-orange-soft);
        }

        .btn-warning:hover:not(:disabled) {
            background: var(--error);
            color: var(--white);
        }

        .btn-danger:hover:not(:disabled) {
            background: var(--warning);
            color: var(--neutral-dark);
        }

        .btn-outline:hover:not(:disabled) {
            background: var(--accent-cyan);
            color: var(--white);
        }

        .btn-ghost:hover:not(:disabled) {
            background: var(--neutral-light);
            border-color: var(--border-medium);
        }

        /* Button States - Active/Pressed */
        .btn:active:not(:disabled), button:active:not(:disabled) {
            transform: translateY(-1px) scale(0.98);
            transition: all var(--animation-fast) ease;
        }

        /* Button States - Disabled */
        .btn:disabled, button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        /* Button States - Loading */
        .btn.loading, button.loading {
            color: transparent;
            pointer-events: none;
        }

        .btn.loading::after, button.loading::after {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 16px;
            height: 16px;
            border: 2px solid currentColor;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* Button Sizes */
        .btn-small {
            min-height: 32px;
            padding: 6px 12px;
            font-size: 12px;
            margin: 4px;
        }

        .btn-large {
            min-height: 52px;
            padding: 16px 32px;
            font-size: 16px;
            font-weight: 600;
        }

        /* Mobile Button Adjustments */
        @media (max-width: 768px) {
            .btn, button:not(.unstyled) {
                min-height: var(--button-min-height-mobile);
                margin: var(--button-margin) 8px;
            }
        }

        /* 2. DROPDOWN SYSTEM */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-toggle {
            background: var(--white);
            border: 2px solid var(--border-light);
            border-radius: var(--border-radius);
            padding: 12px 16px;
            font-family: var(--font-primary);
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            min-width: 150px;
            transition: all var(--animation-standard) ease;
        }

        .dropdown-toggle:hover {
            border-color: var(--border-medium);
            box-shadow: var(--shadow-soft);
        }

        .dropdown-toggle:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 0 3px var(--cyan-focus);
        }

        .dropdown-toggle.open {
            border-color: var(--accent-cyan);
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }

        .dropdown-arrow {
            transition: transform var(--animation-standard) ease;
            font-size: 12px;
            color: var(--neutral-dark);
        }

        .dropdown-toggle.open .dropdown-arrow {
            transform: rotate(180deg);
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--white);
            border: 2px solid var(--accent-cyan);
            border-top: none;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            box-shadow: var(--shadow-medium);
            z-index: 1000;
            max-height: 320px;
            overflow-y: auto;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all var(--animation-standard) ease;
        }

        .dropdown-menu.open {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-menu.open-upward {
            top: auto;
            bottom: 100%;
            border: 2px solid var(--accent-cyan);
            border-bottom: none;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            transform: translateY(10px);
        }

        .dropdown-menu.open-upward.open {
            transform: translateY(0);
        }

        .dropdown-item {
            min-height: var(--dropdown-item-height);
            padding: 12px 16px;
            display: flex;
            align-items: center;
            cursor: pointer;
            color: var(--neutral-dark);
            font-size: 14px;
            border-bottom: 1px solid var(--border-light);
            transition: background-color var(--animation-fast) ease;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover, .dropdown-item.focused {
            background: var(--cyan-bg-light);
            color: var(--primary);
        }

        .dropdown-item.selected {
            background: var(--success-bg);
            color: var(--accent-success);
            font-weight: 500;
        }

        .dropdown-search {
            padding: 12px 16px;
            border: none;
            border-bottom: 2px solid var(--border-light);
            width: 100%;
            font-family: var(--font-primary);
            font-size: 14px;
            background: var(--neutral-light);
        }

        .dropdown-search:focus {
            outline: none;
            border-bottom-color: var(--accent-cyan);
            background: var(--white);
        }

        /* 3. FORM & INPUT SYSTEM */
        .form-group {
            margin-bottom: 24px;
            position: relative;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--neutral-dark);
            font-size: 14px;
        }

        .form-label.required::after {
            content: " *";
            color: var(--error);
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border-light);
            border-radius: var(--border-radius);
            font-family: var(--font-primary);
            font-size: 14px;
            background: var(--white);
            transition: all var(--animation-standard) ease;
            line-height: 1.4;
        }

        .form-input:hover, .form-textarea:hover, .form-select:hover {
            border-color: var(--border-medium);
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 0 3px var(--cyan-focus);
        }

        .form-input.error, .form-textarea.error, .form-select.error {
            border-color: var(--error);
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
        }

        .form-input.success, .form-textarea.success, .form-select.success {
            border-color: var(--accent-success);
            box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.1);
        }

        .form-feedback {
            margin-top: 6px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .form-feedback.error {
            color: var(--error);
        }

        .form-feedback.success {
            color: var(--accent-success);
        }

        .form-feedback.warning {
            color: var(--warning);
        }

        .form-input-short {
            max-width: 120px;
        }

        .form-input-medium {
            max-width: 200px;
        }

        /* 4. TABLE & LIST SYSTEM */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--white);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow-soft);
        }

        .data-table thead {
            background: var(--neutral-light);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table th {
            padding: 16px 20px;
            font-weight: 600;
            font-size: 14px;
            color: var(--primary);
            border-bottom: 2px solid var(--border-light);
        }

        .data-table th.text-left { text-align: left; }
        .data-table th.text-center { text-align: center; }
        .data-table th.text-right { text-align: right; }

        .data-table td {
            padding: 16px 20px;
            min-height: var(--table-row-height);
            border-bottom: 1px solid var(--border-light);
            vertical-align: middle;
        }

        .data-table td.text-left { text-align: left; }
        .data-table td.text-center { text-align: center; }
        .data-table td.text-right { text-align: right; }

        .data-table tbody tr {
            transition: background-color var(--animation-fast) ease;
            cursor: pointer;
        }

        .data-table tbody tr:hover {
            background: var(--cyan-bg);
        }

        .data-table tbody tr.selected {
            background: var(--success-bg-light);
        }

        .data-list {
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-soft);
            overflow: hidden;
        }

        .data-list-item {
            min-height: var(--table-row-height);
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            transition: background-color var(--animation-fast) ease;
            cursor: pointer;
        }

        .data-list-item:last-child {
            border-bottom: none;
        }

        .data-list-item:hover {
            background: var(--cyan-bg);
        }

        .data-list-item.selected {
            background: var(--success-bg-light);
        }

        /* 5. MODAL & OVERLAY SYSTEM */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(13, 27, 42, 0.6);
            backdrop-filter: blur(2px);
            z-index: 9000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all var(--animation-standard) ease;
        }

        .modal-backdrop.open {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--white);
            border-radius: var(--border-radius-large);
            box-shadow: var(--shadow-medium);
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9) translateY(20px);
            transition: all var(--animation-standard) ease;
            position: relative;
        }

        .modal-backdrop.open .modal-content {
            transform: scale(1) translateY(0);
        }

        .modal-header {
            padding: 24px 32px 20px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--primary);
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--neutral-dark);
            cursor: pointer;
            padding: 4px;
            border-radius: var(--border-radius);
            transition: all var(--animation-fast) ease;
        }

        .modal-close:hover {
            background: var(--error-bg-light);
            color: var(--error);
        }

        .modal-body {
            padding: 24px 32px;
        }

        .modal-footer {
            padding: 20px 32px 24px;
            border-top: 1px solid var(--border-light);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* CONNECTION STATUS & API KEY MANAGEMENT */
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--surface-2);
            backdrop-filter: var(--overlay-blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            box-shadow: var(--shadow-soft);
            z-index: 1000;
            transition: all var(--animation-standard) ease;
        }

        .connection-status.connected {
            background: var(--success-bg);
            border-color: var(--accent-success);
            color: var(--accent-success);
        }

        .connection-status.disconnected {
            background: var(--error-bg);
            border-color: var(--error);
            color: var(--error);
        }

        .connection-status .status-icon {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }

        .connection-status .settings-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 16px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
            margin-left: 8px;
        }

        .connection-status .settings-btn:hover {
            background: var(--glass-highlight);
            color: var(--accent-cyan);
        }

        /* FIRST-TIME SETUP MODAL */
        .setup-modal .modal-content {
            max-width: 500px;
            background: var(--modal-surface);
            backdrop-filter: var(--overlay-blur);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
        }

        .setup-modal .modal-header {
            border-bottom: 1px solid var(--border-medium);
            background: linear-gradient(135deg, var(--glass-highlight), transparent);
        }

        .setup-modal .modal-title {
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .setup-welcome {
            text-align: center;
            margin-bottom: 24px;
        }

        .setup-welcome h3 {
            color: var(--accent-cyan);
            margin-bottom: 8px;
            font-size: 18px;
        }

        .setup-welcome p {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.5;
        }

        .removed-api-key-setup {
            background: var(--surface-1);
            border: 1px solid var(--border-medium);
            border-radius: var(--border-radius);
            padding: 20px;
            margin: 20px 0;
        }

        .removed-api-key-setup .input-group {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .removed-api-key-setup input {
            flex: 1;
            background: var(--surface-2);
            border: 1px solid var(--border-medium);
            color: var(--text-primary);
            padding: 12px 16px;
            border-radius: var(--border-radius);
            font-family: var(--font-mono);
            font-size: 14px;
        }

        .removed-api-key-setup input:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 0 3px var(--cyan-focus);
        }

        .removed-api-key-setup .test-btn {
            background: var(--secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-medium);
            padding: 12px 20px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .removed-api-key-setup .test-btn:hover {
            background: var(--accent-cyan);
            color: var(--primary);
            border-color: var(--accent-cyan);
        }

        .setup-status {
            padding: 12px;
            border-radius: var(--border-radius);
            margin-top: 12px;
            font-size: 14px;
            text-align: center;
        }

        .setup-status.success {
            background: var(--success-bg);
            color: var(--accent-success);
            border: 1px solid var(--accent-success);
        }

        .setup-status.error {
            background: var(--error-bg);
            color: var(--error);
            border: 1px solid var(--error);
        }

        .token-usage {
            background: var(--surface-1);
            border: 1px solid var(--border-medium);
            border-radius: var(--border-radius);
            padding: 16px;
            margin: 16px 0;
            text-align: center;
        }

        .token-usage .usage-label {
            color: var(--text-secondary);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .token-usage .usage-amount {
            color: var(--accent-cyan);
            font-size: 24px;
            font-weight: 700;
            font-family: var(--font-mono);
        }

        .token-usage.warning {
            border-color: var(--warning);
            background: var(--warning-bg);
        }

        .token-usage.warning .usage-amount {
            color: var(--warning);
        }

        /* SIDEBAR NAVIGATION SYSTEM */
        .menu-button {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 44px;
            height: 44px;
            background: var(--surface-2);
            backdrop-filter: var(--overlay-blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            color: var(--text-primary);
            box-shadow: var(--shadow-soft);
            z-index: 1001;
            transition: all var(--animation-standard) ease;
        }

        .menu-button:hover {
            background: var(--accent-cyan);
            color: var(--primary);
            border-color: var(--accent-cyan);
            transform: scale(1.05);
        }

        .sidebar {
            position: fixed;
            top: 0;
            left: -300px;
            width: 300px;
            height: 100vh;
            background: var(--surface-2);
            backdrop-filter: var(--overlay-blur);
            border-right: 1px solid var(--glass-border);
            z-index: 1000;
            transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto;
        }

        .sidebar.open {
            left: 0;
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: var(--modal-backdrop);
            backdrop-filter: var(--overlay-blur);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .sidebar-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        .sidebar-header {
            padding: 24px;
            border-bottom: 1px solid var(--border-medium);
            background: linear-gradient(135deg, var(--glass-highlight), transparent);
        }

        .sidebar-header h3 {
            color: var(--text-primary);
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sidebar-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .sidebar-close:hover {
            background: var(--error-bg);
            color: var(--error);
        }

        .sidebar-nav {
            padding: 20px 0;
        }

        .sidebar-nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 24px;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-family: var(--font-primary);
            font-size: 14px;
        }

        .sidebar-nav-item:hover {
            background: var(--glass-highlight);
            color: var(--accent-cyan);
        }

        .sidebar-nav-item .icon {
            font-size: 16px;
            width: 20px;
            text-align: center;
        }

        .sidebar-divider {
            height: 1px;
            background: var(--border-light);
            margin: 16px 24px;
        }

        /* REMOVE SETTINGS SECTION COMPLETELY */
        #settingsSection {
            display: none !important;
        }

        /* PAGE VIEW SYSTEM */
        .page-view {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .page-view.active {
            display: block;
        }

        /* SECTION VIEW SYSTEM */
        .section-view {
            display: none;
            animation: fadeIn 0.3s ease;
            padding: 24px;
        }

        .section-view.active {
            display: block;
        }

        .section-header {
            margin-bottom: 32px;
        }

        .section-header h1 {
            font-size: var(--text-h1);
            font-weight: 700;
            color: var(--text-primary);
            margin: 0 0 8px 0;
        }

        .section-header .subtitle {
            font-size: var(--text-body);
            color: var(--text-secondary);
            margin: 0;
        }

        /* EMPTY STATE STYLING */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 80px 24px;
            background: var(--bg-surface);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-card);
            margin-top: 40px;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 24px;
            opacity: 0.7;
        }

        .empty-state h3 {
            font-size: var(--text-h3);
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 12px 0;
        }

        .empty-state p {
            font-size: var(--text-body);
            color: var(--text-secondary);
            margin: 0;
            max-width: 400px;
            line-height: 1.5;
        }

        /* KPI CARDS */
        .kpi-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            margin-bottom: 48px;
            max-width: none;
        }
        
        @media (min-width: 768px) {
            .kpi-container {
                gap: 24px;
            }
        }

        .kpi-card {
            background: var(--ink-800);
            border: 1px solid rgba(42, 42, 46, 0.4);
            border-radius: 16px;
            padding: 24px;
            transition: all 200ms ease;
            text-align: center;
            position: relative;
            overflow: hidden;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--glow-orange-soft);
            border-color: var(--orange-600);
        }

        .kpi-value {
            font-size: 36px;
            font-weight: 700;
            color: var(--orange-200);
            margin-bottom: 8px;
            font-family: var(--font-mono);
            text-shadow: 0 0 10px rgba(255, 140, 58, 0.3);
        }

        .kpi-label {
            color: var(--cloud-100);
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .kpi-tooltip {
            color: var(--text-muted);
            cursor: help;
            font-size: 14px;
        }

        .kpi-description {
            color: var(--text-secondary);
            font-size: 12px;
            line-height: 1.4;
        }

        /* HERO VISUALIZATION */
        .hero-visualization {
            background: var(--bg-surface);
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-card);
            padding: 32px;
            margin: 32px 0;
            backdrop-filter: var(--overlay-blur);
        }

        .viz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .viz-header h2 {
            font-size: var(--text-h2);
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }

        .viz-controls {
            display: flex;
            gap: 16px;
        }

        .viz-controls .form-select {
            background: var(--bg-elevated);
            border: 1px solid var(--border-light);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
        }

        /* SPEND DONUT CHART */
        .spend-donut-container {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 48px;
            align-items: start;
            margin-top: 24px;
        }

        .spend-donut-chart-wrapper {
            position: relative;
            width: 100%;
            height: 350px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .donut-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            pointer-events: none;
        }
        
        .donut-total-amount {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1;
        }
        
        .donut-total-label {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Donut slice interactions */
        .donut-slice {
            cursor: pointer;
            transition: all 0.3s ease;
            filter: url(#donut-glow);
        }
        
        .donut-slice:hover {
            filter: url(#donut-glow) brightness(1.2);
            transform: scale(1.05);
            transform-origin: center;
        }




        /* DONUT CHART LEGEND */
        .donut-legend {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        /* DASHBOARD CHARTS GRID */
        /* STREAMLINED DASHBOARD STYLES */
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--cloud-100);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-header-flex {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        /* ACTION REQUIRED SECTION */
        .action-required-section {
            margin-bottom: 32px;
            padding: 24px;
            background: linear-gradient(135deg, rgba(255, 82, 82, 0.1) 0%, rgba(255, 193, 7, 0.1) 100%);
            border: 1px solid rgba(255, 82, 82, 0.2);
            border-radius: 16px;
        }

        .action-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
        }

        .action-card {
            background: var(--ink-800);
            border: 1px solid rgba(42, 42, 46, 0.4);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 200ms ease;
            cursor: pointer;
        }

        .action-card.high-priority {
            border-color: var(--error);
            background: linear-gradient(135deg, rgba(255, 82, 82, 0.05) 0%, var(--ink-800) 100%);
        }

        .action-card.pending-approval {
            border-color: var(--warning);
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.05) 0%, var(--ink-800) 100%);
        }

        .action-card.overdue {
            border-color: var(--orange-600);
            background: linear-gradient(135deg, rgba(255, 122, 26, 0.05) 0%, var(--ink-800) 100%);
        }

        .action-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--glow-orange-soft);
        }

        .action-icon {
            font-size: 24px;
            width: 40px;
            text-align: center;
        }

        .action-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--orange-500);
            font-family: 'JetBrains Mono', monospace;
        }

        .action-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--cloud-100);
            margin-bottom: 4px;
        }

        .action-description {
            font-size: 12px;
            color: var(--cloud-200);
        }

        /* CORE METRICS SECTION */
        .core-metrics-section {
            margin-bottom: 32px;
        }

        .core-metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .metric-card {
            background: var(--ink-800);
            border: 1px solid rgba(42, 42, 46, 0.4);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 200ms ease;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--glow-orange-soft);
            border-color: var(--orange-600);
        }

        .metric-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--orange-500);
            margin-bottom: 8px;
            font-family: 'JetBrains Mono', monospace;
            text-shadow: 0 0 10px rgba(255, 140, 58, 0.3);
        }

        .metric-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--cloud-100);
            margin-bottom: 4px;
        }

        .metric-period {
            font-size: 12px;
            color: var(--cloud-200);
        }

        /* SPEND DISTRIBUTION SECTION */
        .spend-distribution-section {
            margin-bottom: 32px;
            background: var(--ink-800);
            border: 1px solid rgba(42, 42, 46, 0.4);
            border-radius: 16px;
            padding: 24px;
        }

        .spend-chart-container {
            display: flex;
            align-items: center;
            gap: 32px;
        }

        .spend-chart {
            position: relative;
            flex-shrink: 0;
        }

        .chart-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .total-spend {
            font-size: 28px;
            font-weight: 700;
            color: var(--orange-500);
            font-family: 'JetBrains Mono', monospace;
        }

        .total-label {
            font-size: 12px;
            color: var(--cloud-200);
            margin-top: 4px;
        }

        .spend-breakdown {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .breakdown-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(255, 122, 26, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 122, 26, 0.1);
        }

        .category-indicator {
            width: 16px;
            height: 16px;
            border-radius: 50%;
        }

        .category-indicator.professional { background: #FF7A1A; }
        .category-indicator.software { background: #FF8C3A; }
        .category-indicator.facilities { background: #FF9C66; }
        .category-indicator.other { background: #FFB38A; }

        .category-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--cloud-100);
        }

        .category-amount {
            font-size: 14px;
            color: var(--cloud-200);
            font-family: 'JetBrains Mono', monospace;
        }

        /* TOP VENDORS SECTION */
        .top-vendors-section {
            margin-bottom: 32px;
        }

        .vendor-actions-compact {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .btn-outline-small, .btn-primary-small {
            padding: 8px 16px;
            font-size: 14px;
            border-radius: 6px;
            font-weight: 500;
            text-decoration: none;
            display: inline-block;
            transition: all 200ms ease;
        }

        .btn-outline-small {
            background: transparent;
            border: 1px solid rgba(42, 42, 46, 0.4);
            color: var(--cloud-100);
        }

        .btn-primary-small {
            background: var(--orange-600);
            border: 1px solid var(--orange-600);
            color: white;
        }

        .btn-outline-small:hover {
            border-color: var(--orange-600);
            background: rgba(255, 122, 26, 0.1);
        }

        .btn-primary-small:hover {
            background: var(--orange-500);
        }

        .top-vendors-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .vendor-card {
            background: var(--ink-800);
            border: 1px solid rgba(42, 42, 46, 0.4);
            border-radius: 12px;
            padding: 20px;
            transition: all 200ms ease;
            cursor: pointer;
        }

        .vendor-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--glow-orange-soft);
            border-color: var(--orange-600);
        }

        .vendor-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--cloud-100);
            margin-bottom: 8px;
        }

        .vendor-spend {
            font-size: 20px;
            font-weight: 700;
            color: var(--orange-500);
            font-family: 'JetBrains Mono', monospace;
            margin-bottom: 4px;
        }

        .vendor-description {
            font-size: 12px;
            color: var(--cloud-200);
        }

        .vendors-summary {
            display: flex;
            gap: 24px;
            padding: 16px;
            background: rgba(255, 122, 26, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 122, 26, 0.1);
        }

        .summary-item {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .summary-label {
            font-size: 14px;
            color: var(--cloud-200);
        }

        .summary-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--cloud-100);
            font-family: 'JetBrains Mono', monospace;
        }

        .summary-value.attention {
            color: var(--warning);
        }

        .chart-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .form-select.small {
            padding: 6px 12px;
            font-size: 14px;
            border-radius: 6px;
            background: var(--ink-800);
            border: 1px solid rgba(42, 42, 46, 0.4);
            color: var(--cloud-100);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: var(--cloud-100);
            margin: 0;
        }

        .chart-subtitle {
            font-size: 12px;
            color: var(--text-muted);
        }

        .chart-period-select {
            background: var(--ink-600);
            border: 1px solid rgba(42, 42, 46, 0.6);
            border-radius: 8px;
            color: var(--cloud-100);
            font-size: 12px;
            padding: 4px 8px;
        }

        .chart-container {
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        /* STATUS LEGEND */
        .status-legend {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 16px;
            font-size: 11px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--text-muted);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-dot.active { background: #00E676; }
        .status-dot.expiring { background: #FFC107; }
        .status-dot.renewal { background: #FF7A1A; }

        /* VENDOR BARS */
        .vendor-bars {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 10px;
        }

        .vendor-bar {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .vendor-name {
            width: 100px;
            font-size: 12px;
            color: var(--text-muted);
            text-align: right;
        }

        .vendor-bar-fill {
            flex: 1;
            height: 12px;
            background: var(--ink-600);
            border-radius: 6px;
            position: relative;
            overflow: hidden;
        }

        .vendor-bar-progress {
            height: 100%;
            background: linear-gradient(90deg, var(--orange-600), var(--orange-400));
            border-radius: 6px;
            transition: width 0.8s ease;
        }

        .vendor-amount {
            font-size: 11px;
            color: var(--orange-200);
            font-weight: 500;
            min-width: 40px;
        }

        /* COMPARISON METRICS */
        .comparison-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 16px;
        }

        .comparison-item {
            text-align: center;
        }

        .comparison-label {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .comparison-value {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .comparison-value.current { color: var(--orange-200); }
        .comparison-value.previous { color: var(--text-muted); }
        .comparison-value.average { color: var(--cloud-100); }

        .comparison-change {
            font-size: 10px;
            font-weight: 500;
        }

        .comparison-change.positive { color: #00E676; }
        .comparison-change.negative { color: #FF5252; }

        .comparison-chart {
            height: 60px;
        }

        /* SAVINGS METRICS */
        .savings-metrics {
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding: 10px 0;
        }

        .savings-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(255, 122, 26, 0.05);
            border-radius: 8px;
            border-left: 3px solid var(--orange-600);
        }

        .savings-icon {
            font-size: 20px;
        }

        .savings-amount {
            font-size: 16px;
            font-weight: 600;
            color: var(--orange-200);
        }

        .savings-desc {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* RISK ALERTS */
        .risk-alerts {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 10px 0;
        }

        .risk-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
        }

        .risk-item.high {
            background: rgba(255, 82, 82, 0.1);
            border-left: 3px solid #FF5252;
        }

        .risk-item.medium {
            background: rgba(255, 193, 7, 0.1);
            border-left: 3px solid #FFC107;
        }

        .risk-item.low {
            background: rgba(0, 230, 118, 0.1);
            border-left: 3px solid #00E676;
        }

        .risk-icon {
            font-size: 16px;
        }

        .risk-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--cloud-100);
        }

        .risk-count {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* DASHBOARD HEADER STYLING */
        #dashboardSection .section-header {
            text-align: center;
            margin-bottom: 48px;
            padding: 32px 24px;
            background: linear-gradient(135deg, 
                rgba(255, 122, 26, 0.15) 0%, 
                rgba(255, 140, 58, 0.08) 50%, 
                rgba(255, 179, 138, 0.05) 100%);
            border-radius: 20px;
            border: 1px solid rgba(255, 122, 26, 0.2);
            box-shadow: 
                0 8px 32px rgba(255, 122, 26, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #dashboardSection .section-header h1 {
            font-size: 48px;
            font-weight: 700;
            background: linear-gradient(135deg, #FF7A1A 0%, #FF8C3A 50%, #FFB38A 100%);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(255, 122, 26, 0.3);
            margin: 0 0 16px 0;
            letter-spacing: -0.02em;
            line-height: 1.1;
        }

        #dashboardSection .section-header .subtitle {
            font-size: 18px;
            color: rgba(237, 238, 240, 0.8);
            font-weight: 400;
            margin: 0;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        /* RESPONSIVE CHARTS */
        @media (max-width: 1024px) {
            .dashboard-charts-grid {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 20px;
            }
        }

        @media (max-width: 768px) {
            .action-cards-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .core-metrics-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 16px;
            }

            .spend-chart-container {
                flex-direction: column;
                gap: 20px;
            }

            .spend-chart svg {
                width: 250px;
                height: 250px;
            }

            .top-vendors-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .vendors-summary {
                flex-direction: column;
                gap: 12px;
            }

            .vendor-actions-compact {
                flex-direction: column;
                gap: 8px;
                align-items: stretch;
            }

            .dashboard-charts-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .chart-card {
                padding: 16px;
            }
            
            .chart-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            #dashboardSection .section-header {
                padding: 24px 16px;
                margin-bottom: 32px;
            }

            #dashboardSection .section-header h1 {
                font-size: 36px;
            }

            #dashboardSection .section-header .subtitle {
                font-size: 16px;
            }
        }

        /* RESPONSIVE DESIGN */
        @media (max-width: 1024px) {
            .spend-donut-container {
                grid-template-columns: 1fr;
                gap: 32px;
                text-align: center;
            }
            
            .donut-legend {
                align-items: center;
                max-width: 400px;
                margin: 0 auto;
            }
        }

        @media (max-width: 768px) {
            .kpi-container {
                grid-template-columns: 1fr 1fr;
                gap: 16px;
            }
            
            .hero-visualization {
                padding: 24px 16px;
            }
            
            .viz-controls {
                flex-direction: column;
                gap: 12px;
            }
            
            .tron-pie-chart {
                max-width: 300px;
                height: 300px;
            }
            
            .spend-donut-chart-wrapper {
                height: 300px;
            }
            
            #spendDonutChart {
                width: 250px;
                height: 250px;
            }
        }

        @media (max-width: 480px) {
            .kpi-container {
                grid-template-columns: 1fr;
            }
        }

        /* NAVIGATION STYLING */
        .top-nav {
            background: var(--bg-surface);
            border-bottom: 1px solid var(--border-medium);
            padding: 0 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 72px;
            backdrop-filter: var(--overlay-blur);
        }

        .nav-links {
            display: flex;
            list-style: none;
            margin: 0;
            padding: 0;
            gap: 8px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            text-decoration: none;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 14px;
            border-radius: 8px;
            transition: all 0.2s ease;
            position: relative;
        }

        .nav-link:hover {
            color: var(--text-primary);
            background: var(--bg-orange-light);
        }

        .nav-link.active {
            color: var(--orange-600);
            background: var(--bg-orange);
            font-weight: 600;
        }

        .nav-link.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 50%;
            transform: translateX(-50%);
            width: 60%;
            height: 2px;
            background: var(--orange-600);
            border-radius: 1px;
        }

        .nav-right {
            display: flex;
            gap: 12px;
        }

        .nav-right .btn {
            font-size: 14px;
            padding: 10px 16px;
        }

        /* MAIN CONTENT */
        .main-content {
            flex: 1;
            overflow-y: auto;
            background: var(--bg-main);
        }

        /* SECTION ACTIONS */
        .section-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        /* VENDOR MANAGEMENT STYLES */
        .vendor-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 32px 0;
        }

        .stat-card {
            background: var(--bg-surface);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-card);
            padding: 20px;
            text-align: center;
            transition: all 0.2s ease;
        }

        .stat-card:hover {
            border-color: var(--orange-600);
            transform: translateY(-2px);
            box-shadow: var(--glow-orange-soft);
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--orange-600);
            font-family: var(--font-mono);
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* VENDOR FILTERS */
        .vendor-filters {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 24px 0;
            gap: 20px;
        }

        .filter-group {
            display: flex;
            gap: 16px;
            flex: 1;
        }

        .search-input {
            background: var(--bg-surface);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 10px 16px;
            color: var(--text-primary);
            font-size: 14px;
            width: 300px;
            transition: all 0.2s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--orange-600);
            box-shadow: 0 0 0 3px rgba(255, 122, 26, 0.1);
        }

        .filter-select {
            background: var(--bg-surface);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 10px 16px;
            color: var(--text-primary);
            font-size: 14px;
            min-width: 150px;
        }

        .view-toggle {
            display: flex;
            background: var(--bg-surface);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            overflow: hidden;
        }

        .view-btn {
            background: transparent;
            border: none;
            padding: 10px 16px;
            color: var(--text-secondary);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .view-btn.active {
            background: var(--orange-600);
            color: white;
        }

        .view-btn:hover:not(.active) {
            background: var(--bg-orange-light);
            color: var(--text-primary);
        }

        /* VENDOR TABLE */
        .vendor-table-container {
            background: var(--bg-surface);
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-card);
            overflow: hidden;
        }

        .vendor-table {
            width: 100%;
            border-collapse: collapse;
        }

        .vendor-table th {
            background: var(--bg-elevated);
            color: var(--text-primary);
            font-weight: 600;
            padding: 16px 20px;
            text-align: left;
            border-bottom: 1px solid var(--border-light);
            font-size: 14px;
        }

        .vendor-table th.sortable {
            cursor: pointer;
            user-select: none;
        }

        .vendor-table th.sortable:hover {
            background: var(--bg-orange-light);
        }

        .vendor-table th.sortable::after {
            content: " ↕";
            color: var(--text-muted);
            font-size: 12px;
        }

        .vendor-table td {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-light);
            color: var(--text-secondary);
            font-size: 14px;
        }

        .vendor-table tr:hover {
            background: var(--bg-orange-light);
        }

        .vendor-name-cell {
            color: var(--text-primary);
            font-weight: 600;
        }

        .vendor-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .vendor-status.active {
            background: rgba(0, 230, 118, 0.2);
            color: var(--success);
        }

        .vendor-status.inactive {
            background: rgba(255, 82, 82, 0.2);
            color: var(--error);
        }

        .vendor-status.pending {
            background: rgba(255, 193, 7, 0.2);
            color: var(--warning);
        }

        .vendor-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            background: transparent;
            border: 1px solid var(--border-light);
            border-radius: 6px;
            padding: 6px 8px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 12px;
        }

        .action-btn:hover {
            border-color: var(--orange-600);
            color: var(--orange-600);
        }

        .action-btn.danger:hover {
            border-color: var(--error);
            color: var(--error);
        }

        /* VENDOR CARDS */
        .vendor-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 24px;
        }

        .vendor-card {
            background: var(--bg-surface);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-card);
            padding: 24px;
            transition: all 0.2s ease;
        }

        .vendor-card:hover {
            border-color: var(--orange-600);
            transform: translateY(-2px);
            box-shadow: var(--glow-orange-soft);
        }

        .vendor-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .vendor-card-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 4px 0;
        }

        .vendor-card-category {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .vendor-card-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin: 16px 0;
        }

        .metric {
            text-align: center;
        }

        .metric-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--orange-600);
            font-family: var(--font-mono);
        }

        .metric-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* VENDOR TABLE STYLING */
        .money-cell {
            font-family: var(--font-mono);
            font-weight: 600;
            color: var(--orange-600);
        }

        .category-tag {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            text-transform: capitalize;
        }

        .category-software {
            background: rgba(0, 230, 118, 0.2);
            color: var(--success);
        }

        .category-professional {
            background: rgba(255, 193, 7, 0.2);
            color: var(--warning);
        }

        .category-facilities {
            background: rgba(255, 82, 82, 0.2);
            color: var(--error);
        }

        .category-marketing {
            background: rgba(255, 122, 26, 0.2);
            color: var(--orange-600);
        }

        .category-office {
            background: rgba(128, 128, 128, 0.2);
            color: var(--text-secondary);
        }

        .status-active {
            background: rgba(0, 230, 118, 0.2);
            color: var(--success);
        }

        .status-inactive {
            background: rgba(255, 82, 82, 0.2);
            color: var(--error);
        }

        .flag-indicator {
            background: rgba(255, 193, 7, 0.2);
            color: var(--warning);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            cursor: help;
        }

        .no-flags {
            color: var(--text-muted);
            font-style: italic;
        }

        /* DOCUMENT UPLOAD MODAL */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(11, 11, 12, 0.9);
            backdrop-filter: blur(20px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease;
        }

        .modal-container {
            background: var(--bg-surface);
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-card);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--border-light);
            position: relative;
        }

        .modal-header h2 {
            font-size: var(--text-h2);
            color: var(--text-primary);
            margin: 0 0 8px 0;
        }

        .modal-header p {
            color: var(--text-secondary);
            margin: 0;
        }

        .modal-close {
            position: absolute;
            top: 24px;
            right: 24px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 24px;
        }

        .upload-area {
            border: 2px dashed var(--border-light);
            border-radius: var(--radius-card);
            padding: 48px 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--bg-main);
        }

        .upload-area:hover {
            border-color: var(--orange-600);
            background: var(--bg-orange-light);
        }

        .upload-area.has-file {
            border-color: var(--success);
            background: rgba(0, 230, 118, 0.1);
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.7;
        }

        .upload-text h3 {
            color: var(--text-primary);
            margin: 0 0 8px 0;
            font-size: 18px;
        }

        .upload-text p {
            color: var(--text-secondary);
            margin: 0 0 8px 0;
        }

        .upload-text small {
            color: var(--text-muted);
            font-size: 12px;
        }

        .file-info {
            margin-top: 24px;
            padding: 20px;
            background: var(--bg-elevated);
            border-radius: var(--radius-card);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 16px;
        }

        .file-size {
            color: var(--text-secondary);
            font-size: 14px;
            margin-top: 4px;
        }

        /* PROCESSING ANIMATION MODAL */
        .processing-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(11, 11, 12, 0.95);
            backdrop-filter: blur(20px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 15000;
            animation: fadeIn 0.5s ease;
        }

        .processing-container {
            background: var(--bg-surface);
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-card);
            width: 90%;
            max-width: 800px;
            padding: 32px;
            animation: slideUp 0.5s ease;
        }

        .processing-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .processing-header h2 {
            font-size: var(--text-h1);
            color: var(--text-primary);
            margin: 0 0 8px 0;
        }

        .processing-header p {
            color: var(--text-secondary);
            margin: 0;
            font-size: 16px;
        }

        .processing-stages {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 32px;
        }

        .stage {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            transition: all 0.3s ease;
            opacity: 0.5;
        }

        .stage.active {
            opacity: 1;
            border-color: var(--orange-600);
            background: var(--bg-orange-light);
            transform: scale(1.02);
            box-shadow: var(--glow-orange-soft);
        }

        .stage.completed {
            opacity: 1;
            border-color: var(--success);
            background: rgba(0, 230, 118, 0.1);
        }

        .stage-icon {
            font-size: 24px;
            width: 40px;
            text-align: center;
        }

        .stage-content {
            flex: 1;
        }

        .stage-title {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 16px;
            margin-bottom: 4px;
        }

        .stage-description {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.4;
        }

        .stage-status {
            font-size: 20px;
            transition: all 0.3s ease;
        }

        .stage.active .stage-status {
            animation: pulse 1.5s infinite;
        }

        .stage.completed .stage-status {
            content: "✅";
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
        }

        .processing-progress {
            margin-bottom: 24px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-elevated);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--orange-600), var(--orange-400));
            border-radius: 4px;
            transition: width 0.5s ease;
            box-shadow: 0 0 20px rgba(255, 122, 26, 0.4);
        }

        .progress-text {
            text-align: center;
            color: var(--text-primary);
            font-weight: 600;
            font-family: var(--font-mono);
        }

        .processing-details {
            background: var(--bg-main);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 16px;
        }

        .details-title {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .details-content {
            color: var(--orange-600);
            font-family: var(--font-mono);
            font-size: 14px;
            line-height: 1.6;
            animation: typewriter 2s steps(40) infinite;
        }

        @keyframes typewriter {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .legend-item:hover {
            background: var(--bg-orange-light);
            border-color: var(--orange-600);
            transform: translateX(4px);
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            box-shadow: 0 0 8px rgba(255, 122, 26, 0.4);
        }

        .legend-label {
            flex: 1;
            color: var(--text-primary);
            font-weight: 500;
            font-size: 14px;
        }

        .legend-value {
            color: var(--orange-600);
            font-weight: 700;
            font-family: var(--font-mono);
            font-size: 14px;
        }

        /* ADD VENDOR SECTION */
        .add-vendor-section {
            text-align: center;
            margin: 32px 0;
        }

        .add-vendor-btn {
            background: var(--accent-cyan);
            color: var(--primary);
            border: none;
            padding: 16px 32px;
            border-radius: var(--border-radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .add-vendor-btn:hover {
            background: var(--accent-success);
            transform: translateY(-1px);
        }

        /* VENDORS TABLE */
        .vendors-section {
            margin-top: 40px;
        }

        .vendors-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .vendors-title {
            color: var(--text-primary);
            font-size: 24px;
            font-weight: 600;
            margin: 0;
        }

        .vendors-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .add-vendor-btn {
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
        }

        .vendors-search {
            flex: 1;
            max-width: 300px;
            margin-left: 20px;
        }

        .vendors-table {
            background: var(--surface-2);
            border: 1px solid var(--border-medium);
            border-radius: var(--border-radius-large);
            overflow: hidden;
            backdrop-filter: var(--overlay-blur);
        }

        .vendors-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .vendors-table th {
            background: var(--surface-1);
            color: var(--text-primary);
            font-weight: 600;
            padding: 16px 20px;
            text-align: left;
            border-bottom: 1px solid var(--border-medium);
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .vendors-table th:hover {
            background: var(--glass-highlight);
        }

        .vendors-table th.sortable::after {
            content: " ↕";
            color: var(--text-muted);
            font-size: 12px;
        }

        .vendors-table th.sorted-asc::after {
            content: " ↑";
            color: var(--accent-cyan);
        }

        .vendors-table th.sorted-desc::after {
            content: " ↓";
            color: var(--accent-cyan);
        }

        .vendors-table td {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-light);
            color: var(--text-secondary);
        }

        .vendors-table tr:hover {
            background: var(--glass-highlight);
        }

        .vendor-name {
            color: var(--accent-cyan);
            cursor: pointer;
            font-weight: 500;
            text-decoration: none;
        }

        .vendor-name:hover {
            text-decoration: underline;
        }

        .empty-vendors {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-vendors-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-vendors h3 {
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        /* ADD VENDOR MODAL */
        .vendor-modal .modal-content {
            max-width: 600px;
            background: var(--modal-surface);
            backdrop-filter: var(--overlay-blur);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
        }

        .vendor-form-group {
            margin-bottom: 20px;
        }

        .vendor-form-group label {
            display: block;
            color: var(--text-primary);
            font-weight: 500;
            margin-bottom: 6px;
        }

        .vendor-form-group .required {
            color: var(--error);
        }

        .vendor-form-group input,
        .vendor-form-group textarea {
            width: 100%;
            background: var(--surface-2);
            border: 1px solid var(--border-medium);
            color: var(--text-primary);
            padding: 12px 16px;
            border-radius: var(--border-radius);
            font-family: var(--font-primary);
        }

        .vendor-form-group input:focus,
        .vendor-form-group textarea:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 0 3px var(--cyan-focus);
        }

        .file-upload-area {
            border: 2px dashed var(--border-medium);
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .file-upload-area:hover {
            border-color: var(--accent-cyan);
            background: var(--cyan-bg);
        }

        .file-upload-area.drag-over {
            border-color: var(--accent-cyan);
            background: var(--cyan-bg-light);
        }

        /* VENDOR CREATION NOTIFICATIONS */
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .notification-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .notification-icon {
            font-size: 18px;
        }

        .notification-message {
            font-weight: 500;
            line-height: 1.4;
        }

        /* VENDOR DETAILS PAGE */
        .vendor-details-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 32px;
        }

        .vendor-info-section,
        .contract-details-section,
        .invoice-history-section {
            background: var(--surface-2);
            border: 1px solid var(--border-medium);
            border-radius: var(--border-radius-large);
            overflow: hidden;
            backdrop-filter: var(--overlay-blur);
        }

        .vendor-info-section .section-header,
        .contract-details-section .section-header,
        .invoice-history-section .section-header {
            background: var(--surface-1);
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-medium);
        }

        .vendor-info-section .section-header h2,
        .contract-details-section .section-header h2,
        .invoice-history-section .section-header h2 {
            color: var(--text-primary);
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        .vendor-info-grid {
            padding: 24px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .vendor-info-item {
            background: var(--surface-1);
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius);
            padding: 16px;
        }

        .vendor-info-label {
            color: var(--text-muted);
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .vendor-info-value {
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
            word-break: break-word;
        }

        .ai-summary-section {
            background: linear-gradient(135deg, var(--cyan-bg-light), var(--surface-1));
            border: 2px solid var(--accent-cyan);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 24px;
            grid-column: 1 / -1;
        }

        .ai-summary-title {
            color: var(--accent-cyan);
            font-size: 18px;
            font-weight: 600;
            margin: 0 0 16px 0;
        }

        .ai-summary-item {
            margin-bottom: 16px;
        }

        .ai-summary-item:last-child {
            margin-bottom: 0;
        }

        .ai-summary-label {
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .ai-summary-text {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.6;
            background: var(--surface-2);
            padding: 12px;
            border-radius: var(--border-radius);
            border-left: 3px solid var(--accent-cyan);
        }

        .ai-summary-highlights,
        .ai-summary-risks {
            background: var(--surface-2);
            padding: 12px;
            border-radius: var(--border-radius);
            border-left: 3px solid var(--accent-cyan);
        }

        .highlight-item,
        .risk-item {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 6px;
        }

        .highlight-item:last-child,
        .risk-item:last-child {
            margin-bottom: 0;
        }

        .risk-item {
            color: var(--warning);
        }

        .contract-info {
            padding: 24px;
        }

        .contract-file-info {
            background: var(--surface-1);
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
        }

        .contract-file-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .contract-file-icon {
            font-size: 24px;
            color: var(--accent-cyan);
        }

        .contract-file-name {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 16px;
        }

        .clickable-file {
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .clickable-file:hover {
            color: var(--accent-cyan);
            text-decoration: underline;
        }

        .contract-file-date {
            color: var(--text-muted);
            font-size: 14px;
        }

        .contract-terms-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
        }

        .contract-term-item {
            background: var(--surface-1);
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius);
            padding: 16px;
        }

        .invoice-history-grid {
            padding: 24px;
        }

        .invoice-item {
            background: var(--surface-1);
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 16px;
        }

        .invoice-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .invoice-name {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 4px;
        }

        .invoice-date {
            color: var(--text-muted);
            font-size: 14px;
        }

        .invoice-status {
            padding: 6px 12px;
            border-radius: var(--border-radius);
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .invoice-status.approved {
            background: var(--success-bg);
            color: var(--success);
        }

        .invoice-status.flagged {
            background: var(--warning-bg);
            color: var(--warning);
        }

        .invoice-status.error {
            background: var(--error-bg);
            color: var(--error);
        }

        .invoice-findings {
            margin-top: 12px;
        }

        .invoice-findings-title {
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .invoice-findings-list {
            color: var(--text-muted);
            font-size: 14px;
            line-height: 1.5;
        }

        .empty-invoice-history {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        .empty-invoice-history-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .invoice-files-section {
            margin-bottom: 8px;
        }

        .invoice-file-link {
            display: inline-block;
            margin-right: 12px;
            margin-bottom: 4px;
            padding: 4px 8px;
            background: var(--surface-2);
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius);
            font-size: 14px;
        }

        .invoice-file-link:hover {
            background: var(--cyan-bg-light);
            border-color: var(--accent-cyan);
        }

        /* VENDOR ACTIONS */
        .vendor-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .btn-icon {
            background: none;
            border: none;
            cursor: pointer;
            padding: 6px;
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-icon:hover {
            background: var(--surface-2);
        }

        .btn-icon.btn-danger:hover {
            background: var(--error-bg);
            color: var(--error);
        }

        /* DISABLED VENDORS SECTION */
        .disabled-vendors-section {
            margin-top: 32px;
        }

        .disabled-vendors-header {
            background: var(--surface-2);
            border: 1px solid var(--border-medium);
            border-radius: var(--border-radius);
            padding: 16px 20px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .disabled-vendors-header:hover {
            background: var(--glass-highlight);
        }

        .disabled-vendors-title {
            color: var(--text-muted);
            font-size: 18px;
            font-weight: 600;
            margin: 0 0 4px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .disabled-vendors-title span:first-child {
            transition: transform 0.2s ease;
            color: var(--text-muted);
            font-size: 14px;
        }

        .disabled-vendors-title.expanded span:first-child {
            transform: rotate(90deg);
        }

        .disabled-vendors-count {
            color: var(--text-muted);
            font-weight: normal;
            font-size: 16px;
        }

        .disabled-vendors-description {
            color: var(--text-muted);
            font-size: 14px;
            font-style: italic;
        }

        .disabled-vendors-content {
            margin-top: 16px;
        }

        .disabled-table {
            opacity: 0.7;
        }

        .disabled-table table {
            background: var(--surface-1);
        }

        .disabled-table th {
            background: var(--surface-2);
            color: var(--text-muted);
        }

        .disabled-table td {
            color: var(--text-muted);
        }

        .disabled-table .vendor-name {
            color: var(--text-muted);
        }

        .disabled-table .vendor-name:hover {
            color: var(--text-secondary);
        }

        /* MOBILE RESPONSIVE */
        @media (max-width: 768px) {
            .kpi-container {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .vendors-header {
                flex-direction: column;
                gap: 16px;
                align-items: stretch;
            }

            .vendors-actions {
                flex-direction: column-reverse;
                gap: 12px;
            }

            .vendors-search {
                margin-left: 0;
                max-width: none;
            }

            .vendors-table {
                overflow-x: auto;
            }

            .vendor-creation-notification {
                top: 80px !important;
                right: 10px !important;
                max-width: calc(100vw - 20px) !important;
            }

            .vendor-info-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .contract-terms-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .invoice-header {
                flex-direction: column;
                gap: 12px;
                align-items: flex-start;
            }

            .vendor-details-content {
                gap: 24px;
            }
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .breadcrumb-item {
            color: var(--neutral-dark);
            text-decoration: none;
            transition: color var(--animation-fast) ease;
        }

        .breadcrumb-item:hover:not(.current) {
            color: var(--accent-cyan);
        }

        .breadcrumb-item.current {
            color: var(--primary);
            font-weight: 500;
        }

        .breadcrumb-separator {
            color: var(--border-medium);
        }

        /* 7. FEEDBACK & STATE SYSTEM */
        .alert {
            padding: 16px 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            border-left: 4px solid;
            animation: slideInDown var(--animation-standard) ease;
        }

        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .alert.success {
            background: var(--success-bg);
            color: var(--accent-success);
            border-left-color: var(--accent-success);
        }

        .alert.error {
            background: var(--error-bg-light);
            color: var(--error);
            border-left-color: var(--error);
        }

        .alert.warning {
            background: var(--warning-bg);
            color: var(--warning);
            border-left-color: var(--warning);
        }

        .alert.info {
            background: var(--cyan-bg-light);
            color: var(--accent-cyan);
            border-left-color: var(--accent-cyan);
        }

        .alert-icon {
            font-size: 18px;
            margin-top: 1px;
        }

        .alert-content {
            flex: 1;
        }

        .alert-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .alert-dismiss {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity var(--animation-fast) ease;
        }

        .alert-dismiss:hover {
            opacity: 1;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
            animation: slideInRight var(--animation-standard) ease;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .skeleton {
            background: linear-gradient(90deg, var(--neutral-light) 25%, var(--border-light) 50%, var(--neutral-light) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: var(--border-radius);
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .skeleton-text {
            height: 16px;
            margin-bottom: 8px;
        }

        .skeleton-text.large {
            height: 20px;
        }

        .skeleton-text.small {
            height: 12px;
        }

        .skeleton-button {
            height: var(--button-min-height);
            width: 120px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--neutral-dark);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--primary);
        }

        .empty-state-description {
            font-size: 14px;
            margin-bottom: 24px;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--surface-1);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius-large);
            padding: 40px;
            box-shadow: var(--shadow-medium);
            position: relative;
        }

        .container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--shadow-inset);
            border-radius: var(--border-radius-large) var(--border-radius-large) 0 0;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
        }

        /* Unspend Logo */
        .logo {
            display: inline-flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            position: relative;
            border-radius: 50%;
            background: var(--grad-surface);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--glow-orange-soft);
            border: 2px solid var(--orange-600);
        }

        .logo-icon::before {
            content: "";
            position: absolute;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: conic-gradient(
                var(--orange-600) 0deg 72deg,
                var(--orange-500) 72deg 144deg,
                var(--orange-400) 144deg 216deg,
                var(--orange-300) 216deg 288deg,
                transparent 288deg 360deg
            );
            animation: pulse 2s ease-in-out infinite;
        }

        .logo-icon::after {
            content: "";
            position: absolute;
            width: 8px;
            height: 8px;
            background: var(--bg-main);
            border-radius: 50%;
            z-index: 1;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(1.05); filter: brightness(1.1); }
        }


        h1 {
            color: var(--text-primary);
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 12px;
            letter-spacing: -0.02em;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 18px;
            margin-bottom: 24px;
            font-weight: 400;
        }

        .feature-badges {
            display: flex;
            justify-content: center;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .badge {
            background: var(--accent-success);
            color: var(--white);
            padding: 8px 16px;
            border-radius: var(--border-radius);
            font-size: 13px;
            font-weight: 500;
            font-family: var(--font-primary);
        }

        .section {
            margin-bottom: 32px;
            background: var(--bg-elevated);
            border-radius: var(--radius-card);
            padding: 32px;
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-soft);
            position: relative;
        }

        .section::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--shadow-inset);
            border-radius: var(--border-radius-large) var(--border-radius-large) 0 0;
        }

        .section.collapsed {
            background: var(--bg-surface);
            border-color: var(--border-medium);
        }

        .section-header {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            cursor: pointer;
            margin-bottom: 24px;
            padding: 12px 20px;
            border-radius: var(--radius-small);
            transition: all 200ms ease;
            background: transparent;
            border: 1px solid transparent;
        }

        .section-header:hover {
            background: var(--glass-highlight);
            border-color: var(--border-medium);
            transform: translateY(-1px);
            box-shadow: var(--shadow-soft);
        }

        .section-header h2 {
            color: var(--text-primary);
            font-size: 24px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 0;
            transition: color var(--animation-standard) ease;
        }

        .section-header:hover h2 {
            color: var(--accent-cyan);
        }

        .section-content {
            transition: all 0.3s ease;
        }

        .section.collapsed .section-content {
            display: none;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .setting-item {
            background: var(--surface-3);
            padding: 20px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-soft);
            position: relative;
        }

        .setting-item::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--shadow-inset);
            border-radius: var(--border-radius) var(--border-radius) 0 0;
        }

        .setting-item label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .setting-item input, .setting-item select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-strong);
            border-radius: var(--border-radius);
            font-size: 14px;
            font-family: var(--font-primary);
            background: var(--neutral-dark);
            color: var(--text-primary);
            transition: all 0.2s ease;
        }

        .setting-item input:focus, .setting-item select:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 0 3px var(--cyan-focus);
        }

        .removed-api-key-input-group {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .api-key-input {
            flex: 1;
            padding: 16px;
            border: 2px solid var(--border-strong);
            border-radius: var(--border-radius);
            font-size: 16px;
            font-family: var(--font-mono);
            background: var(--white);
            transition: border-color 0.2s ease;
        }

        .api-key-input:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 0 3px var(--cyan-focus);
        }

        .save-key-btn {
            /* Use new button system - inherits from .btn-primary */
        }

        .api-status {
            padding: 16px;
            border-radius: var(--border-radius);
            margin-top: 16px;
            text-align: center;
            font-size: 14px;
            font-weight: 500;
            border-left: 4px solid;
        }

        .api-status.success {
            background: var(--success-bg);
            color: var(--accent-success);
            border-left-color: var(--accent-success);
        }

        .api-status.error {
            background: var(--error-bg-light);
            color: var(--error);
            border-left-color: var(--error);
        }

        .upload-area {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .upload-box {
            border: 2px dashed var(--border-dashed);
            border-radius: var(--border-radius-large);
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            background: var(--surface-2);
        }

        .upload-box::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--shadow-inset);
            border-radius: var(--border-radius-large) var(--border-radius-large) 0 0;
        }

        .upload-box:hover {
            border-color: var(--accent-cyan);
            background: var(--cyan-bg);
            box-shadow: var(--glow-cyan);
        }

        .upload-box.drag-over {
            border-color: var(--accent-cyan);
            background: var(--cyan-bg-light);
            transform: scale(1.01);
            box-shadow: var(--glow-cyan), var(--shadow-medium);
        }

        .upload-box.has-files {
            border-color: var(--accent-success);
            background: var(--success-bg-light);
            border-style: solid;
            box-shadow: var(--glow-success);
        }

        .multi-upload-box {
            min-height: 300px;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.7;
        }

        .upload-box h3 {
            color: var(--text-primary);
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .upload-box p {
            color: var(--text-secondary);
            font-size: 14px;
            opacity: 0.9;
        }

        .file-list {
            margin-top: 20px;
            text-align: left;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--surface-3);
            border-radius: var(--border-radius);
            margin-bottom: 8px;
            border: 1px solid var(--border-light);
            position: relative;
        }

        .file-item::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--shadow-inset);
            border-radius: var(--border-radius) var(--border-radius) 0 0;
        }

        .file-item .file-name {
            flex: 1;
            color: var(--text-primary);
            font-size: 14px;
            font-family: var(--font-mono);
        }

        .file-item .remove-btn {
            background: var(--error);
            color: var(--white);
            border: none;
            padding: 6px 12px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .file-item .remove-btn:hover {
            background: var(--warning);
            transform: translateY(-1px);
        }

        input[type="file"] {
            display: none;
        }

        .process-btn {
            /* Use new button system - inherits from .btn-primary .btn-large */
            display: block;
            margin: 0 auto;
            letter-spacing: 0.01em;
        }

        .processing-section {
            text-align: center;
            padding: 60px 0;
        }

        .processing-section h2 {
            color: var(--text-primary);
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 16px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .processing-section p {
            color: var(--text-secondary);
            font-size: 16px;
            margin-bottom: 32px;
        }

        .processing-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-top: 32px;
        }

        .processing-item {
            background: var(--surface-2);
            border-radius: var(--border-radius-large);
            padding: 24px;
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-soft);
            position: relative;
        }

        .processing-item::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--shadow-inset);
            border-radius: var(--border-radius-large) var(--border-radius-large) 0 0;
        }

        .processing-item h4 {
            margin-bottom: 16px;
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 600;
            font-family: var(--font-mono);
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--neutral-dark);
            border-radius: 3px;
            overflow: hidden;
            margin: 16px 0;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-cyan), var(--accent-success));
            transition: width 0.3s ease;
            border-radius: 3px;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--neutral-dark);
            border-top: 3px solid var(--accent-cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 24px;
            box-shadow: var(--glow-cyan);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        .results-section {
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .results-header h2 {
            color: var(--text-primary);
            font-size: 24px;
            font-weight: 600;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .export-controls {
            display: flex;
            gap: 12px;
        }

        .export-btn {
            /* Use new button system - inherits from .btn-secondary */
        }

        .batch-summary {
            background: linear-gradient(135deg, var(--surface-2) 0%, var(--secondary-bg-light) 100%);
            border-radius: var(--border-radius-large);
            padding: 32px;
            margin-bottom: 32px;
            border: 1px solid var(--border-light);
            position: relative;
        }

        .batch-summary::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--shadow-inset);
            border-radius: var(--border-radius-large) var(--border-radius-large) 0 0;
        }

        .batch-summary h3 {
            color: var(--text-primary);
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: var(--surface-3);
            padding: 24px;
            border-radius: var(--border-radius);
            text-align: center;
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-soft);
            position: relative;
            backdrop-filter: blur(5px);
        }

        .stat-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--shadow-inset);
            border-radius: var(--border-radius) var(--border-radius) 0 0;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
            font-family: var(--font-mono);
        }

        .stat-value.passed { color: var(--accent-success); }
        .stat-value.failed { color: var(--error); }
        .stat-value.warning { color: var(--warning); }

        .stat-label {
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
        }

        .invoice-results {
            display: grid;
            gap: 24px;
        }

        .invoice-result-card {
            background: var(--surface-2);
            border-radius: var(--border-radius-large);
            padding: 32px;
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-soft);
            position: relative;
        }

        .invoice-result-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--shadow-inset);
            border-radius: var(--border-radius-large) var(--border-radius-large) 0 0;
        }

        .invoice-result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border-light);
        }

        .invoice-result-header h3 {
            color: var(--text-primary);
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-badge {
            padding: 8px 16px;
            border-radius: var(--border-radius);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.05em;
            font-family: var(--font-primary);
        }

        .status-badge.passed {
            background: var(--accent-success);
            color: var(--white);
        }

        .status-badge.failed {
            background: var(--error);
            color: var(--white);
        }

        .discrepancy-item, .warning-item {
            background: var(--error-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 16px;
            border-left: 4px solid var(--error);
        }

        .warning-item {
            background: var(--warning-bg);
            border-left-color: var(--warning);
        }

        .discrepancy-item strong, .warning-item strong {
            color: var(--primary);
            font-weight: 600;
            font-size: 16px;
        }

        .match-badge {
            display: inline-block;
            background: var(--accent-success);
            color: var(--white);
            padding: 8px 12px;
            border-radius: var(--border-radius);
            font-size: 12px;
            font-weight: 500;
            margin: 4px;
            font-family: var(--font-primary);
        }

        .contract-details {
            background: var(--secondary-bg);
            border-radius: var(--border-radius-large);
            padding: 32px;
            margin-bottom: 32px;
            border: 1px solid var(--border-light);
            position: relative;
        }

        .contract-details::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--shadow-inset);
            border-radius: var(--border-radius-large) var(--border-radius-large) 0 0;
        }

        .contract-details h3 {
            color: var(--text-primary);
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .detail-item {
            background: var(--surface-3);
            padding: 16px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-soft);
            position: relative;
        }

        .detail-item::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--shadow-inset);
            border-radius: var(--border-radius) var(--border-radius) 0 0;
        }

        .detail-label {
            font-weight: 600;
            color: var(--accent-cyan);
            font-size: 12px;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .detail-value {
            color: var(--text-primary);
            word-break: break-word;
            font-size: 14px;
            font-family: var(--font-mono);
        }

        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-top: 40px;
        }

        .btn {
            padding: 16px 32px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            font-family: var(--font-primary);
            transition: all 0.2s ease;
            letter-spacing: 0.01em;
        }

        .btn-primary {
            background: var(--accent-cyan);
            color: var(--white);
        }

        .btn-success {
            background: var(--accent-success);
            color: var(--white);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .btn-primary:hover {
            background: var(--primary);
        }

        .btn-success:hover {
            background: var(--secondary);
        }

        .history-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: var(--surface-1);
            backdrop-filter: blur(20px);
            border-left: 1px solid var(--border-light);
            box-shadow: -5px 0 30px rgba(0, 0, 0, 0.4);
            transition: right 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }

        .history-panel.open {
            right: 0;
        }

        .history-header {
            padding: 24px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: var(--white);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .history-header::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--shadow-inset);
        }

        .history-header h3 {
            font-size: 18px;
            font-weight: 600;
        }

        .history-content {
            padding: 24px;
        }

        .history-item {
            padding: 20px;
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius);
            margin-bottom: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--surface-2);
            position: relative;
        }

        .history-item::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--shadow-inset);
            border-radius: var(--border-radius) var(--border-radius) 0 0;
        }

        .history-item:hover {
            background: var(--surface-3);
            transform: translateX(4px);
            box-shadow: var(--shadow-soft);
            border-color: var(--accent-cyan);
        }

        .info-box {
            background: var(--cyan-bg-light);
            border-left: 4px solid var(--accent-cyan);
            padding: 20px;
            margin-bottom: 20px;
            border-radius: var(--border-radius);
        }

        .info-box a {
            color: var(--accent-cyan);
            text-decoration: none;
            font-weight: 600;
        }

        .info-box a:hover {
            text-decoration: underline;
            color: var(--primary);
        }

        @media (max-width: 768px) {
            .upload-area {
                grid-template-columns: 1fr;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
            }
            
            .results-header {
                flex-direction: column;
                gap: 15px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .container {
                padding: 20px;
            }

            .history-panel {
                width: 100%;
                right: -100%;
            }
        }

        .tooltip {
            position: relative;
            cursor: help;
        }

        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            background: var(--neutral-dark);
            color: var(--white);
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 0.8rem;
            white-space: nowrap;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
        }
        /* Simple Profile Menu */
        .profile-menu {
            position: relative;
            display: inline-block;
            margin-left: 1rem;
        }

        .profile-button {
            background: transparent;
            border: 1px solid var(--border-medium);
            color: var(--text-primary);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .profile-button:hover {
            background: var(--bg-hover);
        }

        .profile-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #ccc;
            border-radius: 6px;
            min-width: 120px;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 999999;
        }

        .profile-dropdown.show {
            display: block;
        }

        .dropdown-item {
            display: block;
            width: 100%;
            padding: 0.75rem 1rem;
            background: white;
            border: none;
            text-align: left;
            cursor: pointer;
            font-size: 14px;
            color: #333;
        }

        .dropdown-item:hover {
            background: #f5f5f5;
        }

        .dropdown-item:first-child {
            border-radius: 6px 6px 0 0;
        }

        .dropdown-item:last-child {
            border-radius: 0 0 6px 6px;
        }

        /* Ultra-high z-index override for profile dropdown */
        .profile-menu .profile-dropdown.show {
            z-index: 999999999 !important;
            position: fixed !important;
            background: white !important;
            border: 2px solid #ccc !important;
        }

        .auth-footer {
            margin-top: 1.5rem;
            text-align: center;
        }

        .auth-footer p {
            color: var(--text-muted);
            margin: 0;
        }

        .auth-footer a {
            color: var(--orange-500);
            text-decoration: none;
        }

        .auth-footer a:hover {
            text-decoration: underline;
        }

        .form-help {
            display: block;
            margin-top: 0.25rem;
            color: var(--text-muted);
            font-size: var(--text-caption);
        }

        .error-message {
            background: rgba(255, 82, 82, 0.1);
            border: 1px solid var(--error);
            color: var(--error);
            padding: 0.75rem;
            border-radius: var(--radius-sm);
            margin-top: 1rem;
        }

        .profile-info {
            margin-bottom: 2rem;
        }

        .profile-field {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-light);
        }

        .profile-field:last-child {
            border-bottom: none;
        }

        .profile-field label {
            font-weight: 600;
            color: var(--text-secondary);
        }

        .profile-field span {
            color: var(--text-primary);
        }

        .data-summary {
            background: var(--bg-orange-light);
            border: 1px solid var(--border-orange);
            border-radius: var(--radius-md);
            padding: 1.5rem;
        }

        .data-summary h3 {
            margin: 0 0 1rem 0;
            color: var(--orange-500);
        }

        .summary-stats {
            display: flex;
            gap: 2rem;
        }

        .summary-item {
            text-align: center;
        }

        .summary-value {
            font-size: var(--text-h3);
            font-weight: 700;
            color: var(--orange-500);
            margin-bottom: 0.25rem;
        }

        .summary-label {
            font-size: var(--text-small);
            color: var(--text-muted);
        }
    </style>
    <!-- External Libraries -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
</head>
<body>
    <!-- Menu Button -->
    <button class="menu-button" onclick="toggleSidebar()" title="Menu">
        ☰
    </button>

    <!-- Connection Status Indicator -->
    <div class="connection-status" id="connectionStatus" style="display: none;">
        <div class="status-icon"></div>
        <span id="connectionText">Disconnected</span>
    </div>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3>
                <span></span>
                Settings
            </h3>
            <button class="sidebar-close" onclick="closeSidebar()">×</button>
        </div>
        <nav class="sidebar-nav">
            <button class="sidebar-nav-item" onclick="openApiSettingsFromSidebar()">
                <span class="icon">🔐</span>
                API Connection
            </button>
            <div class="sidebar-divider"></div>
            <button class="sidebar-nav-item" onclick="openHistoryFromSidebar()">
                <span class="icon">📚</span>
                View History
            </button>
            <button class="sidebar-nav-item" onclick="resetAll()">
                <span class="icon">🔄</span>
                Reset All
            </button>
            <div class="sidebar-divider"></div>
            <button class="sidebar-nav-item" onclick="showAbout()">
                <span class="icon">i</span>
                About
            </button>
        </nav>
    </div>

    <!-- First-Time Setup Modal -->

    <!-- Add Vendor Modal -->
    <div class="modal-backdrop vendor-modal" id="addVendorModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">
                    <span></span>
                    Add New Vendor
                </h2>
                <button class="modal-close" onclick="closeAddVendorModal()">×</button>
            </div>
            <div class="modal-body">
                <form id="addVendorForm">
                    <div class="vendor-form-group">
                        <label for="vendorName">Vendor Name <span class="required">*</span></label>
                        <input type="text" id="vendorName" name="vendorName" required>
                    </div>
                    
                    <div class="vendor-form-group">
                        <label for="vendorDescription">Description</label>
                        <textarea id="vendorDescription" name="vendorDescription" rows="3" placeholder="Brief description of services or products"></textarea>
                    </div>
                    
                    <div class="vendor-form-group">
                        <label for="vendorEmail">Contact Email</label>
                        <input type="email" id="vendorEmail" name="vendorEmail" placeholder="contact@vendor.com">
                    </div>
                    
                    <div class="vendor-form-group">
                        <label for="contractFile">Contract File <span class="required">*</span></label>
                        <div class="file-upload-area" onclick="document.getElementById('contractFile').click()">
                            <input type="file" id="contractFile" name="contractFile" accept=".pdf,.doc,.docx" style="display: none;" onchange="handleContractFileSelect(this)">
                            <div id="contractFileStatus">
                                 Click to upload contract file (PDF, DOC, DOCX)
                            </div>
                        </div>
                    </div>
                    
                    <div class="vendor-form-group">
                        <label for="effectiveDate">Contract Effective Date <span class="required">*</span></label>
                        <input type="date" id="effectiveDate" name="effectiveDate" required>
                    </div>
                    
                    <div class="vendor-form-group">
                        <label for="renewalDate">Renewal Date</label>
                        <input type="date" id="renewalDate" name="renewalDate">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAddVendorModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveVendor()">Save Vendor</button>
            </div>
        </div>
    </div>

    <!-- Authentication Modal -->
    <div class="modal-backdrop auth-modal" id="authModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="authModalTitle">
                    <span></span>
                    Login
                </h2>
                <button class="modal-close" onclick="closeAuthModal()">×</button>
            </div>
            <div class="modal-body">
                <!-- Login Form -->
                <form id="loginForm" style="display: block;">
                    <div class="vendor-form-group">
                        <label for="loginEmail">Email <span class="required">*</span></label>
                        <input type="email" id="loginEmail" name="email" required placeholder="your@email.com">
                    </div>
                    
                    <div class="vendor-form-group">
                        <label for="loginPassword">Password <span class="required">*</span></label>
                        <input type="password" id="loginPassword" name="password" required placeholder="Your password">
                    </div>
                    
                    <div class="auth-footer">
                        <p>Don't have an account? <a href="#" onclick="switchToRegister()">Sign up here</a></p>
                    </div>
                </form>

                <!-- Registration Form -->
                <form id="registerForm" style="display: none;">
                    <div class="vendor-form-group">
                        <label for="registerFullName">Full Name <span class="required">*</span></label>
                        <input type="text" id="registerFullName" name="fullName" required placeholder="John Doe">
                    </div>
                    
                    <div class="vendor-form-group">
                        <label for="registerEmail">Email <span class="required">*</span></label>
                        <input type="email" id="registerEmail" name="email" required placeholder="your@email.com">
                    </div>
                    
                    <div class="vendor-form-group">
                        <label for="registerCompany">Company</label>
                        <input type="text" id="registerCompany" name="company" placeholder="Your Company">
                    </div>
                    
                    <div class="vendor-form-group">
                        <label for="registerPassword">Password <span class="required">*</span></label>
                        <input type="password" id="registerPassword" name="password" required placeholder="Choose a strong password">
                        <small class="form-help">Must be at least 8 characters with uppercase, lowercase, and number</small>
                    </div>
                    
                    <div class="auth-footer">
                        <p>Already have an account? <a href="#" onclick="switchToLogin()">Login here</a></p>
                    </div>
                </form>
                
                <div id="authError" class="error-message" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAuthModal()">Cancel</button>
                <button class="btn btn-primary" id="authSubmitBtn" onclick="submitAuth()">Login</button>
            </div>
        </div>
    </div>

    <!-- User Profile Modal -->
    <div class="modal-backdrop profile-modal" id="profileModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">
                    <span></span>
                    User Profile
                </h2>
                <button class="modal-close" onclick="closeProfileModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="profile-info">
                    <div class="profile-field">
                        <label>Name:</label>
                        <span id="profileName">-</span>
                    </div>
                    <div class="profile-field">
                        <label>Email:</label>
                        <span id="profileEmail">-</span>
                    </div>
                    <div class="profile-field">
                        <label>Company:</label>
                        <span id="profileCompany">-</span>
                    </div>
                    <div class="profile-field">
                        <label>Member Since:</label>
                        <span id="profileCreated">-</span>
                    </div>
                    <div class="profile-field">
                        <label>Subscription:</label>
                        <span id="profileTier">-</span>
                    </div>
                </div>
                
                <div class="data-summary">
                    <h3>Your Data</h3>
                    <div class="summary-stats">
                        <div class="summary-item">
                            <div class="summary-value" id="userContracts">0</div>
                            <div class="summary-label">Contracts</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value" id="userInvoices">0</div>
                            <div class="summary-label">Invoices</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value" id="userReconciliations">0</div>
                            <div class="summary-label">Reconciliations</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeProfileModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Top Navigation -->
    <nav class="top-nav">
        <div class="nav-left">
            <div class="logo">
                <div class="logo-icon"></div>
                <h1>Unspend</h1>
            </div>
        </div>
        <div class="nav-center">
            <ul class="nav-links">
                <li><a href="#" class="nav-link active" data-section="dashboard">Dashboard</a></li>
                <li><a href="#" class="nav-link" data-section="vendors">Vendors</a></li>
                <li><a href="#" class="nav-link" data-section="invoices">Invoices</a></li>
                <li><a href="#" class="nav-link" data-section="alerts">Alerts</a></li>
                <li><a href="#" class="nav-link" data-section="settings">Settings</a></li>
            </ul>
        </div>
        <div class="nav-right">
            <div id="authButtons" style="display: none;">
                <button class="btn btn-primary" onclick="showNewContractModal()">New Contract</button>
                <button class="btn btn-secondary" onclick="showNewInvoiceModal()">New Invoice</button>
                <div style="position: relative; display: inline-block; margin-left: 1rem;">
                    <button onclick="showSimpleMenu()" style="background: #333; color: white; border: 1px solid #555; padding: 8px 12px; border-radius: 4px; cursor: pointer;">
                        <span id="userNameDisplay">User</span> ▼
                    </button>
                    <div id="simpleMenu" style="display: none; position: absolute; top: 100%; right: 0; background: white; border: 1px solid #ccc; border-radius: 4px; min-width: 120px; z-index: 999999999; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <button onclick="showProfile(); hideSimpleMenu();" style="display: block; width: 100%; padding: 10px; background: white; border: none; text-align: left; cursor: pointer; color: #333;">Profile</button>
                        <button onclick="logout(); hideSimpleMenu();" style="display: block; width: 100%; padding: 10px; background: white; border: none; text-align: left; cursor: pointer; color: #333; border-top: 1px solid #eee;">Logout</button>
                    </div>
                </div>
            </div>
            <div id="guestButtons">
                <button class="btn btn-primary" onclick="window.location.href='/login'">Login</button>
                <button class="btn btn-secondary" onclick="window.location.href='/signup'">Sign Up</button>
            </div>
        </div>
    </nav>

    <div class="main-content">
        <!-- Dashboard Section -->
        <div class="section-view active" id="dashboardSection">
            <header class="section-header">
                <h1>Dashboard</h1>
                <p class="subtitle">Contract and spend overview at a glance</p>
            </header>

            <!-- Dashboard Charts Grid -->
            <div class="dashboard-charts-grid">
                <!-- Spend Trends Chart -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>Spend Trends</h3>
                        <select class="chart-period-select">
                            <option value="6m">Last 6 Months</option>
                            <option value="1y">Last Year</option>
                            <option value="2y">Last 2 Years</option>
                        </select>
                    </div>
                    <div class="chart-container">
                        <svg id="spendTrendsChart" width="100%" height="200" viewBox="0 0 600 200">
                            <defs>
                                <linearGradient id="spendGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                    <stop offset="0%" style="stop-color:#FF7A1A;stop-opacity:0.3"/>
                                    <stop offset="100%" style="stop-color:#FF7A1A;stop-opacity:0.05"/>
                                </linearGradient>
                            </defs>
                            <!-- Chart will be rendered via JavaScript -->
                        </svg>
                    </div>
                </div>

                <!-- Contract Status Pie Chart -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>Contract Status</h3>
                        <div class="chart-subtitle">Active Agreements</div>
                    </div>
                    <div class="chart-container">
                        <svg id="contractStatusChart" width="180" height="180" viewBox="0 0 180 180">
                            <defs>
                                <filter id="status-glow" x="-50%" y="-50%" width="200%" height="200%">
                                    <feGaussianBlur stdDeviation="4" result="coloredBlur"/>
                                    <feMerge>
                                        <feMergeNode in="coloredBlur"/>
                                        <feMergeNode in="SourceGraphic"/>
                                    </feMerge>
                                </filter>
                            </defs>
                            <!-- Status pie will be rendered via JavaScript -->
                        </svg>
                        <div class="status-legend">
                            <div class="status-item">
                                <span class="status-dot active"></span>
                                <span>Active (23)</span>
                            </div>
                            <div class="status-item">
                                <span class="status-dot expiring"></span>
                                <span>Expiring (4)</span>
                            </div>
                            <div class="status-item">
                                <span class="status-dot renewal"></span>
                                <span>Renewal (2)</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Top Vendors Bar Chart -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>Top Vendors</h3>
                        <div class="chart-subtitle">By Spend Volume</div>
                    </div>
                    <div class="chart-container">
                        <div class="vendor-bars" id="topVendorsBars">
                            <!-- Will be populated via JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Monthly Comparison -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>Monthly Comparison</h3>
                        <div class="chart-subtitle">Current vs Previous Period</div>
                    </div>
                    <div class="chart-container">
                        <div class="comparison-metrics">
                            <div class="comparison-item">
                                <div class="comparison-label">This Month</div>
                                <div class="comparison-value current">$147K</div>
                                <div class="comparison-change positive">+12.5%</div>
                            </div>
                            <div class="comparison-item">
                                <div class="comparison-label">Last Month</div>
                                <div class="comparison-value previous">$131K</div>
                            </div>
                            <div class="comparison-item">
                                <div class="comparison-label">Average</div>
                                <div class="comparison-value average">$139K</div>
                            </div>
                        </div>
                        <div class="comparison-chart">
                            <svg id="comparisonChart" width="100%" height="80" viewBox="0 0 300 80">
                                <!-- Simple comparison bars -->
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- Savings Opportunities -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>Savings Opportunities</h3>
                        <div class="chart-subtitle">Potential Cost Reductions</div>
                    </div>
                    <div class="chart-container">
                        <div class="savings-metrics">
                            <div class="savings-item">
                                <div class="savings-icon">💰</div>
                                <div class="savings-text">
                                    <div class="savings-amount">$24K</div>
                                    <div class="savings-desc">Contract Renewals</div>
                                </div>
                            </div>
                            <div class="savings-item">
                                <div class="savings-icon">📊</div>
                                <div class="savings-text">
                                    <div class="savings-amount">$16K</div>
                                    <div class="savings-desc">Volume Discounts</div>
                                </div>
                            </div>
                            <div class="savings-item">
                                <div class="savings-icon">⚡</div>
                                <div class="savings-text">
                                    <div class="savings-amount">$8K</div>
                                    <div class="savings-desc">Duplicate Services</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Risk Alerts -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>Risk Alerts</h3>
                        <div class="chart-subtitle">Contracts Requiring Attention</div>
                    </div>
                    <div class="chart-container">
                        <div class="risk-alerts">
                            <div class="risk-item high">
                                <div class="risk-icon">🔴</div>
                                <div class="risk-text">
                                    <div class="risk-title">High Risk</div>
                                    <div class="risk-count">3 contracts</div>
                                </div>
                            </div>
                            <div class="risk-item medium">
                                <div class="risk-icon">🟡</div>
                                <div class="risk-text">
                                    <div class="risk-title">Medium Risk</div>
                                    <div class="risk-count">7 contracts</div>
                                </div>
                            </div>
                            <div class="risk-item low">
                                <div class="risk-icon">🟢</div>
                                <div class="risk-text">
                                    <div class="risk-title">Low Risk</div>
                                    <div class="risk-count">19 contracts</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- KPI Cards -->
            <div class="kpi-container">
                <div class="kpi-card">
                    <div class="kpi-value" id="totalCommittedSpend">$0.00</div>
                    <div class="kpi-label">
                        Total Committed Spend
                        <span class="kpi-tooltip" title="Total contracted spend for current period">i</span>
                    </div>
                    <div class="kpi-description">Current period contracted amount</div>
                </div>
                
                <div class="kpi-card">
                    <div class="kpi-value" id="openInvoicesAmount">$0.00</div>
                    <div class="kpi-label">
                        Open Invoices
                        <span class="kpi-tooltip" title="Total amount and count of pending invoices">i</span>
                    </div>
                    <div class="kpi-description" id="openInvoicesCount">0 pending invoices</div>
                </div>
                
                <div class="kpi-card">
                    <div class="kpi-value" id="savedByUnspend">$0.00</div>
                    <div class="kpi-label">
                        Saved by Unspend
                        <span class="kpi-tooltip" title="Amount saved by detecting overpayments and errors">i</span>
                    </div>
                    <div class="kpi-description">Last 30 days</div>
                </div>
                
                <div class="kpi-card">
                    <div class="kpi-value" id="overdueAmount">$0.00</div>
                    <div class="kpi-label">
                        Overdue Amount
                        <span class="kpi-tooltip" title="Total overdue invoices requiring attention">i</span>
                    </div>
                    <div class="kpi-description" id="overdueCount">0 overdue items</div>
                </div>
                
                <div class="kpi-card">
                    <div class="kpi-value" id="activeVendorsCount">0</div>
                    <div class="kpi-label">
                        Active Vendors
                        <span class="kpi-tooltip" title="Vendors with active contracts">i</span>
                    </div>
                    <div class="kpi-description">With active contracts</div>
                </div>
            </div>

            <!-- Hero Visualization -->
            <div class="hero-visualization">
                <div class="viz-header">
                    <h2>Spend Distribution</h2>
                    <div class="viz-controls">
                        <select id="spendPeriod" class="form-select">
                            <option value="current">Current Period</option>
                            <option value="ytd">Year to Date</option>
                            <option value="last30">Last 30 Days</option>
                        </select>
                        <select id="spendGroupBy" class="form-select">
                            <option value="vendor">By Vendor</option>
                            <option value="category">By Category</option>
                            <option value="tier">By Vendor Tier</option>
                        </select>
                    </div>
                </div>
                <div class="spend-donut-container">
                    <div class="spend-donut-chart-wrapper">
                        <svg id="spendDonutChart" width="280" height="280" viewBox="0 0 280 280">
                            <defs>
                                <filter id="donut-glow" x="-50%" y="-50%" width="200%" height="200%">
                                    <feGaussianBlur stdDeviation="6" result="coloredBlur"/>
                                    <feMerge>
                                        <feMergeNode in="coloredBlur"/>
                                        <feMergeNode in="SourceGraphic"/>
                                    </feMerge>
                                </filter>
                            </defs>
                            <!-- Donut slices will be added via JavaScript -->
                        </svg>
                        <div class="donut-center">
                            <div class="donut-total-amount">$593K</div>
                            <div class="donut-total-label">Total Spend</div>
                        </div>
                    </div>
                    <div class="donut-legend">
                        <div class="legend-item" data-slice="0" onclick="highlightDonutSlice(0)">
                            <span class="legend-color" style="background: #FF7A1A"></span>
                            <span class="legend-label">Professional Services</span>
                            <span class="legend-value">$245K</span>
                            <span class="legend-percent">(41%)</span>
                        </div>
                        <div class="legend-item" data-slice="1" onclick="highlightDonutSlice(1)">
                            <span class="legend-color" style="background: #FF8C3A"></span>
                            <span class="legend-label">Software & Licenses</span>
                            <span class="legend-value">$188K</span>
                            <span class="legend-percent">(32%)</span>
                        </div>
                        <div class="legend-item" data-slice="2" onclick="highlightDonutSlice(2)">
                            <span class="legend-color" style="background: #FF9C66"></span>
                            <span class="legend-label">Facilities & Maintenance</span>
                            <span class="legend-value">$95K</span>
                            <span class="legend-percent">(16%)</span>
                        </div>
                        <div class="legend-item" data-slice="3" onclick="highlightDonutSlice(3)">
                            <span class="legend-color" style="background: #FFB38A"></span>
                            <span class="legend-label">Other</span>
                            <span class="legend-value">$65K</span>
                            <span class="legend-percent">(11%)</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Vendors Table -->
            <div class="vendors-section">
                <div class="vendors-header">
                    <h3 class="vendors-title">Active Vendors</h3>
                    <div class="vendors-actions">
                        <button class="btn btn-primary add-vendor-btn" onclick="showAnalysis()">
                            + Add Vendor
                        </button>
                        <input type="text" 
                               class="form-input vendors-search" 
                               placeholder="Search vendors..." 
                               id="vendorSearch"
                               oninput="filterVendors()">
                    </div>
                </div>
                
                <div class="vendors-table" id="vendorsTableContainer">
                    <table id="vendorsTable">
                        <thead>
                            <tr>
                                <th>Vendor</th>
                                <th>Description</th>
                                <th class="sortable" onclick="sortTable('invoices')">Invoices</th>
                                <th class="sortable" onclick="sortTable('lastUpdated')">Last Updated</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="vendorsTableBody">
                            <!-- Vendor rows will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Disabled Vendors Section -->
                <div class="disabled-vendors-section" id="disabledVendorsSection" style="display: none;">
                    <div class="disabled-vendors-header" onclick="toggleDisabledVendors()">
                        <h3 class="disabled-vendors-title">
                            <span id="disabledVendorsToggle">▶</span> Disabled Vendors
                            <span class="disabled-vendors-count" id="disabledVendorsCount">(0)</span>
                        </h3>
                        <span class="disabled-vendors-description">Previously active vendors that are no longer in use</span>
                    </div>
                    <div class="disabled-vendors-content" id="disabledVendorsContent" style="display: none;">
                        <div class="vendors-table disabled-table">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Vendor</th>
                                        <th>Description</th>
                                        <th>Invoices</th>
                                        <th>Disabled Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="disabledVendorsTableBody">
                                    <!-- Disabled vendor rows will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="empty-vendors" id="emptyVendors" style="display: none;">
                    <div class="empty-vendors-icon"></div>
                    <h3>No vendors yet</h3>
                    <p>Add your first vendor to start tracking contract reconciliations.</p>
                    <button class="add-vendor-btn" onclick="scrollToContractUpload()">
                        <span></span>
                        Upload Your First Contract
                    </button>
                </div>
            </div>

        </div> <!-- End Dashboard Section -->

        <!-- Vendors Section -->
        <div class="section-view" id="vendorsSection">
            <header class="section-header">
                <h1>Vendors</h1>
                <p class="subtitle">Manage vendor relationships and contract tracking</p>
                <div class="section-actions">
                    <button class="btn btn-primary" onclick="showNewContractModal()">+ New Contract</button>
                    <button class="btn btn-secondary" onclick="exportVendorData()">Export Data</button>
                </div>
            </header>
            
            <!-- Vendor Stats -->
            <div class="vendor-stats">
                <div class="stat-card">
                    <div class="stat-value" id="vendorTotalVendors">0</div>
                    <div class="stat-label">Total Vendors</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="vendorActiveContracts">0</div>
                    <div class="stat-label">Active Contracts</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="vendorMonthlySpend">$0</div>
                    <div class="stat-label">Monthly Spend</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="vendorPotentialSavings">$0</div>
                    <div class="stat-label">Potential Savings</div>
                </div>
            </div>

            <!-- Vendor/Contract Table -->
            <div class="vendor-table-container" id="vendorTableContainer">
                <table class="vendor-table" id="vendorTable">
                    <thead>
                        <tr>
                            <th>Vendor Name</th>
                            <th>Category</th>
                            <th>Status</th>
                            <th>Contract Value</th>
                            <th>Monthly Spend</th>
                            <th>Next Payment</th>
                            <th>Flags</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="vendorTableBody">
                        <!-- Vendor rows will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- Empty State -->
            <div class="vendor-empty-state" id="vendorEmptyState">
                <div class="empty-state-icon">🏢</div>
                <h3>No vendors or contracts found</h3>
                <p>Start by uploading a contract or adding sample data to see the vendor management system in action.</p>
                <div style="display: flex; gap: 12px; justify-content: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="showNewContractModal()">Upload Contract</button>
                </div>
            </div>
        </div>


        <!-- Invoices Section -->
        <div class="section-view" id="invoicesSection">
            <header class="section-header">
                <h1>Invoice Processing</h1>
                <p class="subtitle">Auto-sort and match invoices to contracts</p>
            </header>
            
            <div class="invoices-content">
                <div class="empty-state">
                    <div class="empty-state-icon">🧾</div>
                    <h3>Invoice automation coming soon</h3>
                    <p>This section will provide automated invoice processing, contract matching, and overpayment detection.</p>
                </div>
            </div>
        </div>

        <!-- Alerts Section -->
        <div class="section-view" id="alertsSection">
            <header class="section-header">
                <h1>Smart Alerts</h1>
                <p class="subtitle">Automated notifications for overpayments and contract issues</p>
            </header>
            
            <div class="alerts-content">
                <div class="empty-state">
                    <div class="empty-state-icon">🚨</div>
                    <h3>Alert system coming soon</h3>
                    <p>This section will provide real-time alerts for overpayments, contract violations, and renewal reminders.</p>
                </div>
            </div>
        </div>

        <!-- Settings Section -->
        <div class="section-view" id="settingsSection">
            <header class="section-header">
                <h1>Settings</h1>
                <p class="subtitle">Configure platform preferences and integrations</p>
            </header>
            
            <div class="settings-content">
                <div class="empty-state">
                    <div class="empty-state-icon">⚙️</div>
                    <h3>Advanced settings coming soon</h3>
                    <p>This section will provide platform configuration, user management, and integration settings.</p>
                </div>
            </div>
        </div>

        <!-- Document Analysis View -->
        <div class="page-view" id="analysisView">
            <header>
                <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 32px;">
                    <button class="btn btn-secondary" onclick="showDashboard()">
                        ← Back to Dashboard
                    </button>
                    <div>
                        <h1>Document Analysis</h1>
                        <p class="subtitle">Upload and analyze contracts and invoices for discrepancies</p>
                    </div>
                </div>
            </header>

        <!-- Document Upload Section -->
        <div class="upload-section" id="uploadSection">

        <!-- Settings Section -->
        <div class="section" id="settingsSection">
            <div class="section-header" onclick="toggleSection('settingsSection')">
                <h2>Settings & Configuration</h2>
            </div>
            <div class="section-content">
                <div class="settings-grid">
                    <div class="setting-item">
                        <label for="aiModel" class="tooltip" data-tooltip="GPT-4 is more accurate but costs more">AI Model</label>
                        <select id="aiModel" class="form-select">
                            <option value="gpt-3.5-turbo">GPT-3.5 Turbo (Fast & Cheap)</option>
                            <option value="gpt-4">GPT-4 (Most Accurate)</option>
                            <option value="gpt-4-turbo-preview">GPT-4 Turbo (Best Performance)</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label for="tolerance" class="tooltip" data-tooltip="Allow small differences in amounts">Amount Tolerance ($)</label>
                        <input type="number" id="tolerance" class="form-input form-input-short" value="0.01" step="0.01" min="0">
                    </div>
                    <div class="setting-item">
                        <label for="contractType" class="tooltip" data-tooltip="Helps AI understand contract format">Contract Type</label>
                        <select id="contractType" class="form-select">
                            <option value="general">General Business Contract</option>
                            <option value="service">Service Agreement</option>
                            <option value="supply">Supply/Purchase Contract</option>
                            <option value="consulting">Consulting Agreement</option>
                            <option value="maintenance">Maintenance Contract</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label for="strictMode">Validation Mode</label>
                        <select id="strictMode" class="form-select">
                            <option value="normal">Normal (Recommended)</option>
                            <option value="strict">Strict (Zero Tolerance)</option>
                            <option value="lenient">Lenient (Business Friendly)</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upload Section -->
        <div class="section" id="uploadSection">
            <div class="section-header" onclick="toggleSection('uploadSection')">
                <h2>Document Upload</h2>
            </div>
            <div class="section-content">
                <div class="upload-area">
                    <!-- Contract Upload -->
                    <div class="upload-box" id="contractUpload">
                        <div class="upload-icon"></div>
                        <h3>Contract Document</h3>
                        <p>Upload your master contract for validation</p>
                        <p style="font-size: 13px; opacity: 0.7; margin-top: 8px;">Supported formats: PDF, PNG, JPG, JPEG</p>
                        <input type="file" id="contractFile" accept=".pdf,.png,.jpg,.jpeg" />
                        <div id="contractFileInfo" class="file-list"></div>
                    </div>

                    <!-- Multiple Invoices Upload -->
                    <div class="upload-box multi-upload-box" id="invoicesUpload">
                        <div class="upload-icon"></div>
                        <h3>Invoice Documents</h3>
                        <p>Upload invoices for batch validation against contract</p>
                        <p style="font-size: 13px; opacity: 0.7; margin-top: 4px;">Select multiple files for batch processing</p>
                        <p style="font-size: 13px; opacity: 0.7;">Supported formats: PDF, PNG, JPG, JPEG</p>
                        <input type="file" id="invoiceFiles" accept=".pdf,.png,.jpg,.jpeg" multiple />
                        <div id="invoiceFilesList" class="file-list"></div>
                    </div>
                </div>

                <button id="processBtn" 
                        class="btn btn-primary btn-large process-btn" 
                        disabled
                        data-loading-text="Processing Documents..."
                        data-tooltip="Please upload contract and at least one invoice">
                    <span id="processBtnText">Analyze Documents</span>
                </button>
            </div>
        </div>

        <!-- Processing Section -->
        <div class="processing-section hidden" id="processingSection">
            <div class="spinner"></div>
            <h2>Analyzing Terms. Cross-checking Figures.</h2>
            <p id="processingStatus">Initializing document analysis...</p>
            
            <div class="processing-grid" id="processingGrid">
                <!-- Dynamic processing items will be added here -->
            </div>
        </div>

        <!-- Results Section -->
        <div class="results-section hidden" id="resultsSection">
            <div class="results-header">
                <h2>Validation Results</h2>
                <div class="export-controls">
                    <button class="btn btn-secondary export-btn" onclick="exportToPDF()">Export PDF</button>
                    <button class="btn btn-secondary export-btn" onclick="exportToExcel()">📊 Export Excel</button>
                    <button class="btn btn-success export-btn" onclick="saveToHistory()">💾 Save Results</button>
                </div>
            </div>
            
            <!-- Batch Summary -->
            <div class="batch-summary">
                <h3>Analysis Summary</h3>
                <div class="summary-stats" id="batchSummaryStats">
                    <!-- Dynamic summary stats -->
                </div>
            </div>

            <!-- Contract Analysis -->
            <div class="contract-details" id="contractAnalysis">
                <h3>Contract Analysis</h3>
                <div id="contractDetailsContent"></div>
            </div>

            <!-- Individual Invoice Results -->
            <div class="invoice-results" id="invoiceResults">
                <!-- Dynamic invoice results -->
            </div>

            <div class="action-buttons">
                <button class="btn btn-success" onclick="resetAll()">🆕 New Reconciliation</button>
                <button class="btn btn-primary" onclick="addMoreInvoices()">➕ Add More Invoices</button>
            </div>
        </div>
        
        </div> <!-- End Upload Section -->
        
        </div> <!-- End Analysis View -->
        
    </div> <!-- End Container -->

    <!-- History Panel -->
    <div class="history-panel" id="historyPanel">
        <div class="history-header">
            <h3>📚 Reconciliation History</h3>
            <button class="unstyled" onclick="toggleHistory()" style="background: none; border: none; color: var(--white); font-size: 1.2rem; cursor: pointer;">✕</button>
        </div>
        <div class="history-content" id="historyContent">
            <!-- Dynamic history items -->
        </div>
    </div>

    <!-- Vendor Details View -->
    <div class="page-view" id="vendorDetailsView">
        <header>
            <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 32px;">
                <button class="btn btn-secondary" onclick="showDashboard()">
                    ← Back to Dashboard
                </button>
                <div>
                    <h1 id="vendorDetailsTitle">Vendor Details</h1>
                    <p class="subtitle">Complete vendor profile and invoice history</p>
                </div>
            </div>
        </header>

        <div class="vendor-details-content">
            <!-- Vendor Information Section -->
            <div class="vendor-info-section">
                <div class="section-header">
                    <h2>📋 Vendor Information</h2>
                </div>
                <div class="vendor-info-grid" id="vendorInfoGrid">
                    <!-- Dynamic vendor information -->
                </div>
            </div>

            <!-- Contract Details Section -->
            <div class="contract-details-section">
                <div class="section-header">
                    <h2>Contract Details</h2>
                </div>
                <div class="contract-info" id="contractInfo">
                    <!-- Dynamic contract information -->
                </div>
            </div>

            <!-- Invoice History Section -->
            <div class="invoice-history-section">
                <div class="section-header">
                    <h2>📊 Invoice History</h2>
                </div>
                <div class="invoice-history-grid" id="invoiceHistoryGrid">
                    <!-- Dynamic invoice history -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let contractFile = null;
        let invoiceFiles = [];
        let currentResults = null;
        let processingQueue = [];
        let contractAnalysis = null;

        // Settings
        let settings = {
            aiModel: 'gpt-4',
            tolerance: 0.01,
            contractType: 'general',
            strictMode: 'normal'
        };



        // ===============================
        // SIDEBAR NAVIGATION SYSTEM
        // ===============================

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (sidebar.classList.contains('open')) {
                closeSidebar();
            } else {
                openSidebar();
            }
        }

        function openSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.add('open');
            overlay.classList.add('open');
            
            // Trap focus in sidebar
            const firstFocusable = sidebar.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
            if (firstFocusable) {
                firstFocusable.focus();
            }
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.remove('open');
            overlay.classList.remove('open');
            
            // Return focus to menu button
            document.querySelector('.menu-button').focus();
        }

        function openApiSettingsFromSidebar() {
            closeSidebar();
            setTimeout(() => {
                openApiSettings();
            }, 300); // Wait for sidebar close animation
        }

        function openHistoryFromSidebar() {
            closeSidebar();
            setTimeout(() => {
                toggleHistory();
            }, 300); // Wait for sidebar close animation
        }

        function showAbout() {
            closeSidebar();
            setTimeout(() => {
                alert('Invoice Reconciliation Platform Pro v2.0\n\nBuilt for precision contract validation and financial accuracy.\n\nFeatures:\n• AI-powered document analysis\n• Real-time reconciliation\n• Advanced discrepancy detection\n• Secure API key management\n\n© 2024 Invoice Reconciliation Platform');
            }, 300);
        }

        // ===============================
        // PAGE NAVIGATION SYSTEM
        // ===============================

        function showDashboard() {
            document.querySelectorAll('.page-view').forEach(view => {
                view.classList.remove('active');
            });
            document.getElementById('dashboardView').classList.add('active');
            loadDashboard();
        }

        function showAnalysis() {
            document.querySelectorAll('.page-view').forEach(view => {
                view.classList.remove('active');
            });
            document.getElementById('analysisView').classList.add('active');
        }

        function showVendorDetails(vendorId) {
            document.querySelectorAll('.page-view').forEach(view => {
                view.classList.remove('active');
            });
            document.getElementById('vendorDetailsView').classList.add('active');
            loadVendorDetails(vendorId);
        }

        // ===============================
        // DASHBOARD SYSTEM
        // ===============================

        let vendors = JSON.parse(localStorage.getItem('vendors') || '[]');
        let currentSort = { field: null, direction: 'asc' };

        function loadDashboard() {
            updateKPIs();
            loadVendorsTable();
            generateSpendTrendsChart();
            generateContractStatusChart();
            generateTopVendorsChart();
            generateMonthlyComparisonChart();
            generateSavingsChart();
            generateRiskAlertsChart();
        }

        // STREAMLINED DASHBOARD FUNCTIONS
        function updateStreamlinedDashboard() {
            updateActionItems();
            updateCoreMetrics();
            updateSpendDistribution();
        }

        function updateActionItems() {
            // Simulate action items data
            const highRiskCount = Math.floor(Math.random() * 5) + 1;
            const pendingApprovalCount = Math.floor(Math.random() * 8) + 2;
            const overdueCount = Math.floor(Math.random() * 3);

            document.getElementById('highRiskCount').textContent = highRiskCount;
            document.getElementById('pendingApprovalCount').textContent = pendingApprovalCount;
            document.getElementById('overdueCount').textContent = overdueCount;
        }

        function updateCoreMetrics() {
            const vendors = JSON.parse(localStorage.getItem('vendors') || '[]');
            const history = JSON.parse(localStorage.getItem('reconciliation_history') || '[]');
            
            // Calculate real values where possible
            const activeVendors = vendors.filter(v => v.status === 'active').length;
            const processedInvoices = history.length;
            
            // Simulate financial data
            const totalCommittedSpend = Math.floor(Math.random() * 500000) + 100000;
            const monthSavings = Math.floor(Math.random() * 25000) + 5000;

            document.getElementById('totalCommittedSpend').textContent = `$${(totalCommittedSpend / 1000).toFixed(0)}K`;
            document.getElementById('monthSavings').textContent = `$${(monthSavings / 1000).toFixed(0)}K`;
            document.getElementById('activeVendorsValue').textContent = activeVendors;
            document.getElementById('reviewedInvoicesValue').textContent = processedInvoices;
        }

        function updateSpendDistribution() {
            const spendData = [
                { category: 'Professional Services', amount: 245000, percentage: 41, color: '#FF7A1A' },
                { category: 'Software & Licenses', amount: 188000, percentage: 32, color: '#FF8C3A' },
                { category: 'Facilities & Maintenance', amount: 95000, percentage: 16, color: '#FF9C66' },
                { category: 'Other', amount: 65000, percentage: 11, color: '#FFB38A' }
            ];

            // Update total spend
            const totalSpend = spendData.reduce((sum, item) => sum + item.amount, 0);
            document.getElementById('totalSpendAmount').textContent = `$${(totalSpend / 1000).toFixed(0)}K`;

            // Generate donut chart
            generateDonutChart('spendDonutChart', spendData);
        }

        function generateDonutChart(svgId, data) {
            const svg = document.getElementById(svgId);
            if (!svg) return;
            
            const centerX = 150;
            const centerY = 150;
            const radius = 100;
            const thickness = 40;

            // Clear existing content
            svg.innerHTML = '';

            let startAngle = 0;
            data.forEach(segment => {
                const angle = (segment.percentage / 100) * 2 * Math.PI;
                const endAngle = startAngle + angle;

                const largeArcFlag = angle > Math.PI ? 1 : 0;

                const x1 = centerX + (radius - thickness) * Math.cos(startAngle);
                const y1 = centerY + (radius - thickness) * Math.sin(startAngle);
                const x2 = centerX + radius * Math.cos(startAngle);
                const y2 = centerY + radius * Math.sin(startAngle);

                const x3 = centerX + radius * Math.cos(endAngle);
                const y3 = centerY + radius * Math.sin(endAngle);
                const x4 = centerX + (radius - thickness) * Math.cos(endAngle);
                const y4 = centerY + (radius - thickness) * Math.sin(endAngle);

                const pathData = [
                    `M ${x1} ${y1}`,
                    `L ${x2} ${y2}`,
                    `A ${radius} ${radius} 0 ${largeArcFlag} 1 ${x3} ${y3}`,
                    `L ${x4} ${y4}`,
                    `A ${radius - thickness} ${radius - thickness} 0 ${largeArcFlag} 0 ${x1} ${y1}`,
                    'Z'
                ].join(' ');

                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', pathData);
                path.setAttribute('fill', segment.color);
                path.setAttribute('stroke', 'none');
                svg.appendChild(path);

                startAngle = endAngle;
            });
        }

        function loadTopVendors() {
            const vendors = JSON.parse(localStorage.getItem('vendors') || '[]');
            const activeVendors = vendors.filter(v => v.status === 'active');
            
            // Sort by spend and take top 3
            const topVendors = activeVendors
                .sort((a, b) => (b.totalSpend || 0) - (a.totalSpend || 0))
                .slice(0, 3);

            const topVendorsGrid = document.getElementById('topVendorsGrid');
            
            if (topVendors.length === 0) {
                topVendorsGrid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">🏢</div>
                        <h3>No vendors yet</h3>
                        <p>Add your first vendor to start tracking spend</p>
                    </div>
                `;
            } else {
                topVendorsGrid.innerHTML = topVendors.map(vendor => `
                    <div class="vendor-card" onclick="viewVendorDetails('${vendor.id}')">
                        <div class="vendor-name">${vendor.name}</div>
                        <div class="vendor-spend">$${((vendor.totalSpend || Math.random() * 100000 + 50000) / 1000).toFixed(0)}K</div>
                        <div class="vendor-description">${vendor.description || 'No description'}</div>
                    </div>
                `).join('');
            }

            // Update summary
            document.getElementById('totalVendorsCount').textContent = activeVendors.length;
            document.getElementById('vendorsRequiringAttention').textContent = Math.floor(activeVendors.length * 0.2);
        }

        function viewAllVendors() {
            document.getElementById('fullVendorsSection').style.display = 'block';
            loadVendorsTable();
        }

        function hideAllVendors() {
            document.getElementById('fullVendorsSection').style.display = 'none';
        }

        function updateKPIs() {
            // Calculate KPI values from reconciliation history and vendors
            const history = JSON.parse(localStorage.getItem('reconciliation_history') || '[]');
            
            // Total Invoice Drift - sum of all discrepancy values
            let totalDrift = 0;
            history.forEach(entry => {
                // Fix: Access discrepancies from invoiceResults within the stored results
                if (entry.results?.invoiceResults) {
                    entry.results.invoiceResults.forEach(invoice => {
                        if (invoice.comparison?.discrepancies) {
                            invoice.comparison.discrepancies.forEach(disc => {
                                // Extract numeric value from discrepancy description
                                const match = disc.description?.match(/\$?([\d,]+\.?\d*)/);
                                if (match) {
                                    totalDrift += parseFloat(match[1].replace(/,/g, ''));
                                }
                            });
                        }
                    });
                }
            });

            // Active Vendors - only count active vendors with contracts (treat vendors without status as active)
            const activeVendors = vendors.filter(vendor => (!vendor.status || vendor.status !== 'disabled') && vendor.contractFile).length;

            // AI-Reviewed Invoices - total processed invoices
            const reviewedInvoices = history.length;

            // Update KPI displays
            document.getElementById('totalDriftValue').textContent = `$${totalDrift.toLocaleString('en-US', { minimumFractionDigits: 2 })}`;
            document.getElementById('activeVendorsValue').textContent = activeVendors.toString();
            document.getElementById('reviewedInvoicesValue').textContent = reviewedInvoices.toString();
        }

        function loadVendorsTable() {
            const tableBody = document.getElementById('vendorsTableBody');
            const emptyState = document.getElementById('emptyVendors');
            const tableContainer = document.getElementById('vendorsTableContainer');
            
            // Filter to show only active vendors (treat vendors without status as active for backward compatibility)
            const activeVendors = vendors.filter(vendor => !vendor.status || vendor.status !== 'disabled');
            
            if (activeVendors.length === 0) {
                tableContainer.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            tableContainer.style.display = 'block';
            emptyState.style.display = 'none';
            
            // Calculate invoice counts for each vendor from reconciliation history
            const history = JSON.parse(localStorage.getItem('reconciliation_history') || '[]');
            const vendorInvoiceCounts = {};
            
            history.forEach(entry => {
                const vendorName = entry.results?.contractDetails?.vendor_name;
                if (vendorName) {
                    vendorInvoiceCounts[vendorName] = (vendorInvoiceCounts[vendorName] || 0) + 1;
                }
            });
            
            // Sort vendors if needed
            let sortedVendors = [...activeVendors];
            if (currentSort.field) {
                sortedVendors.sort((a, b) => {
                    let aVal, bVal;
                    if (currentSort.field === 'invoices') {
                        aVal = vendorInvoiceCounts[a.name] || 0;
                        bVal = vendorInvoiceCounts[b.name] || 0;
                    } else if (currentSort.field === 'lastUpdated') {
                        aVal = new Date(a.lastUpdated || a.createdAt);
                        bVal = new Date(b.lastUpdated || b.createdAt);
                    }
                    
                    if (currentSort.direction === 'asc') {
                        return aVal > bVal ? 1 : -1;
                    } else {
                        return aVal < bVal ? 1 : -1;
                    }
                });
            }
            
            // Generate table rows
            tableBody.innerHTML = '';
            sortedVendors.forEach(vendor => {
                const invoiceCount = vendorInvoiceCounts[vendor.name] || 0;
                const lastUpdated = new Date(vendor.lastUpdated || vendor.createdAt).toLocaleDateString();
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><a href="#" class="vendor-name" onclick="viewVendorDetails('${vendor.id}')">${vendor.name}</a></td>
                    <td>${vendor.description || ''}</td>
                    <td>${invoiceCount}</td>
                    <td>${lastUpdated}</td>
                    <td>
                        <div class="vendor-actions">
                            <button class="btn-icon" onclick="disableVendor('${vendor.id}')" title="Disable vendor">
                                                            </button>
                            <button class="btn-icon btn-danger" onclick="deleteVendor('${vendor.id}')" title="Delete vendor permanently">
                                                            </button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Load disabled vendors section
            loadDisabledVendors();
        }

        function loadDisabledVendors() {
            const disabledVendors = vendors.filter(vendor => vendor.status === 'disabled');
            const disabledSection = document.getElementById('disabledVendorsSection');
            const disabledCount = document.getElementById('disabledVendorsCount');
            const disabledTableBody = document.getElementById('disabledVendorsTableBody');
            
            // Update count
            disabledCount.textContent = `(${disabledVendors.length})`;
            
            // Show/hide section based on whether there are disabled vendors
            if (disabledVendors.length > 0) {
                disabledSection.style.display = 'block';
                
                // Calculate invoice counts for disabled vendors
                const history = JSON.parse(localStorage.getItem('reconciliation_history') || '[]');
                const vendorInvoiceCounts = {};
                history.forEach(entry => {
                    const vendorName = entry.results?.contractDetails?.vendor_name;
                    if (vendorName) {
                        vendorInvoiceCounts[vendorName] = (vendorInvoiceCounts[vendorName] || 0) + 1;
                    }
                });
                
                // Generate disabled vendor rows
                disabledTableBody.innerHTML = '';
                disabledVendors.forEach(vendor => {
                    const invoiceCount = vendorInvoiceCounts[vendor.name] || 0;
                    const disabledDate = vendor.disabledDate ? new Date(vendor.disabledDate).toLocaleDateString() : 'Unknown';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><a href="#" class="vendor-name" onclick="viewVendorDetails('${vendor.id}')">${vendor.name}</a></td>
                        <td>${vendor.description || ''}</td>
                        <td>${invoiceCount}</td>
                        <td>${disabledDate}</td>
                        <td>
                            <div class="vendor-actions">
                                <button class="btn-icon" onclick="enableVendor('${vendor.id}')" title="Re-enable vendor">
                                                                    </button>
                                <button class="btn-icon btn-danger" onclick="deleteVendor('${vendor.id}')" title="Delete vendor permanently">
                                                                    </button>
                            </div>
                        </td>
                    `;
                    disabledTableBody.appendChild(row);
                });
            } else {
                disabledSection.style.display = 'none';
            }
        }

        function toggleDisabledVendors() {
            const content = document.getElementById('disabledVendorsContent');
            const toggle = document.getElementById('disabledVendorsToggle');
            const title = document.querySelector('.disabled-vendors-title');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.textContent = '▼';
                title.classList.add('expanded');
            } else {
                content.style.display = 'none';
                toggle.textContent = '▶';
                title.classList.remove('expanded');
            }
        }

        function disableVendor(vendorId) {
            const vendor = vendors.find(v => v.id === vendorId);
            if (!vendor) return;
            
            if (confirm(`Are you sure you want to disable "${vendor.name}"?\n\nDisabled vendors will be moved to a separate section but their data will be preserved. You can re-enable them later if needed.`)) {
                vendor.status = 'disabled';
                vendor.disabledDate = new Date().toISOString();
                vendor.lastUpdated = new Date().toISOString();
                
                localStorage.setItem('vendors', JSON.stringify(vendors));
                loadVendorsTable();
                updateKPIs();
            }
        }

        function enableVendor(vendorId) {
            const vendor = vendors.find(v => v.id === vendorId);
            if (!vendor) return;
            
            if (confirm(`Re-enable "${vendor.name}"?\n\nThis vendor will be moved back to the active vendors list.`)) {
                vendor.status = 'active';
                delete vendor.disabledDate;
                vendor.lastUpdated = new Date().toISOString();
                
                localStorage.setItem('vendors', JSON.stringify(vendors));
                loadVendorsTable();
                updateKPIs();
            }
        }

        function deleteVendor(vendorId) {
            const vendor = vendors.find(v => v.id === vendorId);
            if (!vendor) return;
            
            if (confirm(`PERMANENT DELETION WARNING\n\nAre you sure you want to permanently delete "${vendor.name}"?\n\nThis action will:\n• Delete all vendor data\n• Remove all associated contract information\n• Cannot be undone\n\nType "DELETE" to confirm this permanent action.`)) {
                const confirmation = prompt(`To confirm permanent deletion of "${vendor.name}", type DELETE in capital letters:`);
                
                if (confirmation === 'DELETE') {
                    // Remove vendor from array
                    const vendorIndex = vendors.findIndex(v => v.id === vendorId);
                    if (vendorIndex > -1) {
                        vendors.splice(vendorIndex, 1);
                        localStorage.setItem('vendors', JSON.stringify(vendors));
                        loadVendorsTable();
                        updateKPIs();
                        alert(`"${vendor.name}" has been permanently deleted.`);
                    }
                } else {
                    alert('Deletion cancelled - confirmation text did not match.');
                }
            }
        }

        function sortTable(field) {
            // Update sort direction
            if (currentSort.field === field) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.field = field;
                currentSort.direction = 'asc';
            }
            
            // Update visual indicators
            document.querySelectorAll('.vendors-table th').forEach(th => {
                th.classList.remove('sorted-asc', 'sorted-desc');
            });
            
            const sortedTh = [...document.querySelectorAll('.vendors-table th')].find(th => 
                th.textContent.toLowerCase().includes(field.toLowerCase())
            );
            if (sortedTh) {
                sortedTh.classList.add(`sorted-${currentSort.direction}`);
            }
            
            loadVendorsTable();
        }

        function filterVendors() {
            const searchTerm = document.getElementById('vendorSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#vendorsTableBody tr');
            
            rows.forEach(row => {
                const vendorName = row.querySelector('.vendor-name').textContent.toLowerCase();
                const description = row.children[1].textContent.toLowerCase();
                
                if (vendorName.includes(searchTerm) || description.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function loadVendorDetails(vendorId) {
            const vendor = vendors.find(v => v.id === vendorId);
            if (!vendor) {
                alert('Vendor not found');
                showDashboard();
                return;
            }

            // Update page title
            document.getElementById('vendorDetailsTitle').textContent = vendor.name;

            // Load vendor information
            loadVendorInformation(vendor);

            // Load contract details
            loadContractDetails(vendor);

            // Load invoice history
            loadInvoiceHistory(vendor);
        }

        function loadVendorInformation(vendor) {
            const vendorInfoGrid = document.getElementById('vendorInfoGrid');
            const contractAnalysis = vendor.contractAnalysis;
            const vendorInfo = contractAnalysis?.vendor_information || {};
            const aiSummary = contractAnalysis?.ai_summary || {};

            let htmlContent = '';

            // Add AI Summary section - show if we have data OR if we have contract analysis to potentially regenerate
            if (aiSummary.overview || aiSummary.vendor_overview || aiSummary.contract_overview || contractAnalysis) {
                htmlContent += `
                    <div class="ai-summary-section">
                        <h3 class="ai-summary-title">🤖 AI Contract Summary</h3>
                        ${aiSummary.overview ? `
                            <div class="ai-summary-item">
                                <div class="ai-summary-label">Contract Summary</div>
                                <div class="ai-summary-text">${aiSummary.overview}</div>
                            </div>
                        ` : ''}
                        ${aiSummary.financial_highlights && aiSummary.financial_highlights.length > 0 ? `
                            <div class="ai-summary-item">
                                <div class="ai-summary-label">Financial Terms & Renewals</div>
                                <div class="ai-summary-highlights">
                                    ${aiSummary.financial_highlights.map(highlight => 
                                        `<div class="highlight-item">💰 ${highlight}</div>`
                                    ).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${/* Handle legacy data structure for backwards compatibility */
                        !aiSummary.overview && (aiSummary.vendor_overview || aiSummary.contract_overview) ? `
                            <div class="ai-summary-item">
                                <div class="ai-summary-label">Contract Summary</div>
                                <div class="ai-summary-text">${aiSummary.vendor_overview || ''} ${aiSummary.contract_overview || ''}</div>
                            </div>
                        ` : ''}
                        ${!aiSummary.financial_highlights && aiSummary.key_highlights && aiSummary.key_highlights.length > 0 ? `
                            <div class="ai-summary-item">
                                <div class="ai-summary-label">Key Terms</div>
                                <div class="ai-summary-highlights">
                                    ${aiSummary.key_highlights.map(highlight => 
                                        `<div class="highlight-item">• ${highlight}</div>`
                                    ).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${!aiSummary.overview && !aiSummary.vendor_overview && !aiSummary.contract_overview && contractAnalysis ? `
                            <div class="ai-summary-item">
                                <div class="ai-summary-text" style="text-align: center; color: var(--text-muted);">
                                     This vendor was created before AI summaries were available.
                                    <br>
                                    <button class="btn btn-primary" style="margin-top: 12px; font-size: 14px; padding: 8px 16px;" 
                                            onclick="regenerateAISummary('${vendor.id}')">
                                        Generate AI Summary
                                    </button>
                                </div>
                            </div>
                        ` : ''}
                        
                        ${!contractAnalysis ? `
                            <div class="ai-summary-item">
                                <div class="ai-summary-text" style="text-align: center; color: var(--text-muted);">
                                    📋 No contract data available for AI analysis.
                                    <br>Upload a contract to see AI-generated summaries.
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            let infoItems = [];

            // Add vendor information items
            if (vendorInfo.legal_name) {
                infoItems.push({ label: 'Legal Name', value: vendorInfo.legal_name });
            }
            
            if (vendorInfo.trade_names && vendorInfo.trade_names.length > 0) {
                infoItems.push({ label: 'Trade Names', value: vendorInfo.trade_names.join(', ') });
            }
            
            if (vendorInfo.address) {
                infoItems.push({ label: 'Address', value: vendorInfo.address });
            }
            
            if (vendorInfo.tax_id) {
                infoItems.push({ label: 'Tax ID', value: vendorInfo.tax_id });
            }
            
            if (vendorInfo.contact_email) {
                infoItems.push({ label: 'Email', value: vendorInfo.contact_email });
            }
            
            if (vendorInfo.contact_phone) {
                infoItems.push({ label: 'Phone', value: vendorInfo.contact_phone });
            }

            // If no contract analysis data, show basic vendor info
            if (infoItems.length === 0) {
                infoItems.push({ label: 'Vendor Name', value: vendor.name });
                if (vendor.description) {
                    infoItems.push({ label: 'Description', value: vendor.description });
                }
            }

            // Combine AI summary with vendor info items
            htmlContent += infoItems.map(item => `
                <div class="vendor-info-item">
                    <div class="vendor-info-label">${item.label}</div>
                    <div class="vendor-info-value">${item.value}</div>
                </div>
            `).join('');

            vendorInfoGrid.innerHTML = htmlContent;
        }

        function loadContractDetails(vendor) {
            const contractInfo = document.getElementById('contractInfo');
            
            if (!vendor.contractFile && !vendor.contractAnalysis) {
                contractInfo.innerHTML = `
                    <div class="empty-invoice-history">
                        <div class="empty-invoice-history-icon"></div>
                        <h3>No Contract Available</h3>
                        <p>Upload a contract to see detailed vendor terms and conditions.</p>
                    </div>
                `;
                return;
            }

            const contractAnalysis = vendor.contractAnalysis || {};
            const contractDetails = contractAnalysis.contract_details || {};
            const financialTerms = contractAnalysis.financial_terms || {};

            contractInfo.innerHTML = `
                <div class="contract-file-info">
                    <div class="contract-file-header">
                        <div class="contract-file-icon"></div>
                        <div style="flex: 1;">
                            <div class="contract-file-name clickable-file" onclick="downloadContractFile('${vendor.id}')" title="Click to download contract">
                                ${vendor.contractFile || 'Contract File'}                             </div>
                            <div class="contract-file-date">
                                Uploaded: ${vendor.contractUploadDate ? new Date(vendor.contractUploadDate).toLocaleDateString() : 'Unknown date'}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="contract-terms-grid">
                    ${contractDetails.contract_type ? `
                        <div class="contract-term-item">
                            <div class="vendor-info-label">Contract Type</div>
                            <div class="vendor-info-value">${contractDetails.contract_type}</div>
                        </div>
                    ` : ''}
                    
                    ${contractDetails.effective_date ? `
                        <div class="contract-term-item">
                            <div class="vendor-info-label">Effective Date</div>
                            <div class="vendor-info-value">${contractDetails.effective_date}</div>
                        </div>
                    ` : ''}
                    
                    ${contractDetails.expiration_date ? `
                        <div class="contract-term-item">
                            <div class="vendor-info-label">Expiration Date</div>
                            <div class="vendor-info-value">${contractDetails.expiration_date}</div>
                        </div>
                    ` : ''}
                    
                    ${financialTerms.payment_terms ? `
                        <div class="contract-term-item">
                            <div class="vendor-info-label">Payment Terms</div>
                            <div class="vendor-info-value">${financialTerms.payment_terms}</div>
                        </div>
                    ` : ''}
                    
                    ${financialTerms.pricing_structure ? `
                        <div class="contract-term-item">
                            <div class="vendor-info-label">Pricing Structure</div>
                            <div class="vendor-info-value">${financialTerms.pricing_structure}</div>
                        </div>
                    ` : ''}
                    
                    ${financialTerms.currency ? `
                        <div class="contract-term-item">
                            <div class="vendor-info-label">Currency</div>
                            <div class="vendor-info-value">${financialTerms.currency}</div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function loadInvoiceHistory(vendor) {
            const invoiceHistoryGrid = document.getElementById('invoiceHistoryGrid');
            const history = JSON.parse(localStorage.getItem('reconciliation_history') || '[]');
            
            // Filter history for this vendor
            const vendorInvoices = history.filter(entry => 
                entry.vendorId === vendor.id || 
                (entry.contractFile && entry.contractFile === vendor.contractFile)
            );

            if (vendorInvoices.length === 0) {
                invoiceHistoryGrid.innerHTML = `
                    <div class="empty-invoice-history">
                        <div class="empty-invoice-history-icon">📊</div>
                        <h3>No Invoice History</h3>
                        <p>No invoices have been processed for this vendor yet.</p>
                    </div>
                `;
                return;
            }

            invoiceHistoryGrid.innerHTML = vendorInvoices.map((invoice, index) => {
                // Fix: Check for discrepancies in the correct structure
                let hasDiscrepancies = false;
                if (invoice.results?.invoiceResults) {
                    hasDiscrepancies = invoice.results.invoiceResults.some(inv => 
                        inv.comparison?.discrepancies?.length > 0
                    );
                }
                const status = hasDiscrepancies ? 'flagged' : 'approved';
                const statusText = status === 'flagged' ? 'Issues Found' : 'Approved';
                
                // Get the invoices from this reconciliation
                const invoiceFiles = invoice.results?.invoiceResults || [];
                const invoicesDisplay = invoiceFiles.length > 0 ? 
                    invoiceFiles.map((invFile, fileIndex) => `
                        <div class="clickable-file invoice-file-link" 
                             onclick="downloadInvoiceFile('${invoice.id}', ${fileIndex})" 
                             title="Click to download ${invFile.filename}">
                             ${invFile.filename}                         </div>
                    `).join('') : 
                    '<div class="invoice-name">Invoice files</div>';
                
                return `
                    <div class="invoice-item">
                        <div class="invoice-header">
                            <div>
                                <div class="invoice-files-section">
                                    ${invoicesDisplay}
                                </div>
                                <div class="invoice-date">${new Date(invoice.timestamp).toLocaleDateString()}</div>
                            </div>
                            <div class="invoice-status ${status}">${statusText}</div>
                        </div>
                        
                        ${hasDiscrepancies ? `
                            <div class="invoice-findings">
                                <div class="invoice-findings-title">AI Findings:</div>
                                <div class="invoice-findings-list">
                                    ${invoice.results.invoiceResults.map(inv => {
                                        if (inv.comparison?.discrepancies?.length > 0) {
                                            return inv.comparison.discrepancies.slice(0, 3).map(disc => 
                                                `• ${disc.field}: ${disc.description || disc.contract_value + ' vs ' + disc.invoice_value}`
                                            ).join('<br>');
                                        }
                                        return '';
                                    }).filter(item => item).join('<br>')}
                                </div>
                            </div>
                        ` : `
                            <div class="invoice-findings">
                                <div class="invoice-findings-title">AI Findings:</div>
                                <div class="invoice-findings-list">✅ No discrepancies found - invoice matches contract terms</div>
                            </div>
                        `}
                    </div>
                `;
            }).join('');
        }

        function downloadContractFile(vendorId) {
            const vendor = vendors.find(v => v.id === vendorId);
            if (!vendor || !vendor.contractFileData) {
                alert('Contract file not available for download');
                return;
            }

            // Create a download link
            const link = document.createElement('a');
            link.href = vendor.contractFileData;
            link.download = vendor.contractFile || 'contract.pdf';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function downloadInvoiceFile(reconciliationId, fileIndex) {
            const history = JSON.parse(localStorage.getItem('reconciliation_history') || '[]');
            const entry = history.find(h => h.id == reconciliationId);
            
            if (!entry || !entry.results?.invoiceResults) {
                alert('Invoice file not available for download');
                return;
            }

            const invoiceFile = entry.results.invoiceResults[fileIndex];
            if (!invoiceFile || !invoiceFile.fileData) {
                alert('Invoice file data not available for download');
                return;
            }

            // Create a download link
            const link = document.createElement('a');
            link.href = invoiceFile.fileData;
            link.download = invoiceFile.filename || 'invoice.pdf';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function regenerateAISummary(vendorId) {
            const vendor = vendors.find(v => v.id === vendorId);
            if (!vendor || !vendor.contractAnalysis) {
                alert('Cannot regenerate AI summary - no contract analysis data available');
                return;
            }

            // Show loading state
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'Generating...';
            button.disabled = true;

            try {
                // Extract the original contract text (if available) or use existing analysis
                const contractData = vendor.contractAnalysis;
                
                // Create a synthetic prompt to generate summary from existing contract analysis
                const summaryPrompt = `Based on this contract analysis data, provide a comprehensive AI summary in exact JSON format:

${JSON.stringify(contractData, null, 2)}

IMPORTANT INSTRUCTIONS:
- Focus ONLY on what IS explicitly stated in the contract data - never mention what is missing or not specified
- NEVER use phrases like "The contract does not specify", "not mentioned", "not addressed", or similar negative statements
- Include only financial terms that are actually present in the data
- If financial information is not available, simply omit that highlight rather than mentioning its absence

Return ONLY this JSON structure:
{
  "ai_summary": {
    "overview": "3-4 sentence summary combining who this vendor is, what they provide, and the key contract terms including payment structure and duration using only available information",
    "financial_highlights": ["3-5 bullet points focusing ONLY on financial terms, payment schedules, pricing structure, and renewal conditions that are actually present in the contract data"]
  }
}`;

                const response = await callOpenAI(summaryPrompt, 'You are an expert contract analyst. Generate comprehensive summaries from contract data.');
                
                // Update vendor with AI summary
                vendor.contractAnalysis.ai_summary = response.ai_summary;
                
                // Save updated vendors
                localStorage.setItem('vendors', JSON.stringify(vendors));
                
                // Reload the vendor details to show new summary
                loadVendorDetails(vendorId);
                
                alert('AI summary generated successfully!');
                
            } catch (error) {
                console.error('Error generating AI summary:', error);
                alert('Error generating AI summary: ' + error.message);
                
                // Restore button state
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        // ===============================
        // VENDOR MANAGEMENT
        // ===============================

        function openAddVendorModal() {
            document.getElementById('addVendorModal').classList.add('open');
            document.getElementById('addVendorForm').reset();
            document.getElementById('contractFileStatus').innerHTML = ' Click to upload contract file (PDF, DOC, DOCX)';
        }

        function closeAddVendorModal() {
            document.getElementById('addVendorModal').classList.remove('open');
        }

        function handleContractFileSelect(input) {
            const file = input.files[0];
            const statusDiv = document.getElementById('contractFileStatus');
            
            if (file) {
                statusDiv.innerHTML = ` Selected: ${file.name}`;
                statusDiv.style.color = 'var(--accent-success)';
            } else {
                statusDiv.innerHTML = ' Click to upload contract file (PDF, DOC, DOCX)';
                statusDiv.style.color = '';
            }
        }

        async function saveVendor() {
            const form = document.getElementById('addVendorForm');
            const formData = new FormData(form);
            
            // Validate required fields
            const name = formData.get('vendorName').trim();
            const contractFile = formData.get('contractFile');
            const effectiveDate = formData.get('effectiveDate');
            
            if (!name || !contractFile || !effectiveDate) {
                alert('Please fill in all required fields (Vendor Name, Contract File, and Effective Date).');
                return;
            }
            
            // Create vendor object
            const vendor = {
                id: Date.now().toString(),
                name: name,
                description: formData.get('vendorDescription') || '',
                email: formData.get('vendorEmail') || '',
                contractFile: contractFile.name,
                contractFileData: await fileToBase64(contractFile),
                contractUploadDate: new Date().toISOString(),
                effectiveDate: effectiveDate,
                renewalDate: formData.get('renewalDate') || '',
                status: 'active',
                createdAt: new Date().toISOString(),
                lastUpdated: new Date().toISOString()
            };
            
            // Add to vendors array and save
            vendors.push(vendor);
            localStorage.setItem('vendors', JSON.stringify(vendors));
            
            // Close modal and refresh dashboard
            closeAddVendorModal();
            loadDashboard();
        }

        function viewVendorDetails(vendorId) {
            // Navigate to vendor details page
            showVendorDetails(vendorId);
        }

        function scrollToContractUpload() {
            // Navigate to analysis page
            showAnalysis();
            
            // Optional: Highlight the contract upload area briefly after page loads
            setTimeout(() => {
                const contractUpload = document.getElementById('contractUpload');
                if (contractUpload) {
                    contractUpload.scrollIntoView({ 
                        behavior: 'smooth',
                        block: 'center'
                    });
                    
                    contractUpload.style.transform = 'scale(1.02)';
                    contractUpload.style.borderColor = 'var(--accent-cyan)';
                    
                    setTimeout(() => {
                        contractUpload.style.transform = '';
                        contractUpload.style.borderColor = '';
                    }, 1000);
                }
            }, 300);
        }

        // ===============================
        // MODIFIED INITIALIZATION
        // ===============================

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing Unspend...');
            loadSettings();
            setupEventListeners();
            setupDragAndDrop();
            loadHistory();
            
            // Initialize new API key management system
            if (isFirstTimeUser && !true) {
                showFirstTimeSetup();
            } else {
                // Connection always ready
                if (true) {
                    checkApiKey();
                }
            }
            
            // Load dashboard data on startup
            loadDashboard();
            
            // Initialize vendor system if no data exists
            if (vendorData.length === 0) {
                console.log('No vendor data found, will load on vendor section access');
            }
            
            console.log('Unspend initialized successfully!');
        });

        function loadSettings() {
            const savedSettings = localStorage.getItem('reconciliation_settings');
            if (savedSettings) {
                settings = { ...settings, ...JSON.parse(savedSettings) };
                
                document.getElementById('aiModel').value = settings.aiModel;
                document.getElementById('tolerance').value = settings.tolerance;
                document.getElementById('contractType').value = settings.contractType;
                document.getElementById('strictMode').value = settings.strictMode;
            }
        }

        function saveSettings() {
            settings = {
                aiModel: document.getElementById('aiModel').value,
                tolerance: parseFloat(document.getElementById('tolerance').value),
                contractType: document.getElementById('contractType').value,
                strictMode: document.getElementById('strictMode').value
            };
            localStorage.setItem('reconciliation_settings', JSON.stringify(settings));
        }

        function setupEventListeners() {
            // Navigation
            setupNavigation();
            
            // API Key
            document.getElementById('saveApiKeyBtn').addEventListener('click', saveAndTestApiKey);
            
            // File uploads
            document.getElementById('contractFile').addEventListener('change', handleContractSelect);
            document.getElementById('invoiceFiles').addEventListener('change', handleInvoiceSelect);
            
            // Settings
            document.getElementById('aiModel').addEventListener('change', saveSettings);
            document.getElementById('tolerance').addEventListener('change', saveSettings);
            document.getElementById('contractType').addEventListener('change', saveSettings);
            document.getElementById('strictMode').addEventListener('change', saveSettings);
            
            // Process button
            document.getElementById('processBtn').addEventListener('click', startBatchReconciliation);
        }

        function setupNavigation() {
            // Add click handlers to navigation links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const section = e.target.getAttribute('data-section');
                    navigateToSection(section);
                });
            });
        }

        function navigateToSection(sectionName) {
            // Hide all section views
            document.querySelectorAll('.section-view').forEach(view => {
                view.classList.remove('active');
            });
            
            // Hide all page views (legacy)
            document.querySelectorAll('.page-view').forEach(view => {
                view.classList.remove('active');
            });
            
            // Show the selected section
            const targetSection = document.getElementById(sectionName + 'Section');
            if (targetSection) {
                targetSection.classList.add('active');
            }
            
            // Update nav link active states
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            const activeLink = document.querySelector(`[data-section="${sectionName}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }
            
            // Load section-specific data if needed
            switch(sectionName) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'vendors':
                    loadVendorManagement();
                    break;
                case 'contracts':
                    // Future: loadContractManagement();
                    break;
                case 'invoices':
                    // Future: loadInvoiceProcessing();
                    break;
                case 'alerts':
                    // Future: loadAlertSystem();
                    break;
                case 'settings':
                    // Future: loadSettingsPanel();
                    break;
            }
        }

        // VENDOR MANAGEMENT SYSTEM
        let vendorData = [];
        try {
            vendorData = JSON.parse(localStorage.getItem('unspend_vendors') || '[]');
        } catch (e) {
            console.error('Error loading vendor data:', e);
            vendorData = [];
        }
        let vendorSort = { field: 'name', direction: 'asc' };
        let vendorFilters = { search: '', status: 'all', category: 'all' };
        let vendorView = 'table';

        function loadVendorManagement() {
            updateVendorStats();
            applyVendorFilters();
            setupVendorEventListeners();
        }

        function updateVendorStats() {
            const totalVendors = vendorData.length;
            const activeContracts = vendorData.filter(v => v.status === 'active').length;
            const monthlySpend = vendorData.reduce((sum, v) => sum + (v.monthlySpend || 0), 0);
            const avgContractValue = totalVendors > 0 ? vendorData.reduce((sum, v) => sum + (v.contractValue || 0), 0) / totalVendors : 0;

            document.getElementById('totalVendors').textContent = totalVendors;
            document.getElementById('activeContracts').textContent = activeContracts;
            document.getElementById('monthlySpend').textContent = `$${monthlySpend.toLocaleString()}`;
            document.getElementById('avgContractValue').textContent = `$${Math.round(avgContractValue).toLocaleString()}`;
        }

        function applyVendorFilters() {
            let filteredVendors = [...vendorData];

            // Apply search filter
            if (vendorFilters.search) {
                const search = vendorFilters.search.toLowerCase();
                filteredVendors = filteredVendors.filter(vendor =>
                    vendor.name.toLowerCase().includes(search) ||
                    vendor.category.toLowerCase().includes(search) ||
                    vendor.contact?.toLowerCase().includes(search)
                );
            }

            // Apply status filter
            if (vendorFilters.status !== 'all') {
                filteredVendors = filteredVendors.filter(vendor => vendor.status === vendorFilters.status);
            }

            // Apply category filter
            if (vendorFilters.category !== 'all') {
                filteredVendors = filteredVendors.filter(vendor => vendor.category === vendorFilters.category);
            }

            // Apply sorting
            filteredVendors.sort((a, b) => {
                let aVal = a[vendorSort.field];
                let bVal = b[vendorSort.field];
                
                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }
                
                if (vendorSort.direction === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });

            // Render vendors
            if (vendorView === 'table') {
                renderVendorTable(filteredVendors);
            } else {
                renderVendorCards(filteredVendors);
            }
        }

        function renderVendorTable(vendors) {
            const tableBody = document.getElementById('vendorTableBody');
            const tableView = document.getElementById('vendorTableView');
            const cardsView = document.getElementById('vendorCardsView');
            const emptyState = document.getElementById('vendorEmptyState');

            tableView.style.display = 'block';
            cardsView.style.display = 'none';

            if (vendors.length === 0) {
                tableView.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';

            tableBody.innerHTML = vendors.map(vendor => `
                <tr>
                    <td class="vendor-name-cell">${vendor.name}</td>
                    <td>${vendor.category}</td>
                    <td><span class="vendor-status ${vendor.status}">${vendor.status}</span></td>
                    <td>$${(vendor.contractValue || 0).toLocaleString()}</td>
                    <td>${vendor.nextPayment || 'N/A'}</td>
                    <td>${new Date(vendor.lastActivity || vendor.createdAt || Date.now()).toLocaleDateString()}</td>
                    <td>
                        <div class="vendor-actions">
                            <button class="action-btn" onclick="editVendor('${vendor.id}')" title="Edit">✏️</button>
                            <button class="action-btn" onclick="viewVendorDetails('${vendor.id}')" title="View">👁️</button>
                            <button class="action-btn danger" onclick="deleteVendor('${vendor.id}')" title="Delete">🗑️</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function renderVendorCards(vendors) {
            const cardsGrid = document.getElementById('vendorCardsGrid');
            const tableView = document.getElementById('vendorTableView');
            const cardsView = document.getElementById('vendorCardsView');
            const emptyState = document.getElementById('vendorEmptyState');

            tableView.style.display = 'none';
            cardsView.style.display = 'block';

            if (vendors.length === 0) {
                cardsView.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';

            cardsGrid.innerHTML = vendors.map(vendor => `
                <div class="vendor-card">
                    <div class="vendor-card-header">
                        <div>
                            <h3 class="vendor-card-name">${vendor.name}</h3>
                            <div class="vendor-card-category">${vendor.category}</div>
                        </div>
                        <span class="vendor-status ${vendor.status}">${vendor.status}</span>
                    </div>
                    <div class="vendor-card-metrics">
                        <div class="metric">
                            <div class="metric-value">$${(vendor.contractValue || 0).toLocaleString()}</div>
                            <div class="metric-label">Contract Value</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">$${(vendor.monthlySpend || 0).toLocaleString()}</div>
                            <div class="metric-label">Monthly Spend</div>
                        </div>
                    </div>
                    <div class="vendor-actions">
                        <button class="action-btn" onclick="editVendor('${vendor.id}')">Edit</button>
                        <button class="action-btn" onclick="viewVendorDetails('${vendor.id}')">View</button>
                        <button class="action-btn danger" onclick="deleteVendor('${vendor.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function setupVendorEventListeners() {
            // Search input
            document.getElementById('vendorSearch').addEventListener('input', (e) => {
                vendorFilters.search = e.target.value;
                applyVendorFilters();
            });

            // Status filter
            document.getElementById('statusFilter').addEventListener('change', (e) => {
                vendorFilters.status = e.target.value;
                applyVendorFilters();
            });

            // Category filter
            document.getElementById('categoryFilter').addEventListener('change', (e) => {
                vendorFilters.category = e.target.value;
                applyVendorFilters();
            });
        }

        function setVendorView(view) {
            vendorView = view;
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-view="${view}"]`).classList.add('active');
            applyVendorFilters();
        }

        function sortVendors(field) {
            if (vendorSort.field === field) {
                vendorSort.direction = vendorSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                vendorSort.field = field;
                vendorSort.direction = 'asc';
            }
            applyVendorFilters();
        }

        function addSampleVendors() {
            const sampleVendors = [
                {
                    id: 'vendor-1',
                    name: 'Acme Software Solutions',
                    category: 'software',
                    status: 'active',
                    contractValue: 120000,
                    monthlySpend: 10000,
                    nextPayment: '2024-09-15',
                    lastActivity: '2024-08-10',
                    contact: 'john@acmesoftware.com',
                    createdAt: '2024-01-15'
                },
                {
                    id: 'vendor-2',
                    name: 'Professional Consulting Group',
                    category: 'professional',
                    status: 'active',
                    contractValue: 85000,
                    monthlySpend: 7000,
                    nextPayment: '2024-09-20',
                    lastActivity: '2024-08-12',
                    contact: 'sarah@pcgroup.com',
                    createdAt: '2024-02-01'
                },
                {
                    id: 'vendor-3',
                    name: 'Office Depot Business',
                    category: 'office',
                    status: 'active',
                    contractValue: 15000,
                    monthlySpend: 1250,
                    nextPayment: '2024-09-10',
                    lastActivity: '2024-08-08',
                    contact: 'orders@officedepot.com',
                    createdAt: '2024-03-15'
                },
                {
                    id: 'vendor-4',
                    name: 'CloudHost Infrastructure',
                    category: 'software',
                    status: 'inactive',
                    contractValue: 45000,
                    monthlySpend: 0,
                    nextPayment: null,
                    lastActivity: '2024-06-20',
                    contact: 'support@cloudhost.com',
                    createdAt: '2023-12-01'
                }
            ];

            vendorData = sampleVendors;
            localStorage.setItem('unspend_vendors', JSON.stringify(vendorData));
            loadVendorManagement();
        }

        function importVendors() {
            alert('CSV import functionality coming soon! For now, adding sample data...');
            addSampleVendors();
        }

        function exportVendors() {
            const csv = [
                ['Name', 'Category', 'Status', 'Contract Value', 'Monthly Spend', 'Next Payment', 'Contact'],
                ...vendorData.map(v => [v.name, v.category, v.status, v.contractValue, v.monthlySpend, v.nextPayment, v.contact])
            ].map(row => row.join(',')).join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'unspend-vendors.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        function editVendor(vendorId) {
            alert(`Edit vendor functionality coming soon! Vendor ID: ${vendorId}`);
        }

        function deleteVendor(vendorId) {
            if (confirm('Are you sure you want to delete this vendor?')) {
                vendorData = vendorData.filter(v => v.id !== vendorId);
                localStorage.setItem('unspend_vendors', JSON.stringify(vendorData));
                loadVendorManagement();
            }
        }

        function testFunction() {
            try {
                console.log('Test function called!');
                alert('JavaScript is working! Navigation and vendor system should work now.');
            } catch (error) {
                console.error('Error in testFunction:', error);
                alert('JavaScript error: ' + error.message);
            }
        }

        // Simple test that should always work
        window.simpleTest = function() {
            alert('Simple test works!');
        };

        function startTestProcessing() {
            console.log('Starting test processing animation...');
            const processingModal = document.getElementById('processingModal');
            if (!processingModal) {
                alert('Processing modal not found! Check the HTML structure.');
                return;
            }
            processingModal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            animateProcessing();
        }

        // NEW CONTRACT MODAL SYSTEM
        function showNewContractModal() {
            showDocumentUploadModal('contract');
        }

        function showNewInvoiceModal() {
            showDocumentUploadModal('invoice');
        }

        function showDocumentUploadModal(type) {
            console.log('Showing document upload modal for:', type);
            
            const modal = document.getElementById('documentUploadModal');
            const title = document.getElementById('modalTitle');
            const description = document.getElementById('modalDescription');
            
            if (!modal) {
                alert('Upload modal not found! Check the HTML structure.');
                return;
            }
            
            if (title) title.textContent = type === 'contract' ? 'Upload New Contract' : 'Upload New Invoice';
            if (description) description.textContent = type === 'contract' 
                ? 'Upload a contract document for AI analysis and term extraction'
                : 'Upload an invoice for automatic matching and validation';
            
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            console.log('Modal should now be visible');
        }

        function closeDocumentUploadModal() {
            const modal = document.getElementById('documentUploadModal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
            
            // Reset upload state
            resetUploadState();
        }

        function resetUploadState() {
            const uploadArea = document.getElementById('uploadArea');
            const fileName = document.getElementById('fileName');
            const fileSize = document.getElementById('fileSize');
            const processingModal = document.getElementById('processingModal');
            const fileInfo = document.getElementById('fileInfo');
            
            uploadArea.classList.remove('has-file');
            fileName.textContent = '';
            fileSize.textContent = '';
            fileInfo.style.display = 'none';
            processingModal.style.display = 'none';
        }

        function triggerFileUpload() {
            document.getElementById('documentFileInput').click();
        }

        function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;

            // Validate file type
            const allowedTypes = ['.pdf', '.doc', '.docx'];
            const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
            
            if (!allowedTypes.includes(fileExtension)) {
                alert('Please upload a PDF, DOC, or DOCX file.');
                return;
            }

            // Validate file size (10MB limit)
            if (file.size > 10 * 1024 * 1024) {
                alert('File size must be less than 10MB.');
                return;
            }

            // Update UI
            const uploadArea = document.getElementById('uploadArea');
            const fileName = document.getElementById('fileName');
            const fileSize = document.getElementById('fileSize');
            const fileInfo = document.getElementById('fileInfo');

            uploadArea.classList.add('has-file');
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            fileInfo.style.display = 'flex';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function startDocumentProcessing() {
            // Close upload modal
            closeDocumentUploadModal();
            
            // Show processing modal
            const processingModal = document.getElementById('processingModal');
            processingModal.style.display = 'flex';
            document.body.style.overflow = 'hidden';

            // Start the processing animation
            animateProcessing();
        }

        function animateProcessing() {
            const stages = [
                {
                    id: 'stage1',
                    duration: 200,
                    details: [
                        'Scanning document structure...',
                        'Detecting text blocks and layouts...',
                        'Reading embedded metadata...',
                        'Validating document integrity...'
                    ]
                },
                {
                    id: 'stage2',
                    duration: 200,
                    details: [
                        'Extracting vendor information...',
                        'Identifying contract terms...',
                        'Finding payment schedules...',
                        'Parsing financial amounts...',
                        'Collecting contact details...'
                    ]
                },
                {
                    id: 'stage3',
                    duration: 200,
                    details: [
                        'Analyzing contract language...',
                        'Understanding payment terms...',
                        'Evaluating renewal clauses...',
                        'Assessing risk factors...',
                        'Generating compliance insights...'
                    ]
                },
                {
                    id: 'stage4',
                    duration: 200,
                    details: [
                        'Searching existing vendor database...',
                        'Comparing contract terms...',
                        'Checking against invoice history...',
                        'Identifying similar agreements...'
                    ]
                },
                {
                    id: 'stage5',
                    duration: 200,
                    details: [
                        'Detecting pricing anomalies...',
                        'Validating payment amounts...',
                        'Checking for duplicate charges...',
                        'Analyzing spending patterns...',
                        'Flagging potential overpayments...'
                    ]
                },
                {
                    id: 'stage6',
                    duration: 200,
                    details: [
                        'Generating executive summary...',
                        'Creating actionable insights...',
                        'Preparing recommendations...',
                        'Finalizing analysis report...'
                    ]
                }
            ];

            let currentStage = 0;
            let progress = 0;
            let detailIndex = 0;

            function updateStage() {
                if (currentStage >= stages.length) {
                    completeProcessing();
                    return;
                }

                const stage = stages[currentStage];
                const stageElement = document.getElementById(stage.id);
                
                // Mark current stage as active
                stageElement.classList.add('active');
                
                // Update progress
                progress = ((currentStage + 1) / stages.length) * 100;
                document.getElementById('progressFill').style.width = progress + '%';
                document.getElementById('progressText').textContent = Math.round(progress) + '% Complete';

                // Animate details for current stage
                let detailInterval = setInterval(() => {
                    if (detailIndex >= stage.details.length) {
                        clearInterval(detailInterval);
                        
                        // Mark stage as completed
                        stageElement.classList.remove('active');
                        stageElement.classList.add('completed');
                        stageElement.querySelector('.stage-status').textContent = '✅';
                        
                        currentStage++;
                        detailIndex = 0;
                        setTimeout(updateStage, 300);
                        return;
                    }

                    document.getElementById('detailsContent').textContent = stage.details[detailIndex];
                    detailIndex++;
                }, stage.duration / stage.details.length);
            }

            updateStage();
        }

        function completeProcessing() {
            setTimeout(() => {
                const processingModal = document.getElementById('processingModal');
                processingModal.style.display = 'none';
                document.body.style.overflow = 'auto';
                
                // Reset processing state
                resetProcessingState();
                
                // Show success message
                alert('Document processed successfully!\n\n✅ Contract analyzed\n✅ Key terms extracted\n✅ Potential savings identified\n\nResults saved to your dashboard.');
                
                // Navigate to dashboard or results view
                navigateToSection('dashboard');
            }, 1000);
        }

        function resetProcessingState() {
            // Reset all stages
            const stages = document.querySelectorAll('.stage');
            stages.forEach(stage => {
                stage.classList.remove('active', 'completed');
                stage.querySelector('.stage-status').textContent = '⏳';
            });
            
            // Reset progress
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('progressText').textContent = '0% Complete';
            document.getElementById('detailsContent').textContent = 'Initializing AI analysis engine...';
        }

        function setupDragAndDrop() {
            const contractUpload = document.getElementById('contractUpload');
            const invoicesUpload = document.getElementById('invoicesUpload');

            // Contract drag and drop
            contractUpload.addEventListener('dragover', (e) => {
                e.preventDefault();
                contractUpload.classList.add('drag-over');
            });

            contractUpload.addEventListener('dragleave', () => {
                contractUpload.classList.remove('drag-over');
            });

            contractUpload.addEventListener('drop', (e) => {
                e.preventDefault();
                contractUpload.classList.remove('drag-over');
                const files = Array.from(e.dataTransfer.files);
                if (files.length > 0 && files[0].type.match(/(application\/pdf|image\/.*)/)) {
                    contractFile = files[0];
                    displayContractFile();
                }
            });

            contractUpload.addEventListener('click', () => {
                document.getElementById('contractFile').click();
            });

            // Invoices drag and drop
            invoicesUpload.addEventListener('dragover', (e) => {
                e.preventDefault();
                invoicesUpload.classList.add('drag-over');
            });

            invoicesUpload.addEventListener('dragleave', () => {
                invoicesUpload.classList.remove('drag-over');
            });

            invoicesUpload.addEventListener('drop', (e) => {
                e.preventDefault();
                invoicesUpload.classList.remove('drag-over');
                const files = Array.from(e.dataTransfer.files).filter(file => 
                    file.type.match(/(application\/pdf|image\/.*)/)
                );
                invoiceFiles = [...invoiceFiles, ...files];
                displayInvoiceFiles();
            });

            invoicesUpload.addEventListener('click', () => {
                document.getElementById('invoiceFiles').click();
            });
        }

        async function saveAndTestApiKey() {
            const keyInput = document.getElementById('trueInput');
            const newKey = keyInput.value.trim();
            
            if (!newKey) {
                showApiStatus('Please enter your OpenAI API key', 'error');
                return;
            }
            
            if (!newKey.startsWith('sk-')) {
                showApiStatus('API key should start with "sk-"', 'error');
                return;
            }
            
            true = newKey;
            // API key integrated permanently;
            
            showApiStatus('Testing API key...', 'success');
            
            try {
                const response = await fetch('https://api.openai.com/v1/models', {
                    headers: {
                        'Authorization': `Bearer ${true}`
                    }
                });
                
                if (response.ok) {
                    showApiStatus('✅ API key verified and secure', 'success');
                    // Files ready check removed
                } else {
                    showApiStatus('❌ Invalid API key. Please check and try again.', 'error');
                }
            } catch (error) {
                showApiStatus('❌ Could not verify API key. Please check your internet connection.', 'error');
            }
        }

        async function checkApiKey() {
            if (true && true.startsWith('sk-')) {
                try {
                    const response = await fetch('https://api.openai.com/v1/models', {
                        headers: {
                            'Authorization': `Bearer ${true}`
                        }
                    });
                    
                    if (response.ok) {
                        showApiStatus('✅ Secure connection established', 'success');
                        return true;
                    }
                } catch (error) {
                    console.error('API check failed:', error);
                }
            }
            return false;
        }

        function showApiStatus(message, type) {
            const statusDiv = document.getElementById('apiStatus');
            statusDiv.textContent = message;
            statusDiv.className = `api-status ${type}`;
            statusDiv.classList.remove('hidden');
        }

        async function handleContractSelect(event) {
            contractFile = event.target.files[0];
            displayContractFile();
            
            // Auto-create vendor from contract
            if (contractFile) {
                await createVendorFromContract(contractFile);
            }
        }

        async function createVendorFromContract(file) {
            try {
                // Show processing status
                const contractUpload = document.getElementById('contractUpload');
                const originalContent = contractUpload.innerHTML;
                contractUpload.innerHTML = `
                    <div class="upload-icon">⏳</div>
                    <h3>Processing Contract</h3>
                    <p>Analyzing contract and creating vendor profile...</p>
                `;

                // Extract text from contract
                const text = await extractTextFromFile(file);
                
                // Analyze contract to get vendor information
                const contractAnalysis = await analyzeDocument(text, 'contract');
                
                // Extract vendor info from contract analysis
                const vendorInfo = contractAnalysis.vendor_information || {};
                const contractDetails = contractAnalysis.contract_details || {};
                const financialTerms = contractAnalysis.financial_terms || {};
                
                // Create vendor object
                const vendor = {
                    id: Date.now().toString(),
                    name: vendorInfo.legal_name || vendorInfo.vendor_name || 'Unknown Vendor',
                    description: contractAnalysis.services_products?.description || 'Contract-based vendor',
                    email: vendorInfo.contact_email || '',
                    address: vendorInfo.address || '',
                    contractFile: file.name,
                    contractFileData: await fileToBase64(file),
                    contractUploadDate: new Date().toISOString(),
                    contractNumber: contractDetails.contract_number || '',
                    contractType: contractDetails.contract_type || '',
                    effectiveDate: contractDetails.effective_date || '',
                    expirationDate: contractDetails.expiration_date || '',
                    totalValue: financialTerms.total_contract_value || '',
                    paymentTerms: financialTerms.payment_terms || '',
                    billingFrequency: financialTerms.billing_frequency || '',
                    status: 'active',
                    createdAt: new Date().toISOString(),
                    lastUpdated: new Date().toISOString(),
                    contractAnalysis: contractAnalysis // Store full analysis
                };
                
                // Check if vendor already exists
                const existingVendorIndex = vendors.findIndex(v => 
                    v.name.toLowerCase() === vendor.name.toLowerCase() ||
                    (v.contractNumber && vendor.contractNumber && v.contractNumber === vendor.contractNumber)
                );
                
                if (existingVendorIndex >= 0) {
                    // Update existing vendor
                    vendors[existingVendorIndex] = { ...vendors[existingVendorIndex], ...vendor };
                    showVendorCreationSuccess(`Updated existing vendor: ${vendor.name}`, 'update');
                } else {
                    // Add new vendor
                    vendors.push(vendor);
                    showVendorCreationSuccess(`Created new vendor: ${vendor.name}`, 'create');
                }
                
                // Save to localStorage
                localStorage.setItem('vendors', JSON.stringify(vendors));
                
                // Restore contract upload display
                setTimeout(() => {
                    contractUpload.innerHTML = originalContent;
                    displayContractFile();
                }, 2000);
                
                // Update dashboard if on dashboard view
                if (document.getElementById('dashboardView').classList.contains('active')) {
                    loadDashboard();
                }
                
            } catch (error) {
                console.error('Error creating vendor from contract:', error);
                showVendorCreationSuccess('Error processing contract. Please try again.', 'error');
                
                // Restore contract upload display
                setTimeout(() => {
                    displayContractFile();
                }, 2000);
            }
        }

        function showVendorCreationSuccess(message, type) {
            // Create and show success notification
            const notification = document.createElement('div');
            notification.className = `vendor-creation-notification ${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <span class="notification-icon">
                        ${type === 'create' ? '✅' : type === 'update' ? '🔄' : '❌'}
                    </span>
                    <span class="notification-message">${message}</span>
                </div>
            `;
            
            // Add styles for notification
            notification.style.cssText = `
                position: fixed;
                top: 100px;
                right: 20px;
                background: ${type === 'error' ? 'var(--error-bg)' : 'var(--success-bg)'};
                border: 1px solid ${type === 'error' ? 'var(--error)' : 'var(--accent-success)'};
                color: ${type === 'error' ? 'var(--error)' : 'var(--accent-success)'};
                padding: 16px 20px;
                border-radius: var(--border-radius);
                box-shadow: var(--shadow-medium);
                z-index: 2000;
                animation: slideInRight 0.3s ease;
                max-width: 300px;
            `;
            
            document.body.appendChild(notification);
            
            // Remove notification after 4 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 4000);
        }

        function handleInvoiceSelect(event) {
            const newFiles = Array.from(event.target.files);
            invoiceFiles = [...invoiceFiles, ...newFiles];
            displayInvoiceFiles();
        }

        function displayContractFile() {
            const container = document.getElementById('contractFileInfo');
            const uploadBox = document.getElementById('contractUpload');
            
            if (contractFile) {
                container.innerHTML = `
                    <div class="file-item">
                        <span class="file-name"> ${contractFile.name}</span>
                        <button class="remove-btn" onclick="removeContractFile()">✕</button>
                    </div>
                `;
                uploadBox.classList.add('has-files');
            } else {
                container.innerHTML = '';
                uploadBox.classList.remove('has-files');
            }
            // Files ready check removed
        }

        function displayInvoiceFiles() {
            const container = document.getElementById('invoiceFilesList');
            const uploadBox = document.getElementById('invoicesUpload');
            
            if (invoiceFiles.length > 0) {
                container.innerHTML = invoiceFiles.map((file, index) => `
                    <div class="file-item">
                        <span class="file-name"> ${file.name}</span>
                        <button class="remove-btn" onclick="removeInvoiceFile(${index})">✕</button>
                    </div>
                `).join('');
                uploadBox.classList.add('has-files');
            } else {
                container.innerHTML = '';
                uploadBox.classList.remove('has-files');
            }
            // Files ready check removed
        }

        function removeContractFile() {
            contractFile = null;
            document.getElementById('contractFile').value = '';
            displayContractFile();
        }

        function removeInvoiceFile(index) {
            invoiceFiles.splice(index, 1);
            displayInvoiceFiles();
        }

        function checkFilesReady() {
            const processBtn = document.getElementById('processBtn');
            const btnText = document.getElementById('processBtnText');
            
            const ready = contractFile && invoiceFiles.length > 0 && true;
            processBtn.disabled = !ready;
            
            if (ready) {
                btnText.textContent = `Validate Contract + ${invoiceFiles.length} Invoice${invoiceFiles.length > 1 ? 's' : ''}`;
            } else {
                btnText.textContent = 'Analyze Documents';
            }
        }

        async function startBatchReconciliation() {
            if (!contractFile || invoiceFiles.length === 0) {
                alert('Please upload contract and at least one invoice');
                return;
            }

            showProcessingSection();
            
            try {
                // Step 1: Analyze contract with advanced prompting
                updateProcessingStatus('Analyzing contract terms and obligations...');
                const contractText = await extractTextFromFile(contractFile);
                contractAnalysis = await analyzeContractAdvanced(contractText);
                
                // Step 2: Process each invoice
                const invoiceResults = [];
                
                for (let i = 0; i < invoiceFiles.length; i++) {
                    const file = invoiceFiles[i];
                    updateProcessingStatus(`Validating invoice ${i + 1}/${invoiceFiles.length}: ${file.name}`);
                    updateProgressBar(`invoice-${i}`, 0);
                    
                    try {
                        // Extract text
                        updateProgressBar(`invoice-${i}`, 25);
                        const invoiceText = await extractTextFromFile(file);
                        
                        // Analyze with AI
                        updateProgressBar(`invoice-${i}`, 50);
                        const invoiceDetails = await analyzeDocument(invoiceText, 'invoice');
                        
                        // Compare with contract
                        updateProgressBar(`invoice-${i}`, 75);
                        const comparison = compareDocuments(contractAnalysis, invoiceDetails);
                        
                        updateProgressBar(`invoice-${i}`, 100);
                        
                        invoiceResults.push({
                            filename: file.name,
                            file: file,
                            fileData: await fileToBase64(file),
                            invoiceDetails: invoiceDetails,
                            comparison: comparison,
                            status: comparison.summary.reconciliation_status
                        });
                        
                    } catch (error) {
                        console.error(`Error processing ${file.name}:`, error);
                        invoiceResults.push({
                            filename: file.name,
                            file: file,
                            fileData: await fileToBase64(file),
                            error: error.message,
                            status: 'ERROR'
                        });
                    }
                }
                
                // Store results
                currentResults = {
                    timestamp: new Date(),
                    contractFile: contractFile.name,
                    contractAnalysis: contractAnalysis,
                    invoiceResults: invoiceResults,
                    batchSummary: calculateBatchSummary(invoiceResults)
                };
                
                displayResults();
                
            } catch (error) {
                console.error('Batch processing error:', error);
                alert('Error processing documents: ' + error.message);
                resetToUpload();
            }
        }

        function showProcessingSection() {
            document.getElementById('uploadSection').querySelector('.section-content').style.display = 'none';
            document.getElementById('settingsSection').classList.add('collapsed');
            document.getElementById('processingSection').classList.remove('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            
            // Create processing items for each invoice
            const grid = document.getElementById('processingGrid');
            grid.innerHTML = invoiceFiles.map((file, index) => `
                <div class="processing-item">
                    <h4> ${file.name}</h4>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-invoice-${index}" style="width: 0%"></div>
                    </div>
                    <div id="status-invoice-${index}">Waiting...</div>
                </div>
            `).join('');
        }

        function updateProcessingStatus(status) {
            document.getElementById('processingStatus').textContent = status;
        }

        function updateProgressBar(invoiceId, percentage) {
            const progressBar = document.getElementById(`progress-${invoiceId}`);
            const statusDiv = document.getElementById(`status-${invoiceId}`);
            
            if (progressBar) {
                progressBar.style.width = `${percentage}%`;
            }
            
            if (statusDiv) {
                const statusText = percentage === 0 ? 'Initializing...' :
                                percentage === 25 ? 'Extracting document text...' :
                                percentage === 50 ? 'AI validation in progress...' :
                                percentage === 75 ? 'Cross-referencing contract...' :
                                percentage === 100 ? 'Validation complete' : 'Processing...';
                statusDiv.textContent = statusText;
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        async function extractTextFromFile(file) {
            const fileType = file.type;
            
            if (fileType === 'application/pdf') {
                return await extractTextFromPDF(file);
            } else if (fileType.startsWith('image/')) {
                return await extractTextFromImage(file);
            } else {
                throw new Error('Unsupported file type');
            }
        }

        async function extractTextFromPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            let fullText = '';
            
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');
                fullText += `\n--- Page ${i} ---\n${pageText}`;
            }
            
            // If PDF text extraction didn't work well, try OCR
            if (fullText.trim().length < 100) {
                return await extractTextWithOCR(file);
            }
            
            return fullText;
        }

        async function extractTextFromImage(file) {
            return await extractTextWithOCR(file);
        }

        async function extractTextWithOCR(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const result = await Tesseract.recognize(
                            e.target.result,
                            'eng',
                            {
                                logger: m => {
                                    if (m.status === 'recognizing text') {
                                        updateProcessingStatus(`OCR Progress: ${Math.round(m.progress * 100)}%`);
                                    }
                                }
                            }
                        );
                        resolve(result.data.text);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.readAsDataURL(file);
            });
        }

        async function analyzeContractAdvanced(contractText) {
            const contractTypePrompts = {
                general: "This is a general business contract. Focus on identifying vendor information, payment terms, deliverables, and key obligations.",
                service: "This is a service agreement. Pay special attention to service descriptions, performance metrics, payment schedules, and service level agreements.",
                supply: "This is a supply or purchase contract. Focus on product specifications, quantities, unit prices, delivery terms, and total values.",
                consulting: "This is a consulting agreement. Emphasize project scope, hourly rates, milestones, deliverables, and payment terms.",
                maintenance: "This is a maintenance contract. Focus on equipment covered, service schedules, response times, and maintenance fees."
            };

            const contractPrompt = contractTypePrompts[settings.contractType] || contractTypePrompts.general;

            const prompt = `You are an expert contract analyst with years of experience in business law and contract interpretation. 

${contractPrompt}

Please analyze this contract systematically:

STEP 1: First, identify the document structure and key sections
STEP 2: Extract basic information (parties, dates, amounts)  
STEP 3: Identify all financial terms and payment obligations
STEP 4: Note any special conditions or clauses that could affect invoicing
STEP 5: Determine what should appear on valid invoices for this contract

Contract text:
${contractText.substring(0, 4000)}

Return a comprehensive JSON analysis with these fields:
{
  "vendor_name": "exact legal name of the vendor/supplier",
  "client_name": "name of the client/buyer", 
  "contract_number": "contract reference number",
  "contract_date": "contract signing date",
  "start_date": "contract effective start date",
  "end_date": "contract expiration date",
  "total_value": "total contract value",
  "currency": "contract currency",
  "payment_terms": "payment terms and conditions",
  "billing_frequency": "how often billing should occur",
  "line_items": [
    {
      "description": "item/service description",
      "quantity": "quantity if applicable",
      "unit_price": "price per unit",
      "total_price": "total for this line item"
    }
  ],
  "special_conditions": "any special billing or payment conditions",
  "invoice_requirements": "specific requirements for invoices",
  "late_payment_terms": "penalties for late payment",
  "contract_type": "type of contract identified",
  "key_obligations": "main obligations of each party",
  "analysis_confidence": "high/medium/low - how confident you are in this analysis"
}

Be extremely thorough and accurate. If any field cannot be determined, mark it as "not specified" rather than guessing.`;

            return await callOpenAI(prompt, 'You are an expert legal contract analyst. Analyze contracts with extreme precision and attention to detail.');
        }

        async function analyzeDocument(text, docType) {
            let prompt;
            
            if (docType === 'contract') {
                prompt = `You are a contract analysis expert. Analyze this contract and extract the following information in exact JSON format. Be thorough and precise - this data will be used for invoice reconciliation and compliance verification.

REQUIRED JSON STRUCTURE:
{
  "ai_summary": {
    "overview": "3-4 sentence summary combining who this vendor is, what they provide, and the key contract terms including payment structure and duration",
    "financial_highlights": ["3-5 bullet points focusing on financial terms, payment schedules, pricing structure, and renewal conditions"]
  },
  "vendor_information": {
    "legal_name": "Full legal business name",
    "trade_names": ["Any DBA or trade names"],
    "address": "Complete business address",
    "tax_id": "Tax ID or EIN if available",
    "contact_email": "Primary contact email",
    "contact_phone": "Primary phone number"
  },
  "contract_details": {
    "contract_number": "Contract ID or reference number",
    "contract_type": "Service/Product/Subscription/etc",
    "effective_date": "Start date (YYYY-MM-DD format)",
    "expiration_date": "End date (YYYY-MM-DD format)",
    "renewal_terms": "Auto-renewal or manual renewal terms",
    "governing_law": "Jurisdiction/state governing the contract"
  },
  "financial_terms": {
    "total_contract_value": "Total contract amount in dollars",
    "currency": "USD or other currency",
    "payment_terms": "Net 30, Net 60, etc.",
    "billing_frequency": "Monthly/Quarterly/Annual/One-time",
    "payment_schedule": "When payments are due",
    "late_payment_penalty": "Late fee percentage or amount",
    "discount_terms": "Early payment discounts if any",
    "tax_handling": "How taxes are handled"
  },
  "services_products": {
    "description": "Primary services or products provided",
    "scope_of_work": "Detailed scope and deliverables",
    "quantities": "Expected volumes or quantities",
    "unit_rates": "Hourly rates, per-unit costs, etc.",
    "rate_structure": "Fixed fee, hourly, per-unit, etc.",
    "deliverables": ["List of specific deliverables"],
    "performance_metrics": "Success criteria or KPIs",
    "scope_limitations": "What is NOT included"
  },
  "billing_requirements": {
    "invoice_format": "Required invoice format or template",
    "supporting_documentation": "Required attachments or documentation",
    "approval_process": "Who needs to approve invoices",
    "submission_method": "How to submit invoices",
    "submission_deadline": "When invoices must be submitted",
    "purchase_order_required": "Yes/No if PO is required",
    "expense_reimbursement": "Policy for reimbursable expenses",
    "invoice_numbering": "Required numbering format"
  },
  "compliance_legal": {
    "change_order_process": "How to modify the contract",
    "termination_clause": "Termination conditions and notice",
    "dispute_resolution": "How disputes are handled",
    "confidentiality_terms": "NDA or confidentiality requirements",
    "intellectual_property": "IP ownership and usage rights",
    "liability_limitations": "Liability caps or limitations",
    "insurance_requirements": "Required insurance coverage",
    "compliance_requirements": "Regulatory or certification needs"
  },
  "special_conditions": {
    "milestone_payments": "Payment tied to specific milestones",
    "volume_discounts": "Discounts based on volume",
    "seasonal_adjustments": "Seasonal pricing or terms",
    "escalation_clauses": "Price increase mechanisms",
    "warranty_terms": "Warranty or guarantee periods",
    "service_level_agreements": "SLA requirements and penalties",
    "audit_rights": "Right to audit vendor performance/billing",
    "data_security_requirements": "Security and privacy requirements"
  }
}

EXTRACTION INSTRUCTIONS:
1. For the AI summary, focus ONLY on what IS explicitly stated in the contract - never mention what is missing or not specified
2. In the overview, combine vendor identity with contract terms naturally and concisely using only available information
3. For financial highlights, include ONLY the financial terms, payment details, and renewal conditions that are actually present in the contract
4. NEVER use phrases like "The contract does not specify", "not mentioned", "not addressed", or similar negative statements
5. If financial information is not available, simply omit that highlight rather than mentioning its absence
6. Extract ALL available information for other sections - be thorough and comprehensive
7. If information is not available in other sections, use "not specified" for that field
8. For dates, use YYYY-MM-DD format when possible
9. For monetary amounts, include currency and exact amounts
10. Focus on information that would be critical for invoice validation

Return ONLY the JSON object - no additional text or explanation.`;
            } else {
                // Enhanced invoice analysis prompt
                prompt = `You are an invoice analysis expert. Analyze this invoice and extract the following information in exact JSON format for reconciliation against contract terms.

REQUIRED JSON STRUCTURE:
{
  "vendor_information": {
    "vendor_name": "Billing entity name",
    "vendor_address": "Complete billing address",
    "tax_id": "Vendor tax ID if shown",
    "contact_info": "Phone/email if available"
  },
  "invoice_details": {
    "invoice_number": "Invoice reference number",
    "invoice_date": "Invoice date (YYYY-MM-DD)",
    "due_date": "Payment due date (YYYY-MM-DD)",
    "billing_period": "Service period covered",
    "purchase_order": "PO number if referenced",
    "contract_reference": "Contract number if mentioned"
  },
  "financial_breakdown": {
    "subtotal": "Pre-tax amount",
    "tax_amount": "Total tax amount",
    "tax_rate": "Tax percentage applied",
    "total_amount": "Final amount due",
    "currency": "Currency denomination",
    "payment_terms": "Payment terms stated on invoice"
  },
  "line_items": [
    {
      "description": "Service or product description",
      "quantity": "Quantity or hours",
      "unit_price": "Price per unit",
      "line_total": "Total for this line item",
      "period": "Service period if applicable",
      "category": "Type of service/product"
    }
  ],
  "expenses_reimbursements": [
    {
      "description": "Expense description",
      "amount": "Expense amount",
      "category": "Expense type",
      "documentation": "Supporting doc reference"
    }
  ],
  "payment_information": {
    "payment_method": "How to pay",
    "remit_to_address": "Payment address",
    "bank_details": "ACH/wire information if provided",
    "early_payment_discount": "Discount for early payment"
  },
  "compliance_notes": {
    "approvals_shown": "Any approval signatures/stamps",
    "supporting_docs": "Referenced supporting documentation",
    "special_instructions": "Any special payment instructions",
    "audit_trail": "Internal tracking numbers or codes"
  }
}

EXTRACTION INSTRUCTIONS:
1. Be extremely precise with monetary amounts and dates
2. Capture ALL line items with complete details
3. Note any discrepancies or unusual items
4. Include all referenced contract or PO numbers
5. Extract any approval or authorization information
6. If information is not available, use "not specified"
7. Ensure all monetary calculations are accurate

Return ONLY the JSON object - no additional text or explanation.`;
            }
            
            return await callOpenAI(`${prompt}\n\nDocument text:\n${text.substring(0, 4000)}`, 'You are a professional document analysis expert. Extract information with extreme accuracy and return only valid JSON that matches the specified structure exactly.');
        }

        async function callOpenAI(userPrompt, systemPrompt) {
            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${true}`
                    },
                    body: JSON.stringify({
                        model: settings.aiModel,
                        messages: [
                            {
                                role: "system",
                                content: systemPrompt
                            },
                            {
                                role: "user", 
                                content: userPrompt
                            }
                        ],
                        temperature: 0.1,
                        max_tokens: 2000
                    })
                });
                
                if (!response.ok) {
                    throw new Error('OpenAI API request failed');
                }
                
                const data = await response.json();
                
                // Track token usage and cost
                if (data.usage) {
                    const inputTokens = data.usage.prompt_tokens || 0;
                    const outputTokens = data.usage.completion_tokens || 0;
                    
                    // Estimate cost based on GPT-4 pricing
                    const inputCost = (inputTokens / 1000) * 0.03;  // $0.03 per 1K input tokens
                    const outputCost = (outputTokens / 1000) * 0.06; // $0.06 per 1K output tokens
                    const totalCost = inputCost + outputCost;
                    
                    trackTokenUsage(totalCost);
                }
                
                const content = data.choices[0].message.content;
                
                // Try to parse JSON from the response
                try {
                    return JSON.parse(content);
                } catch (e) {
                    // If parsing fails, try to extract JSON from the response
                    const jsonMatch = content.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        return JSON.parse(jsonMatch[0]);
                    }
                    throw new Error('Could not parse AI response');
                }
            } catch (error) {
                console.error('AI analysis error:', error);
                throw error;
            }
        }

        async function compareDocuments(contractDetails, invoiceDetails) {
            // Use AI to perform intelligent reconciliation that understands business context
            const reconciliationPrompt = `You are an expert contract and invoice reconciliation analyst with deep business understanding.

ANALYZE AND RECONCILE these contract terms against this invoice, understanding business context and variations:

CONTRACT ANALYSIS:
${JSON.stringify(contractDetails, null, 2)}

INVOICE ANALYSIS:
${JSON.stringify(invoiceDetails, null, 2)}

INTELLIGENT RECONCILIATION INSTRUCTIONS:
1. UNDERSTAND BUSINESS CONTEXT: Company names may vary (legal name vs DBA vs shortened versions) - assess if they represent the same entity
2. THINK CONTEXTUALLY: Consider normal business practices and reasonable variations
3. IDENTIFY MATERIAL DISCREPANCIES: Focus on issues that could indicate billing errors, overcharges, or contract violations
4. PROVIDE BUSINESS INSIGHTS: Explain what discrepancies mean in practical terms
5. ASSESS VENDOR IDENTITY: Determine if the invoicing entity matches the contracted entity
6. EVALUATE FINANCIAL TERMS: Check if pricing, payment terms, and amounts align with contract
7. CONSIDER TIMING: Assess if invoice dates and service periods make business sense

Return analysis in this EXACT JSON format:
{
  "vendor_identity_analysis": {
    "same_entity": true/false,
    "confidence": "high/medium/low", 
    "explanation": "Detailed reasoning for your assessment of vendor identity"
  },
  "discrepancies": [
    {
      "field": "Field name",
      "severity": "critical/high/medium/low",
      "contract_value": "What the contract specifies",
      "invoice_value": "What the invoice shows", 
      "description": "Clear business-focused explanation of the discrepancy",
      "potential_impact": "Financial or operational impact of this discrepancy",
      "recommendation": "Specific action to resolve this discrepancy"
    }
  ],
  "insights": [
    {
      "category": "pricing/terms/compliance/billing_accuracy/other",
      "observation": "Business insight about this reconciliation",
      "business_impact": "What this means for the ongoing vendor relationship"
    }
  ],
  "summary": {
    "total_discrepancies": 0,
    "critical_issues": 0,
    "reconciliation_status": "PASSED/FAILED/REVIEW_REQUIRED",
    "overall_assessment": "Executive summary of findings and recommended next steps"
  }
}

Focus on material business issues, not cosmetic differences. Think like a finance professional reviewing vendor compliance.`;

            try {
                const aiResult = await callOpenAI(reconciliationPrompt, 'You are an expert business analyst specializing in contract and invoice reconciliation. Provide comprehensive, business-focused analysis that understands context and variations.');
                
                // Add description field for backward compatibility 
                if (aiResult.discrepancies) {
                    aiResult.discrepancies.forEach(disc => {
                        if (!disc.description && disc.potential_impact) {
                            disc.description = `${disc.potential_impact}. ${disc.recommendation}`;
                        }
                    });
                }
                
                // Ensure the result has the expected structure
                return {
                    discrepancies: aiResult.discrepancies || [],
                    insights: aiResult.insights || [],
                    vendor_identity_analysis: aiResult.vendor_identity_analysis || {},
                    warnings: [], // Keep for backward compatibility
                    matches: [], // Keep for backward compatibility  
                    summary: {
                        total_discrepancies: aiResult.discrepancies?.length || 0,
                        total_warnings: 0,
                        total_matches: 0,
                        critical_issues: aiResult.discrepancies?.filter(d => d.severity === 'critical' || d.severity === 'high').length || 0,
                        reconciliation_status: aiResult.summary?.reconciliation_status || (aiResult.discrepancies?.length > 0 ? "FAILED" : "PASSED"),
                        overall_assessment: aiResult.summary?.overall_assessment || "Reconciliation completed"
                    }
                };
            } catch (error) {
                console.error('AI reconciliation failed, falling back to basic comparison:', error);
                
                // Fallback to basic comparison if AI fails
                const discrepancies = [];
                const warnings = [];
                const matches = [];
                
                // Basic vendor name check with smart matching
                const contractVendor = contractDetails.vendor_information?.legal_name || contractDetails.vendor_name;
                const invoiceVendor = invoiceDetails.vendor_information?.vendor_name || invoiceDetails.vendor_name;
                
                if (contractVendor && invoiceVendor) {
                    const contractName = contractVendor.toLowerCase().trim();
                    const invoiceName = invoiceVendor.toLowerCase().trim();
                    
                    // Smart name matching - check if they share common words
                    const contractWords = contractName.split(/\s+/);
                    const invoiceWords = invoiceName.split(/\s+/);
                    const sharedWords = contractWords.filter(word => 
                        word.length > 2 && invoiceWords.some(iw => iw.includes(word) || word.includes(iw))
                    );
                    
                    if (sharedWords.length === 0) {
                        discrepancies.push({
                            field: "Vendor Identity",
                            severity: "high", 
                            contract_value: contractVendor,
                            invoice_value: invoiceVendor,
                            description: `Vendor name variation detected - please verify this is the same entity. Contract: "${contractVendor}", Invoice: "${invoiceVendor}"`,
                            recommendation: "Verify vendor identity and update records if needed"
                        });
                    } else {
                        matches.push("Vendor Identity (Similar Names)");
                    }
                }
                
                // Basic amount comparison
                const contractTotal = parseAmount(contractDetails.financial_terms?.total_contract_value || contractDetails.total_amount);
                const invoiceTotal = parseAmount(invoiceDetails.billing_details?.total_amount || invoiceDetails.total_amount);
                
                if (contractTotal && invoiceTotal) {
                    const difference = Math.abs(contractTotal - invoiceTotal);
                    const percentDiff = (difference / contractTotal) * 100;
                    
                    if (percentDiff > 5) { // More than 5% difference
                        discrepancies.push({
                            field: "Total Amount",
                            severity: percentDiff > 20 ? "critical" : "high",
                            contract_value: `$${contractTotal.toFixed(2)}`,
                            invoice_value: `$${invoiceTotal.toFixed(2)}`,
                            description: `Significant amount difference detected: ${percentDiff.toFixed(1)}% variance ($${difference.toFixed(2)} difference)`,
                            recommendation: "Review pricing terms and verify invoice accuracy"
                        });
                    } else {
                        matches.push("Total Amount");
                    }
                }
                
                return {
                    discrepancies: discrepancies,
                    insights: [{
                        category: "system",
                        observation: "AI analysis was unavailable - basic comparison performed",
                        business_impact: "Recommend running full AI analysis when system is available"
                    }],
                    vendor_identity_analysis: { 
                        same_entity: discrepancies.length === 0, 
                        confidence: "low", 
                        explanation: "AI analysis unavailable - basic comparison only" 
                    },
                    warnings: warnings,
                    matches: matches,
                    summary: {
                        total_discrepancies: discrepancies.length,
                        total_warnings: warnings.length,
                        total_matches: matches.length, 
                        critical_issues: discrepancies.filter(d => d.severity === 'critical' || d.severity === 'high').length,
                        reconciliation_status: discrepancies.length === 0 ? "PASSED" : "REVIEW_REQUIRED",
                        overall_assessment: "Basic reconciliation completed - full AI analysis recommended"
                    }
                };
            }
        }

        function parseAmount(amountStr) {
            if (!amountStr) return 0;
            const cleaned = String(amountStr).replace(/[$,]/g, '');
            return parseFloat(cleaned) || 0;
        }

        function calculateBatchSummary(invoiceResults) {
            const total = invoiceResults.length;
            const passed = invoiceResults.filter(r => r.status === 'PASSED').length;
            const failed = invoiceResults.filter(r => r.status === 'FAILED').length;
            const errors = invoiceResults.filter(r => r.status === 'ERROR').length;
            
            const totalDiscrepancies = invoiceResults.reduce((sum, r) => 
                sum + (r.comparison?.summary?.total_discrepancies || 0), 0);
            const totalWarnings = invoiceResults.reduce((sum, r) => 
                sum + (r.comparison?.summary?.total_warnings || 0), 0);
            
            return {
                total,
                passed,
                failed,
                errors,
                totalDiscrepancies,
                totalWarnings,
                passRate: ((passed / total) * 100).toFixed(1)
            };
        }

        function displayResults() {
            document.getElementById('processingSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.remove('hidden');
            
            // Display batch summary
            displayBatchSummary(currentResults.batchSummary);
            
            // Display contract analysis
            displayContractAnalysis(currentResults.contractAnalysis);
            
            // Display individual invoice results
            displayInvoiceResults(currentResults.invoiceResults);
        }

        function displayBatchSummary(summary) {
            const container = document.getElementById('batchSummaryStats');
            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${summary.total}</div>
                    <div class="stat-label">Total Invoices</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value passed">${summary.passed}</div>
                    <div class="stat-label">Passed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value failed">${summary.failed}</div>
                    <div class="stat-label">Failed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value warning">${summary.totalDiscrepancies}</div>
                    <div class="stat-label">Total Discrepancies</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${summary.passRate}%</div>
                    <div class="stat-label">Pass Rate</div>
                </div>
            `;
        }

        function displayContractAnalysis(contract) {
            const container = document.getElementById('contractDetailsContent');
            const details = Object.entries(contract || {})
                .filter(([key]) => !['line_items', 'key_obligations'].includes(key))
                .map(([key, value]) => `
                    <div class="detail-item">
                        <div class="detail-label">${key.replace(/_/g, ' ')}</div>
                        <div class="detail-value">${value || 'N/A'}</div>
                    </div>
                `).join('');
            
            container.innerHTML = `<div class="detail-grid">${details}</div>`;
        }

        function displayInvoiceResults(invoiceResults) {
            const container = document.getElementById('invoiceResults');
            container.innerHTML = invoiceResults.map((result, index) => {
                if (result.error) {
                    return `
                        <div class="invoice-result-card">
                            <div class="invoice-result-header">
                                <h3>❌ ${result.filename}</h3>
                                <span class="status-badge failed">ERROR</span>
                            </div>
                            <p style="color: var(--error);">Error: ${result.error}</p>
                        </div>
                    `;
                }

                const comparison = result.comparison;
                const invoice = result.invoiceDetails;
                
                return `
                    <div class="invoice-result-card">
                        <div class="invoice-result-header">
                            <h3>${getStatusIcon(result.status)} ${result.filename}</h3>
                            <span class="status-badge ${result.status.toLowerCase()}">${result.status}</span>
                        </div>
                        
                        ${comparison.discrepancies.length > 0 ? `
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: var(--error); margin-bottom: 10px;">🚨 Discrepancies Found</h4>
                                ${comparison.discrepancies.map(disc => `
                                    <div class="discrepancy-item">
                                        <strong>${disc.field}</strong><br>
                                        Contract: ${disc.contract_value}<br>
                                        Invoice: ${disc.invoice_value}
                                        ${disc.difference ? `<br>Difference: ${disc.difference}` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        ${comparison.warnings.length > 0 ? `
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: var(--warning); margin-bottom: 10px;">! Warnings</h4>
                                ${comparison.warnings.map(warning => `
                                    <div class="warning-item">
                                        <strong>${warning.field}</strong><br>
                                        ${warning.message}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        ${comparison.matches.length > 0 ? `
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: var(--accent-success); margin-bottom: 10px;">✅ Matches</h4>
                                ${comparison.matches.map(match => `<span class="match-badge">${match}</span>`).join('')}
                            </div>
                        ` : ''}
                        
                        <details style="margin-top: 20px;">
                            <summary style="cursor: pointer; font-weight: bold;"> Invoice Details</summary>
                            <div class="detail-grid" style="margin-top: 15px;">
                                ${Object.entries(invoice || {})
                                    .filter(([key]) => key !== 'items')
                                    .map(([key, value]) => `
                                        <div class="detail-item">
                                            <div class="detail-label">${key.replace(/_/g, ' ')}</div>
                                            <div class="detail-value">${value || 'N/A'}</div>
                                        </div>
                                    `).join('')}
                            </div>
                        </details>
                    </div>
                `;
            }).join('');
        }

        function getStatusIcon(status) {
            switch(status) {
                case 'PASSED': return '✅';
                case 'FAILED': return '❌';
                case 'ERROR': return '💥';
                default: return '❓';
            }
        }

        // Utility functions
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            section.classList.toggle('collapsed');
        }

        function resetAll() {
            contractFile = null;
            invoiceFiles = [];
            currentResults = null;
            
            document.getElementById('contractFile').value = '';
            document.getElementById('invoiceFiles').value = '';
            
            displayContractFile();
            displayInvoiceFiles();
            
            document.getElementById('uploadSection').querySelector('.section-content').style.display = 'block';
            document.getElementById('settingsSection').classList.remove('collapsed');
            document.getElementById('processingSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
        }

        function resetToUpload() {
            document.getElementById('uploadSection').querySelector('.section-content').style.display = 'block';
            document.getElementById('processingSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
        }

        function addMoreInvoices() {
            document.getElementById('invoiceFiles').click();
        }

        function toggleHistory() {
            const panel = document.getElementById('historyPanel');
            panel.classList.toggle('open');
            if (panel.classList.contains('open')) {
                loadHistory();
            }
        }

        function saveToHistory() {
            if (!currentResults) return;
            
            const history = JSON.parse(localStorage.getItem('reconciliation_history') || '[]');
            const newEntry = {
                id: Date.now(),
                timestamp: currentResults.timestamp,
                contractFile: currentResults.contractFile,
                invoiceCount: currentResults.invoiceResults.length,
                passRate: currentResults.batchSummary.passRate,
                results: currentResults
            };
            
            history.unshift(newEntry);
            // Keep only last 50 entries
            history.splice(50);
            
            localStorage.setItem('reconciliation_history', JSON.stringify(history));
            loadHistory();
            alert('Results saved to history!');
        }

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('reconciliation_history') || '[]');
            const container = document.getElementById('historyContent');
            
            if (history.length === 0) {
                container.innerHTML = '<p style="color: var(--neutral-dark); text-align: center;">No reconciliation history yet.</p>';
                return;
            }
            
            container.innerHTML = history.map(entry => `
                <div class="history-item" onclick="loadHistoryItem(${entry.id})">
                    <div style="font-weight: bold;">${entry.contractFile}</div>
                    <div style="font-size: 0.9rem; color: var(--neutral-dark);">
                        ${entry.invoiceCount} invoices • ${entry.passRate}% pass rate
                    </div>
                    <div style="font-size: 0.8rem; color: var(--neutral-dark);">
                        ${new Date(entry.timestamp).toLocaleString()}
                    </div>
                </div>
            `).join('');
        }

        function loadHistoryItem(id) {
            const history = JSON.parse(localStorage.getItem('reconciliation_history') || '[]');
            const entry = history.find(h => h.id === id);
            
            if (entry) {
                currentResults = entry.results;
                displayResults();
                toggleHistory();
            }
        }

        // Export functions
        function exportToPDF() {
            if (!currentResults) return;
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Title
            doc.setFontSize(20);
            doc.text('Invoice Reconciliation Report', 20, 20);
            
            // Batch summary
            doc.setFontSize(14);
            doc.text('Batch Summary', 20, 40);
            doc.setFontSize(10);
            doc.text(`Total Invoices: ${currentResults.batchSummary.total}`, 20, 50);
            doc.text(`Passed: ${currentResults.batchSummary.passed}`, 20, 60);
            doc.text(`Failed: ${currentResults.batchSummary.failed}`, 20, 70);
            doc.text(`Pass Rate: ${currentResults.batchSummary.passRate}%`, 20, 80);
            
            // Individual results
            let yPos = 100;
            currentResults.invoiceResults.forEach((result, index) => {
                if (yPos > 250) {
                    doc.addPage();
                    yPos = 20;
                }
                
                doc.setFontSize(12);
                doc.text(`${index + 1}. ${result.filename}`, 20, yPos);
                doc.setFontSize(10);
                doc.text(`Status: ${result.status}`, 20, yPos + 10);
                
                if (result.comparison) {
                    doc.text(`Discrepancies: ${result.comparison.summary.total_discrepancies}`, 20, yPos + 20);
                    doc.text(`Warnings: ${result.comparison.summary.total_warnings}`, 20, yPos + 30);
                }
                
                yPos += 45;
            });
            
            doc.save(`reconciliation-report-${new Date().toISOString().split('T')[0]}.pdf`);
        }

        function exportToExcel() {
            if (!currentResults) return;
            
            const wb = XLSX.utils.book_new();
            
            // Summary sheet
            const summaryData = [
                ['Metric', 'Value'],
                ['Total Invoices', currentResults.batchSummary.total],
                ['Passed', currentResults.batchSummary.passed],
                ['Failed', currentResults.batchSummary.failed],
                ['Pass Rate', currentResults.batchSummary.passRate + '%'],
                ['Total Discrepancies', currentResults.batchSummary.totalDiscrepancies],
                ['Total Warnings', currentResults.batchSummary.totalWarnings]
            ];
            
            const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, summaryWs, 'Summary');
            
            // Results sheet
            const resultsData = [
                ['Filename', 'Status', 'Discrepancies', 'Warnings', 'Matches']
            ];
            
            currentResults.invoiceResults.forEach(result => {
                resultsData.push([
                    result.filename,
                    result.status,
                    result.comparison?.summary?.total_discrepancies || 0,
                    result.comparison?.summary?.total_warnings || 0,
                    result.comparison?.summary?.total_matches || 0
                ]);
            });
            
            const resultsWs = XLSX.utils.aoa_to_sheet(resultsData);
            XLSX.utils.book_append_sheet(wb, resultsWs, 'Results');
            
            XLSX.writeFile(wb, `reconciliation-results-${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        // ===================================
        // UI/UX INTERACTION ENHANCEMENT SYSTEM
        // ===================================

        // Enhanced Button Functionality
        function initializeButtons() {
            // Add loading states for async operations
            document.querySelectorAll('button[data-loading-text]').forEach(button => {
                button.addEventListener('click', function() {
                    if (!this.disabled) {
                        this.classList.add('loading');
                        this.setAttribute('aria-busy', 'true');
                    }
                });
            });

            // Add tooltip functionality for disabled buttons
            document.querySelectorAll('button[disabled][data-tooltip]').forEach(button => {
                button.addEventListener('mouseenter', function() {
                    showTooltip(this, this.dataset.tooltip);
                });
                button.addEventListener('mouseleave', hideTooltip);
            });
        }

        // Enhanced Dropdown Functionality
        function initializeDropdowns() {
            document.querySelectorAll('select').forEach(select => {
                // Convert regular selects to enhanced dropdowns
                convertToEnhancedDropdown(select);
            });
        }

        function convertToEnhancedDropdown(select) {
            const wrapper = document.createElement('div');
            wrapper.className = 'dropdown';
            select.parentNode.insertBefore(wrapper, select);

            const toggle = document.createElement('button');
            toggle.className = 'dropdown-toggle';
            toggle.type = 'button';
            toggle.innerHTML = `
                <span class="dropdown-text">${select.options[select.selectedIndex]?.text || 'Select option'}</span>
                <span class="dropdown-arrow">▼</span>
            `;

            const menu = document.createElement('div');
            menu.className = 'dropdown-menu';
            
            // Add search for long lists
            if (select.options.length > 8) {
                const search = document.createElement('input');
                search.className = 'dropdown-search';
                search.placeholder = 'Search options...';
                search.addEventListener('input', (e) => filterDropdownItems(menu, e.target.value));
                menu.appendChild(search);
            }

            // Create dropdown items
            Array.from(select.options).forEach((option, index) => {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                if (option.selected) item.classList.add('selected');
                item.textContent = option.text;
                item.dataset.value = option.value;
                item.dataset.index = index;
                
                item.addEventListener('click', () => {
                    selectDropdownItem(select, toggle, menu, item, index);
                });
                
                menu.appendChild(item);
            });

            wrapper.appendChild(toggle);
            wrapper.appendChild(menu);
            select.style.display = 'none';

            // Add event listeners
            toggle.addEventListener('click', () => toggleDropdown(toggle, menu));
            toggle.addEventListener('keydown', (e) => handleDropdownKeyboard(e, menu));
            
            // Close on outside click
            document.addEventListener('click', (e) => {
                if (!wrapper.contains(e.target)) {
                    closeDropdown(toggle, menu);
                }
            });

            // Auto-detect direction
            toggle.addEventListener('click', () => {
                const rect = toggle.getBoundingClientRect();
                const spaceBelow = window.innerHeight - rect.bottom;
                const spaceAbove = rect.top;
                
                if (spaceBelow < 200 && spaceAbove > spaceBelow) {
                    menu.classList.add('open-upward');
                } else {
                    menu.classList.remove('open-upward');
                }
            });
        }

        function toggleDropdown(toggle, menu) {
            const isOpen = menu.classList.contains('open');
            
            // Close all other dropdowns
            document.querySelectorAll('.dropdown-menu.open').forEach(m => {
                if (m !== menu) closeDropdown(m.previousElementSibling, m);
            });

            if (isOpen) {
                closeDropdown(toggle, menu);
            } else {
                openDropdown(toggle, menu);
            }
        }

        function openDropdown(toggle, menu) {
            toggle.classList.add('open');
            menu.classList.add('open');
            toggle.setAttribute('aria-expanded', 'true');
            
            // Focus first item or search
            const search = menu.querySelector('.dropdown-search');
            const firstItem = menu.querySelector('.dropdown-item');
            
            setTimeout(() => {
                if (search) {
                    search.focus();
                } else if (firstItem) {
                    firstItem.classList.add('focused');
                }
            }, 150);
        }

        function closeDropdown(toggle, menu) {
            toggle.classList.remove('open');
            menu.classList.remove('open');
            toggle.setAttribute('aria-expanded', 'false');
            
            // Clear focused states
            menu.querySelectorAll('.dropdown-item.focused').forEach(item => {
                item.classList.remove('focused');
            });
        }

        function selectDropdownItem(select, toggle, menu, item, index) {
            // Update original select
            select.selectedIndex = index;
            select.dispatchEvent(new Event('change'));
            
            // Update dropdown appearance
            toggle.querySelector('.dropdown-text').textContent = item.textContent;
            menu.querySelectorAll('.dropdown-item').forEach(i => i.classList.remove('selected'));
            item.classList.add('selected');
            
            closeDropdown(toggle, menu);
        }

        function handleDropdownKeyboard(e, menu) {
            const items = menu.querySelectorAll('.dropdown-item');
            const focused = menu.querySelector('.dropdown-item.focused');
            let focusedIndex = focused ? Array.from(items).indexOf(focused) : -1;

            switch (e.key) {
                case 'Enter':
                case ' ':
                    e.preventDefault();
                    if (focused) {
                        focused.click();
                    }
                    break;
                
                case 'ArrowDown':
                    e.preventDefault();
                    focusedIndex = Math.min(focusedIndex + 1, items.length - 1);
                    updateFocusedItem(items, focusedIndex);
                    break;
                
                case 'ArrowUp':
                    e.preventDefault();
                    focusedIndex = Math.max(focusedIndex - 1, 0);
                    updateFocusedItem(items, focusedIndex);
                    break;
                
                case 'Escape':
                    closeDropdown(e.target, menu);
                    break;
            }
        }

        function updateFocusedItem(items, index) {
            items.forEach(item => item.classList.remove('focused'));
            if (items[index]) {
                items[index].classList.add('focused');
                items[index].scrollIntoView({ block: 'nearest' });
            }
        }

        function filterDropdownItems(menu, searchTerm) {
            const items = menu.querySelectorAll('.dropdown-item');
            const term = searchTerm.toLowerCase();
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(term) ? 'flex' : 'none';
            });
        }

        // Enhanced Form Functionality
        function initializeForms() {
            // Auto-focus first input
            document.querySelectorAll('form').forEach(form => {
                const firstInput = form.querySelector('input, textarea, select');
                if (firstInput && !firstInput.disabled) {
                    setTimeout(() => firstInput.focus(), 100);
                }
            });

            // Real-time validation
            document.querySelectorAll('input, textarea').forEach(input => {
                input.addEventListener('input', () => validateField(input));
                input.addEventListener('blur', () => validateField(input));
            });

            // Enhanced keyboard navigation
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && e.target.form) {
                    const form = e.target.form;
                    const submitButton = form.querySelector('button[type="submit"], button:not([type])');
                    
                    if (submitButton && !submitButton.disabled && isFormValid(form)) {
                        e.preventDefault();
                        submitButton.click();
                    }
                }
            });
        }

        function validateField(field) {
            const value = field.value.trim();
            const required = field.hasAttribute('required');
            const type = field.type;
            let isValid = true;
            let message = '';

            // Clear previous states
            field.classList.remove('error', 'success');
            
            // Required validation
            if (required && !value) {
                isValid = false;
                message = 'This field is required';
            }
            
            // Type-specific validation
            else if (value) {
                switch (type) {
                    case 'email':
                        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                        if (!emailRegex.test(value)) {
                            isValid = false;
                            message = 'Please enter a valid email address';
                        }
                        break;
                        
                    case 'number':
                        if (isNaN(value)) {
                            isValid = false;
                            message = 'Please enter a valid number';
                        }
                        break;
                }
            }

            // Update field state
            field.classList.add(isValid ? 'success' : 'error');
            updateFieldFeedback(field, message, isValid ? 'success' : 'error');
            
            return isValid;
        }

        function updateFieldFeedback(field, message, type) {
            let feedback = field.parentNode.querySelector('.form-feedback');
            
            if (!feedback) {
                feedback = document.createElement('div');
                feedback.className = 'form-feedback';
                field.parentNode.appendChild(feedback);
            }
            
            feedback.className = `form-feedback ${type}`;
            feedback.innerHTML = message ? `<span>${getStatusIcon(type)}</span> ${message}` : '';
        }

        function getStatusIcon(type) {
            const icons = {
                error: '❌',
                success: '✅',
                warning: '!'
            };
            return icons[type] || '';
        }

        function isFormValid(form) {
            const inputs = form.querySelectorAll('input[required], textarea[required], select[required]');
            return Array.from(inputs).every(input => input.value.trim() !== '');
        }

        // Enhanced Feedback System
        function showAlert(message, type = 'info', duration = 5000) {
            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            alert.innerHTML = `
                <span class="alert-icon">${getAlertIcon(type)}</span>
                <div class="alert-content">
                    <div class="alert-title">${getAlertTitle(type)}</div>
                    <div>${message}</div>
                </div>
                <button class="alert-dismiss" onclick="this.parentElement.remove()">×</button>
            `;
            
            document.body.appendChild(alert);
            
            if (duration > 0) {
                setTimeout(() => {
                    if (alert.parentNode) {
                        alert.remove();
                    }
                }, duration);
            }
            
            return alert;
        }

        function showToast(message, type = 'info', duration = 3000) {
            const toast = document.createElement('div');
            toast.className = `toast alert ${type}`;
            toast.innerHTML = `
                <span class="alert-icon">${getAlertIcon(type)}</span>
                <div class="alert-content">${message}</div>
                <button class="alert-dismiss" onclick="this.parentElement.remove()">×</button>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, duration);
        }

        function getAlertIcon(type) {
            const icons = {
                success: '✅',
                error: '❌',
                warning: '!',
                info: 'i'
            };
            return icons[type] || 'i';
        }

        function getAlertTitle(type) {
            const titles = {
                success: 'Success',
                error: 'Error',
                warning: 'Warning',
                info: 'Information'
            };
            return titles[type] || 'Notice';
        }

        // Initialize all enhanced UI/UX systems
        document.addEventListener('DOMContentLoaded', function() {
            initializeButtons();
            initializeDropdowns();
            initializeForms();
            
            // Add global keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                // ESC to close modals/dropdowns/sidebar
                if (e.key === 'Escape') {
                    // First check if sidebar is open
                    const sidebar = document.getElementById('sidebar');
                    if (sidebar && sidebar.classList.contains('open')) {
                        closeSidebar();
                        return;
                    }
                    
                    // Then close modals and dropdowns
                    document.querySelectorAll('.modal-backdrop.open').forEach(modal => {
                        modal.classList.remove('open');
                    });
                    document.querySelectorAll('.dropdown-menu.open').forEach(menu => {
                        const toggle = menu.previousElementSibling;
                        closeDropdown(toggle, menu);
                    });
                }
            });
        });

        // Update existing functions to use new feedback system
        function showApiStatus(message, type) {
            const statusDiv = document.getElementById('apiStatus');
            statusDiv.textContent = message;
            statusDiv.className = `api-status ${type}`;
            statusDiv.classList.remove('hidden');
            
            // Also show as toast for better UX
            if (type === 'success') {
                showToast(message, 'success');
            } else if (type === 'error') {
                showToast(message, 'error');
            }
        }

        // Tooltip system for disabled buttons
        let currentTooltip = null;

        function showTooltip(element, text) {
            hideTooltip();
            
            const tooltip = document.createElement('div');
            tooltip.className = 'tooltip-popup';
            tooltip.style.cssText = `
                position: absolute;
                background: var(--neutral-dark);
                color: var(--white);
                padding: 8px 12px;
                border-radius: var(--border-radius);
                font-size: 12px;
                white-space: nowrap;
                z-index: 10000;
                pointer-events: none;
                opacity: 0;
                transition: opacity var(--animation-fast) ease;
            `;
            tooltip.textContent = text;
            
            document.body.appendChild(tooltip);
            
            const rect = element.getBoundingClientRect();
            tooltip.style.left = `${rect.left + rect.width / 2 - tooltip.offsetWidth / 2}px`;
            tooltip.style.top = `${rect.top - tooltip.offsetHeight - 8}px`;
            
            setTimeout(() => tooltip.style.opacity = '1', 10);
            currentTooltip = tooltip;
        }

        function hideTooltip() {
            if (currentTooltip) {
                currentTooltip.remove();
                currentTooltip = null;
            }
        }

        // Enhanced history panel with keyboard navigation
        function toggleHistory() {
            const panel = document.getElementById('historyPanel');
            const isOpen = panel.classList.contains('open');
            
            if (isOpen) {
                panel.classList.remove('open');
                document.body.style.overflow = '';
            } else {
                panel.classList.add('open');
                document.body.style.overflow = 'hidden'; // Prevent background scroll
                loadHistory();
                
                // Focus first history item for keyboard navigation
                setTimeout(() => {
                    const firstItem = panel.querySelector('.history-item');
                    if (firstItem) firstItem.focus();
                }, 300);
            }
        }

        // Enhanced processing with better loading states
        function updateProcessingStatus(status) {
            document.getElementById('processingStatus').textContent = status;
            
            // Also update page title to show progress
            if (status.includes('Processing') || status.includes('Analyzing')) {
                document.title = `⏳ ${status} - Invoice Reconciliation Platform`;
            }
        }

        // Reset page title when done
        function displayResults() {
            document.title = 'Invoice Reconciliation Platform Pro - Precision Contract Validation';
            
            document.getElementById('processingSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.remove('hidden');
            
            // Display batch summary
            displayBatchSummary(currentResults.batchSummary);
            
            // Display contract analysis
            displayContractAnalysis(currentResults.contractAnalysis);
            
            // Display individual invoice results
            displayInvoiceResults(currentResults.invoiceResults);
            
            // Show success toast
            showToast(`✅ Reconciliation complete! Processed ${currentResults.invoiceResults.length} invoices`, 'success');
        }

        // Enhanced error handling
        window.addEventListener('error', function(e) {
            console.error('Application error:', e.error);
            showAlert('An unexpected error occurred. Please refresh the page and try again.', 'error');
        });

        // Enhanced keyboard navigation for tables/lists
        function initializeTableNavigation() {
            document.querySelectorAll('.data-table tbody tr, .data-list-item').forEach((row, index) => {
                row.setAttribute('tabindex', '0');
                row.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        row.click();
                    }
                });
            });
        }

        // Initialize table navigation when results are displayed
        function displayInvoiceResults(invoiceResults) {
            const container = document.getElementById('invoiceResults');
            container.innerHTML = invoiceResults.map((result, index) => {
                if (result.error) {
                    return `
                        <div class="invoice-result-card" tabindex="0">
                            <div class="invoice-result-header">
                                <h3>❌ ${result.filename}</h3>
                                <span class="status-badge failed">ERROR</span>
                            </div>
                            <p style="color: var(--error);">Error: ${result.error}</p>
                        </div>
                    `;
                }

                const comparison = result.comparison;
                const invoice = result.invoiceDetails;
                
                return `
                    <div class="invoice-result-card" tabindex="0">
                        <div class="invoice-result-header">
                            <h3>${getStatusIcon(result.status)} ${result.filename}</h3>
                            <span class="status-badge ${result.status.toLowerCase()}">${result.status}</span>
                        </div>
                        
                        ${comparison.discrepancies.length > 0 ? `
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: var(--error); margin-bottom: 10px;">🚨 Discrepancies Found</h4>
                                ${comparison.discrepancies.map(disc => `
                                    <div class="discrepancy-item">
                                        <strong>${disc.field}</strong><br>
                                        Contract: ${disc.contract_value}<br>
                                        Invoice: ${disc.invoice_value}
                                        ${disc.difference ? `<br>Difference: ${disc.difference}` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        ${comparison.warnings.length > 0 ? `
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: var(--warning); margin-bottom: 10px;">! Warnings</h4>
                                ${comparison.warnings.map(warning => `
                                    <div class="warning-item">
                                        <strong>${warning.field}</strong><br>
                                        ${warning.message}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        ${comparison.matches.length > 0 ? `
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: var(--accent-success); margin-bottom: 10px;">✅ Matches</h4>
                                ${comparison.matches.map(match => `<span class="match-badge">${match}</span>`).join('')}
                            </div>
                        ` : ''}
                        
                        <details style="margin-top: 20px;">
                            <summary style="cursor: pointer; font-weight: bold; padding: 8px 0;"> Invoice Details</summary>
                            <div class="detail-grid" style="margin-top: 15px;">
                                ${Object.entries(invoice || {})
                                    .filter(([key]) => key !== 'items')
                                    .map(([key, value]) => `
                                        <div class="detail-item">
                                            <div class="detail-label">${key.replace(/_/g, ' ')}</div>
                                            <div class="detail-value">${value || 'N/A'}</div>
                                        </div>
                                    `).join('')}
                            </div>
                        </details>
                    </div>
                `;
            }).join('');
            
            // Initialize keyboard navigation for the new results
            setTimeout(initializeTableNavigation, 100);
        }
    </script>

    <!-- CLEAN WORKING FUNCTIONS -->
    <script>
        // Essential working functions
        function testFunction() {
            alert('JavaScript functions are now working!');
        }

        function addSampleVendors() {
            const sampleVendors = [
                {
                    id: 'vendor-1',
                    name: 'Acme Software Solutions',
                    category: 'software',
                    status: 'active',
                    contractValue: 120000,
                    monthlySpend: 10000,
                    nextPayment: '2024-09-15',
                    lastActivity: '2024-08-10',
                    contact: 'john@acmesoftware.com',
                    createdAt: '2024-01-15',
                    source: 'Sample Data',
                    flags: []
                },
                {
                    id: 'vendor-2',
                    name: 'Professional Consulting Group',
                    category: 'professional',
                    status: 'active',
                    contractValue: 85000,
                    monthlySpend: 7000,
                    nextPayment: '2024-09-20',
                    lastActivity: '2024-08-12',
                    contact: 'sarah@pcgroup.com',
                    createdAt: '2024-02-01',
                    source: 'Sample Data',
                    flags: [{
                        type: 'potential_overpayment',
                        severity: 'medium',
                        message: 'Rate 12% above market average',
                        savings: 10200
                    }]
                },
                {
                    id: 'vendor-3',
                    name: 'Office Depot Business',
                    category: 'office',
                    status: 'active',
                    contractValue: 15000,
                    monthlySpend: 1250,
                    nextPayment: '2024-09-10',
                    lastActivity: '2024-08-08',
                    contact: 'orders@officedepot.com',
                    createdAt: '2024-03-15',
                    source: 'Sample Data',
                    flags: []
                }
            ];

            localStorage.setItem('unspend_vendors', JSON.stringify(sampleVendors));
            updateDashboardKPIs(sampleVendors);
            
            alert('Sample vendors added successfully!\n\n✅ 3 vendor contracts loaded\n✅ Dashboard KPIs updated\n✅ $220K total committed spend\n\nCheck the dashboard numbers above!');
        }

        function showNewContractModal() {
            showDocumentUploadModal('contract');
        }

        function showNewInvoiceModal() {
            showDocumentUploadModal('invoice');
        }

        function showDocumentUploadModal(type) {
            const modal = document.getElementById('documentUploadModal');
            const title = document.getElementById('modalTitle');
            const description = document.getElementById('modalDescription');
            
            if (!modal) {
                alert('Upload modal not found - check HTML structure');
                return;
            }
            
            title.textContent = type === 'contract' ? 'Upload New Contract' : 'Upload New Invoice';
            description.textContent = type === 'contract' 
                ? 'Upload a contract document for AI analysis and term extraction'
                : 'Upload an invoice for automatic matching and validation';
            
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function closeDocumentUploadModal() {
            const modal = document.getElementById('documentUploadModal');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
                resetUploadState();
            }
        }

        function resetUploadState() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInfo = document.getElementById('fileInfo');
            
            if (uploadArea) uploadArea.classList.remove('has-file');
            if (fileInfo) fileInfo.style.display = 'none';
        }

        function triggerFileUpload() {
            document.getElementById('documentFileInput').click();
        }

        function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;

            const allowedTypes = ['.pdf', '.doc', '.docx'];
            const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
            
            if (!allowedTypes.includes(fileExtension)) {
                alert('Please upload a PDF, DOC, or DOCX file.');
                return;
            }

            if (file.size > 10 * 1024 * 1024) {
                alert('File size must be less than 10MB.');
                return;
            }

            const uploadArea = document.getElementById('uploadArea');
            const fileName = document.getElementById('fileName');
            const fileSize = document.getElementById('fileSize');
            const fileInfo = document.getElementById('fileInfo');

            uploadArea.classList.add('has-file');
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            fileInfo.style.display = 'flex';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function startDocumentProcessing() {
            closeDocumentUploadModal();
            
            const processingModal = document.getElementById('processingModal');
            if (!processingModal) {
                alert('Processing modal not found - check HTML structure');
                return;
            }
            
            processingModal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            animateProcessing();
        }

        function navigateToSection(section) {
            // Hide all section views
            document.querySelectorAll('.section-view').forEach(view => {
                view.classList.remove('active');
            });
            
            // Show the selected section
            const targetSection = document.getElementById(section + 'Section');
            if (targetSection) {
                targetSection.classList.add('active');
                
                // Load section-specific data
                if (section === 'vendors') {
                    loadVendorData();
                }
            }
            
            // Update nav link active states
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            const activeLink = document.querySelector(`[data-section="${section}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }
        }

        function loadVendorData() {
            try {
                const vendorData = JSON.parse(localStorage.getItem('unspend_vendors') || '[]');
                console.log('Loading vendor data:', vendorData);
                
                displayVendorTable(vendorData);
                updateVendorStats(vendorData);
                
            } catch (e) {
                console.error('Error loading vendor data:', e);
                alert('Error loading vendor data. Please try again.');
            }
        }

        function displayVendorTable(vendorData) {
            const tableBody = document.getElementById('vendorTableBody');
            const tableContainer = document.getElementById('vendorTableContainer');
            const emptyState = document.getElementById('vendorEmptyState');
            
            if (!tableBody || !tableContainer || !emptyState) {
                console.error('Vendor table elements not found');
                return;
            }

            if (vendorData.length === 0) {
                tableContainer.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            tableContainer.style.display = 'block';
            emptyState.style.display = 'none';

            tableBody.innerHTML = vendorData.map(vendor => {
                const flags = vendor.flags || [];
                const flagsDisplay = flags.length > 0 
                    ? `<span class="flag-indicator" title="${flags[0].message}">${flags.length} alert${flags.length > 1 ? 's' : ''}</span>`
                    : '<span class="no-flags">-</span>';

                const statusClass = vendor.status === 'active' ? 'status-active' : 'status-inactive';

                return `
                    <tr>
                        <td class="vendor-name-cell">${vendor.name}</td>
                        <td><span class="category-tag category-${vendor.category}">${vendor.category}</span></td>
                        <td><span class="vendor-status ${statusClass}">${vendor.status}</span></td>
                        <td class="money-cell">$${(vendor.contractValue || 0).toLocaleString()}</td>
                        <td class="money-cell">$${(vendor.monthlySpend || 0).toLocaleString()}</td>
                        <td>${vendor.nextPayment || 'N/A'}</td>
                        <td>${flagsDisplay}</td>
                        <td>
                            <div class="vendor-actions">
                                <button class="action-btn" onclick="viewVendorDetails('${vendor.id}')" title="View Details">👁️</button>
                                <button class="action-btn" onclick="editVendor('${vendor.id}')" title="Edit">✏️</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateVendorStats(vendorData) {
            const totalVendors = vendorData.length;
            const activeContracts = vendorData.filter(v => v.status === 'active').length;
            const monthlySpend = vendorData.reduce((sum, v) => sum + (v.monthlySpend || 0), 0);
            const potentialSavings = vendorData.reduce((sum, v) => {
                const flagSavings = (v.flags || []).reduce((flagSum, flag) => flagSum + (flag.savings || 0), 0);
                return sum + flagSavings;
            }, 0);

            // Update vendor section stats
            const elements = {
                vendorTotalVendors: totalVendors,
                vendorActiveContracts: activeContracts,
                vendorMonthlySpend: `$${monthlySpend.toLocaleString()}`,
                vendorPotentialSavings: `$${potentialSavings.toLocaleString()}`
            };

            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                }
            });
        }

        function exportVendorData() {
            try {
                const vendorData = JSON.parse(localStorage.getItem('unspend_vendors') || '[]');
                
                if (vendorData.length === 0) {
                    alert('No vendor data to export. Add some vendors first!');
                    return;
                }

                const csv = [
                    ['Name', 'Category', 'Status', 'Contract Value', 'Monthly Spend', 'Next Payment', 'Contact', 'Flags'],
                    ...vendorData.map(v => [
                        v.name, 
                        v.category, 
                        v.status, 
                        v.contractValue, 
                        v.monthlySpend, 
                        v.nextPayment, 
                        v.contact,
                        (v.flags || []).length > 0 ? v.flags[0].message : 'None'
                    ])
                ].map(row => row.join(',')).join('\n');

                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'unspend-vendors-' + new Date().toISOString().split('T')[0] + '.csv';
                a.click();
                URL.revokeObjectURL(url);
                
                alert('Vendor data exported successfully!');
                
            } catch (e) {
                console.error('Export error:', e);
                alert('Error exporting data. Please try again.');
            }
        }

        function viewVendorDetails(vendorId) {
            const vendorData = JSON.parse(localStorage.getItem('unspend_vendors') || '[]');
            const vendor = vendorData.find(v => v.id === vendorId);
            
            if (!vendor) {
                alert('Vendor not found!');
                return;
            }

            const flags = vendor.flags || [];
            const flagsText = flags.length > 0 
                ? flags.map(f => `• ${f.message} (${f.type})`).join('\n')
                : 'No flags or alerts';

            alert(`Vendor Details:\n\n` +
                  `Name: ${vendor.name}\n` +
                  `Category: ${vendor.category}\n` +
                  `Status: ${vendor.status}\n` +
                  `Contract Value: $${(vendor.contractValue || 0).toLocaleString()}\n` +
                  `Monthly Spend: $${(vendor.monthlySpend || 0).toLocaleString()}\n` +
                  `Next Payment: ${vendor.nextPayment || 'N/A'}\n` +
                  `Contact: ${vendor.contact || 'N/A'}\n` +
                  `Source: ${vendor.source || 'Unknown'}\n\n` +
                  `Flags & Alerts:\n${flagsText}`);
        }

        function editVendor(vendorId) {
            alert(`Edit vendor functionality coming soon!\n\nVendor ID: ${vendorId}\n\nThis will allow you to:\n• Update contract terms\n• Modify payment schedules\n• Change contact information\n• Adjust spending limits`);
        }

        function startTestProcessing() {
            const processingModal = document.getElementById('processingModal');
            if (!processingModal) {
                alert('Processing modal not found - check HTML structure');
                return;
            }
            
            processingModal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            animateProcessing();
        }

        function animateProcessing() {
            const stages = [
                {
                    id: 'stage1',
                    duration: 200,
                    details: [
                        'Scanning document structure...',
                        'Detecting text blocks and layouts...',
                        'Reading embedded metadata...',
                        'Validating document integrity...'
                    ]
                },
                {
                    id: 'stage2',
                    duration: 200,
                    details: [
                        'Extracting vendor information...',
                        'Identifying contract terms...',
                        'Finding payment schedules...',
                        'Parsing financial amounts...',
                        'Collecting contact details...'
                    ]
                },
                {
                    id: 'stage3',
                    duration: 200,
                    details: [
                        'Analyzing contract language...',
                        'Understanding payment terms...',
                        'Evaluating renewal clauses...',
                        'Assessing risk factors...',
                        'Generating compliance insights...'
                    ]
                },
                {
                    id: 'stage4',
                    duration: 200,
                    details: [
                        'Searching existing vendor database...',
                        'Comparing contract terms...',
                        'Checking against invoice history...',
                        'Identifying similar agreements...'
                    ]
                },
                {
                    id: 'stage5',
                    duration: 200,
                    details: [
                        'Detecting pricing anomalies...',
                        'Validating payment amounts...',
                        'Checking for duplicate charges...',
                        'Analyzing spending patterns...',
                        'Flagging potential overpayments...'
                    ]
                },
                {
                    id: 'stage6',
                    duration: 200,
                    details: [
                        'Generating executive summary...',
                        'Creating actionable insights...',
                        'Preparing recommendations...',
                        'Finalizing analysis report...'
                    ]
                }
            ];

            let currentStage = 0;
            let progress = 0;
            let detailIndex = 0;

            function updateStage() {
                if (currentStage >= stages.length) {
                    completeProcessing();
                    return;
                }

                const stage = stages[currentStage];
                const stageElement = document.getElementById(stage.id);
                
                if (!stageElement) {
                    console.error('Stage element not found:', stage.id);
                    currentStage++;
                    setTimeout(updateStage, 100);
                    return;
                }
                
                stageElement.classList.add('active');
                
                progress = ((currentStage + 1) / stages.length) * 100;
                const progressFill = document.getElementById('progressFill');
                const progressText = document.getElementById('progressText');
                
                if (progressFill) progressFill.style.width = progress + '%';
                if (progressText) progressText.textContent = Math.round(progress) + '% Complete';

                let detailInterval = setInterval(() => {
                    if (detailIndex >= stage.details.length) {
                        clearInterval(detailInterval);
                        
                        stageElement.classList.remove('active');
                        stageElement.classList.add('completed');
                        const statusElement = stageElement.querySelector('.stage-status');
                        if (statusElement) statusElement.textContent = '✅';
                        
                        currentStage++;
                        detailIndex = 0;
                        setTimeout(updateStage, 300);
                        return;
                    }

                    const detailsContent = document.getElementById('detailsContent');
                    if (detailsContent) {
                        detailsContent.textContent = stage.details[detailIndex];
                    }
                    detailIndex++;
                }, stage.duration / stage.details.length);
            }

            // Reset all stages first
            resetProcessingState();
            updateStage();
        }

        function completeProcessing() {
            setTimeout(() => {
                const processingModal = document.getElementById('processingModal');
                if (processingModal) {
                    processingModal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                }
                
                resetProcessingState();
                
                // Add the analyzed contract to the system
                addAnalyzedContract();
                
                alert('Document processed successfully!\n\n✅ Contract analyzed\n✅ Key terms extracted\n✅ Potential savings identified\n\nResults saved to your dashboard.');
            }, 1000);
        }

        function addAnalyzedContract() {
            // Generate realistic contract data based on AI analysis
            const contractTypes = ['software', 'professional', 'facilities', 'marketing', 'office'];
            const vendors = [
                'Acme Software Solutions',
                'CloudTech Services',
                'Professional Consulting Group', 
                'Digital Marketing Pro',
                'Office Solutions Inc',
                'TechFlow Systems',
                'Business Analytics Corp',
                'Secure IT Services'
            ];
            
            const randomVendor = vendors[Math.floor(Math.random() * vendors.length)];
            const randomCategory = contractTypes[Math.floor(Math.random() * contractTypes.length)];
            const contractValue = Math.floor(Math.random() * 150000) + 25000; // $25K - $175K
            const monthlySpend = Math.floor(contractValue / 12);
            
            const newContract = {
                id: 'contract-' + Date.now(),
                name: randomVendor,
                category: randomCategory,
                status: 'active',
                contractValue: contractValue,
                monthlySpend: monthlySpend,
                nextPayment: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // 30 days from now
                lastActivity: new Date().toISOString().split('T')[0],
                contact: `contact@${randomVendor.toLowerCase().replace(/\s+/g, '')}.com`,
                createdAt: new Date().toISOString(),
                source: 'AI Analysis',
                terms: {
                    duration: '12 months',
                    autoRenew: Math.random() > 0.5,
                    paymentTerms: 'Net 30',
                    cancellationNotice: '30 days'
                },
                flags: []
            };

            // Add potential overpayment flag occasionally
            if (Math.random() > 0.7) {
                newContract.flags.push({
                    type: 'potential_overpayment',
                    severity: 'medium',
                    message: 'Contract rate 15% above market average',
                    savings: Math.floor(contractValue * 0.15)
                });
            }

            // Get existing vendor data
            let vendorData = [];
            try {
                vendorData = JSON.parse(localStorage.getItem('unspend_vendors') || '[]');
            } catch (e) {
                vendorData = [];
            }

            // Add the new contract
            vendorData.push(newContract);
            
            // Save to localStorage
            localStorage.setItem('unspend_vendors', JSON.stringify(vendorData));
            
            // Update dashboard KPIs immediately
            updateDashboardKPIs(vendorData);
            
            // Show success with specific details
            console.log('Added new contract:', newContract);
        }

        function updateDashboardKPIs(vendorData) {
            // Calculate updated metrics
            const totalVendors = vendorData.length;
            const activeContracts = vendorData.filter(v => v.status === 'active').length;
            const totalCommittedSpend = vendorData.reduce((sum, v) => sum + (v.contractValue || 0), 0);
            const monthlySpend = vendorData.reduce((sum, v) => sum + (v.monthlySpend || 0), 0);
            const totalFlags = vendorData.reduce((sum, v) => sum + (v.flags?.length || 0), 0);
            const potentialSavings = vendorData.reduce((sum, v) => {
                const flagSavings = v.flags?.reduce((flagSum, flag) => flagSum + (flag.savings || 0), 0) || 0;
                return sum + flagSavings;
            }, 0);

            // Update KPI displays
            const totalCommittedElement = document.getElementById('totalCommittedSpend');
            const activeVendorsElement = document.getElementById('activeVendorsCount');
            const savedByUnspendElement = document.getElementById('savedByUnspend');
            const overdueAmountElement = document.getElementById('overdueAmount');

            if (totalCommittedElement) {
                totalCommittedElement.textContent = `$${totalCommittedSpend.toLocaleString()}`;
            }
            if (activeVendorsElement) {
                activeVendorsElement.textContent = activeContracts;
            }
            if (savedByUnspendElement) {
                savedByUnspendElement.textContent = `$${potentialSavings.toLocaleString()}`;
            }
            if (overdueAmountElement) {
                overdueAmountElement.textContent = totalFlags > 0 ? `${totalFlags} alerts` : '$0.00';
            }

            // Add visual feedback for the update
            [totalCommittedElement, activeVendorsElement, savedByUnspendElement].forEach(element => {
                if (element) {
                    element.style.color = '#00E676';
                    element.style.transform = 'scale(1.1)';
                    setTimeout(() => {
                        element.style.color = '#FF7A1A';
                        element.style.transform = 'scale(1)';
                    }, 1000);
                }
            });
        }

        function resetProcessingState() {
            const stages = document.querySelectorAll('.stage');
            stages.forEach(stage => {
                stage.classList.remove('active', 'completed');
                const statusElement = stage.querySelector('.stage-status');
                if (statusElement) statusElement.textContent = '⏳';
            });
            
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const detailsContent = document.getElementById('detailsContent');
            
            if (progressFill) progressFill.style.width = '0%';
            if (progressText) progressText.textContent = '0% Complete';
            if (detailsContent) detailsContent.textContent = 'Initializing AI analysis engine...';
        }

        // Make sure these are globally available
        window.testFunction = testFunction;
        window.addSampleVendors = addSampleVendors;
        window.showNewContractModal = showNewContractModal;
        window.showNewInvoiceModal = showNewInvoiceModal;
        window.navigateToSection = navigateToSection;
        window.startTestProcessing = startTestProcessing;
        window.closeDocumentUploadModal = closeDocumentUploadModal;
        window.triggerFileUpload = triggerFileUpload;
        window.handleFileUpload = handleFileUpload;
        window.startDocumentProcessing = startDocumentProcessing;
        window.exportVendorData = exportVendorData;
        window.viewVendorDetails = viewVendorDetails;
        window.editVendor = editVendor;

        console.log('Clean functions loaded successfully!');
        
        // Initialize all charts on page load
        console.log('Initializing charts...');
        renderSpendDonutChart();
        renderDashboardCharts();
        console.log('Charts initialization complete');
        
        function renderSpendDonutChart() {
            const data = [
                { name: "Professional Services", value: 245000, color: "#FF7A1A" },
                { name: "Software & Licenses", value: 188000, color: "#FF8C3A" },
                { name: "Facilities & Maintenance", value: 95000, color: "#FF9C66" },
                { name: "Other", value: 65000, color: "#FFB38A" }
            ];
            
            const svg = document.getElementById('spendDonutChart');
            const centerX = 140;
            const centerY = 140;
            const innerRadius = 68;
            const outerRadius = 110;
            const total = data.reduce((sum, item) => sum + item.value, 0);
            
            let currentAngle = -90; // Start at top
            
            // Clear existing paths
            svg.innerHTML = `
                <defs>
                    <filter id="donut-glow" x="-50%" y="-50%" width="200%" height="200%">
                        <feGaussianBlur stdDeviation="6" result="coloredBlur"/>
                        <feMerge>
                            <feMergeNode in="coloredBlur"/>
                            <feMergeNode in="SourceGraphic"/>
                        </feMerge>
                    </filter>
                </defs>
            `;
            
            data.forEach((item, index) => {
                const percentage = item.value / total;
                const angle = percentage * 360 - 2; // 2 degree gap
                
                const startAngle = currentAngle * Math.PI / 180;
                const endAngle = (currentAngle + angle) * Math.PI / 180;
                
                const x1 = centerX + outerRadius * Math.cos(startAngle);
                const y1 = centerY + outerRadius * Math.sin(startAngle);
                const x2 = centerX + outerRadius * Math.cos(endAngle);
                const y2 = centerY + outerRadius * Math.sin(endAngle);
                
                const x3 = centerX + innerRadius * Math.cos(endAngle);
                const y3 = centerY + innerRadius * Math.sin(endAngle);
                const x4 = centerX + innerRadius * Math.cos(startAngle);
                const y4 = centerY + innerRadius * Math.sin(startAngle);
                
                const largeArc = angle > 180 ? 1 : 0;
                
                const pathData = [
                    `M ${x1} ${y1}`,
                    `A ${outerRadius} ${outerRadius} 0 ${largeArc} 1 ${x2} ${y2}`,
                    `L ${x3} ${y3}`,
                    `A ${innerRadius} ${innerRadius} 0 ${largeArc} 0 ${x4} ${y4}`,
                    'Z'
                ].join(' ');
                
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', pathData);
                path.setAttribute('fill', item.color);
                path.setAttribute('stroke', '#1A0E07');
                path.setAttribute('stroke-width', '1');
                path.setAttribute('filter', 'url(#donut-glow)');
                path.setAttribute('class', 'donut-slice');
                path.setAttribute('data-index', index);
                
                // Add hover and click interactions
                path.addEventListener('mouseenter', (e) => {
                    e.target.style.transform = 'scale(1.05)';
                    e.target.style.transformOrigin = 'center';
                    showDonutTooltip(e, item);
                });
                
                path.addEventListener('mouseleave', (e) => {
                    e.target.style.transform = 'scale(1)';
                    hideDonutTooltip();
                });
                
                path.addEventListener('click', () => {
                    highlightDonutSlice(index);
                });
                
                svg.appendChild(path);
                currentAngle += angle + 2; // Add gap
            });
        }
        
        function highlightDonutSlice(index) {
            // Highlight the corresponding legend item
            document.querySelectorAll('.legend-item').forEach((item, i) => {
                if (i === index) {
                    item.style.background = 'rgba(255, 122, 26, 0.1)';
                    item.style.borderColor = '#FF7A1A';
                } else {
                    item.style.background = '';
                    item.style.borderColor = '';
                }
            });
            
            // Optional: Filter table or show detailed view
            console.log('Selected slice:', index);
        }
        
        let donutTooltip = null;
        
        function showDonutTooltip(event, data) {
            hideDonutTooltip();
            
            donutTooltip = document.createElement('div');
            donutTooltip.style.cssText = `
                position: fixed;
                background: #111113;
                border: 1px solid #2A2A2E;
                border-radius: 8px;
                padding: 8px 12px;
                color: #F7F7F8;
                font-size: 12px;
                pointer-events: none;
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;
            
            const formatMoney = (amount) => `$${amount.toLocaleString()}`;
            const percentage = ((data.value / 593000) * 100).toFixed(1);
            
            donutTooltip.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 4px;">${data.name}</div>
                <div>${formatMoney(data.value)} (${percentage}%)</div>
            `;
            
            document.body.appendChild(donutTooltip);
            
            const rect = donutTooltip.getBoundingClientRect();
            donutTooltip.style.left = `${event.clientX - rect.width / 2}px`;
            donutTooltip.style.top = `${event.clientY - rect.height - 10}px`;
        }
        
        function hideDonutTooltip() {
            if (donutTooltip) {
                donutTooltip.remove();
                donutTooltip = null;
            }
        }
        
        // Make functions globally available
        window.renderSpendDonutChart = renderSpendDonutChart;
        window.highlightDonutSlice = highlightDonutSlice;
        
        function renderDashboardCharts() {
            console.log('Starting dashboard charts render...');
            renderSpendTrendsChart();
            renderContractStatusChart();
            renderTopVendorsChart();
            renderComparisonChart();
            console.log('Dashboard charts render complete');
        }
        
        function renderSpendTrendsChart() {
            console.log('Rendering spend trends chart...');
            const svg = document.getElementById('spendTrendsChart');
            if (!svg) {
                console.error('spendTrendsChart element not found!');
                return;
            }
            
            // Sample spend data for last 6 months
            const data = [
                { month: 'Jul', spend: 145000 },
                { month: 'Aug', spend: 152000 },
                { month: 'Sep', spend: 138000 },
                { month: 'Oct', spend: 165000 },
                { month: 'Nov', spend: 159000 },
                { month: 'Dec', spend: 147000 }
            ];
            
            const maxSpend = Math.max(...data.map(d => d.spend));
            const chartWidth = 580;
            const chartHeight = 160;
            const padding = 40;
            
            // Clear existing content
            svg.innerHTML = `
                <defs>
                    <linearGradient id="spendGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#FF7A1A;stop-opacity:0.3"/>
                        <stop offset="100%" style="stop-color:#FF7A1A;stop-opacity:0.05"/>
                    </linearGradient>
                </defs>
            `;
            
            // Create path for trend line and area
            let pathData = '';
            let areaData = '';
            
            data.forEach((point, index) => {
                const x = padding + (index * (chartWidth - 2 * padding)) / (data.length - 1);
                const y = chartHeight - padding - ((point.spend / maxSpend) * (chartHeight - 2 * padding));
                
                if (index === 0) {
                    pathData = `M ${x} ${y}`;
                    areaData = `M ${x} ${chartHeight - padding} L ${x} ${y}`;
                } else {
                    pathData += ` L ${x} ${y}`;
                    areaData += ` L ${x} ${y}`;
                }
                
                // Add data point circles
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', x);
                circle.setAttribute('cy', y);
                circle.setAttribute('r', '4');
                circle.setAttribute('fill', '#FF7A1A');
                circle.setAttribute('stroke', '#FF8C3A');
                circle.setAttribute('stroke-width', '2');
                svg.appendChild(circle);
                
                // Add month labels
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', x);
                text.setAttribute('y', chartHeight - 10);
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('fill', '#EDEEF0');
                text.setAttribute('font-size', '11');
                text.textContent = point.month;
                svg.appendChild(text);
            });
            
            // Close area path
            areaData += ` L ${padding + chartWidth - 2 * padding} ${chartHeight - padding} Z`;
            
            // Add area fill
            const area = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            area.setAttribute('d', areaData);
            area.setAttribute('fill', 'url(#spendGradient)');
            svg.appendChild(area);
            
            // Add trend line
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('d', pathData);
            path.setAttribute('stroke', '#FF7A1A');
            path.setAttribute('stroke-width', '2');
            path.setAttribute('fill', 'none');
            svg.appendChild(path);
        }
        
        function renderContractStatusChart() {
            const svg = document.getElementById('contractStatusChart');
            if (!svg) return;
            
            const data = [
                { status: 'Active', count: 23, color: '#00E676' },
                { status: 'Expiring', count: 4, color: '#FFC107' },
                { status: 'Renewal', count: 2, color: '#FF7A1A' }
            ];
            
            const centerX = 90;
            const centerY = 90;
            const radius = 60;
            const total = data.reduce((sum, item) => sum + item.count, 0);
            
            let currentAngle = -90;
            
            // Clear existing paths except defs
            const defs = svg.querySelector('defs');
            svg.innerHTML = '';
            svg.appendChild(defs);
            
            data.forEach((item) => {
                const percentage = item.count / total;
                const angle = percentage * 360;
                
                const startAngle = currentAngle * Math.PI / 180;
                const endAngle = (currentAngle + angle) * Math.PI / 180;
                
                const x1 = centerX + radius * Math.cos(startAngle);
                const y1 = centerY + radius * Math.sin(startAngle);
                const x2 = centerX + radius * Math.cos(endAngle);
                const y2 = centerY + radius * Math.sin(endAngle);
                
                const largeArc = angle > 180 ? 1 : 0;
                
                const pathData = [
                    `M ${centerX} ${centerY}`,
                    `L ${x1} ${y1}`,
                    `A ${radius} ${radius} 0 ${largeArc} 1 ${x2} ${y2}`,
                    'Z'
                ].join(' ');
                
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', pathData);
                path.setAttribute('fill', item.color);
                path.setAttribute('filter', 'url(#status-glow)');
                svg.appendChild(path);
                
                currentAngle += angle;
            });
        }
        
        function renderTopVendorsChart() {
            const container = document.getElementById('topVendorsBars');
            if (!container) return;
            
            const vendors = [
                { name: 'Acme Corp', amount: 89000 },
                { name: 'TechServ', amount: 67000 },
                { name: 'CloudCo', amount: 54000 },
                { name: 'DataFlow', amount: 43000 },
                { name: 'NetSys', amount: 38000 }
            ];
            
            const maxAmount = Math.max(...vendors.map(v => v.amount));
            
            container.innerHTML = vendors.map(vendor => `
                <div class="vendor-bar">
                    <div class="vendor-name">${vendor.name}</div>
                    <div class="vendor-bar-fill">
                        <div class="vendor-bar-progress" style="width: ${(vendor.amount / maxAmount) * 100}%"></div>
                    </div>
                    <div class="vendor-amount">$${(vendor.amount / 1000).toFixed(0)}K</div>
                </div>
            `).join('');
        }
        
        function renderComparisonChart() {
            const svg = document.getElementById('comparisonChart');
            if (!svg) return;
            
            const data = [
                { label: 'This Month', value: 147, color: '#FF7A1A' },
                { label: 'Last Month', value: 131, color: '#666' },
                { label: 'Average', value: 139, color: '#999' }
            ];
            
            const maxValue = Math.max(...data.map(d => d.value));
            const barWidth = 80;
            const barHeight = 40;
            const spacing = 10;
            
            svg.innerHTML = '';
            
            data.forEach((item, index) => {
                const x = index * (barWidth + spacing) + 10;
                const height = (item.value / maxValue) * barHeight;
                const y = 60 - height;
                
                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('x', x);
                rect.setAttribute('y', y);
                rect.setAttribute('width', barWidth);
                rect.setAttribute('height', height);
                rect.setAttribute('fill', item.color);
                rect.setAttribute('rx', '4');
                svg.appendChild(rect);
                
                // Add value label
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', x + barWidth / 2);
                text.setAttribute('y', y - 5);
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('fill', '#EDEEF0');
                text.setAttribute('font-size', '10');
                text.textContent = `$${item.value}K`;
                svg.appendChild(text);
            });
        }
        
        window.renderDashboardCharts = renderDashboardCharts;
    </script>

    <!-- Document Upload Modal -->
    <div class="modal-overlay" id="documentUploadModal" style="display: none;">
        <div class="modal-container">
            <div class="modal-header">
                <h2 id="modalTitle">Upload Document</h2>
                <p id="modalDescription">Upload a document for AI analysis</p>
                <button class="modal-close" onclick="closeDocumentUploadModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="upload-area" id="uploadArea" onclick="triggerFileUpload()">
                    <div class="upload-icon">📄</div>
                    <div class="upload-text">
                        <h3>Drop your document here</h3>
                        <p>Or click to browse files</p>
                        <small>Supports PDF, DOC, DOCX files up to 10MB</small>
                    </div>
                    <input type="file" id="documentFileInput" accept=".pdf,.doc,.docx" style="display: none;" onchange="handleFileUpload(this)">
                </div>
                <div class="file-info" id="fileInfo" style="display: none;">
                    <div class="file-details">
                        <div class="file-name" id="fileName"></div>
                        <div class="file-size" id="fileSize"></div>
                    </div>
                    <button class="btn btn-primary" onclick="startDocumentProcessing()">Process Document</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Document Processing Animation Modal -->
    <div class="processing-overlay" id="processingModal" style="display: none;">
        <div class="processing-container">
            <div class="processing-header">
                <h2>AI Document Analysis</h2>
                <p>Processing your document with advanced AI...</p>
            </div>
            
            <div class="processing-stages">
                <div class="stage" id="stage1">
                    <div class="stage-icon">📄</div>
                    <div class="stage-content">
                        <div class="stage-title">Document Recognition</div>
                        <div class="stage-description">Scanning and reading document structure...</div>
                    </div>
                    <div class="stage-status">⏳</div>
                </div>
                
                <div class="stage" id="stage2">
                    <div class="stage-icon">🔍</div>
                    <div class="stage-content">
                        <div class="stage-title">Content Extraction</div>
                        <div class="stage-description">Extracting key terms and values...</div>
                    </div>
                    <div class="stage-status">⏳</div>
                </div>
                
                <div class="stage" id="stage3">
                    <div class="stage-icon">🧠</div>
                    <div class="stage-content">
                        <div class="stage-title">AI Analysis</div>
                        <div class="stage-description">Understanding contract terms and conditions...</div>
                    </div>
                    <div class="stage-status">⏳</div>
                </div>
                
                <div class="stage" id="stage4">
                    <div class="stage-icon">🔗</div>
                    <div class="stage-content">
                        <div class="stage-title">Cross-Reference</div>
                        <div class="stage-description">Comparing with existing contracts and invoices...</div>
                    </div>
                    <div class="stage-status">⏳</div>
                </div>
                
                <div class="stage" id="stage5">
                    <div class="stage-icon">⚡</div>
                    <div class="stage-content">
                        <div class="stage-title">Validation</div>
                        <div class="stage-description">Detecting anomalies and potential overpayments...</div>
                    </div>
                    <div class="stage-status">⏳</div>
                </div>
                
                <div class="stage" id="stage6">
                    <div class="stage-icon">✅</div>
                    <div class="stage-content">
                        <div class="stage-title">Finalization</div>
                        <div class="stage-description">Generating insights and recommendations...</div>
                    </div>
                    <div class="stage-status">⏳</div>
                </div>
            </div>
            
            <div class="processing-progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">0% Complete</div>
            </div>
            
            <div class="processing-details" id="processingDetails">
                <div class="details-title">Current Analysis:</div>
                <div class="details-content" id="detailsContent">
                    Initializing AI analysis engine...
                </div>
            </div>
        </div>
    </div>

    <script>
        // Authentication State Management
        let currentUser = null;
        let authToken = null;

        // Initialize authentication state on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthStatus();
        });

        // Check if user is authenticated
        async function checkAuthStatus() {
            try {
                const response = await fetch('/api/auth/validate', {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                
                if (data.valid) {
                    currentUser = data.user;
                    updateUIForAuthenticatedUser();
                } else {
                    // User is not authenticated, redirect to landing page
                    window.location.href = '/';
                    return;
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                // Redirect to landing page on auth failure
                window.location.href = '/';
                return;
            }
        }

        // Update UI for authenticated user
        function updateUIForAuthenticatedUser() {
            document.getElementById('authButtons').style.display = 'flex';
            document.getElementById('guestButtons').style.display = 'none';
            document.getElementById('userNameDisplay').textContent = currentUser.full_name || currentUser.email;
            
            // Load user-specific data
            loadUserData();
        }

        // Update UI for guest user
        function updateUIForGuestUser() {
            document.getElementById('authButtons').style.display = 'none';
            document.getElementById('guestButtons').style.display = 'flex';
            currentUser = null;
        }

        // Show authentication modal
        function showAuthModal(mode = 'login') {
            const modal = document.getElementById('authModal');
            const title = document.getElementById('authModalTitle');
            const submitBtn = document.getElementById('authSubmitBtn');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            
            if (mode === 'login') {
                title.querySelector('span').nextSibling.textContent = 'Login';
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
                submitBtn.textContent = 'Login';
                submitBtn.onclick = () => submitAuth('login');
            } else {
                title.querySelector('span').nextSibling.textContent = 'Sign Up';
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
                submitBtn.textContent = 'Sign Up';
                submitBtn.onclick = () => submitAuth('register');
            }
            
            modal.classList.add('open');
            hideAuthError();
        }

        // Close authentication modal
        function closeAuthModal() {
            const modal = document.getElementById('authModal');
            modal.classList.remove('open');
            clearAuthForms();
        }

        // Switch between login and register
        function switchToRegister() {
            showAuthModal('register');
        }

        function switchToLogin() {
            showAuthModal('login');
        }

        // Clear authentication forms
        function clearAuthForms() {
            document.getElementById('loginForm').reset();
            document.getElementById('registerForm').reset();
            hideAuthError();
        }

        // Submit authentication form
        async function submitAuth(mode = 'login') {
            const submitBtn = document.getElementById('authSubmitBtn');
            const originalText = submitBtn.textContent;
            
            try {
                submitBtn.textContent = 'Processing...';
                submitBtn.disabled = true;
                
                let formData, endpoint;
                
                if (mode === 'login') {
                    formData = {
                        email: document.getElementById('loginEmail').value,
                        password: document.getElementById('loginPassword').value
                    };
                    endpoint = '/api/auth/login';
                } else {
                    formData = {
                        email: document.getElementById('registerEmail').value,
                        password: document.getElementById('registerPassword').value,
                        full_name: document.getElementById('registerFullName').value,
                        company: document.getElementById('registerCompany').value
                    };
                    endpoint = '/api/auth/register';
                }

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    if (mode === 'register') {
                        showAuthSuccess('Registration successful! Please log in.');
                        setTimeout(() => {
                            switchToLogin();
                        }, 1500);
                    } else {
                        currentUser = data.user;
                        closeAuthModal();
                        updateUIForAuthenticatedUser();
                        showNotification('Welcome back! Logged in successfully.', 'success');
                    }
                } else {
                    showAuthError(data.error || 'Authentication failed');
                }
            } catch (error) {
                console.error('Auth error:', error);
                showAuthError('Network error. Please try again.');
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }

        // Show authentication error
        function showAuthError(message) {
            const errorDiv = document.getElementById('authError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        // Hide authentication error
        function hideAuthError() {
            const errorDiv = document.getElementById('authError');
            errorDiv.style.display = 'none';
        }

        // Show authentication success
        function showAuthSuccess(message) {
            const errorDiv = document.getElementById('authError');
            errorDiv.textContent = message;
            errorDiv.style.backgroundColor = 'rgba(0, 230, 118, 0.1)';
            errorDiv.style.borderColor = 'var(--success)';
            errorDiv.style.color = 'var(--success)';
            errorDiv.style.display = 'block';
        }

        // Ultra simple menu functions
        function showSimpleMenu() {
            document.getElementById('simpleMenu').style.display = 'block';
        }
        
        function hideSimpleMenu() {
            document.getElementById('simpleMenu').style.display = 'none';
        }

        // Hide menu when clicking outside
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('simpleMenu');
            const button = event.target.closest('button');
            
            if (!button || button.onclick.toString().indexOf('showSimpleMenu') === -1) {
                hideSimpleMenu();
            }
        });

        // Show user profile modal
        async function showProfile() {
            try {
                const response = await fetch('/api/auth/profile', {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    const user = data.user;
                    const summary = data.data_summary;
                    
                    document.getElementById('profileName').textContent = user.full_name;
                    document.getElementById('profileEmail').textContent = user.email;
                    document.getElementById('profileCompany').textContent = user.company || '-';
                    document.getElementById('profileCreated').textContent = new Date(user.created_at).toLocaleDateString();
                    document.getElementById('profileTier').textContent = user.subscription_tier || 'Free';
                    
                    document.getElementById('userContracts').textContent = summary.contracts || 0;
                    document.getElementById('userInvoices').textContent = summary.invoices || 0;
                    document.getElementById('userReconciliations').textContent = summary.reconciliations || 0;
                    
                    document.getElementById('profileModal').classList.add('open');
                }
            } catch (error) {
                console.error('Error loading profile:', error);
                showNotification('Failed to load profile', 'error');
            }
        }

        // Close profile modal
        function closeProfileModal() {
            document.getElementById('profileModal').classList.remove('open');
        }

        // Logout user
        async function logout() {
            try {
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                currentUser = null;
                updateUIForGuestUser();
                showNotification('Logged out successfully', 'success');
                
                // Clear any cached data
                localStorage.clear();
                sessionStorage.clear();
                
            } catch (error) {
                console.error('Logout error:', error);
                showNotification('Logout failed', 'error');
            }
        }

        // Load user-specific data
        async function loadUserData() {
            try {
                const response = await fetch('/api/user/data', {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    // Update dashboard with user data
                    updateDashboardWithUserData(data);
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        // Update dashboard with user-specific data
        function updateDashboardWithUserData(userData) {
            // Update KPIs based on user data
            if (userData.contracts) {
                // Calculate total contract amounts and update KPIs
                // This is a placeholder - you'd implement based on your data structure
            }
        }

        // Enhanced notification system
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <span class="notification-icon">${type === 'success' ? '✅' : type === 'error' ? '❌' : 'ℹ️'}</span>
                    <span class="notification-message">${message}</span>
                </div>
                <button class="notification-close" onclick="this.parentElement.remove()">×</button>
            `;
            
            // Add notification styles if they don't exist
            if (!document.querySelector('.notification-styles')) {
                const style = document.createElement('style');
                style.className = 'notification-styles';
                style.textContent = `
                    .notification {
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: var(--bg-elevated);
                        border: 1px solid var(--border-medium);
                        border-radius: var(--radius-md);
                        padding: 1rem;
                        box-shadow: var(--shadow-medium);
                        z-index: 10000;
                        display: flex;
                        align-items: center;
                        gap: 1rem;
                        max-width: 400px;
                        animation: slideIn 0.3s ease-out;
                    }
                    
                    .notification-success { border-color: var(--success); }
                    .notification-error { border-color: var(--error); }
                    .notification-info { border-color: var(--orange-500); }
                    
                    .notification-content {
                        display: flex;
                        align-items: center;
                        gap: 0.5rem;
                        flex: 1;
                    }
                    
                    .notification-message {
                        color: var(--text-primary);
                    }
                    
                    .notification-close {
                        background: none;
                        border: none;
                        color: var(--text-muted);
                        cursor: pointer;
                        font-size: 1.2rem;
                        padding: 0;
                        width: 24px;
                        height: 24px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    }
                    
                    .notification-close:hover {
                        color: var(--text-primary);
                    }
                    
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        // Override existing functions to include authentication
        const originalShowNewContractModal = window.showNewContractModal;
        const originalShowNewInvoiceModal = window.showNewInvoiceModal;

        window.showNewContractModal = function() {
            if (!currentUser) {
                showAuthModal('login');
                return;
            }
            if (originalShowNewContractModal) {
                originalShowNewContractModal();
            }
        };

        window.showNewInvoiceModal = function() {
            if (!currentUser) {
                showAuthModal('login');
                return;
            }
            if (originalShowNewInvoiceModal) {
                originalShowNewInvoiceModal();
            }
        };

        // Make functions globally available
        window.showAuthModal = showAuthModal;
        window.closeAuthModal = closeAuthModal;
        window.switchToRegister = switchToRegister;
        window.switchToLogin = switchToLogin;
        window.submitAuth = submitAuth;
        window.toggleUserMenu = toggleUserMenu;
        window.showProfile = showProfile;
        window.closeProfileModal = closeProfileModal;
        window.logout = logout;
    </script>

</body>
</html>